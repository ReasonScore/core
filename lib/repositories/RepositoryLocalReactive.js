"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.RepositoryLocalReactive = void 0;

var _RsData = require("../dataModels/RsData");

var _RepositoryLocalBase = require("./RepositoryLocalBase");

class RepositoryLocalReactive extends _RepositoryLocalBase.RepositoryLocalBase {
  constructor(rsData = new _RsData.RsData()) {
    super(rsData);
    this.rsData = rsData;
  }

  notify(actions) {
    this.rsData.actionsLog.push(actions);

    for (const action of actions) {
      // "add_claim" |
      if (action.type == "add_claim" || action.type == "modify_claim") {
        this.rsData.items[action.dataId] = action.newData;
      }

      if (action.type == "delete_claim") {
        throw new Error("Method not implemented.");
      }

      if (action.type == "add_claimEdge" || action.type == "modify_claimEdge") {
        this.rsData.items[action.dataId] = action.newData;
        const item = action.newData;
        this.indexClaimEdgeIdByParentId(item);
        this.indexClaimEdgeIdByChildId(item);
      }

      if (action.type == "delete_claimEdge") {
        throw new Error("Method not implemented.");
      }

      if (action.type == "add_score" || action.type == "modify_score") {
        const item = action.newData;
        this.rsData.items[action.dataId] = action.newData;
        this.scoreIdsBySourceId(item);
        this.childIdsByScoreId(item);
      }

      if (action.type == "delete_score") {
        throw new Error("Method not implemented.");
      }
    }
  }

  indexClaimEdgeIdByParentId(claimEdge) {
    let indexId = claimEdge.parentId;
    let id = claimEdge.id;
    let destination = this.rsData.claimEdgeIdsByParentId[claimEdge.parentId];

    if (!destination) {
      destination = [];
      this.rsData.claimEdgeIdsByParentId[claimEdge.parentId] = destination;
    }

    if (!destination.includes(claimEdge.id)) {
      destination.push(claimEdge.id);
    }
  }

  indexClaimEdgeIdByChildId(claimEdge) {
    let indexId = claimEdge.childId;
    let id = claimEdge.id;
    let destination = this.rsData.claimEdgeIdsByChildId[indexId];

    if (!destination) {
      destination = [];
      this.rsData.claimEdgeIdsByChildId[indexId] = destination;
    }

    if (!destination.includes(id)) {
      destination.push(id);
    }
  }

  scoreIdsBySourceId(score) {
    //Source Claim ID
    {
      let indexId = score.sourceClaimId;
      let id = score.id;
      let destination = this.rsData.scoreIdsBySourceId[indexId];

      if (!destination) {
        destination = [];
        this.rsData.scoreIdsBySourceId[indexId] = destination;
      }

      if (!destination.includes(id)) {
        destination.push(id);
      }
    } //Source Edge ID

    if (score.sourceEdgeId) {
      let indexId = score.sourceEdgeId;
      let id = score.id;
      let destination = this.rsData.scoreIdsBySourceId[indexId];

      if (!destination) {
        destination = [];
        this.rsData.scoreIdsBySourceId[indexId] = destination;
      }

      if (!destination.includes(id)) {
        destination.push(id);
      }
    }
  } //TODO: not sure if this is correct


  childIdsByScoreId(score) {
    let indexId = score.parentScoreId;
    let id = score.id;

    if (indexId) {
      let destination = this.rsData.childIdsByScoreId[indexId];

      if (!destination) {
        destination = [];
        this.rsData.childIdsByScoreId[indexId] = destination;
      }

      if (!destination.includes(id)) {
        destination.push(id);
      }
    }
  }

}

exports.RepositoryLocalReactive = RepositoryLocalReactive;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZXBvc2l0b3JpZXMvUmVwb3NpdG9yeUxvY2FsUmVhY3RpdmUudHMiXSwibmFtZXMiOlsiUmVwb3NpdG9yeUxvY2FsUmVhY3RpdmUiLCJSZXBvc2l0b3J5TG9jYWxCYXNlIiwiY29uc3RydWN0b3IiLCJyc0RhdGEiLCJSc0RhdGEiLCJub3RpZnkiLCJhY3Rpb25zIiwiYWN0aW9uc0xvZyIsInB1c2giLCJhY3Rpb24iLCJ0eXBlIiwiaXRlbXMiLCJkYXRhSWQiLCJuZXdEYXRhIiwiRXJyb3IiLCJpdGVtIiwiaW5kZXhDbGFpbUVkZ2VJZEJ5UGFyZW50SWQiLCJpbmRleENsYWltRWRnZUlkQnlDaGlsZElkIiwic2NvcmVJZHNCeVNvdXJjZUlkIiwiY2hpbGRJZHNCeVNjb3JlSWQiLCJjbGFpbUVkZ2UiLCJpbmRleElkIiwicGFyZW50SWQiLCJpZCIsImRlc3RpbmF0aW9uIiwiY2xhaW1FZGdlSWRzQnlQYXJlbnRJZCIsImluY2x1ZGVzIiwiY2hpbGRJZCIsImNsYWltRWRnZUlkc0J5Q2hpbGRJZCIsInNjb3JlIiwic291cmNlQ2xhaW1JZCIsInNvdXJjZUVkZ2VJZCIsInBhcmVudFNjb3JlSWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7QUFJQTs7QUFJTyxNQUFNQSx1QkFBTixTQUFzQ0Msd0NBQXRDLENBQWlGO0FBRXBGQyxFQUFBQSxXQUFXLENBQ0FDLE1BQWUsR0FBRyxJQUFJQyxjQUFKLEVBRGxCLEVBRVQ7QUFDRSxVQUFNRCxNQUFOO0FBREYsU0FEU0EsTUFDVCxHQURTQSxNQUNUO0FBRUQ7O0FBRURFLEVBQUFBLE1BQU0sQ0FBQ0MsT0FBRCxFQUEyQjtBQUM3QixTQUFLSCxNQUFMLENBQVlJLFVBQVosQ0FBdUJDLElBQXZCLENBQTRCRixPQUE1Qjs7QUFDQSxTQUFLLE1BQU1HLE1BQVgsSUFBcUJILE9BQXJCLEVBQThCO0FBQzFCO0FBQ0EsVUFBSUcsTUFBTSxDQUFDQyxJQUFQLElBQWUsV0FBZixJQUNBRCxNQUFNLENBQUNDLElBQVAsSUFBZSxjQURuQixFQUNtQztBQUMvQixhQUFLUCxNQUFMLENBQVlRLEtBQVosQ0FBa0JGLE1BQU0sQ0FBQ0csTUFBekIsSUFBbUNILE1BQU0sQ0FBQ0ksT0FBMUM7QUFDSDs7QUFDRCxVQUFJSixNQUFNLENBQUNDLElBQVAsSUFBZSxjQUFuQixFQUFtQztBQUMvQixjQUFNLElBQUlJLEtBQUosQ0FBVSx5QkFBVixDQUFOO0FBQ0g7O0FBQ0QsVUFBSUwsTUFBTSxDQUFDQyxJQUFQLElBQWUsZUFBZixJQUNBRCxNQUFNLENBQUNDLElBQVAsSUFBZSxrQkFEbkIsRUFDdUM7QUFDbkMsYUFBS1AsTUFBTCxDQUFZUSxLQUFaLENBQWtCRixNQUFNLENBQUNHLE1BQXpCLElBQW1DSCxNQUFNLENBQUNJLE9BQTFDO0FBQ0EsY0FBTUUsSUFBSSxHQUFHTixNQUFNLENBQUNJLE9BQXBCO0FBQ0EsYUFBS0csMEJBQUwsQ0FBZ0NELElBQWhDO0FBQ0EsYUFBS0UseUJBQUwsQ0FBK0JGLElBQS9CO0FBQ0g7O0FBQ0QsVUFBSU4sTUFBTSxDQUFDQyxJQUFQLElBQWUsa0JBQW5CLEVBQXVDO0FBQ25DLGNBQU0sSUFBSUksS0FBSixDQUFVLHlCQUFWLENBQU47QUFDSDs7QUFDRCxVQUFJTCxNQUFNLENBQUNDLElBQVAsSUFBZSxXQUFmLElBQ0FELE1BQU0sQ0FBQ0MsSUFBUCxJQUFlLGNBRG5CLEVBQ21DO0FBQy9CLGNBQU1LLElBQUksR0FBR04sTUFBTSxDQUFDSSxPQUFwQjtBQUNBLGFBQUtWLE1BQUwsQ0FBWVEsS0FBWixDQUFrQkYsTUFBTSxDQUFDRyxNQUF6QixJQUFtQ0gsTUFBTSxDQUFDSSxPQUExQztBQUNBLGFBQUtLLGtCQUFMLENBQXdCSCxJQUF4QjtBQUNBLGFBQUtJLGlCQUFMLENBQXVCSixJQUF2QjtBQUNIOztBQUNELFVBQUlOLE1BQU0sQ0FBQ0MsSUFBUCxJQUFlLGNBQW5CLEVBQW1DO0FBQy9CLGNBQU0sSUFBSUksS0FBSixDQUFVLHlCQUFWLENBQU47QUFDSDtBQUNKO0FBQ0o7O0FBRU9FLEVBQUFBLDBCQUFSLENBQW1DSSxTQUFuQyxFQUF5RDtBQUNyRCxRQUFJQyxPQUFPLEdBQUdELFNBQVMsQ0FBQ0UsUUFBeEI7QUFDQSxRQUFJQyxFQUFFLEdBQUdILFNBQVMsQ0FBQ0csRUFBbkI7QUFDQSxRQUFJQyxXQUFXLEdBQUcsS0FBS3JCLE1BQUwsQ0FBWXNCLHNCQUFaLENBQW1DTCxTQUFTLENBQUNFLFFBQTdDLENBQWxCOztBQUNBLFFBQUksQ0FBQ0UsV0FBTCxFQUFrQjtBQUNkQSxNQUFBQSxXQUFXLEdBQUcsRUFBZDtBQUNBLFdBQUtyQixNQUFMLENBQVlzQixzQkFBWixDQUFtQ0wsU0FBUyxDQUFDRSxRQUE3QyxJQUF5REUsV0FBekQ7QUFDSDs7QUFDRCxRQUFJLENBQUNBLFdBQVcsQ0FBQ0UsUUFBWixDQUFxQk4sU0FBUyxDQUFDRyxFQUEvQixDQUFMLEVBQXlDO0FBQ3JDQyxNQUFBQSxXQUFXLENBQUNoQixJQUFaLENBQWlCWSxTQUFTLENBQUNHLEVBQTNCO0FBQ0g7QUFDSjs7QUFFT04sRUFBQUEseUJBQVIsQ0FBa0NHLFNBQWxDLEVBQXdEO0FBQ3BELFFBQUlDLE9BQU8sR0FBR0QsU0FBUyxDQUFDTyxPQUF4QjtBQUNBLFFBQUlKLEVBQUUsR0FBR0gsU0FBUyxDQUFDRyxFQUFuQjtBQUNBLFFBQUlDLFdBQVcsR0FBRyxLQUFLckIsTUFBTCxDQUFZeUIscUJBQVosQ0FBa0NQLE9BQWxDLENBQWxCOztBQUNBLFFBQUksQ0FBQ0csV0FBTCxFQUFrQjtBQUNkQSxNQUFBQSxXQUFXLEdBQUcsRUFBZDtBQUNBLFdBQUtyQixNQUFMLENBQVl5QixxQkFBWixDQUFrQ1AsT0FBbEMsSUFBNkNHLFdBQTdDO0FBQ0g7O0FBQ0QsUUFBSSxDQUFDQSxXQUFXLENBQUNFLFFBQVosQ0FBcUJILEVBQXJCLENBQUwsRUFBK0I7QUFDM0JDLE1BQUFBLFdBQVcsQ0FBQ2hCLElBQVosQ0FBaUJlLEVBQWpCO0FBQ0g7QUFDSjs7QUFFT0wsRUFBQUEsa0JBQVIsQ0FBMkJXLEtBQTNCLEVBQTBDO0FBQ3RDO0FBQ0E7QUFDSSxVQUFJUixPQUFPLEdBQUdRLEtBQUssQ0FBQ0MsYUFBcEI7QUFDQSxVQUFJUCxFQUFFLEdBQUdNLEtBQUssQ0FBQ04sRUFBZjtBQUNBLFVBQUlDLFdBQVcsR0FBRyxLQUFLckIsTUFBTCxDQUFZZSxrQkFBWixDQUErQkcsT0FBL0IsQ0FBbEI7O0FBQ0EsVUFBSSxDQUFDRyxXQUFMLEVBQWtCO0FBQ2RBLFFBQUFBLFdBQVcsR0FBRyxFQUFkO0FBQ0EsYUFBS3JCLE1BQUwsQ0FBWWUsa0JBQVosQ0FBK0JHLE9BQS9CLElBQTBDRyxXQUExQztBQUNIOztBQUNELFVBQUksQ0FBQ0EsV0FBVyxDQUFDRSxRQUFaLENBQXFCSCxFQUFyQixDQUFMLEVBQStCO0FBQzNCQyxRQUFBQSxXQUFXLENBQUNoQixJQUFaLENBQWlCZSxFQUFqQjtBQUNIO0FBQ0osS0FicUMsQ0FldEM7O0FBQ0EsUUFBSU0sS0FBSyxDQUFDRSxZQUFWLEVBQXVCO0FBQ25CLFVBQUlWLE9BQU8sR0FBR1EsS0FBSyxDQUFDRSxZQUFwQjtBQUNBLFVBQUlSLEVBQUUsR0FBR00sS0FBSyxDQUFDTixFQUFmO0FBQ0EsVUFBSUMsV0FBVyxHQUFHLEtBQUtyQixNQUFMLENBQVllLGtCQUFaLENBQStCRyxPQUEvQixDQUFsQjs7QUFDQSxVQUFJLENBQUNHLFdBQUwsRUFBa0I7QUFDZEEsUUFBQUEsV0FBVyxHQUFHLEVBQWQ7QUFDQSxhQUFLckIsTUFBTCxDQUFZZSxrQkFBWixDQUErQkcsT0FBL0IsSUFBMENHLFdBQTFDO0FBQ0g7O0FBQ0QsVUFBSSxDQUFDQSxXQUFXLENBQUNFLFFBQVosQ0FBcUJILEVBQXJCLENBQUwsRUFBK0I7QUFDM0JDLFFBQUFBLFdBQVcsQ0FBQ2hCLElBQVosQ0FBaUJlLEVBQWpCO0FBQ0g7QUFDSjtBQUNKLEdBaEdtRixDQWtHcEY7OztBQUNRSixFQUFBQSxpQkFBUixDQUEwQlUsS0FBMUIsRUFBeUM7QUFDckMsUUFBSVIsT0FBTyxHQUFHUSxLQUFLLENBQUNHLGFBQXBCO0FBQ0EsUUFBSVQsRUFBRSxHQUFHTSxLQUFLLENBQUNOLEVBQWY7O0FBQ0EsUUFBSUYsT0FBSixFQUFhO0FBQ1QsVUFBSUcsV0FBVyxHQUFHLEtBQUtyQixNQUFMLENBQVlnQixpQkFBWixDQUE4QkUsT0FBOUIsQ0FBbEI7O0FBQ0EsVUFBSSxDQUFDRyxXQUFMLEVBQWtCO0FBQ2RBLFFBQUFBLFdBQVcsR0FBRyxFQUFkO0FBQ0EsYUFBS3JCLE1BQUwsQ0FBWWdCLGlCQUFaLENBQThCRSxPQUE5QixJQUF5Q0csV0FBekM7QUFDSDs7QUFDRCxVQUFJLENBQUNBLFdBQVcsQ0FBQ0UsUUFBWixDQUFxQkgsRUFBckIsQ0FBTCxFQUErQjtBQUMzQkMsUUFBQUEsV0FBVyxDQUFDaEIsSUFBWixDQUFpQmUsRUFBakI7QUFDSDtBQUNKO0FBQ0o7O0FBaEhtRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlDbGFpbUVkZ2UsIENsYWltRWRnZSB9IGZyb20gXCIuLi9kYXRhTW9kZWxzL0NsYWltRWRnZVwiO1xyXG5pbXBvcnQgeyBpU2NvcmUsIFNjb3JlIH0gZnJvbSBcIi4uL2RhdGFNb2RlbHMvU2NvcmVcIjtcclxuaW1wb3J0IHsgUnNEYXRhLCBpUnNEYXRhIH0gZnJvbSBcIi4uL2RhdGFNb2RlbHMvUnNEYXRhXCI7XHJcbmltcG9ydCB7IGlSZXBvc2l0b3J5IH0gZnJvbSBcIi4uL2RhdGFNb2RlbHMvaVJlcG9zaXRvcnlcIjtcclxuaW1wb3J0IHsgaUFjdGlvbiwgQWN0aW9uIH0gZnJvbSBcIi4uL2RhdGFNb2RlbHMvQWN0aW9uXCI7XHJcbmltcG9ydCB7IGlDbGFpbSB9IGZyb20gXCIuLi9kYXRhTW9kZWxzL0NsYWltXCI7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnlMb2NhbEJhc2UgfSBmcm9tIFwiLi9SZXBvc2l0b3J5TG9jYWxCYXNlXCI7XHJcbmltcG9ydCB7IEFjdGlvblR5cGVzIH0gZnJvbSBcIi4uL2RhdGFNb2RlbHMvQWN0aW9uVHlwZXNcIjtcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgUmVwb3NpdG9yeUxvY2FsUmVhY3RpdmUgZXh0ZW5kcyBSZXBvc2l0b3J5TG9jYWxCYXNlIGltcGxlbWVudHMgaVJlcG9zaXRvcnkge1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHB1YmxpYyByc0RhdGE6IGlSc0RhdGEgPSBuZXcgUnNEYXRhKClcclxuICAgICkge1xyXG4gICAgICAgIHN1cGVyKHJzRGF0YSk7XHJcbiAgICB9XHJcblxyXG4gICAgbm90aWZ5KGFjdGlvbnM6IGlBY3Rpb25bXSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMucnNEYXRhLmFjdGlvbnNMb2cucHVzaChhY3Rpb25zKTtcclxuICAgICAgICBmb3IgKGNvbnN0IGFjdGlvbiBvZiBhY3Rpb25zKSB7XHJcbiAgICAgICAgICAgIC8vIFwiYWRkX2NsYWltXCIgfFxyXG4gICAgICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT0gXCJhZGRfY2xhaW1cIiB8fFxyXG4gICAgICAgICAgICAgICAgYWN0aW9uLnR5cGUgPT0gXCJtb2RpZnlfY2xhaW1cIikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yc0RhdGEuaXRlbXNbYWN0aW9uLmRhdGFJZF0gPSBhY3Rpb24ubmV3RGF0YVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChhY3Rpb24udHlwZSA9PSBcImRlbGV0ZV9jbGFpbVwiKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJNZXRob2Qgbm90IGltcGxlbWVudGVkLlwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT0gXCJhZGRfY2xhaW1FZGdlXCIgfHxcclxuICAgICAgICAgICAgICAgIGFjdGlvbi50eXBlID09IFwibW9kaWZ5X2NsYWltRWRnZVwiKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJzRGF0YS5pdGVtc1thY3Rpb24uZGF0YUlkXSA9IGFjdGlvbi5uZXdEYXRhXHJcbiAgICAgICAgICAgICAgICBjb25zdCBpdGVtID0gYWN0aW9uLm5ld0RhdGEgYXMgQ2xhaW1FZGdlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbmRleENsYWltRWRnZUlkQnlQYXJlbnRJZChpdGVtKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5kZXhDbGFpbUVkZ2VJZEJ5Q2hpbGRJZChpdGVtKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT0gXCJkZWxldGVfY2xhaW1FZGdlXCIpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCBub3QgaW1wbGVtZW50ZWQuXCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChhY3Rpb24udHlwZSA9PSBcImFkZF9zY29yZVwiIHx8XHJcbiAgICAgICAgICAgICAgICBhY3Rpb24udHlwZSA9PSBcIm1vZGlmeV9zY29yZVwiKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpdGVtID0gYWN0aW9uLm5ld0RhdGEgYXMgU2NvcmU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJzRGF0YS5pdGVtc1thY3Rpb24uZGF0YUlkXSA9IGFjdGlvbi5uZXdEYXRhXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNjb3JlSWRzQnlTb3VyY2VJZChpdGVtKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRJZHNCeVNjb3JlSWQoaXRlbSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGFjdGlvbi50eXBlID09IFwiZGVsZXRlX3Njb3JlXCIpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCBub3QgaW1wbGVtZW50ZWQuXCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaW5kZXhDbGFpbUVkZ2VJZEJ5UGFyZW50SWQoY2xhaW1FZGdlOiBDbGFpbUVkZ2UpIHtcclxuICAgICAgICBsZXQgaW5kZXhJZCA9IGNsYWltRWRnZS5wYXJlbnRJZDtcclxuICAgICAgICBsZXQgaWQgPSBjbGFpbUVkZ2UuaWRcclxuICAgICAgICBsZXQgZGVzdGluYXRpb24gPSB0aGlzLnJzRGF0YS5jbGFpbUVkZ2VJZHNCeVBhcmVudElkW2NsYWltRWRnZS5wYXJlbnRJZF07XHJcbiAgICAgICAgaWYgKCFkZXN0aW5hdGlvbikge1xyXG4gICAgICAgICAgICBkZXN0aW5hdGlvbiA9IFtdO1xyXG4gICAgICAgICAgICB0aGlzLnJzRGF0YS5jbGFpbUVkZ2VJZHNCeVBhcmVudElkW2NsYWltRWRnZS5wYXJlbnRJZF0gPSBkZXN0aW5hdGlvbjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFkZXN0aW5hdGlvbi5pbmNsdWRlcyhjbGFpbUVkZ2UuaWQpKSB7XHJcbiAgICAgICAgICAgIGRlc3RpbmF0aW9uLnB1c2goY2xhaW1FZGdlLmlkKVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGluZGV4Q2xhaW1FZGdlSWRCeUNoaWxkSWQoY2xhaW1FZGdlOiBDbGFpbUVkZ2UpIHtcclxuICAgICAgICBsZXQgaW5kZXhJZCA9IGNsYWltRWRnZS5jaGlsZElkO1xyXG4gICAgICAgIGxldCBpZCA9IGNsYWltRWRnZS5pZDtcclxuICAgICAgICBsZXQgZGVzdGluYXRpb24gPSB0aGlzLnJzRGF0YS5jbGFpbUVkZ2VJZHNCeUNoaWxkSWRbaW5kZXhJZF07XHJcbiAgICAgICAgaWYgKCFkZXN0aW5hdGlvbikge1xyXG4gICAgICAgICAgICBkZXN0aW5hdGlvbiA9IFtdO1xyXG4gICAgICAgICAgICB0aGlzLnJzRGF0YS5jbGFpbUVkZ2VJZHNCeUNoaWxkSWRbaW5kZXhJZF0gPSBkZXN0aW5hdGlvbjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFkZXN0aW5hdGlvbi5pbmNsdWRlcyhpZCkpIHtcclxuICAgICAgICAgICAgZGVzdGluYXRpb24ucHVzaChpZClcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzY29yZUlkc0J5U291cmNlSWQoc2NvcmU6IGlTY29yZSkge1xyXG4gICAgICAgIC8vU291cmNlIENsYWltIElEXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBsZXQgaW5kZXhJZCA9IHNjb3JlLnNvdXJjZUNsYWltSWQ7XHJcbiAgICAgICAgICAgIGxldCBpZCA9IHNjb3JlLmlkO1xyXG4gICAgICAgICAgICBsZXQgZGVzdGluYXRpb24gPSB0aGlzLnJzRGF0YS5zY29yZUlkc0J5U291cmNlSWRbaW5kZXhJZF07XHJcbiAgICAgICAgICAgIGlmICghZGVzdGluYXRpb24pIHtcclxuICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uID0gW107XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJzRGF0YS5zY29yZUlkc0J5U291cmNlSWRbaW5kZXhJZF0gPSBkZXN0aW5hdGlvbjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIWRlc3RpbmF0aW9uLmluY2x1ZGVzKGlkKSkge1xyXG4gICAgICAgICAgICAgICAgZGVzdGluYXRpb24ucHVzaChpZClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy9Tb3VyY2UgRWRnZSBJRFxyXG4gICAgICAgIGlmIChzY29yZS5zb3VyY2VFZGdlSWQpe1xyXG4gICAgICAgICAgICBsZXQgaW5kZXhJZCA9IHNjb3JlLnNvdXJjZUVkZ2VJZDtcclxuICAgICAgICAgICAgbGV0IGlkID0gc2NvcmUuaWQ7XHJcbiAgICAgICAgICAgIGxldCBkZXN0aW5hdGlvbiA9IHRoaXMucnNEYXRhLnNjb3JlSWRzQnlTb3VyY2VJZFtpbmRleElkXTtcclxuICAgICAgICAgICAgaWYgKCFkZXN0aW5hdGlvbikge1xyXG4gICAgICAgICAgICAgICAgZGVzdGluYXRpb24gPSBbXTtcclxuICAgICAgICAgICAgICAgIHRoaXMucnNEYXRhLnNjb3JlSWRzQnlTb3VyY2VJZFtpbmRleElkXSA9IGRlc3RpbmF0aW9uO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICghZGVzdGluYXRpb24uaW5jbHVkZXMoaWQpKSB7XHJcbiAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbi5wdXNoKGlkKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vVE9ETzogbm90IHN1cmUgaWYgdGhpcyBpcyBjb3JyZWN0XHJcbiAgICBwcml2YXRlIGNoaWxkSWRzQnlTY29yZUlkKHNjb3JlOiBpU2NvcmUpIHtcclxuICAgICAgICBsZXQgaW5kZXhJZCA9IHNjb3JlLnBhcmVudFNjb3JlSWQ7XHJcbiAgICAgICAgbGV0IGlkID0gc2NvcmUuaWQ7XHJcbiAgICAgICAgaWYgKGluZGV4SWQpIHtcclxuICAgICAgICAgICAgbGV0IGRlc3RpbmF0aW9uID0gdGhpcy5yc0RhdGEuY2hpbGRJZHNCeVNjb3JlSWRbaW5kZXhJZF07XHJcbiAgICAgICAgICAgIGlmICghZGVzdGluYXRpb24pIHtcclxuICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uID0gW107XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJzRGF0YS5jaGlsZElkc0J5U2NvcmVJZFtpbmRleElkXSA9IGRlc3RpbmF0aW9uO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICghZGVzdGluYXRpb24uaW5jbHVkZXMoaWQpKSB7XHJcbiAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbi5wdXNoKGlkKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxufSJdfQ==
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.calculateScoreActions = calculateScoreActions;

var _Score = require("./dataModels/Score");

var _Action = require("./dataModels/Action");

var _calculateScore = require("./calculateScore");

var _RepositoryLocalReactive = require("./repositories/RepositoryLocalReactive");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Calculates the score actions based on a list of actions
 */
async function calculateScoreActions({
  actions = [],
  repository = new _RepositoryLocalReactive.RepositoryLocalReactive(),
  calculator = _calculateScore.calculateScore
} = {}) {
  const scoreActions = [];
  const claimIdsToScore = [];
  const topScoreIds = [];
  await repository.notify(actions);

  for (const action of actions) {
    // find claims that may need scores changed
    if (action.type == 'add_claim' || action.type == 'modify_claim') {
      claimIdsToScore.push(action.dataId);
    }

    if (action.type == "add_score") {
      const score = action.newData;
      claimIdsToScore.push(score.sourceClaimId);
    } //Add scores if edges adds new children to claims in score trees


    if (action.type == 'add_claimEdge' || action.type == 'modify_claimEdge') {
      const claimEdge = action.newData;
      claimIdsToScore.push(claimEdge.parentId);
    } //TODO: If an edge changes then modify the existing scores to match


    if (action.type == 'modify_claimEdge') {
      const claimEdge = action.newData;
      const scores = await repository.getScoresBySourceId(claimEdge.id);

      for (const score of scores) {
        //TODO: Where should I put this? It is modifying am object. If it is reactive i should just change the data. If pure it should be a new object.
        //For now I will modify it but it may not trigger updates in a pure library (React)
        //This change should also probably be centralized somewhere to reduce the chance of inconsistent bugs. I think it will happen in multiple paces
        //Nope, it is an action so it should always be a new object. If it goes into a reactive respoitory then it will modify the actual object
        //Should I group these actions or just throw them in one at a time like I am doing
        await repository.notify([new _Action.Action({
          pro: claimEdge.pro,
          affects: claimEdge.affects
        }, score, "modify_score", score.id)]);
      }
    }
  } //Walk up the scores for each claim to the top


  for (const claimId of claimIdsToScore) {
    const scoresForTheClaim = await repository.getScoresBySourceId(claimId);

    for (const claimScore of scoresForTheClaim) {
      // for each score, walk up the tree looking for the top (the first score to not have a parentId)
      let currentScore = claimScore;
      let topScoreId = claimScore.id;

      do {
        var _currentScore;

        if (currentScore.parentScoreId) {
          currentScore = await repository.getScore(currentScore.parentScoreId);
        }

        if (currentScore) {
          topScoreId = currentScore.id;
        }
      } while ((_currentScore = currentScore) === null || _currentScore === void 0 ? void 0 : _currentScore.parentScoreId);

      if (topScoreId && topScoreIds.indexOf(topScoreId) == -1) {
        topScoreIds.push(topScoreId);
      }
    }
  } //Re-calc all top scores with possible changed claims


  for (const topScoreId of topScoreIds) {
    const topScore = await repository.getScore(topScoreId);

    if (topScore) {
      const tempMissingScoreActions = [];
      await createBlankMissingScores(repository, topScoreId, topScore.sourceClaimId || "", tempMissingScoreActions, topScoreId);

      if (tempMissingScoreActions.length > 0) {
        await repository.notify(tempMissingScoreActions);
      }

      const tempcalculateScoreTreeActions = [];
      await calculateScoreTree(repository, topScore, calculator, tempMissingScoreActions);
      scoreActions.push(...tempMissingScoreActions, ...tempcalculateScoreTreeActions);
    }
  }

  return scoreActions;
} //Create Blank Missing Scores


async function createBlankMissingScores(repository, currentScoreId, currentClaimId, actions, topScoreId) {
  const edges = await repository.getClaimEdgesByParentId(currentClaimId);
  const scores = await repository.getChildrenByScoreId(currentScoreId);

  for (const edge of edges) {
    //see if there is a matching child score for the child edge
    let score = scores.find(({
      sourceClaimId
    }) => sourceClaimId === edge.childId);

    if (!score) {
      //Create a new Score and attach it to it's parent
      score = new _Score.Score(edge.childId, topScoreId, currentScoreId, edge.id, undefined, edge.pro, edge.affects);
      actions.push(new _Action.Action(score, undefined, "add_score", score.id));
    } //Recurse and through children


    await createBlankMissingScores(repository, score.id, edge.childId, actions, topScoreId);
  }
} //This function assume that all scores already exist


async function calculateScoreTree(repository, currentScore, calculator = _calculateScore.calculateScore, actions) {
  const oldScores = await repository.getChildrenByScoreId(currentScore.id);
  const newScores = [];

  for (const oldScore of oldScores) {
    //Calculate Children
    //TODO: remove any scores to calculate based on formulas that exclude scores
    newScores.push((await calculateScoreTree(repository, oldScore, calculator, actions)));
  }

  const newScoreFragment = calculator({
    childScores: newScores,
    reversible: currentScore.reversible
  }); //TODO: Modify the newScore based on any formulas

  const newScore = _objectSpread({}, currentScore, {}, newScoreFragment);

  if ((0, _Score.differentScores)(currentScore, newScore)) {
    actions.push(new _Action.Action(newScore, undefined, "modify_score", newScore.id));
  }

  return newScore;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWxjdWxhdGVTY29yZUFjdGlvbnMudHMiXSwibmFtZXMiOlsiY2FsY3VsYXRlU2NvcmVBY3Rpb25zIiwiYWN0aW9ucyIsInJlcG9zaXRvcnkiLCJSZXBvc2l0b3J5TG9jYWxSZWFjdGl2ZSIsImNhbGN1bGF0b3IiLCJjYWxjdWxhdGVTY29yZSIsInNjb3JlQWN0aW9ucyIsImNsYWltSWRzVG9TY29yZSIsInRvcFNjb3JlSWRzIiwibm90aWZ5IiwiYWN0aW9uIiwidHlwZSIsInB1c2giLCJkYXRhSWQiLCJzY29yZSIsIm5ld0RhdGEiLCJzb3VyY2VDbGFpbUlkIiwiY2xhaW1FZGdlIiwicGFyZW50SWQiLCJzY29yZXMiLCJnZXRTY29yZXNCeVNvdXJjZUlkIiwiaWQiLCJBY3Rpb24iLCJwcm8iLCJhZmZlY3RzIiwiY2xhaW1JZCIsInNjb3Jlc0ZvclRoZUNsYWltIiwiY2xhaW1TY29yZSIsImN1cnJlbnRTY29yZSIsInRvcFNjb3JlSWQiLCJwYXJlbnRTY29yZUlkIiwiZ2V0U2NvcmUiLCJpbmRleE9mIiwidG9wU2NvcmUiLCJ0ZW1wTWlzc2luZ1Njb3JlQWN0aW9ucyIsImNyZWF0ZUJsYW5rTWlzc2luZ1Njb3JlcyIsImxlbmd0aCIsInRlbXBjYWxjdWxhdGVTY29yZVRyZWVBY3Rpb25zIiwiY2FsY3VsYXRlU2NvcmVUcmVlIiwiY3VycmVudFNjb3JlSWQiLCJjdXJyZW50Q2xhaW1JZCIsImVkZ2VzIiwiZ2V0Q2xhaW1FZGdlc0J5UGFyZW50SWQiLCJnZXRDaGlsZHJlbkJ5U2NvcmVJZCIsImVkZ2UiLCJmaW5kIiwiY2hpbGRJZCIsIlNjb3JlIiwidW5kZWZpbmVkIiwib2xkU2NvcmVzIiwibmV3U2NvcmVzIiwib2xkU2NvcmUiLCJuZXdTY29yZUZyYWdtZW50IiwiY2hpbGRTY29yZXMiLCJyZXZlcnNpYmxlIiwibmV3U2NvcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFLQTs7Ozs7Ozs7QUFFQTs7O0FBR08s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ZSxNQUFNMEIsa0JBQWtCLENBQUNwQyxVQUFELEVBQWFpRCxRQUFiLEVBQXVCL0MsVUFBdkIsRUFBbUNILE9BQW5DLENBQXZDO0FBQ0g7O0FBRUQsUUFBTW1ELGdCQUFnQixHQUFHaEQsVUFBVSxDQUFDO0FBQ2hDaUQsSUFBQUEsV0FBVyxFQUFFSCxTQURtQjtBQUVoQ0ksSUFBQUEsVUFBVSxFQUFFMUIsWUFBWSxDQUFDMEI7QUFGTyxHQUFELENBQW5DLENBVDhJLENBYzlJOztBQUNBLFFBQU1DLFFBQVEscUJBQVEzQixZQUFSLE1BQXlCd0IsZ0JBQXpCLENBQWQ7O0FBQ0EsTUFBSSw0QkFBZ0J4QixZQUFoQixFQUE4QjJCLFFBQTlCLENBQUosRUFBNkM7QUFDekN0RCxJQUFBQSxPQUFPLENBQUNXLElBQVIsQ0FBYSxJQUFJVSxjQUFKLENBQVdpQyxRQUFYLEVBQXFCUCxTQUFyQixFQUFnQyxjQUFoQyxFQUFnRE8sUUFBUSxDQUFDbEMsRUFBekQsQ0FBYjtBQUNIOztBQUNELFNBQU9rQyxRQUFQO0FBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTY29yZSwgZGlmZmVyZW50U2NvcmVzLCBpU2NvcmUgfSBmcm9tIFwiLi9kYXRhTW9kZWxzL1Njb3JlXCI7XHJcbmltcG9ydCB7IEFjdGlvbiB9IGZyb20gXCIuL2RhdGFNb2RlbHMvQWN0aW9uXCI7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnlMb2NhbFB1cmUgfSBmcm9tIFwiLi9yZXBvc2l0b3JpZXMvUmVwb3NpdG9yeUxvY2FsUHVyZVwiO1xyXG5pbXBvcnQgeyBpQ2FsY3VsYXRlU2NvcmUsIGNhbGN1bGF0ZVNjb3JlIH0gZnJvbSBcIi4vY2FsY3VsYXRlU2NvcmVcIjtcclxuaW1wb3J0IHsgQ2xhaW0gfSBmcm9tIFwiLi9kYXRhTW9kZWxzL0NsYWltXCI7XHJcbmltcG9ydCB7IGlSZXBvc2l0b3J5IH0gZnJvbSBcIi4vZGF0YU1vZGVscy9pUmVwb3NpdG9yeVwiO1xyXG5pbXBvcnQgeyBDbGFpbUVkZ2UgfSBmcm9tIFwiLi9kYXRhTW9kZWxzL0NsYWltRWRnZVwiO1xyXG5pbXBvcnQgeyBuZXdJZCB9IGZyb20gXCIuL25ld0lkXCI7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnlMb2NhbFJlYWN0aXZlIH0gZnJvbSBcIi4vcmVwb3NpdG9yaWVzL1JlcG9zaXRvcnlMb2NhbFJlYWN0aXZlXCI7XHJcblxyXG4vKipcclxuICogQ2FsY3VsYXRlcyB0aGUgc2NvcmUgYWN0aW9ucyBiYXNlZCBvbiBhIGxpc3Qgb2YgYWN0aW9uc1xyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNhbGN1bGF0ZVNjb3JlQWN0aW9ucyh7IGFjdGlvbnMgPSBbXSwgcmVwb3NpdG9yeSA9IG5ldyBSZXBvc2l0b3J5TG9jYWxSZWFjdGl2ZSgpLCBjYWxjdWxhdG9yID0gY2FsY3VsYXRlU2NvcmUgfToge1xyXG4gICAgLyoqIEFuIGFycmF5IG9mIGFjdGlvbnMsIHVzdWFsbHkgb24gY2xhaW1zIG9yIGVkZ2VzIHRoYXQgaW5jbHVzZSBubyBzY29yZXMqL1xyXG4gICAgYWN0aW9ucz86IEFjdGlvbltdO1xyXG4gICAgLyoqIFRoZSByZXBvc2l0b3J5IHVzZWQgdG8gZ2V0IGNvbnRleHQgZm9yIHRoZSBhY3Rpb25zICovXHJcbiAgICByZXBvc2l0b3J5PzogaVJlcG9zaXRvcnk7XHJcbiAgICAvKiogVGhlIGZ1bmN0aW9uIHVzZWQgdG8gY2FsY3VsYXRlIHRoZSBzY29yZXMgKi9cclxuICAgIGNhbGN1bGF0b3I/OiBpQ2FsY3VsYXRlU2NvcmU7XHJcbn0gPSB7fSxcclxuKSB7XHJcbiAgICBjb25zdCBzY29yZUFjdGlvbnM6IEFjdGlvbltdID0gW107XHJcbiAgICBjb25zdCBjbGFpbUlkc1RvU2NvcmU6IHN0cmluZ1tdID0gW107XHJcbiAgICBjb25zdCB0b3BTY29yZUlkczogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICBhd2FpdCByZXBvc2l0b3J5Lm5vdGlmeShhY3Rpb25zKTtcclxuICAgIGZvciAoY29uc3QgYWN0aW9uIG9mIGFjdGlvbnMpIHtcclxuXHJcbiAgICAgICAgLy8gZmluZCBjbGFpbXMgdGhhdCBtYXkgbmVlZCBzY29yZXMgY2hhbmdlZFxyXG4gICAgICAgIGlmIChhY3Rpb24udHlwZSA9PSAnYWRkX2NsYWltJyB8fCBhY3Rpb24udHlwZSA9PSAnbW9kaWZ5X2NsYWltJykge1xyXG4gICAgICAgICAgICBjbGFpbUlkc1RvU2NvcmUucHVzaChhY3Rpb24uZGF0YUlkKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGFjdGlvbi50eXBlID09IFwiYWRkX3Njb3JlXCIpIHtcclxuICAgICAgICAgICAgY29uc3Qgc2NvcmUgPSBhY3Rpb24ubmV3RGF0YSBhcyBTY29yZTtcclxuICAgICAgICAgICAgY2xhaW1JZHNUb1Njb3JlLnB1c2goc2NvcmUuc291cmNlQ2xhaW1JZClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vQWRkIHNjb3JlcyBpZiBlZGdlcyBhZGRzIG5ldyBjaGlsZHJlbiB0byBjbGFpbXMgaW4gc2NvcmUgdHJlZXNcclxuICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT0gJ2FkZF9jbGFpbUVkZ2UnIHx8IGFjdGlvbi50eXBlID09ICdtb2RpZnlfY2xhaW1FZGdlJykge1xyXG4gICAgICAgICAgICBjb25zdCBjbGFpbUVkZ2UgPSBhY3Rpb24ubmV3RGF0YSBhcyBDbGFpbUVkZ2U7XHJcbiAgICAgICAgICAgIGNsYWltSWRzVG9TY29yZS5wdXNoKGNsYWltRWRnZS5wYXJlbnRJZClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vVE9ETzogSWYgYW4gZWRnZSBjaGFuZ2VzIHRoZW4gbW9kaWZ5IHRoZSBleGlzdGluZyBzY29yZXMgdG8gbWF0Y2hcclxuICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT0gJ21vZGlmeV9jbGFpbUVkZ2UnKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNsYWltRWRnZSA9IGFjdGlvbi5uZXdEYXRhIGFzIENsYWltRWRnZTtcclxuICAgICAgICAgICAgY29uc3Qgc2NvcmVzID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRTY29yZXNCeVNvdXJjZUlkKGNsYWltRWRnZS5pZClcclxuICAgICAgICAgICAgZm9yIChjb25zdCBzY29yZSBvZiBzY29yZXMpIHtcclxuICAgICAgICAgICAgICAgIC8vVE9ETzogV2hlcmUgc2hvdWxkIEkgcHV0IHRoaXM/IEl0IGlzIG1vZGlmeWluZyBhbSBvYmplY3QuIElmIGl0IGlzIHJlYWN0aXZlIGkgc2hvdWxkIGp1c3QgY2hhbmdlIHRoZSBkYXRhLiBJZiBwdXJlIGl0IHNob3VsZCBiZSBhIG5ldyBvYmplY3QuXHJcbiAgICAgICAgICAgICAgICAvL0ZvciBub3cgSSB3aWxsIG1vZGlmeSBpdCBidXQgaXQgbWF5IG5vdCB0cmlnZ2VyIHVwZGF0ZXMgaW4gYSBwdXJlIGxpYnJhcnkgKFJlYWN0KVxyXG4gICAgICAgICAgICAgICAgLy9UaGlzIGNoYW5nZSBzaG91bGQgYWxzbyBwcm9iYWJseSBiZSBjZW50cmFsaXplZCBzb21ld2hlcmUgdG8gcmVkdWNlIHRoZSBjaGFuY2Ugb2YgaW5jb25zaXN0ZW50IGJ1Z3MuIEkgdGhpbmsgaXQgd2lsbCBoYXBwZW4gaW4gbXVsdGlwbGUgcGFjZXNcclxuICAgICAgICAgICAgICAgIC8vTm9wZSwgaXQgaXMgYW4gYWN0aW9uIHNvIGl0IHNob3VsZCBhbHdheXMgYmUgYSBuZXcgb2JqZWN0LiBJZiBpdCBnb2VzIGludG8gYSByZWFjdGl2ZSByZXNwb2l0b3J5IHRoZW4gaXQgd2lsbCBtb2RpZnkgdGhlIGFjdHVhbCBvYmplY3RcclxuICAgICAgICAgICAgICAgIC8vU2hvdWxkIEkgZ3JvdXAgdGhlc2UgYWN0aW9ucyBvciBqdXN0IHRocm93IHRoZW0gaW4gb25lIGF0IGEgdGltZSBsaWtlIEkgYW0gZG9pbmdcclxuXHJcbiAgICAgICAgICAgICAgICBhd2FpdCByZXBvc2l0b3J5Lm5vdGlmeShbbmV3IEFjdGlvbih7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJvOiBjbGFpbUVkZ2UucHJvLFxyXG4gICAgICAgICAgICAgICAgICAgIGFmZmVjdHM6IGNsYWltRWRnZS5hZmZlY3RzLFxyXG4gICAgICAgICAgICAgICAgfSwgc2NvcmUsIFwibW9kaWZ5X3Njb3JlXCIsIHNjb3JlLmlkKV0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy9XYWxrIHVwIHRoZSBzY29yZXMgZm9yIGVhY2ggY2xhaW0gdG8gdGhlIHRvcFxyXG4gICAgZm9yIChjb25zdCBjbGFpbUlkIG9mIGNsYWltSWRzVG9TY29yZSkge1xyXG4gICAgICAgIGNvbnN0IHNjb3Jlc0ZvclRoZUNsYWltID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRTY29yZXNCeVNvdXJjZUlkKGNsYWltSWQpXHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgY2xhaW1TY29yZSBvZiBzY29yZXNGb3JUaGVDbGFpbSkge1xyXG4gICAgICAgICAgICAvLyBmb3IgZWFjaCBzY29yZSwgd2FsayB1cCB0aGUgdHJlZSBsb29raW5nIGZvciB0aGUgdG9wICh0aGUgZmlyc3Qgc2NvcmUgdG8gbm90IGhhdmUgYSBwYXJlbnRJZClcclxuICAgICAgICAgICAgbGV0IGN1cnJlbnRTY29yZTogaVNjb3JlIHwgdW5kZWZpbmVkID0gY2xhaW1TY29yZTtcclxuICAgICAgICAgICAgbGV0IHRvcFNjb3JlSWQgPSBjbGFpbVNjb3JlLmlkO1xyXG4gICAgICAgICAgICBkbyB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFNjb3JlLnBhcmVudFNjb3JlSWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50U2NvcmUgPSBhd2FpdCByZXBvc2l0b3J5LmdldFNjb3JlKGN1cnJlbnRTY29yZS5wYXJlbnRTY29yZUlkKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChjdXJyZW50U2NvcmUpIHtcclxuICAgICAgICAgICAgICAgICAgICB0b3BTY29yZUlkID0gY3VycmVudFNjb3JlLmlkO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IHdoaWxlIChjdXJyZW50U2NvcmU/LnBhcmVudFNjb3JlSWQpXHJcblxyXG4gICAgICAgICAgICBpZiAodG9wU2NvcmVJZCAmJiB0b3BTY29yZUlkcy5pbmRleE9mKHRvcFNjb3JlSWQpID09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICB0b3BTY29yZUlkcy5wdXNoKHRvcFNjb3JlSWQpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy9SZS1jYWxjIGFsbCB0b3Agc2NvcmVzIHdpdGggcG9zc2libGUgY2hhbmdlZCBjbGFpbXNcclxuICAgIGZvciAoY29uc3QgdG9wU2NvcmVJZCBvZiB0b3BTY29yZUlkcykge1xyXG4gICAgICAgIGNvbnN0IHRvcFNjb3JlID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRTY29yZSh0b3BTY29yZUlkKVxyXG4gICAgICAgIGlmICh0b3BTY29yZSkge1xyXG4gICAgICAgICAgICBjb25zdCB0ZW1wTWlzc2luZ1Njb3JlQWN0aW9uczogQWN0aW9uW10gPSBbXTtcclxuICAgICAgICAgICAgYXdhaXQgY3JlYXRlQmxhbmtNaXNzaW5nU2NvcmVzKHJlcG9zaXRvcnksIHRvcFNjb3JlSWQsIHRvcFNjb3JlLnNvdXJjZUNsYWltSWQgfHwgXCJcIiwgdGVtcE1pc3NpbmdTY29yZUFjdGlvbnMsIHRvcFNjb3JlSWQpXHJcbiAgICAgICAgICAgIGlmICh0ZW1wTWlzc2luZ1Njb3JlQWN0aW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCByZXBvc2l0b3J5Lm5vdGlmeSh0ZW1wTWlzc2luZ1Njb3JlQWN0aW9ucylcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCB0ZW1wY2FsY3VsYXRlU2NvcmVUcmVlQWN0aW9uczogQWN0aW9uW10gPSBbXTtcclxuICAgICAgICAgICAgYXdhaXQgY2FsY3VsYXRlU2NvcmVUcmVlKHJlcG9zaXRvcnksIHRvcFNjb3JlLCBjYWxjdWxhdG9yLCB0ZW1wTWlzc2luZ1Njb3JlQWN0aW9ucyk7XHJcbiAgICAgICAgICAgIHNjb3JlQWN0aW9ucy5wdXNoKC4uLnRlbXBNaXNzaW5nU2NvcmVBY3Rpb25zLCAuLi50ZW1wY2FsY3VsYXRlU2NvcmVUcmVlQWN0aW9ucylcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHNjb3JlQWN0aW9ucztcclxufVxyXG5cclxuLy9DcmVhdGUgQmxhbmsgTWlzc2luZyBTY29yZXNcclxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlQmxhbmtNaXNzaW5nU2NvcmVzKHJlcG9zaXRvcnk6IGlSZXBvc2l0b3J5LCBjdXJyZW50U2NvcmVJZDogc3RyaW5nLCBjdXJyZW50Q2xhaW1JZDogc3RyaW5nLCBhY3Rpb25zOiBBY3Rpb25bXSwgdG9wU2NvcmVJZDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBlZGdlcyA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0Q2xhaW1FZGdlc0J5UGFyZW50SWQoY3VycmVudENsYWltSWQpXHJcbiAgICBjb25zdCBzY29yZXMgPSBhd2FpdCByZXBvc2l0b3J5LmdldENoaWxkcmVuQnlTY29yZUlkKGN1cnJlbnRTY29yZUlkKVxyXG4gICAgZm9yIChjb25zdCBlZGdlIG9mIGVkZ2VzKSB7XHJcbiAgICAgICAgLy9zZWUgaWYgdGhlcmUgaXMgYSBtYXRjaGluZyBjaGlsZCBzY29yZSBmb3IgdGhlIGNoaWxkIGVkZ2VcclxuICAgICAgICBsZXQgc2NvcmUgPSBzY29yZXMuZmluZCgoeyBzb3VyY2VDbGFpbUlkIH0pID0+IHNvdXJjZUNsYWltSWQgPT09IGVkZ2UuY2hpbGRJZCk7XHJcbiAgICAgICAgaWYgKCFzY29yZSkge1xyXG4gICAgICAgICAgICAvL0NyZWF0ZSBhIG5ldyBTY29yZSBhbmQgYXR0YWNoIGl0IHRvIGl0J3MgcGFyZW50XHJcbiAgICAgICAgICAgIHNjb3JlID0gbmV3IFNjb3JlKGVkZ2UuY2hpbGRJZCwgdG9wU2NvcmVJZCwgY3VycmVudFNjb3JlSWQsIGVkZ2UuaWQsIHVuZGVmaW5lZCwgZWRnZS5wcm8sIGVkZ2UuYWZmZWN0cyk7XHJcbiAgICAgICAgICAgIGFjdGlvbnMucHVzaChuZXcgQWN0aW9uKHNjb3JlLCB1bmRlZmluZWQsIFwiYWRkX3Njb3JlXCIsIHNjb3JlLmlkKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vUmVjdXJzZSBhbmQgdGhyb3VnaCBjaGlsZHJlblxyXG4gICAgICAgIGF3YWl0IGNyZWF0ZUJsYW5rTWlzc2luZ1Njb3JlcyhyZXBvc2l0b3J5LCBzY29yZS5pZCwgZWRnZS5jaGlsZElkLCBhY3Rpb25zLCB0b3BTY29yZUlkKTtcclxuICAgIH1cclxufVxyXG5cclxuLy9UaGlzIGZ1bmN0aW9uIGFzc3VtZSB0aGF0IGFsbCBzY29yZXMgYWxyZWFkeSBleGlzdFxyXG5hc3luYyBmdW5jdGlvbiBjYWxjdWxhdGVTY29yZVRyZWUocmVwb3NpdG9yeTogaVJlcG9zaXRvcnksIGN1cnJlbnRTY29yZTogaVNjb3JlLCBjYWxjdWxhdG9yOiBpQ2FsY3VsYXRlU2NvcmUgPSBjYWxjdWxhdGVTY29yZSwgYWN0aW9uczogQWN0aW9uW10pIHtcclxuICAgIGNvbnN0IG9sZFNjb3JlcyA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0Q2hpbGRyZW5CeVNjb3JlSWQoY3VycmVudFNjb3JlLmlkKVxyXG4gICAgY29uc3QgbmV3U2NvcmVzOiBpU2NvcmVbXSA9IFtdO1xyXG5cclxuICAgIGZvciAoY29uc3Qgb2xkU2NvcmUgb2Ygb2xkU2NvcmVzKSB7IC8vQ2FsY3VsYXRlIENoaWxkcmVuXHJcbiAgICAgICAgLy9UT0RPOiByZW1vdmUgYW55IHNjb3JlcyB0byBjYWxjdWxhdGUgYmFzZWQgb24gZm9ybXVsYXMgdGhhdCBleGNsdWRlIHNjb3Jlc1xyXG4gICAgICAgIG5ld1Njb3Jlcy5wdXNoKGF3YWl0IGNhbGN1bGF0ZVNjb3JlVHJlZShyZXBvc2l0b3J5LCBvbGRTY29yZSwgY2FsY3VsYXRvciwgYWN0aW9ucykpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG5ld1Njb3JlRnJhZ21lbnQgPSBjYWxjdWxhdG9yKHtcclxuICAgICAgICBjaGlsZFNjb3JlczogbmV3U2NvcmVzLFxyXG4gICAgICAgIHJldmVyc2libGU6IGN1cnJlbnRTY29yZS5yZXZlcnNpYmxlLFxyXG4gICAgfSlcclxuXHJcbiAgICAvL1RPRE86IE1vZGlmeSB0aGUgbmV3U2NvcmUgYmFzZWQgb24gYW55IGZvcm11bGFzXHJcbiAgICBjb25zdCBuZXdTY29yZSA9IHsgLi4uY3VycmVudFNjb3JlLCAuLi5uZXdTY29yZUZyYWdtZW50IH1cclxuICAgIGlmIChkaWZmZXJlbnRTY29yZXMoY3VycmVudFNjb3JlLCBuZXdTY29yZSkpIHtcclxuICAgICAgICBhY3Rpb25zLnB1c2gobmV3IEFjdGlvbihuZXdTY29yZSwgdW5kZWZpbmVkLCBcIm1vZGlmeV9zY29yZVwiLCBuZXdTY29yZS5pZCkpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG5ld1Njb3JlO1xyXG59XHJcbiJdfQ==
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.calculateScoreActions = calculateScoreActions;

var _Score = require("./dataModels/Score");

var _hasItemChanged = require("./utils/hasItemChanged");

var _Action = require("./dataModels/Action");

var _calculateScore = require("./calculateScore");

var _RepositoryLocalPure = require("./repositories/RepositoryLocalPure");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Calculates the score actions based on a list of actions
 */
async function calculateScoreActions({
  actions = [],
  repository = new _RepositoryLocalPure.RepositoryLocalPure(),
  calculator = _calculateScore.calculateScore
} = {}) {
  const scoreActions = [];
  const claimIdsToScore = [];
  const ScoreTreeIds = [];
  await repository.notify(actions);

  for (const action of actions) {
    // find claims that may need scores changed
    if (action.type == 'add_claim' || action.type == 'modify_claim') {
      claimIdsToScore.push(action.dataId);
    }

    if (action.type == "add_score") {
      let score = action.newData;

      if (!score.parentScoreId) {
        const scoreTemp = await repository.getScore(action.dataId);

        if (scoreTemp) {
          score = scoreTemp;
        }
      }

      claimIdsToScore.push(score.sourceClaimId);
    } //Add scores if edges adds new children to claims in score trees


    if (action.type == 'add_claimEdge' || action.type == 'modify_claimEdge') {
      let claimEdge = action.newData;

      if (!claimEdge.parentId) {
        const claimEdgeTemp = await repository.getClaimEdge(action.dataId);

        if (claimEdgeTemp) {
          claimEdge = claimEdgeTemp;
        }
      }

      claimIdsToScore.push(claimEdge.parentId);
    } //TODO: If an edge changes then modify the existing scores to match


    if (action.type == 'modify_claimEdge') {
      let claimEdge = await repository.getClaimEdge(action.dataId);
      claimEdge = _objectSpread(_objectSpread({}, claimEdge), action.newData);

      if (claimEdge) {
        action.newData;
        const scores = await repository.getScoresBySourceId(claimEdge.id);

        for (const score of scores) {
          //TODO: Where should I put this? It is modifying am object. If it is reactive i should just change the data. If pure it should be a new object.
          //For now I will modify it but it may not trigger updates in a pure library (React)
          //This change should also probably be centralized somewhere to reduce the chance of inconsistent bugs. I think it will happen in multiple paces
          //Nope, it is an action so it should always be a new object. If it goes into a reactive respoitory then it will modify the actual object
          //Should I group these actions or just throw them in one at a time like I am doing
          if (score.pro != claimEdge.pro || score.affects != claimEdge.affects) {
            const action = new _Action.Action({
              pro: claimEdge.pro,
              affects: claimEdge.affects,
              priority: claimEdge.priority
            }, score, "modify_score", score.id);
            scoreActions.push(action);
            await repository.notify([action]);
          }
        }
      }
    }

    if (action.type == 'delete_claimEdge') {
      const oldClaimEdge = action.oldData;
      claimIdsToScore.push(oldClaimEdge.parentId);
    }

    if (action.type == 'add_scoreTree') {
      const scoreTree = action.newData;
      ScoreTreeIds.push(scoreTree.id);
    }
  } //Walk up the scores for each claim to the top


  for (const claimId of claimIdsToScore) {
    for (const claimScore of await repository.getScoresBySourceId(claimId)) {
      ScoreTreeIds.push(claimScore.scoreTreeId);
    }
  } //Re-calc all Score Trees with possible changed claims


  for (const scoreTreeId of ScoreTreeIds) {
    const scoreTree = await repository.getScoreTree(scoreTreeId);

    if (scoreTree) {
      const missingScoreActions = [];
      let mainScore = await repository.getScore(scoreTree.topScoreId);

      if (!mainScore) {
        mainScore = new _Score.Score(scoreTree.sourceClaimId, scoreTree.id);
        mainScore.id = scoreTree.topScoreId;
        missingScoreActions.push(new _Action.Action(mainScore, undefined, "add_score"));
      }

      await createBlankMissingScores(repository, scoreTree.topScoreId, scoreTree.sourceClaimId || "", missingScoreActions, scoreTreeId);

      if (missingScoreActions.length > 0) {
        await repository.notify(missingScoreActions);
      }

      const scoreTreeActions = [];
      const newMainScore = await calculateScoreDescendants(repository, mainScore, calculator, scoreTreeActions);

      if (missingScoreActions.length > 0) {
        await repository.notify(scoreTreeActions);
      }

      const fractionActions = [];
      await calculateFractions(repository, mainScore, fractionActions);

      if (fractionActions.length > 0) {
        await repository.notify(fractionActions);
      }

      const generationActions = [];
      await calculateGenerations(repository, mainScore.id, generationActions, 0);

      if (generationActions.length > 0) {
        await repository.notify(generationActions);
      }

      scoreActions.push(...missingScoreActions, ...scoreTreeActions, ...fractionActions, ...generationActions);

      if (scoreTree.descendantCount != newMainScore.descendantCount) {
        let newScoreTreePartial = {
          descendantCount: newMainScore.descendantCount
        };
        let oldScoreTreePartial = {
          descendantCount: scoreTree.descendantCount
        };
        scoreActions.push(new _Action.Action(newScoreTreePartial, oldScoreTreePartial, "modify_scoreTree", scoreTree.id));
      }
    }
  } //TODO: Review this decision: Feed the score actions back into the repository so this repository is up to date in case it is used 


  await repository.notify(scoreActions);
  return scoreActions;
} //Create Blank Missing Scores


async function createBlankMissingScores(repository, currentScoreId, currentClaimId, actions, scoreTreeId) {
  const edges = await repository.getClaimEdgesByParentId(currentClaimId);
  const scores = await repository.getChildrenByScoreId(currentScoreId);

  for (const edge of edges) {
    //see if there is a matching child score for the child edge
    let score = scores.find(({
      sourceClaimId
    }) => sourceClaimId === edge.childId);

    if (!score) {
      //Create a new Score and attach it to it's parent
      const u = undefined;
      score = new _Score.Score(edge.childId, scoreTreeId, currentScoreId, edge.id, undefined, edge.pro, edge.affects, u, u, u, edge.priority);
      actions.push(new _Action.Action(score, undefined, "add_score", score.id));
    } //Recurse and through children


    await createBlankMissingScores(repository, score.id, edge.childId, actions, scoreTreeId);
  }
} //This function assume that all scores already exist


async function calculateScoreDescendants(repository, currentScore, calculator = _calculateScore.calculateScore, actions) {
  const oldChildScores = await repository.getChildrenByScoreId(currentScore.id);
  const newChildScores = [];
  let newDescendantCount = 0;

  for (const oldChildScore of oldChildScores) {
    //Calculate Children
    //TODO: remove any scores to calculate based on formulas that exclude scores
    const newScore = await calculateScoreDescendants(repository, oldChildScore, calculator, actions);
    newChildScores.push(newScore);
    newDescendantCount += newScore.descendantCount + 1;
  }

  const newScoreFragment = calculator({
    childScores: newChildScores
  }); //update any newChildScores that changed

  for (const newChildScore of newChildScores) {
    // TODO: Is this slow accessing the data store again for this data or do we assume it is cached if it is in an external DB
    const oldChildScore = await repository.getScore(newChildScore.id);

    if (oldChildScore && (0, _hasItemChanged.hasItemChanged)(oldChildScore, newChildScore)) {
      actions.push(new _Action.Action(newChildScore, undefined, "modify_score"));
    }
  } //TODO: Modify the newScore based on any formulas


  const newScore = _objectSpread(_objectSpread(_objectSpread({}, currentScore), newScoreFragment), {}, {
    descendantCount: newDescendantCount
  });

  if ((0, _hasItemChanged.hasItemChanged)(currentScore, newScore)) {
    actions.push(new _Action.Action(newScore, undefined, "modify_score"));
  }

  return newScore;
}

async function calculateFractions(repository, parentScore, actions) {
  if (parentScore.id != undefined && parentScore.fraction != undefined && parentScore.fractionSimple != undefined) {
    const oldChildScores = await repository.getChildrenByScoreId(parentScore.id); //Count up total relevance

    let totalRelevance = 0;

    for (const oldScore of oldChildScores) {
      if (oldScore.affects === "confidence") {
        totalRelevance += oldScore.relevance;
      }
    }

    if (totalRelevance === 0) {
      totalRelevance = 1;
    }

    for (const oldChildScore of oldChildScores) {
      const newChildScore = _objectSpread(_objectSpread({}, oldChildScore), {}, {
        fractionSimple: oldChildScore.relevance / totalRelevance * parentScore.fractionSimple,
        fraction: parentScore.fraction * oldChildScore.percentOfWeight // parentFractionSimple: parentScore.fractionSimple,

      });

      if (newChildScore.fractionSimple != oldChildScore.fractionSimple || newChildScore.fraction != oldChildScore.fraction) {
        actions.push(new _Action.Action(newChildScore, undefined, "modify_score"));
      }

      await calculateFractions(repository, newChildScore, actions);
    }
  }
} // TODO: factor out duplicate code of these calculate functions. maybe mae an array of items to process...


async function calculateGenerations(repository, parentScoreId, actions, generation) {
  const oldChildScores = await repository.getChildrenByScoreId(parentScoreId);
  generation++;

  for (const oldChildScore of oldChildScores) {
    if (oldChildScore.generation != generation) {
      const newChildScore = _objectSpread(_objectSpread({}, oldChildScore), {}, {
        generation: generation
      });

      actions.push(new _Action.Action(newChildScore, undefined, "modify_score"));
    }

    await calculateGenerations(repository, oldChildScore.id, actions, generation);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWxjdWxhdGVTY29yZUFjdGlvbnMudHMiXSwibmFtZXMiOlsiY2FsY3VsYXRlU2NvcmVBY3Rpb25zIiwiYWN0aW9ucyIsInJlcG9zaXRvcnkiLCJSZXBvc2l0b3J5TG9jYWxQdXJlIiwiY2FsY3VsYXRvciIsImNhbGN1bGF0ZVNjb3JlIiwic2NvcmVBY3Rpb25zIiwiY2xhaW1JZHNUb1Njb3JlIiwiU2NvcmVUcmVlSWRzIiwibm90aWZ5IiwiYWN0aW9uIiwidHlwZSIsInB1c2giLCJkYXRhSWQiLCJzY29yZSIsIm5ld0RhdGEiLCJwYXJlbnRTY29yZUlkIiwic2NvcmVUZW1wIiwiZ2V0U2NvcmUiLCJzb3VyY2VDbGFpbUlkIiwiY2xhaW1FZGdlIiwicGFyZW50SWQiLCJjbGFpbUVkZ2VUZW1wIiwiZ2V0Q2xhaW1FZGdlIiwic2NvcmVzIiwiZ2V0U2NvcmVzQnlTb3VyY2VJZCIsImlkIiwicHJvIiwiYWZmZWN0cyIsIkFjdGlvbiIsInByaW9yaXR5Iiwib2xkQ2xhaW1FZGdlIiwib2xkRGF0YSIsInNjb3JlVHJlZSIsImNsYWltSWQiLCJjbGFpbVNjb3JlIiwic2NvcmVUcmVlSWQiLCJnZXRTY29yZVRyZWUiLCJtaXNzaW5nU2NvcmVBY3Rpb25zIiwibWFpblNjb3JlIiwidG9wU2NvcmVJZCIsIlNjb3JlIiwidW5kZWZpbmVkIiwiY3JlYXRlQmxhbmtNaXNzaW5nU2NvcmVzIiwibGVuZ3RoIiwic2NvcmVUcmVlQWN0aW9ucyIsIm5ld01haW5TY29yZSIsImNhbGN1bGF0ZVNjb3JlRGVzY2VuZGFudHMiLCJmcmFjdGlvbkFjdGlvbnMiLCJjYWxjdWxhdGVGcmFjdGlvbnMiLCJnZW5lcmF0aW9uQWN0aW9ucyIsImNhbGN1bGF0ZUdlbmVyYXRpb25zIiwiZGVzY2VuZGFudENvdW50IiwibmV3U2NvcmVUcmVlUGFydGlhbCIsIm9sZFNjb3JlVHJlZVBhcnRpYWwiLCJjdXJyZW50U2NvcmVJZCIsImN1cnJlbnRDbGFpbUlkIiwiZWRnZXMiLCJnZXRDbGFpbUVkZ2VzQnlQYXJlbnRJZCIsImdldENoaWxkcmVuQnlTY29yZUlkIiwiZWRnZSIsImZpbmQiLCJjaGlsZElkIiwidSIsImN1cnJlbnRTY29yZSIsIm9sZENoaWxkU2NvcmVzIiwibmV3Q2hpbGRTY29yZXMiLCJuZXdEZXNjZW5kYW50Q291bnQiLCJvbGRDaGlsZFNjb3JlIiwibmV3U2NvcmUiLCJuZXdTY29yZUZyYWdtZW50IiwiY2hpbGRTY29yZXMiLCJuZXdDaGlsZFNjb3JlIiwicGFyZW50U2NvcmUiLCJmcmFjdGlvbiIsImZyYWN0aW9uU2ltcGxlIiwidG90YWxSZWxldmFuY2UiLCJvbGRTY29yZSIsInJlbGV2YW5jZSIsInBlcmNlbnRPZldlaWdodCIsImdlbmVyYXRpb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQTs7Ozs7Ozs7QUFHQTtBQUNBO0FBQ0E7QUFDTyxlQUFlQSxxQkFBZixDQUFxQztBQUFFQyxFQUFBQSxPQUFPLEdBQUcsRUFBWjtBQUFnQkMsRUFBQUEsVUFBVSxHQUFHLElBQUlDLHdDQUFKLEVBQTdCO0FBQXdEQyxFQUFBQSxVQUFVLEdBQUdDO0FBQXJFLElBT3hDLEVBUEcsRUFRTDtBQUNFLFFBQU1DLFlBQXNCLEdBQUcsRUFBL0I7QUFDQSxRQUFNQyxlQUF5QixHQUFHLEVBQWxDO0FBQ0EsUUFBTUMsWUFBc0IsR0FBRyxFQUEvQjtBQUVBLFFBQU1OLFVBQVUsQ0FBQ08sTUFBWCxDQUFrQlIsT0FBbEIsQ0FBTjs7QUFDQSxPQUFLLE1BQU1TLE1BQVgsSUFBcUJULE9BQXJCLEVBQThCO0FBRTFCO0FBQ0EsUUFBSVMsTUFBTSxDQUFDQyxJQUFQLElBQWUsV0FBZixJQUE4QkQsTUFBTSxDQUFDQyxJQUFQLElBQWUsY0FBakQsRUFBaUU7QUFDN0RKLE1BQUFBLGVBQWUsQ0FBQ0ssSUFBaEIsQ0FBcUJGLE1BQU0sQ0FBQ0csTUFBNUI7QUFDSDs7QUFFRCxRQUFJSCxNQUFNLENBQUNDLElBQVAsSUFBZSxXQUFuQixFQUFnQztBQUM1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LEVBQTRDO0FBQ3hDLFlBQU1SLGFBQWEsbUNBQVFKLGFBQVI7QUFBdUJZLFFBQUFBLFVBQVUsRUFBRUE7QUFBbkMsUUFBbkI7O0FBQ0EvRSxNQUFBQSxPQUFPLENBQUNXLElBQVIsQ0FBYSxJQUFJaUIsY0FBSixDQUFXMkMsYUFBWCxFQUEwQjlCLFNBQTFCLEVBQXFDLGNBQXJDLENBQWI7QUFDSDs7QUFDRCxVQUFNUyxvQkFBb0IsQ0FBQ2pELFVBQUQsRUFBYWtFLGFBQWEsQ0FBQzFDLEVBQTNCLEVBQStCekIsT0FBL0IsRUFBd0MrRSxVQUF4QyxDQUExQjtBQUNIO0FBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTY29yZSB9IGZyb20gXCIuL2RhdGFNb2RlbHMvU2NvcmVcIjtcclxuaW1wb3J0IHsgaGFzSXRlbUNoYW5nZWQgfSBmcm9tIFwiLi91dGlscy9oYXNJdGVtQ2hhbmdlZFwiO1xyXG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tIFwiLi9kYXRhTW9kZWxzL0FjdGlvblwiO1xyXG5pbXBvcnQgeyBpQ2FsY3VsYXRlU2NvcmUsIGNhbGN1bGF0ZVNjb3JlIH0gZnJvbSBcIi4vY2FsY3VsYXRlU2NvcmVcIjtcclxuaW1wb3J0IHsgaVJlcG9zaXRvcnkgfSBmcm9tIFwiLi9kYXRhTW9kZWxzL2lSZXBvc2l0b3J5XCI7XHJcbmltcG9ydCB7IENsYWltRWRnZSB9IGZyb20gXCIuL2RhdGFNb2RlbHMvQ2xhaW1FZGdlXCI7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnlMb2NhbFB1cmUgfSBmcm9tIFwiLi9yZXBvc2l0b3JpZXMvUmVwb3NpdG9yeUxvY2FsUHVyZVwiO1xyXG5pbXBvcnQgeyBTY29yZVRyZWUgfSBmcm9tIFwiLlwiO1xyXG5cclxuLyoqXHJcbiAqIENhbGN1bGF0ZXMgdGhlIHNjb3JlIGFjdGlvbnMgYmFzZWQgb24gYSBsaXN0IG9mIGFjdGlvbnNcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjYWxjdWxhdGVTY29yZUFjdGlvbnMoeyBhY3Rpb25zID0gW10sIHJlcG9zaXRvcnkgPSBuZXcgUmVwb3NpdG9yeUxvY2FsUHVyZSgpLCBjYWxjdWxhdG9yID0gY2FsY3VsYXRlU2NvcmUgfToge1xyXG4gICAgLyoqIEFuIGFycmF5IG9mIGFjdGlvbnMsIHVzdWFsbHkgb24gY2xhaW1zIG9yIGVkZ2VzIHRoYXQgaW5jbHVzZSBubyBzY29yZXMqL1xyXG4gICAgYWN0aW9ucz86IEFjdGlvbltdO1xyXG4gICAgLyoqIFRoZSByZXBvc2l0b3J5IHVzZWQgdG8gZ2V0IGNvbnRleHQgZm9yIHRoZSBhY3Rpb25zICovXHJcbiAgICByZXBvc2l0b3J5PzogaVJlcG9zaXRvcnk7XHJcbiAgICAvKiogVGhlIGZ1bmN0aW9uIHVzZWQgdG8gY2FsY3VsYXRlIHRoZSBzY29yZXMgKi9cclxuICAgIGNhbGN1bGF0b3I/OiBpQ2FsY3VsYXRlU2NvcmU7XHJcbn0gPSB7fSxcclxuKSB7XHJcbiAgICBjb25zdCBzY29yZUFjdGlvbnM6IEFjdGlvbltdID0gW107XHJcbiAgICBjb25zdCBjbGFpbUlkc1RvU2NvcmU6IHN0cmluZ1tdID0gW107XHJcbiAgICBjb25zdCBTY29yZVRyZWVJZHM6IHN0cmluZ1tdID0gW107XHJcblxyXG4gICAgYXdhaXQgcmVwb3NpdG9yeS5ub3RpZnkoYWN0aW9ucyk7XHJcbiAgICBmb3IgKGNvbnN0IGFjdGlvbiBvZiBhY3Rpb25zKSB7XHJcblxyXG4gICAgICAgIC8vIGZpbmQgY2xhaW1zIHRoYXQgbWF5IG5lZWQgc2NvcmVzIGNoYW5nZWRcclxuICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT0gJ2FkZF9jbGFpbScgfHwgYWN0aW9uLnR5cGUgPT0gJ21vZGlmeV9jbGFpbScpIHtcclxuICAgICAgICAgICAgY2xhaW1JZHNUb1Njb3JlLnB1c2goYWN0aW9uLmRhdGFJZClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChhY3Rpb24udHlwZSA9PSBcImFkZF9zY29yZVwiKSB7XHJcbiAgICAgICAgICAgIGxldCBzY29yZSA9IGFjdGlvbi5uZXdEYXRhIGFzIFNjb3JlO1xyXG4gICAgICAgICAgICBpZiAoIXNjb3JlLnBhcmVudFNjb3JlSWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNjb3JlVGVtcCA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0U2NvcmUoYWN0aW9uLmRhdGFJZClcclxuICAgICAgICAgICAgICAgIGlmIChzY29yZVRlbXApIHtcclxuICAgICAgICAgICAgICAgICAgICBzY29yZSA9IHNjb3JlVGVtcDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY2xhaW1JZHNUb1Njb3JlLnB1c2goc2NvcmUuc291cmNlQ2xhaW1JZClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vQWRkIHNjb3JlcyBpZiBlZGdlcyBhZGRzIG5ldyBjaGlsZHJlbiB0byBjbGFpbXMgaW4gc2NvcmUgdHJlZXNcclxuICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT0gJ2FkZF9jbGFpbUVkZ2UnIHx8IGFjdGlvbi50eXBlID09ICdtb2RpZnlfY2xhaW1FZGdlJykge1xyXG4gICAgICAgICAgICBsZXQgY2xhaW1FZGdlID0gYWN0aW9uLm5ld0RhdGEgYXMgQ2xhaW1FZGdlO1xyXG4gICAgICAgICAgICBpZiAoIWNsYWltRWRnZS5wYXJlbnRJZCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY2xhaW1FZGdlVGVtcCA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0Q2xhaW1FZGdlKGFjdGlvbi5kYXRhSWQpXHJcbiAgICAgICAgICAgICAgICBpZiAoY2xhaW1FZGdlVGVtcCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNsYWltRWRnZSA9IGNsYWltRWRnZVRlbXA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2xhaW1JZHNUb1Njb3JlLnB1c2goY2xhaW1FZGdlLnBhcmVudElkKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy9UT0RPOiBJZiBhbiBlZGdlIGNoYW5nZXMgdGhlbiBtb2RpZnkgdGhlIGV4aXN0aW5nIHNjb3JlcyB0byBtYXRjaFxyXG4gICAgICAgIGlmIChhY3Rpb24udHlwZSA9PSAnbW9kaWZ5X2NsYWltRWRnZScpIHtcclxuICAgICAgICAgICAgbGV0IGNsYWltRWRnZSA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0Q2xhaW1FZGdlKGFjdGlvbi5kYXRhSWQpXHJcbiAgICAgICAgICAgIGNsYWltRWRnZSA9IHsgLi4uY2xhaW1FZGdlLCAuLi5hY3Rpb24ubmV3RGF0YSB9XHJcbiAgICAgICAgICAgIGlmIChjbGFpbUVkZ2UpIHtcclxuICAgICAgICAgICAgICAgIGFjdGlvbi5uZXdEYXRhIGFzIENsYWltRWRnZTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNjb3JlcyA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0U2NvcmVzQnlTb3VyY2VJZChjbGFpbUVkZ2UuaWQpXHJcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHNjb3JlIG9mIHNjb3Jlcykge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vVE9ETzogV2hlcmUgc2hvdWxkIEkgcHV0IHRoaXM/IEl0IGlzIG1vZGlmeWluZyBhbSBvYmplY3QuIElmIGl0IGlzIHJlYWN0aXZlIGkgc2hvdWxkIGp1c3QgY2hhbmdlIHRoZSBkYXRhLiBJZiBwdXJlIGl0IHNob3VsZCBiZSBhIG5ldyBvYmplY3QuXHJcbiAgICAgICAgICAgICAgICAgICAgLy9Gb3Igbm93IEkgd2lsbCBtb2RpZnkgaXQgYnV0IGl0IG1heSBub3QgdHJpZ2dlciB1cGRhdGVzIGluIGEgcHVyZSBsaWJyYXJ5IChSZWFjdClcclxuICAgICAgICAgICAgICAgICAgICAvL1RoaXMgY2hhbmdlIHNob3VsZCBhbHNvIHByb2JhYmx5IGJlIGNlbnRyYWxpemVkIHNvbWV3aGVyZSB0byByZWR1Y2UgdGhlIGNoYW5jZSBvZiBpbmNvbnNpc3RlbnQgYnVncy4gSSB0aGluayBpdCB3aWxsIGhhcHBlbiBpbiBtdWx0aXBsZSBwYWNlc1xyXG4gICAgICAgICAgICAgICAgICAgIC8vTm9wZSwgaXQgaXMgYW4gYWN0aW9uIHNvIGl0IHNob3VsZCBhbHdheXMgYmUgYSBuZXcgb2JqZWN0LiBJZiBpdCBnb2VzIGludG8gYSByZWFjdGl2ZSByZXNwb2l0b3J5IHRoZW4gaXQgd2lsbCBtb2RpZnkgdGhlIGFjdHVhbCBvYmplY3RcclxuICAgICAgICAgICAgICAgICAgICAvL1Nob3VsZCBJIGdyb3VwIHRoZXNlIGFjdGlvbnMgb3IganVzdCB0aHJvdyB0aGVtIGluIG9uZSBhdCBhIHRpbWUgbGlrZSBJIGFtIGRvaW5nXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNjb3JlLnBybyAhPSBjbGFpbUVkZ2UucHJvIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3JlLmFmZmVjdHMgIT0gY2xhaW1FZGdlLmFmZmVjdHMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0aW9uID0gbmV3IEFjdGlvbih7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm86IGNsYWltRWRnZS5wcm8sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZmZlY3RzOiBjbGFpbUVkZ2UuYWZmZWN0cyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW9yaXR5OiBjbGFpbUVkZ2UucHJpb3JpdHksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIHNjb3JlLCBcIm1vZGlmeV9zY29yZVwiLCBzY29yZS5pZClcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2NvcmVBY3Rpb25zLnB1c2goYWN0aW9uKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgcmVwb3NpdG9yeS5ub3RpZnkoW2FjdGlvbl0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGFjdGlvbi50eXBlID09ICdkZWxldGVfY2xhaW1FZGdlJykge1xyXG4gICAgICAgICAgICBjb25zdCBvbGRDbGFpbUVkZ2UgPSBhY3Rpb24ub2xkRGF0YSBhcyBDbGFpbUVkZ2U7XHJcbiAgICAgICAgICAgIGNsYWltSWRzVG9TY29yZS5wdXNoKG9sZENsYWltRWRnZS5wYXJlbnRJZClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChhY3Rpb24udHlwZSA9PSAnYWRkX3Njb3JlVHJlZScpIHtcclxuICAgICAgICAgICAgY29uc3Qgc2NvcmVUcmVlID0gYWN0aW9uLm5ld0RhdGEgYXMgU2NvcmVUcmVlO1xyXG4gICAgICAgICAgICBTY29yZVRyZWVJZHMucHVzaChzY29yZVRyZWUuaWQpXHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICAvL1dhbGsgdXAgdGhlIHNjb3JlcyBmb3IgZWFjaCBjbGFpbSB0byB0aGUgdG9wXHJcbiAgICBmb3IgKGNvbnN0IGNsYWltSWQgb2YgY2xhaW1JZHNUb1Njb3JlKSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBjbGFpbVNjb3JlIG9mIGF3YWl0IHJlcG9zaXRvcnkuZ2V0U2NvcmVzQnlTb3VyY2VJZChjbGFpbUlkKSkge1xyXG4gICAgICAgICAgICBTY29yZVRyZWVJZHMucHVzaChjbGFpbVNjb3JlLnNjb3JlVHJlZUlkKVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvL1JlLWNhbGMgYWxsIFNjb3JlIFRyZWVzIHdpdGggcG9zc2libGUgY2hhbmdlZCBjbGFpbXNcclxuXHJcbiAgICBmb3IgKGNvbnN0IHNjb3JlVHJlZUlkIG9mIFNjb3JlVHJlZUlkcykge1xyXG4gICAgICAgIGNvbnN0IHNjb3JlVHJlZSA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0U2NvcmVUcmVlKHNjb3JlVHJlZUlkKVxyXG4gICAgICAgIGlmIChzY29yZVRyZWUpIHtcclxuICAgICAgICAgICAgY29uc3QgbWlzc2luZ1Njb3JlQWN0aW9uczogQWN0aW9uW10gPSBbXTtcclxuXHJcbiAgICAgICAgICAgIGxldCBtYWluU2NvcmUgPSBhd2FpdCByZXBvc2l0b3J5LmdldFNjb3JlKHNjb3JlVHJlZS50b3BTY29yZUlkKTtcclxuICAgICAgICAgICAgaWYgKCFtYWluU2NvcmUpIHtcclxuICAgICAgICAgICAgICAgIG1haW5TY29yZSA9IG5ldyBTY29yZShzY29yZVRyZWUuc291cmNlQ2xhaW1JZCwgc2NvcmVUcmVlLmlkKTtcclxuICAgICAgICAgICAgICAgIG1haW5TY29yZS5pZCA9IHNjb3JlVHJlZS50b3BTY29yZUlkO1xyXG4gICAgICAgICAgICAgICAgbWlzc2luZ1Njb3JlQWN0aW9ucy5wdXNoKG5ldyBBY3Rpb24obWFpblNjb3JlLCB1bmRlZmluZWQsIFwiYWRkX3Njb3JlXCIpKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgYXdhaXQgY3JlYXRlQmxhbmtNaXNzaW5nU2NvcmVzKHJlcG9zaXRvcnksIHNjb3JlVHJlZS50b3BTY29yZUlkLCBzY29yZVRyZWUuc291cmNlQ2xhaW1JZCB8fCBcIlwiLCBtaXNzaW5nU2NvcmVBY3Rpb25zLCBzY29yZVRyZWVJZClcclxuICAgICAgICAgICAgaWYgKG1pc3NpbmdTY29yZUFjdGlvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgcmVwb3NpdG9yeS5ub3RpZnkobWlzc2luZ1Njb3JlQWN0aW9ucylcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3Qgc2NvcmVUcmVlQWN0aW9uczogQWN0aW9uW10gPSBbXTtcclxuICAgICAgICAgICAgY29uc3QgbmV3TWFpblNjb3JlID0gYXdhaXQgY2FsY3VsYXRlU2NvcmVEZXNjZW5kYW50cyhyZXBvc2l0b3J5LCBtYWluU2NvcmUsIGNhbGN1bGF0b3IsIHNjb3JlVHJlZUFjdGlvbnMpO1xyXG4gICAgICAgICAgICBpZiAobWlzc2luZ1Njb3JlQWN0aW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCByZXBvc2l0b3J5Lm5vdGlmeShzY29yZVRyZWVBY3Rpb25zKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBmcmFjdGlvbkFjdGlvbnM6IEFjdGlvbltdID0gW107XHJcbiAgICAgICAgICAgIGF3YWl0IGNhbGN1bGF0ZUZyYWN0aW9ucyhyZXBvc2l0b3J5LCBtYWluU2NvcmUsIGZyYWN0aW9uQWN0aW9ucylcclxuICAgICAgICAgICAgaWYgKGZyYWN0aW9uQWN0aW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCByZXBvc2l0b3J5Lm5vdGlmeShmcmFjdGlvbkFjdGlvbnMpXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGdlbmVyYXRpb25BY3Rpb25zOiBBY3Rpb25bXSA9IFtdO1xyXG4gICAgICAgICAgICBhd2FpdCBjYWxjdWxhdGVHZW5lcmF0aW9ucyhyZXBvc2l0b3J5LCBtYWluU2NvcmUuaWQsIGdlbmVyYXRpb25BY3Rpb25zLCAwKVxyXG4gICAgICAgICAgICBpZiAoZ2VuZXJhdGlvbkFjdGlvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgcmVwb3NpdG9yeS5ub3RpZnkoZ2VuZXJhdGlvbkFjdGlvbnMpXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHNjb3JlQWN0aW9ucy5wdXNoKFxyXG4gICAgICAgICAgICAgICAgLi4ubWlzc2luZ1Njb3JlQWN0aW9ucyxcclxuICAgICAgICAgICAgICAgIC4uLnNjb3JlVHJlZUFjdGlvbnMsXHJcbiAgICAgICAgICAgICAgICAuLi5mcmFjdGlvbkFjdGlvbnMsXHJcbiAgICAgICAgICAgICAgICAuLi5nZW5lcmF0aW9uQWN0aW9ucyxcclxuICAgICAgICAgICAgKVxyXG5cclxuICAgICAgICAgICAgaWYgKHNjb3JlVHJlZS5kZXNjZW5kYW50Q291bnQgIT0gbmV3TWFpblNjb3JlLmRlc2NlbmRhbnRDb3VudCkge1xyXG4gICAgICAgICAgICAgICAgbGV0IG5ld1Njb3JlVHJlZVBhcnRpYWw6IFBhcnRpYWw8U2NvcmVUcmVlPiA9IHsgZGVzY2VuZGFudENvdW50OiBuZXdNYWluU2NvcmUuZGVzY2VuZGFudENvdW50IH1cclxuICAgICAgICAgICAgICAgIGxldCBvbGRTY29yZVRyZWVQYXJ0aWFsOiBQYXJ0aWFsPFNjb3JlVHJlZT4gPSB7IGRlc2NlbmRhbnRDb3VudDogc2NvcmVUcmVlLmRlc2NlbmRhbnRDb3VudCB9XHJcbiAgICAgICAgICAgICAgICBzY29yZUFjdGlvbnMucHVzaChcclxuICAgICAgICAgICAgICAgICAgICBuZXcgQWN0aW9uKG5ld1Njb3JlVHJlZVBhcnRpYWwsIG9sZFNjb3JlVHJlZVBhcnRpYWwsIFwibW9kaWZ5X3Njb3JlVHJlZVwiLCBzY29yZVRyZWUuaWQpXHJcbiAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy9UT0RPOiBSZXZpZXcgdGhpcyBkZWNpc2lvbjogRmVlZCB0aGUgc2NvcmUgYWN0aW9ucyBiYWNrIGludG8gdGhlIHJlcG9zaXRvcnkgc28gdGhpcyByZXBvc2l0b3J5IGlzIHVwIHRvIGRhdGUgaW4gY2FzZSBpdCBpcyB1c2VkIFxyXG4gICAgYXdhaXQgcmVwb3NpdG9yeS5ub3RpZnkoc2NvcmVBY3Rpb25zKTtcclxuXHJcbiAgICByZXR1cm4gc2NvcmVBY3Rpb25zO1xyXG59XHJcblxyXG4vL0NyZWF0ZSBCbGFuayBNaXNzaW5nIFNjb3Jlc1xyXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVCbGFua01pc3NpbmdTY29yZXMocmVwb3NpdG9yeTogaVJlcG9zaXRvcnksIGN1cnJlbnRTY29yZUlkOiBzdHJpbmcsIGN1cnJlbnRDbGFpbUlkOiBzdHJpbmcsIGFjdGlvbnM6IEFjdGlvbltdLCBzY29yZVRyZWVJZDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBlZGdlcyA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0Q2xhaW1FZGdlc0J5UGFyZW50SWQoY3VycmVudENsYWltSWQpXHJcbiAgICBjb25zdCBzY29yZXMgPSBhd2FpdCByZXBvc2l0b3J5LmdldENoaWxkcmVuQnlTY29yZUlkKGN1cnJlbnRTY29yZUlkKVxyXG4gICAgZm9yIChjb25zdCBlZGdlIG9mIGVkZ2VzKSB7XHJcbiAgICAgICAgLy9zZWUgaWYgdGhlcmUgaXMgYSBtYXRjaGluZyBjaGlsZCBzY29yZSBmb3IgdGhlIGNoaWxkIGVkZ2VcclxuICAgICAgICBsZXQgc2NvcmUgPSBzY29yZXMuZmluZCgoeyBzb3VyY2VDbGFpbUlkIH0pID0+IHNvdXJjZUNsYWltSWQgPT09IGVkZ2UuY2hpbGRJZCk7XHJcbiAgICAgICAgaWYgKCFzY29yZSkge1xyXG4gICAgICAgICAgICAvL0NyZWF0ZSBhIG5ldyBTY29yZSBhbmQgYXR0YWNoIGl0IHRvIGl0J3MgcGFyZW50XHJcbiAgICAgICAgICAgIGNvbnN0IHUgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIHNjb3JlID0gbmV3IFNjb3JlKGVkZ2UuY2hpbGRJZCwgc2NvcmVUcmVlSWQsIGN1cnJlbnRTY29yZUlkLCBlZGdlLmlkLCB1bmRlZmluZWQsIGVkZ2UucHJvLCBlZGdlLmFmZmVjdHMsIHUsIHUsIHUsIGVkZ2UucHJpb3JpdHkpO1xyXG4gICAgICAgICAgICBhY3Rpb25zLnB1c2gobmV3IEFjdGlvbihzY29yZSwgdW5kZWZpbmVkLCBcImFkZF9zY29yZVwiLCBzY29yZS5pZCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvL1JlY3Vyc2UgYW5kIHRocm91Z2ggY2hpbGRyZW5cclxuICAgICAgICBhd2FpdCBjcmVhdGVCbGFua01pc3NpbmdTY29yZXMocmVwb3NpdG9yeSwgc2NvcmUuaWQsIGVkZ2UuY2hpbGRJZCwgYWN0aW9ucywgc2NvcmVUcmVlSWQpO1xyXG4gICAgfVxyXG59XHJcblxyXG4vL1RoaXMgZnVuY3Rpb24gYXNzdW1lIHRoYXQgYWxsIHNjb3JlcyBhbHJlYWR5IGV4aXN0XHJcbmFzeW5jIGZ1bmN0aW9uIGNhbGN1bGF0ZVNjb3JlRGVzY2VuZGFudHMocmVwb3NpdG9yeTogaVJlcG9zaXRvcnksIGN1cnJlbnRTY29yZTogU2NvcmUsIGNhbGN1bGF0b3I6IGlDYWxjdWxhdGVTY29yZSA9IGNhbGN1bGF0ZVNjb3JlLCBhY3Rpb25zOiBBY3Rpb25bXSkge1xyXG4gICAgY29uc3Qgb2xkQ2hpbGRTY29yZXMgPSBhd2FpdCByZXBvc2l0b3J5LmdldENoaWxkcmVuQnlTY29yZUlkKGN1cnJlbnRTY29yZS5pZClcclxuICAgIGNvbnN0IG5ld0NoaWxkU2NvcmVzOiBTY29yZVtdID0gW107XHJcbiAgICBsZXQgbmV3RGVzY2VuZGFudENvdW50ID0gMDtcclxuXHJcbiAgICBmb3IgKGNvbnN0IG9sZENoaWxkU2NvcmUgb2Ygb2xkQ2hpbGRTY29yZXMpIHsgLy9DYWxjdWxhdGUgQ2hpbGRyZW5cclxuICAgICAgICAvL1RPRE86IHJlbW92ZSBhbnkgc2NvcmVzIHRvIGNhbGN1bGF0ZSBiYXNlZCBvbiBmb3JtdWxhcyB0aGF0IGV4Y2x1ZGUgc2NvcmVzXHJcbiAgICAgICAgY29uc3QgbmV3U2NvcmUgPSBhd2FpdCBjYWxjdWxhdGVTY29yZURlc2NlbmRhbnRzKHJlcG9zaXRvcnksIG9sZENoaWxkU2NvcmUsIGNhbGN1bGF0b3IsIGFjdGlvbnMpO1xyXG4gICAgICAgIG5ld0NoaWxkU2NvcmVzLnB1c2gobmV3U2NvcmUpO1xyXG4gICAgICAgIG5ld0Rlc2NlbmRhbnRDb3VudCArPSBuZXdTY29yZS5kZXNjZW5kYW50Q291bnQgKyAxO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG5ld1Njb3JlRnJhZ21lbnQgPSBjYWxjdWxhdG9yKHtcclxuICAgICAgICBjaGlsZFNjb3JlczogbmV3Q2hpbGRTY29yZXMsXHJcbiAgICB9KVxyXG5cclxuICAgIC8vdXBkYXRlIGFueSBuZXdDaGlsZFNjb3JlcyB0aGF0IGNoYW5nZWRcclxuICAgIGZvciAoY29uc3QgbmV3Q2hpbGRTY29yZSBvZiBuZXdDaGlsZFNjb3Jlcykge1xyXG4gICAgICAgIC8vIFRPRE86IElzIHRoaXMgc2xvdyBhY2Nlc3NpbmcgdGhlIGRhdGEgc3RvcmUgYWdhaW4gZm9yIHRoaXMgZGF0YSBvciBkbyB3ZSBhc3N1bWUgaXQgaXMgY2FjaGVkIGlmIGl0IGlzIGluIGFuIGV4dGVybmFsIERCXHJcbiAgICAgICAgY29uc3Qgb2xkQ2hpbGRTY29yZSA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0U2NvcmUobmV3Q2hpbGRTY29yZS5pZCk7XHJcbiAgICAgICAgaWYgKG9sZENoaWxkU2NvcmUgJiYgaGFzSXRlbUNoYW5nZWQob2xkQ2hpbGRTY29yZSwgbmV3Q2hpbGRTY29yZSkpIHtcclxuICAgICAgICAgICAgYWN0aW9ucy5wdXNoKG5ldyBBY3Rpb24obmV3Q2hpbGRTY29yZSwgdW5kZWZpbmVkLCBcIm1vZGlmeV9zY29yZVwiKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vVE9ETzogTW9kaWZ5IHRoZSBuZXdTY29yZSBiYXNlZCBvbiBhbnkgZm9ybXVsYXNcclxuICAgIGNvbnN0IG5ld1Njb3JlID0ge1xyXG4gICAgICAgIC4uLmN1cnJlbnRTY29yZSxcclxuICAgICAgICAuLi5uZXdTY29yZUZyYWdtZW50LFxyXG4gICAgICAgIGRlc2NlbmRhbnRDb3VudDogbmV3RGVzY2VuZGFudENvdW50XHJcbiAgICB9XHJcbiAgICBpZiAoaGFzSXRlbUNoYW5nZWQoY3VycmVudFNjb3JlLCBuZXdTY29yZSkpIHtcclxuICAgICAgICBhY3Rpb25zLnB1c2gobmV3IEFjdGlvbihuZXdTY29yZSwgdW5kZWZpbmVkLCBcIm1vZGlmeV9zY29yZVwiKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5ld1Njb3JlO1xyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBjYWxjdWxhdGVGcmFjdGlvbnMocmVwb3NpdG9yeTogaVJlcG9zaXRvcnksIHBhcmVudFNjb3JlOiBQYXJ0aWFsPFNjb3JlPiwgYWN0aW9uczogQWN0aW9uW10pIHtcclxuICAgIGlmIChwYXJlbnRTY29yZS5pZCAhPSB1bmRlZmluZWQgJiZcclxuICAgICAgICBwYXJlbnRTY29yZS5mcmFjdGlvbiAhPSB1bmRlZmluZWQgJiZcclxuICAgICAgICBwYXJlbnRTY29yZS5mcmFjdGlvblNpbXBsZSAhPSB1bmRlZmluZWQpIHtcclxuICAgICAgICBjb25zdCBvbGRDaGlsZFNjb3JlcyA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0Q2hpbGRyZW5CeVNjb3JlSWQocGFyZW50U2NvcmUuaWQpXHJcblxyXG4gICAgICAgIC8vQ291bnQgdXAgdG90YWwgcmVsZXZhbmNlXHJcbiAgICAgICAgbGV0IHRvdGFsUmVsZXZhbmNlID0gMFxyXG4gICAgICAgIGZvciAoY29uc3Qgb2xkU2NvcmUgb2Ygb2xkQ2hpbGRTY29yZXMpIHtcclxuICAgICAgICAgICAgaWYgKG9sZFNjb3JlLmFmZmVjdHMgPT09IFwiY29uZmlkZW5jZVwiKSB7XHJcbiAgICAgICAgICAgICAgICB0b3RhbFJlbGV2YW5jZSArPSBvbGRTY29yZS5yZWxldmFuY2VcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodG90YWxSZWxldmFuY2UgPT09IDApIHtcclxuICAgICAgICAgICAgdG90YWxSZWxldmFuY2UgPSAxO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBvbGRDaGlsZFNjb3JlIG9mIG9sZENoaWxkU2NvcmVzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5ld0NoaWxkU2NvcmU6IFBhcnRpYWw8U2NvcmU+ID0ge1xyXG4gICAgICAgICAgICAgICAgLi4ub2xkQ2hpbGRTY29yZSxcclxuICAgICAgICAgICAgICAgIGZyYWN0aW9uU2ltcGxlOiAob2xkQ2hpbGRTY29yZS5yZWxldmFuY2UgLyB0b3RhbFJlbGV2YW5jZSkgKiBwYXJlbnRTY29yZS5mcmFjdGlvblNpbXBsZSxcclxuICAgICAgICAgICAgICAgIGZyYWN0aW9uOiBwYXJlbnRTY29yZS5mcmFjdGlvbiAqIG9sZENoaWxkU2NvcmUucGVyY2VudE9mV2VpZ2h0LFxyXG4gICAgICAgICAgICAgICAgLy8gcGFyZW50RnJhY3Rpb25TaW1wbGU6IHBhcmVudFNjb3JlLmZyYWN0aW9uU2ltcGxlLFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChuZXdDaGlsZFNjb3JlLmZyYWN0aW9uU2ltcGxlICE9IG9sZENoaWxkU2NvcmUuZnJhY3Rpb25TaW1wbGUgfHxcclxuICAgICAgICAgICAgICAgIG5ld0NoaWxkU2NvcmUuZnJhY3Rpb24gIT0gb2xkQ2hpbGRTY29yZS5mcmFjdGlvbikge1xyXG4gICAgICAgICAgICAgICAgYWN0aW9ucy5wdXNoKG5ldyBBY3Rpb24obmV3Q2hpbGRTY29yZSwgdW5kZWZpbmVkLCBcIm1vZGlmeV9zY29yZVwiKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYXdhaXQgY2FsY3VsYXRlRnJhY3Rpb25zKHJlcG9zaXRvcnksIG5ld0NoaWxkU2NvcmUsIGFjdGlvbnMpO1xyXG5cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG59XHJcblxyXG4vLyBUT0RPOiBmYWN0b3Igb3V0IGR1cGxpY2F0ZSBjb2RlIG9mIHRoZXNlIGNhbGN1bGF0ZSBmdW5jdGlvbnMuIG1heWJlIG1hZSBhbiBhcnJheSBvZiBpdGVtcyB0byBwcm9jZXNzLi4uXHJcbmFzeW5jIGZ1bmN0aW9uIGNhbGN1bGF0ZUdlbmVyYXRpb25zKHJlcG9zaXRvcnk6IGlSZXBvc2l0b3J5LCBwYXJlbnRTY29yZUlkOiBzdHJpbmcsIGFjdGlvbnM6IEFjdGlvbltdLCBnZW5lcmF0aW9uOiBudW1iZXIpIHtcclxuICAgIGNvbnN0IG9sZENoaWxkU2NvcmVzID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRDaGlsZHJlbkJ5U2NvcmVJZChwYXJlbnRTY29yZUlkKVxyXG4gICAgZ2VuZXJhdGlvbisrO1xyXG5cclxuICAgIGZvciAoY29uc3Qgb2xkQ2hpbGRTY29yZSBvZiBvbGRDaGlsZFNjb3Jlcykge1xyXG4gICAgICAgIGlmIChvbGRDaGlsZFNjb3JlLmdlbmVyYXRpb24gIT0gZ2VuZXJhdGlvbikge1xyXG4gICAgICAgICAgICBjb25zdCBuZXdDaGlsZFNjb3JlID0geyAuLi5vbGRDaGlsZFNjb3JlLCBnZW5lcmF0aW9uOiBnZW5lcmF0aW9uIH1cclxuICAgICAgICAgICAgYWN0aW9ucy5wdXNoKG5ldyBBY3Rpb24obmV3Q2hpbGRTY29yZSwgdW5kZWZpbmVkLCBcIm1vZGlmeV9zY29yZVwiKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGF3YWl0IGNhbGN1bGF0ZUdlbmVyYXRpb25zKHJlcG9zaXRvcnksIG9sZENoaWxkU2NvcmUuaWQsIGFjdGlvbnMsIGdlbmVyYXRpb24pXHJcbiAgICB9XHJcbn1cclxuIl19
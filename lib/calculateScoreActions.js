"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.calculateScoreActions = calculateScoreActions;

var _Score = require("./dataModels/Score");

var _Action = require("./dataModels/Action");

var _calculateScore = require("./calculateScore");

var _RepositoryLocalPure = require("./repositories/RepositoryLocalPure");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Calculates the score actions based on a list of actions
 */
async function calculateScoreActions({
  actions = [],
  repository = new _RepositoryLocalPure.RepositoryLocalPure(),
  calculator = _calculateScore.calculateScore
} = {}) {
  const scoreActions = [];
  const claimIdsToScore = [];
  const ScoreTreeIds = [];
  await repository.notify(actions);

  for (const action of actions) {
    // find claims that may need scores changed
    if (action.type == 'add_claim' || action.type == 'modify_claim') {
      claimIdsToScore.push(action.dataId);
    }

    if (action.type == "add_score") {
      let score = action.newData;

      if (!score.parentScoreId) {
        const scoreTemp = await repository.getScore(action.dataId);

        if (scoreTemp) {
          score = scoreTemp;
        }
      }

      claimIdsToScore.push(score.sourceClaimId);
    } //Add scores if edges adds new children to claims in score trees


    if (action.type == 'add_claimEdge' || action.type == 'modify_claimEdge') {
      let claimEdge = action.newData;

      if (!claimEdge.parentId) {
        const claimEdgeTemp = await repository.getClaimEdge(action.dataId);

        if (claimEdgeTemp) {
          claimEdge = claimEdgeTemp;
        }
      }

      claimIdsToScore.push(claimEdge.parentId);
    } //TODO: If an edge changes then modify the existing scores to match


    if (action.type == 'modify_claimEdge') {
      let claimEdge = await repository.getClaimEdge(action.dataId);
      claimEdge = _objectSpread({}, claimEdge, {}, action.newData);

      if (claimEdge) {
        action.newData;
        const scores = await repository.getScoresBySourceId(claimEdge.id);

        for (const score of scores) {
          //TODO: Where should I put this? It is modifying am object. If it is reactive i should just change the data. If pure it should be a new object.
          //For now I will modify it but it may not trigger updates in a pure library (React)
          //This change should also probably be centralized somewhere to reduce the chance of inconsistent bugs. I think it will happen in multiple paces
          //Nope, it is an action so it should always be a new object. If it goes into a reactive respoitory then it will modify the actual object
          //Should I group these actions or just throw them in one at a time like I am doing
          if (score.pro != claimEdge.pro || score.affects != claimEdge.affects) {
            const action = new _Action.Action({
              pro: claimEdge.pro,
              affects: claimEdge.affects,
              priority: claimEdge.priority
            }, score, "modify_score", score.id);
            scoreActions.push(action);
            await repository.notify([action]);
          }
        }
      }
    }

    if (action.type == 'delete_claimEdge') {
      const oldClaimEdge = action.oldData;
      claimIdsToScore.push(oldClaimEdge.parentId);
    }

    if (action.type == 'add_scoreTree') {
      const scoreTree = action.newData;
      ScoreTreeIds.push(scoreTree.id);
    }
  } //Walk up the scores for each claim to the top


  for (const claimId of claimIdsToScore) {
    for (const claimScore of await repository.getScoresBySourceId(claimId)) {
      ScoreTreeIds.push(claimScore.scoreTreeId);
    }
  } //Re-calc all Score Trees with possible changed claims


  for (const scoreTreeId of ScoreTreeIds) {
    const scoreTree = await repository.getScoreTree(scoreTreeId);

    if (scoreTree) {
      const missingScoreActions = [];
      let topScore = await repository.getScore(scoreTree.topScoreId);

      if (!topScore) {
        topScore = new _Score.Score(scoreTree.sourceClaimId, scoreTree.id);
        topScore.id = scoreTree.topScoreId;
        missingScoreActions.push(new _Action.Action(topScore, undefined, "add_score"));
      }

      await createBlankMissingScores(repository, scoreTree.topScoreId, scoreTree.sourceClaimId || "", missingScoreActions, scoreTreeId);

      if (missingScoreActions.length > 0) {
        await repository.notify(missingScoreActions);
      }

      const scoreTreeActions = [];
      await calculateScoreTree(repository, topScore, calculator, scoreTreeActions);

      if (missingScoreActions.length > 0) {
        await repository.notify(scoreTreeActions);
      }

      const fractionActions = [];
      await calculateFractions(repository, topScore, fractionActions);

      if (fractionActions.length > 0) {
        await repository.notify(fractionActions);
      }

      scoreActions.push(...missingScoreActions, ...scoreTreeActions, ...fractionActions);
    }
  } //TODO: Review this decision: Feed the score actions back into the repository so this repository is up to date in case it is used 


  await repository.notify(scoreActions);
  return scoreActions;
} //Create Blank Missing Scores


async function createBlankMissingScores(repository, currentScoreId, currentClaimId, actions, scoreTreeId) {
  const edges = await repository.getClaimEdgesByParentId(currentClaimId);
  const scores = await repository.getChildrenByScoreId(currentScoreId);

  for (const edge of edges) {
    //see if there is a matching child score for the child edge
    let score = scores.find(({
      sourceClaimId
    }) => sourceClaimId === edge.childId);

    if (!score) {
      //Create a new Score and attach it to it's parent
      const u = undefined;
      score = new _Score.Score(edge.childId, scoreTreeId, currentScoreId, edge.id, undefined, edge.pro, edge.affects, u, u, u, edge.priority);
      actions.push(new _Action.Action(score, undefined, "add_score", score.id));
    } //Recurse and through children


    await createBlankMissingScores(repository, score.id, edge.childId, actions, scoreTreeId);
  }
} //This function assume that all scores already exist


async function calculateScoreTree(repository, currentScore, calculator = _calculateScore.calculateScore, actions) {
  const oldScores = await repository.getChildrenByScoreId(currentScore.id);
  const newScores = [];
  let newDescendantCount = 0;

  for (const oldScore of oldScores) {
    //Calculate Children
    //TODO: remove any scores to calculate based on formulas that exclude scores
    const newScore = await calculateScoreTree(repository, oldScore, calculator, actions);
    newScores.push(newScore);
    newDescendantCount += newScore.descendantCount + 1;
  }

  const newScoreFragment = calculator({
    childScores: newScores
  }); //TODO: Modify the newScore based on any formulas

  const newScore = _objectSpread({}, currentScore, {}, newScoreFragment, {
    descendantCount: newDescendantCount
  });

  if ((0, _Score.differentScores)(currentScore, newScore)) {
    actions.push(new _Action.Action(newScore, undefined, "modify_score", newScore.id));
  }

  return newScore;
}

async function calculateFractions(repository, parentScore, actions) {
  const oldChildScores = await repository.getChildrenByScoreId(parentScore.id);
  const newScores = []; //Count up total relevance

  let totalRelevance = 0;

  for (const oldScore of oldChildScores) {
    if (oldScore.affects === "confidence") {
      totalRelevance += oldScore.relevance;
    }
  }

  if (totalRelevance === 0) {
    totalRelevance = 1;
  }

  for (const oldChildScore of oldChildScores) {
    const newChildFraction = oldChildScore.relevance / totalRelevance * parentScore.fraction;

    const newChildScore = _objectSpread({}, oldChildScore, {
      fraction: newChildFraction
    });

    if (newChildFraction != oldChildScore.fraction) {
      actions.push(new _Action.Action(newChildScore, undefined, "modify_score"));
    }

    await calculateFractions(repository, newChildScore, actions);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWxjdWxhdGVTY29yZUFjdGlvbnMudHMiXSwibmFtZXMiOlsiY2FsY3VsYXRlU2NvcmVBY3Rpb25zIiwiYWN0aW9ucyIsInJlcG9zaXRvcnkiLCJSZXBvc2l0b3J5TG9jYWxQdXJlIiwiY2FsY3VsYXRvciIsImNhbGN1bGF0ZVNjb3JlIiwic2NvcmVBY3Rpb25zIiwiY2xhaW1JZHNUb1Njb3JlIiwiU2NvcmVUcmVlSWRzIiwibm90aWZ5IiwiYWN0aW9uIiwidHlwZSIsInB1c2giLCJkYXRhSWQiLCJzY29yZSIsIm5ld0RhdGEiLCJwYXJlbnRTY29yZUlkIiwic2NvcmVUZW1wIiwiZ2V0U2NvcmUiLCJzb3VyY2VDbGFpbUlkIiwiY2xhaW1FZGdlIiwicGFyZW50SWQiLCJjbGFpbUVkZ2VUZW1wIiwiZ2V0Q2xhaW1FZGdlIiwic2NvcmVzIiwiZ2V0U2NvcmVzQnlTb3VyY2VJZCIsImlkIiwicHJvIiwiYWZmZWN0cyIsIkFjdGlvbiIsInByaW9yaXR5Iiwib2xkQ2xhaW1FZGdlIiwib2xkRGF0YSIsInNjb3JlVHJlZSIsImNsYWltSWQiLCJjbGFpbVNjb3JlIiwic2NvcmVUcmVlSWQiLCJnZXRTY29yZVRyZWUiLCJtaXNzaW5nU2NvcmVBY3Rpb25zIiwidG9wU2NvcmUiLCJ0b3BTY29yZUlkIiwiU2NvcmUiLCJ1bmRlZmluZWQiLCJjcmVhdGVCbGFua01pc3NpbmdTY29yZXMiLCJsZW5ndGgiLCJzY29yZVRyZWVBY3Rpb25zIiwiY2FsY3VsYXRlU2NvcmVUcmVlIiwiZnJhY3Rpb25BY3Rpb25zIiwiY2FsY3VsYXRlRnJhY3Rpb25zIiwiY3VycmVudFNjb3JlSWQiLCJjdXJyZW50Q2xhaW1JZCIsImVkZ2VzIiwiZ2V0Q2xhaW1FZGdlc0J5UGFyZW50SWQiLCJnZXRDaGlsZHJlbkJ5U2NvcmVJZCIsImVkZ2UiLCJmaW5kIiwiY2hpbGRJZCIsInUiLCJjdXJyZW50U2NvcmUiLCJvbGRTY29yZXMiLCJuZXdTY29yZXMiLCJuZXdEZXNjZW5kYW50Q291bnQiLCJvbGRTY29yZSIsIm5ld1Njb3JlIiwiZGVzY2VuZGFudENvdW50IiwibmV3U2NvcmVGcmFnbWVudCIsImNoaWxkU2NvcmVzIiwicGFyZW50U2NvcmUiLCJvbGRDaGlsZFNjb3JlcyIsInRvdGFsUmVsZXZhbmNlIiwicmVsZXZhbmNlIiwib2xkQ2hpbGRTY29yZSIsIm5ld0NoaWxkRnJhY3Rpb24iLCJmcmFjdGlvbiIsIm5ld0NoaWxkU2NvcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFHQTs7Ozs7Ozs7QUFHQTs7O0FBR08sZUFBZUEscUJBQWYsQ0FBcUM7QUFBRUMsRUFBQUEsT0FBTyxHQUFHLEVBQVo7QUFBZ0JDLEVBQUFBLFVBQVUsR0FBRyxJQUFJQyx3Q0FBSixFQUE3QjtBQUF3REMsRUFBQUEsVUFBVSxHQUFHQztBQUFyRSxJQU94QyxFQVBHLEVBUUw7QUFDRSxRQUFNQyxZQUFzQixHQUFHLEVBQS9CO0FBQ0EsUUFBTUMsZUFBeUIsR0FBRyxFQUFsQztBQUNBLFFBQU1DLFlBQXNCLEdBQUcsRUFBL0I7QUFFQSxRQUFNTixVQUFVLENBQUNPLE1BQVgsQ0FBa0JSLE9BQWxCLENBQU47O0FBQ0EsT0FBSyxNQUFNUyxNQUFYLElBQXFCVCxPQUFyQixFQUE4QjtBQUUxQjtBQUNBLFFBQUlTLE1BQU0sQ0FBQ0MsSUFBUCxJQUFlLFdBQWYsSUFBOEJELE1BQU0sQ0FBQ0MsSUFBUCxJQUFlLGNBQWpELEVBQWlFO0FBQzdESixNQUFBQSxlQUFlLENBQUNLLElBQWhCLENBQXFCRixNQUFNLENBQUNHLE1BQTVCO0FBQ0g7O0FBRUQsUUFBSUgsTUFBTSxDQUFDQyxJQUFQLElBQWUsV0FBbkIsRUFBZ0M7QUFDNUIsVUFBSUcsS0FBSyxHQUFHSixNQUFNLENBQUNLLE9BQW5COztBQUNBLFVBQUksQ0FBQ0QsS0FBSyxDQUFDRSxhQUFYLEVBQTBCO0FBQ3RCLGNBQU1DLFNBQVMsR0FBRyxNQUFNZixVQUFVLENBQUNnQixRQUFYLENBQW9CUixNQUFNLENBQUNHLE1BQTNCLENB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RCxhQUFhLENBQUNELFNBQWQsR0FBMEJELGNBQTNCLEdBQTZDRixXQUFXLENBQUNNLFFBQWxGOztBQUNBLFVBQU1DLGFBQWEscUJBQVFILGFBQVI7QUFBdUJFLE1BQUFBLFFBQVEsRUFBRUQ7QUFBakMsTUFBbkI7O0FBQ0EsUUFBSUEsZ0JBQWdCLElBQUlELGFBQWEsQ0FBQ0UsUUFBdEMsRUFBZ0Q7QUFDNUN4RSxNQUFBQSxPQUFPLENBQUNXLElBQVIsQ0FBYSxJQUFJaUIsY0FBSixDQUFXNkMsYUFBWCxFQUEwQmhDLFNBQTFCLEVBQXFDLGNBQXJDLENBQWI7QUFDSDs7QUFDRCxVQUFNTSxrQkFBa0IsQ0FBQzlDLFVBQUQsRUFBYXdFLGFBQWIsRUFBNEJ6RSxPQUE1QixDQUF4QjtBQUVIO0FBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTY29yZSwgZGlmZmVyZW50U2NvcmVzLCBpU2NvcmUgfSBmcm9tIFwiLi9kYXRhTW9kZWxzL1Njb3JlXCI7XHJcbmltcG9ydCB7IEFjdGlvbiB9IGZyb20gXCIuL2RhdGFNb2RlbHMvQWN0aW9uXCI7XHJcbmltcG9ydCB7IGlDYWxjdWxhdGVTY29yZSwgY2FsY3VsYXRlU2NvcmUgfSBmcm9tIFwiLi9jYWxjdWxhdGVTY29yZVwiO1xyXG5pbXBvcnQgeyBpUmVwb3NpdG9yeSB9IGZyb20gXCIuL2RhdGFNb2RlbHMvaVJlcG9zaXRvcnlcIjtcclxuaW1wb3J0IHsgQ2xhaW1FZGdlLCBpQ2xhaW1FZGdlIH0gZnJvbSBcIi4vZGF0YU1vZGVscy9DbGFpbUVkZ2VcIjtcclxuaW1wb3J0IHsgUmVwb3NpdG9yeUxvY2FsUHVyZSB9IGZyb20gXCIuL3JlcG9zaXRvcmllcy9SZXBvc2l0b3J5TG9jYWxQdXJlXCI7XHJcbmltcG9ydCB7IFNjb3JlVHJlZSB9IGZyb20gXCIuXCI7XHJcblxyXG4vKipcclxuICogQ2FsY3VsYXRlcyB0aGUgc2NvcmUgYWN0aW9ucyBiYXNlZCBvbiBhIGxpc3Qgb2YgYWN0aW9uc1xyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNhbGN1bGF0ZVNjb3JlQWN0aW9ucyh7IGFjdGlvbnMgPSBbXSwgcmVwb3NpdG9yeSA9IG5ldyBSZXBvc2l0b3J5TG9jYWxQdXJlKCksIGNhbGN1bGF0b3IgPSBjYWxjdWxhdGVTY29yZSB9OiB7XHJcbiAgICAvKiogQW4gYXJyYXkgb2YgYWN0aW9ucywgdXN1YWxseSBvbiBjbGFpbXMgb3IgZWRnZXMgdGhhdCBpbmNsdXNlIG5vIHNjb3JlcyovXHJcbiAgICBhY3Rpb25zPzogQWN0aW9uW107XHJcbiAgICAvKiogVGhlIHJlcG9zaXRvcnkgdXNlZCB0byBnZXQgY29udGV4dCBmb3IgdGhlIGFjdGlvbnMgKi9cclxuICAgIHJlcG9zaXRvcnk/OiBpUmVwb3NpdG9yeTtcclxuICAgIC8qKiBUaGUgZnVuY3Rpb24gdXNlZCB0byBjYWxjdWxhdGUgdGhlIHNjb3JlcyAqL1xyXG4gICAgY2FsY3VsYXRvcj86IGlDYWxjdWxhdGVTY29yZTtcclxufSA9IHt9LFxyXG4pIHtcclxuICAgIGNvbnN0IHNjb3JlQWN0aW9uczogQWN0aW9uW10gPSBbXTtcclxuICAgIGNvbnN0IGNsYWltSWRzVG9TY29yZTogc3RyaW5nW10gPSBbXTtcclxuICAgIGNvbnN0IFNjb3JlVHJlZUlkczogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICBhd2FpdCByZXBvc2l0b3J5Lm5vdGlmeShhY3Rpb25zKTtcclxuICAgIGZvciAoY29uc3QgYWN0aW9uIG9mIGFjdGlvbnMpIHtcclxuXHJcbiAgICAgICAgLy8gZmluZCBjbGFpbXMgdGhhdCBtYXkgbmVlZCBzY29yZXMgY2hhbmdlZFxyXG4gICAgICAgIGlmIChhY3Rpb24udHlwZSA9PSAnYWRkX2NsYWltJyB8fCBhY3Rpb24udHlwZSA9PSAnbW9kaWZ5X2NsYWltJykge1xyXG4gICAgICAgICAgICBjbGFpbUlkc1RvU2NvcmUucHVzaChhY3Rpb24uZGF0YUlkKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGFjdGlvbi50eXBlID09IFwiYWRkX3Njb3JlXCIpIHtcclxuICAgICAgICAgICAgbGV0IHNjb3JlID0gYWN0aW9uLm5ld0RhdGEgYXMgaVNjb3JlO1xyXG4gICAgICAgICAgICBpZiAoIXNjb3JlLnBhcmVudFNjb3JlSWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNjb3JlVGVtcCA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0U2NvcmUoYWN0aW9uLmRhdGFJZClcclxuICAgICAgICAgICAgICAgIGlmIChzY29yZVRlbXApIHtcclxuICAgICAgICAgICAgICAgICAgICBzY29yZSA9IHNjb3JlVGVtcDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY2xhaW1JZHNUb1Njb3JlLnB1c2goc2NvcmUuc291cmNlQ2xhaW1JZClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vQWRkIHNjb3JlcyBpZiBlZGdlcyBhZGRzIG5ldyBjaGlsZHJlbiB0byBjbGFpbXMgaW4gc2NvcmUgdHJlZXNcclxuICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT0gJ2FkZF9jbGFpbUVkZ2UnIHx8IGFjdGlvbi50eXBlID09ICdtb2RpZnlfY2xhaW1FZGdlJykge1xyXG4gICAgICAgICAgICBsZXQgY2xhaW1FZGdlID0gYWN0aW9uLm5ld0RhdGEgYXMgaUNsYWltRWRnZTtcclxuICAgICAgICAgICAgaWYgKCFjbGFpbUVkZ2UucGFyZW50SWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNsYWltRWRnZVRlbXAgPSBhd2FpdCByZXBvc2l0b3J5LmdldENsYWltRWRnZShhY3Rpb24uZGF0YUlkKVxyXG4gICAgICAgICAgICAgICAgaWYgKGNsYWltRWRnZVRlbXApIHtcclxuICAgICAgICAgICAgICAgICAgICBjbGFpbUVkZ2UgPSBjbGFpbUVkZ2VUZW1wO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNsYWltSWRzVG9TY29yZS5wdXNoKGNsYWltRWRnZS5wYXJlbnRJZClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vVE9ETzogSWYgYW4gZWRnZSBjaGFuZ2VzIHRoZW4gbW9kaWZ5IHRoZSBleGlzdGluZyBzY29yZXMgdG8gbWF0Y2hcclxuICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT0gJ21vZGlmeV9jbGFpbUVkZ2UnKSB7XHJcbiAgICAgICAgICAgIGxldCBjbGFpbUVkZ2UgPSBhd2FpdCByZXBvc2l0b3J5LmdldENsYWltRWRnZShhY3Rpb24uZGF0YUlkKVxyXG4gICAgICAgICAgICBjbGFpbUVkZ2UgPSB7IC4uLmNsYWltRWRnZSwgLi4uYWN0aW9uLm5ld0RhdGEgfVxyXG4gICAgICAgICAgICBpZiAoY2xhaW1FZGdlKSB7XHJcbiAgICAgICAgICAgICAgICBhY3Rpb24ubmV3RGF0YSBhcyBDbGFpbUVkZ2U7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzY29yZXMgPSBhd2FpdCByZXBvc2l0b3J5LmdldFNjb3Jlc0J5U291cmNlSWQoY2xhaW1FZGdlLmlkKVxyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBzY29yZSBvZiBzY29yZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAvL1RPRE86IFdoZXJlIHNob3VsZCBJIHB1dCB0aGlzPyBJdCBpcyBtb2RpZnlpbmcgYW0gb2JqZWN0LiBJZiBpdCBpcyByZWFjdGl2ZSBpIHNob3VsZCBqdXN0IGNoYW5nZSB0aGUgZGF0YS4gSWYgcHVyZSBpdCBzaG91bGQgYmUgYSBuZXcgb2JqZWN0LlxyXG4gICAgICAgICAgICAgICAgICAgIC8vRm9yIG5vdyBJIHdpbGwgbW9kaWZ5IGl0IGJ1dCBpdCBtYXkgbm90IHRyaWdnZXIgdXBkYXRlcyBpbiBhIHB1cmUgbGlicmFyeSAoUmVhY3QpXHJcbiAgICAgICAgICAgICAgICAgICAgLy9UaGlzIGNoYW5nZSBzaG91bGQgYWxzbyBwcm9iYWJseSBiZSBjZW50cmFsaXplZCBzb21ld2hlcmUgdG8gcmVkdWNlIHRoZSBjaGFuY2Ugb2YgaW5jb25zaXN0ZW50IGJ1Z3MuIEkgdGhpbmsgaXQgd2lsbCBoYXBwZW4gaW4gbXVsdGlwbGUgcGFjZXNcclxuICAgICAgICAgICAgICAgICAgICAvL05vcGUsIGl0IGlzIGFuIGFjdGlvbiBzbyBpdCBzaG91bGQgYWx3YXlzIGJlIGEgbmV3IG9iamVjdC4gSWYgaXQgZ29lcyBpbnRvIGEgcmVhY3RpdmUgcmVzcG9pdG9yeSB0aGVuIGl0IHdpbGwgbW9kaWZ5IHRoZSBhY3R1YWwgb2JqZWN0XHJcbiAgICAgICAgICAgICAgICAgICAgLy9TaG91bGQgSSBncm91cCB0aGVzZSBhY3Rpb25zIG9yIGp1c3QgdGhyb3cgdGhlbSBpbiBvbmUgYXQgYSB0aW1lIGxpa2UgSSBhbSBkb2luZ1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzY29yZS5wcm8gIT0gY2xhaW1FZGdlLnBybyB8fFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzY29yZS5hZmZlY3RzICE9IGNsYWltRWRnZS5hZmZlY3RzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGlvbiA9IG5ldyBBY3Rpb24oe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvOiBjbGFpbUVkZ2UucHJvLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZmZWN0czogY2xhaW1FZGdlLmFmZmVjdHMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmlvcml0eTogY2xhaW1FZGdlLnByaW9yaXR5LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LCBzY29yZSwgXCJtb2RpZnlfc2NvcmVcIiwgc2NvcmUuaWQpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3JlQWN0aW9ucy5wdXNoKGFjdGlvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHJlcG9zaXRvcnkubm90aWZ5KFthY3Rpb25dKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChhY3Rpb24udHlwZSA9PSAnZGVsZXRlX2NsYWltRWRnZScpIHtcclxuICAgICAgICAgICAgY29uc3Qgb2xkQ2xhaW1FZGdlID0gYWN0aW9uLm9sZERhdGEgYXMgQ2xhaW1FZGdlO1xyXG4gICAgICAgICAgICBjbGFpbUlkc1RvU2NvcmUucHVzaChvbGRDbGFpbUVkZ2UucGFyZW50SWQpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT0gJ2FkZF9zY29yZVRyZWUnKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNjb3JlVHJlZSA9IGFjdGlvbi5uZXdEYXRhIGFzIFNjb3JlVHJlZTtcclxuICAgICAgICAgICAgU2NvcmVUcmVlSWRzLnB1c2goc2NvcmVUcmVlLmlkKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgLy9XYWxrIHVwIHRoZSBzY29yZXMgZm9yIGVhY2ggY2xhaW0gdG8gdGhlIHRvcFxyXG4gICAgZm9yIChjb25zdCBjbGFpbUlkIG9mIGNsYWltSWRzVG9TY29yZSkge1xyXG4gICAgICAgIGZvciAoY29uc3QgY2xhaW1TY29yZSBvZiBhd2FpdCByZXBvc2l0b3J5LmdldFNjb3Jlc0J5U291cmNlSWQoY2xhaW1JZCkpIHtcclxuICAgICAgICAgICAgU2NvcmVUcmVlSWRzLnB1c2goY2xhaW1TY29yZS5zY29yZVRyZWVJZClcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy9SZS1jYWxjIGFsbCBTY29yZSBUcmVlcyB3aXRoIHBvc3NpYmxlIGNoYW5nZWQgY2xhaW1zXHJcblxyXG4gICAgZm9yIChjb25zdCBzY29yZVRyZWVJZCBvZiBTY29yZVRyZWVJZHMpIHtcclxuICAgICAgICBjb25zdCBzY29yZVRyZWUgPSBhd2FpdCByZXBvc2l0b3J5LmdldFNjb3JlVHJlZShzY29yZVRyZWVJZClcclxuICAgICAgICBpZiAoc2NvcmVUcmVlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1pc3NpbmdTY29yZUFjdGlvbnM6IEFjdGlvbltdID0gW107XHJcblxyXG4gICAgICAgICAgICBsZXQgdG9wU2NvcmUgPSBhd2FpdCByZXBvc2l0b3J5LmdldFNjb3JlKHNjb3JlVHJlZS50b3BTY29yZUlkKTtcclxuICAgICAgICAgICAgaWYgKCF0b3BTY29yZSkge1xyXG4gICAgICAgICAgICAgICAgdG9wU2NvcmUgPSBuZXcgU2NvcmUoc2NvcmVUcmVlLnNvdXJjZUNsYWltSWQsIHNjb3JlVHJlZS5pZCk7XHJcbiAgICAgICAgICAgICAgICB0b3BTY29yZS5pZCA9IHNjb3JlVHJlZS50b3BTY29yZUlkO1xyXG4gICAgICAgICAgICAgICAgbWlzc2luZ1Njb3JlQWN0aW9ucy5wdXNoKG5ldyBBY3Rpb24odG9wU2NvcmUsIHVuZGVmaW5lZCwgXCJhZGRfc2NvcmVcIikpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBhd2FpdCBjcmVhdGVCbGFua01pc3NpbmdTY29yZXMocmVwb3NpdG9yeSwgc2NvcmVUcmVlLnRvcFNjb3JlSWQsIHNjb3JlVHJlZS5zb3VyY2VDbGFpbUlkIHx8IFwiXCIsIG1pc3NpbmdTY29yZUFjdGlvbnMsIHNjb3JlVHJlZUlkKVxyXG4gICAgICAgICAgICBpZiAobWlzc2luZ1Njb3JlQWN0aW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCByZXBvc2l0b3J5Lm5vdGlmeShtaXNzaW5nU2NvcmVBY3Rpb25zKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBzY29yZVRyZWVBY3Rpb25zOiBBY3Rpb25bXSA9IFtdO1xyXG4gICAgICAgICAgICBhd2FpdCBjYWxjdWxhdGVTY29yZVRyZWUocmVwb3NpdG9yeSwgdG9wU2NvcmUsIGNhbGN1bGF0b3IsIHNjb3JlVHJlZUFjdGlvbnMpO1xyXG4gICAgICAgICAgICBpZiAobWlzc2luZ1Njb3JlQWN0aW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCByZXBvc2l0b3J5Lm5vdGlmeShzY29yZVRyZWVBY3Rpb25zKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBmcmFjdGlvbkFjdGlvbnM6IEFjdGlvbltdID0gW107XHJcbiAgICAgICAgICAgIGF3YWl0IGNhbGN1bGF0ZUZyYWN0aW9ucyhyZXBvc2l0b3J5LCB0b3BTY29yZSwgZnJhY3Rpb25BY3Rpb25zKVxyXG4gICAgICAgICAgICBpZiAoZnJhY3Rpb25BY3Rpb25zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHJlcG9zaXRvcnkubm90aWZ5KGZyYWN0aW9uQWN0aW9ucylcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBzY29yZUFjdGlvbnMucHVzaChcclxuICAgICAgICAgICAgICAgIC4uLm1pc3NpbmdTY29yZUFjdGlvbnMsXHJcbiAgICAgICAgICAgICAgICAuLi5zY29yZVRyZWVBY3Rpb25zLFxyXG4gICAgICAgICAgICAgICAgLi4uZnJhY3Rpb25BY3Rpb25zKVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvL1RPRE86IFJldmlldyB0aGlzIGRlY2lzaW9uOiBGZWVkIHRoZSBzY29yZSBhY3Rpb25zIGJhY2sgaW50byB0aGUgcmVwb3NpdG9yeSBzbyB0aGlzIHJlcG9zaXRvcnkgaXMgdXAgdG8gZGF0ZSBpbiBjYXNlIGl0IGlzIHVzZWQgXHJcbiAgICBhd2FpdCByZXBvc2l0b3J5Lm5vdGlmeShzY29yZUFjdGlvbnMpO1xyXG5cclxuICAgIHJldHVybiBzY29yZUFjdGlvbnM7XHJcbn1cclxuXHJcbi8vQ3JlYXRlIEJsYW5rIE1pc3NpbmcgU2NvcmVzXHJcbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUJsYW5rTWlzc2luZ1Njb3JlcyhyZXBvc2l0b3J5OiBpUmVwb3NpdG9yeSwgY3VycmVudFNjb3JlSWQ6IHN0cmluZywgY3VycmVudENsYWltSWQ6IHN0cmluZywgYWN0aW9uczogQWN0aW9uW10sIHNjb3JlVHJlZUlkOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGVkZ2VzID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRDbGFpbUVkZ2VzQnlQYXJlbnRJZChjdXJyZW50Q2xhaW1JZClcclxuICAgIGNvbnN0IHNjb3JlcyA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0Q2hpbGRyZW5CeVNjb3JlSWQoY3VycmVudFNjb3JlSWQpXHJcbiAgICBmb3IgKGNvbnN0IGVkZ2Ugb2YgZWRnZXMpIHtcclxuICAgICAgICAvL3NlZSBpZiB0aGVyZSBpcyBhIG1hdGNoaW5nIGNoaWxkIHNjb3JlIGZvciB0aGUgY2hpbGQgZWRnZVxyXG4gICAgICAgIGxldCBzY29yZSA9IHNjb3Jlcy5maW5kKCh7IHNvdXJjZUNsYWltSWQgfSkgPT4gc291cmNlQ2xhaW1JZCA9PT0gZWRnZS5jaGlsZElkKTtcclxuICAgICAgICBpZiAoIXNjb3JlKSB7XHJcbiAgICAgICAgICAgIC8vQ3JlYXRlIGEgbmV3IFNjb3JlIGFuZCBhdHRhY2ggaXQgdG8gaXQncyBwYXJlbnRcclxuICAgICAgICAgICAgY29uc3QgdSA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgc2NvcmUgPSBuZXcgU2NvcmUoZWRnZS5jaGlsZElkLCBzY29yZVRyZWVJZCwgY3VycmVudFNjb3JlSWQsIGVkZ2UuaWQsIHVuZGVmaW5lZCwgZWRnZS5wcm8sIGVkZ2UuYWZmZWN0cywgdSwgdSwgdSwgZWRnZS5wcmlvcml0eSk7XHJcbiAgICAgICAgICAgIGFjdGlvbnMucHVzaChuZXcgQWN0aW9uKHNjb3JlLCB1bmRlZmluZWQsIFwiYWRkX3Njb3JlXCIsIHNjb3JlLmlkKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vUmVjdXJzZSBhbmQgdGhyb3VnaCBjaGlsZHJlblxyXG4gICAgICAgIGF3YWl0IGNyZWF0ZUJsYW5rTWlzc2luZ1Njb3JlcyhyZXBvc2l0b3J5LCBzY29yZS5pZCwgZWRnZS5jaGlsZElkLCBhY3Rpb25zLCBzY29yZVRyZWVJZCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8vVGhpcyBmdW5jdGlvbiBhc3N1bWUgdGhhdCBhbGwgc2NvcmVzIGFscmVhZHkgZXhpc3RcclxuYXN5bmMgZnVuY3Rpb24gY2FsY3VsYXRlU2NvcmVUcmVlKHJlcG9zaXRvcnk6IGlSZXBvc2l0b3J5LCBjdXJyZW50U2NvcmU6IGlTY29yZSwgY2FsY3VsYXRvcjogaUNhbGN1bGF0ZVNjb3JlID0gY2FsY3VsYXRlU2NvcmUsIGFjdGlvbnM6IEFjdGlvbltdKSB7XHJcbiAgICBjb25zdCBvbGRTY29yZXMgPSBhd2FpdCByZXBvc2l0b3J5LmdldENoaWxkcmVuQnlTY29yZUlkKGN1cnJlbnRTY29yZS5pZClcclxuICAgIGNvbnN0IG5ld1Njb3JlczogaVNjb3JlW10gPSBbXTtcclxuICAgIGxldCBuZXdEZXNjZW5kYW50Q291bnQgPSAwO1xyXG5cclxuXHJcblxyXG4gICAgZm9yIChjb25zdCBvbGRTY29yZSBvZiBvbGRTY29yZXMpIHsgLy9DYWxjdWxhdGUgQ2hpbGRyZW5cclxuICAgICAgICAvL1RPRE86IHJlbW92ZSBhbnkgc2NvcmVzIHRvIGNhbGN1bGF0ZSBiYXNlZCBvbiBmb3JtdWxhcyB0aGF0IGV4Y2x1ZGUgc2NvcmVzXHJcbiAgICAgICAgY29uc3QgbmV3U2NvcmUgPSBhd2FpdCBjYWxjdWxhdGVTY29yZVRyZWUocmVwb3NpdG9yeSwgb2xkU2NvcmUsIGNhbGN1bGF0b3IsIGFjdGlvbnMpO1xyXG4gICAgICAgIG5ld1Njb3Jlcy5wdXNoKG5ld1Njb3JlKTtcclxuICAgICAgICBuZXdEZXNjZW5kYW50Q291bnQgKz0gbmV3U2NvcmUuZGVzY2VuZGFudENvdW50ICsgMTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBuZXdTY29yZUZyYWdtZW50ID0gY2FsY3VsYXRvcih7XHJcbiAgICAgICAgY2hpbGRTY29yZXM6IG5ld1Njb3JlcyxcclxuICAgIH0pXHJcblxyXG4gICAgLy9UT0RPOiBNb2RpZnkgdGhlIG5ld1Njb3JlIGJhc2VkIG9uIGFueSBmb3JtdWxhc1xyXG4gICAgY29uc3QgbmV3U2NvcmUgPSB7XHJcbiAgICAgICAgLi4uY3VycmVudFNjb3JlLFxyXG4gICAgICAgIC4uLm5ld1Njb3JlRnJhZ21lbnQsXHJcbiAgICAgICAgZGVzY2VuZGFudENvdW50OiBuZXdEZXNjZW5kYW50Q291bnRcclxuICAgIH1cclxuICAgIGlmIChkaWZmZXJlbnRTY29yZXMoY3VycmVudFNjb3JlLCBuZXdTY29yZSkpIHtcclxuICAgICAgICBhY3Rpb25zLnB1c2gobmV3IEFjdGlvbihuZXdTY29yZSwgdW5kZWZpbmVkLCBcIm1vZGlmeV9zY29yZVwiLCBuZXdTY29yZS5pZCkpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBuZXdTY29yZTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gY2FsY3VsYXRlRnJhY3Rpb25zKHJlcG9zaXRvcnk6IGlSZXBvc2l0b3J5LCBwYXJlbnRTY29yZTogaVNjb3JlLCBhY3Rpb25zOiBBY3Rpb25bXSkge1xyXG4gICAgY29uc3Qgb2xkQ2hpbGRTY29yZXMgPSBhd2FpdCByZXBvc2l0b3J5LmdldENoaWxkcmVuQnlTY29yZUlkKHBhcmVudFNjb3JlLmlkKVxyXG4gICAgY29uc3QgbmV3U2NvcmVzOiBpU2NvcmVbXSA9IFtdO1xyXG5cclxuICAgIC8vQ291bnQgdXAgdG90YWwgcmVsZXZhbmNlXHJcbiAgICBsZXQgdG90YWxSZWxldmFuY2UgPSAwXHJcbiAgICBmb3IgKGNvbnN0IG9sZFNjb3JlIG9mIG9sZENoaWxkU2NvcmVzKSB7XHJcbiAgICAgICAgaWYgKG9sZFNjb3JlLmFmZmVjdHMgPT09IFwiY29uZmlkZW5jZVwiKSB7XHJcbiAgICAgICAgICAgIHRvdGFsUmVsZXZhbmNlICs9IG9sZFNjb3JlLnJlbGV2YW5jZVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGlmICh0b3RhbFJlbGV2YW5jZSA9PT0gMCkge1xyXG4gICAgICAgIHRvdGFsUmVsZXZhbmNlID0gMTtcclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGNvbnN0IG9sZENoaWxkU2NvcmUgb2Ygb2xkQ2hpbGRTY29yZXMpIHtcclxuICAgICAgICBjb25zdCBuZXdDaGlsZEZyYWN0aW9uID0gKG9sZENoaWxkU2NvcmUucmVsZXZhbmNlIC8gdG90YWxSZWxldmFuY2UpICogcGFyZW50U2NvcmUuZnJhY3Rpb25cclxuICAgICAgICBjb25zdCBuZXdDaGlsZFNjb3JlID0geyAuLi5vbGRDaGlsZFNjb3JlLCBmcmFjdGlvbjogbmV3Q2hpbGRGcmFjdGlvbiB9XHJcbiAgICAgICAgaWYgKG5ld0NoaWxkRnJhY3Rpb24gIT0gb2xkQ2hpbGRTY29yZS5mcmFjdGlvbikge1xyXG4gICAgICAgICAgICBhY3Rpb25zLnB1c2gobmV3IEFjdGlvbihuZXdDaGlsZFNjb3JlLCB1bmRlZmluZWQsIFwibW9kaWZ5X3Njb3JlXCIpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYXdhaXQgY2FsY3VsYXRlRnJhY3Rpb25zKHJlcG9zaXRvcnksIG5ld0NoaWxkU2NvcmUsIGFjdGlvbnMpXHJcblxyXG4gICAgfVxyXG59XHJcbiJdfQ==
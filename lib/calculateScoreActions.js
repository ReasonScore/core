"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.calculateScoreActions = calculateScoreActions;

var _Score = require("./dataModels/Score");

var _hasItemChanged = require("./utils/hasItemChanged");

var _Action = require("./dataModels/Action");

var _calculateScore = require("./calculateScore");

var _RepositoryLocalPure = require("./repositories/RepositoryLocalPure");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Calculates the score actions based on a list of actions
 */
async function calculateScoreActions({
  actions = [],
  repository = new _RepositoryLocalPure.RepositoryLocalPure(),
  calculator = _calculateScore.calculateScore
} = {}) {
  const scoreActions = [];
  const claimIdsToScore = [];
  const ScoreTreeIds = [];
  await repository.notify(actions);

  for (const action of actions) {
    // find claims that may need scores changed
    if (action.type == 'add_claim' || action.type == 'modify_claim') {
      claimIdsToScore.push(action.dataId);
    }

    if (action.type == "add_score") {
      let score = action.newData;

      if (!score.parentScoreId) {
        const scoreTemp = await repository.getScore(action.dataId);

        if (scoreTemp) {
          score = scoreTemp;
        }
      }

      claimIdsToScore.push(score.sourceClaimId);
    } //Add scores if edges adds new children to claims in score trees


    if (action.type == 'add_claimEdge' || action.type == 'modify_claimEdge') {
      let claimEdge = action.newData;

      if (!claimEdge.parentId) {
        const claimEdgeTemp = await repository.getClaimEdge(action.dataId);

        if (claimEdgeTemp) {
          claimEdge = claimEdgeTemp;
        }
      }

      claimIdsToScore.push(claimEdge.parentId);
    } //TODO: If an edge changes then modify the existing scores to match


    if (action.type == 'modify_claimEdge') {
      let claimEdge = await repository.getClaimEdge(action.dataId);
      claimEdge = _objectSpread(_objectSpread({}, claimEdge), action.newData);

      if (claimEdge) {
        action.newData;
        const scores = await repository.getScoresBySourceId(claimEdge.id);

        for (const score of scores) {
          //TODO: Where should I put this? It is modifying am object. If it is reactive i should just change the data. If pure it should be a new object.
          //For now I will modify it but it may not trigger updates in a pure library (React)
          //This change should also probably be centralized somewhere to reduce the chance of inconsistent bugs. I think it will happen in multiple paces
          //Nope, it is an action so it should always be a new object. If it goes into a reactive respoitory then it will modify the actual object
          //Should I group these actions or just throw them in one at a time like I am doing
          if (score.pro != claimEdge.pro || score.affects != claimEdge.affects || score.priority != claimEdge.priority) {
            const action = new _Action.Action({
              pro: claimEdge.pro,
              affects: claimEdge.affects,
              priority: claimEdge.priority
            }, score, "modify_score", score.id);
            scoreActions.push(action);
            await repository.notify([action]);
          }
        }
      }
    }

    if (action.type == 'delete_claimEdge') {
      const oldClaimEdge = action.oldData;
      claimIdsToScore.push(oldClaimEdge.parentId);
    }

    if (action.type == 'add_scoreTree') {
      const scoreTree = action.newData;
      ScoreTreeIds.push(scoreTree.id);
    }
  } //Walk up the scores for each claim to the top


  for (const claimId of claimIdsToScore) {
    for (const claimScore of await repository.getScoresBySourceId(claimId)) {
      ScoreTreeIds.push(claimScore.scoreTreeId);
    }
  } //Re-calc all Score Trees with possible changed claims


  for (const scoreTreeId of ScoreTreeIds) {
    const scoreTree = await repository.getScoreTree(scoreTreeId);

    if (scoreTree) {
      const missingScoreActions = [];
      let mainScore = await repository.getScore(scoreTree.topScoreId);

      if (!mainScore) {
        mainScore = new _Score.Score(scoreTree.sourceClaimId, scoreTree.id);
        mainScore.id = scoreTree.topScoreId;
        missingScoreActions.push(new _Action.Action(mainScore, undefined, "add_score"));
      }

      await createBlankMissingScores(repository, scoreTree.topScoreId, scoreTree.sourceClaimId || "", missingScoreActions, scoreTreeId);

      if (missingScoreActions.length > 0) {
        await repository.notify(missingScoreActions);
      }

      const scoreTreeActions = [];
      const newMainScore = await calculateScoreDescendants(repository, mainScore, calculator, scoreTreeActions);

      if (missingScoreActions.length > 0) {
        await repository.notify(scoreTreeActions);
      }

      const fractionActions = [];
      await calculateFractions(repository, mainScore, fractionActions);

      if (fractionActions.length > 0) {
        await repository.notify(fractionActions);
      }

      const generationActions = [];
      await calculateGenerations(repository, mainScore.id, generationActions, 0);

      if (generationActions.length > 0) {
        await repository.notify(generationActions);
      }

      const proMainActions = [];

      const newChildScore = _objectSpread(_objectSpread({}, mainScore), {}, {
        proMain: true
      });

      proMainActions.push(new _Action.Action(newChildScore, undefined, "modify_score"));
      await calculateProMain(repository, mainScore.id, proMainActions, true);

      if (proMainActions.length > 0) {
        await repository.notify(proMainActions);
      }

      scoreActions.push(...missingScoreActions, ...scoreTreeActions, ...fractionActions, ...generationActions, ...proMainActions);

      if (scoreTree.descendantCount != newMainScore.descendantCount) {
        let newScoreTreePartial = {
          descendantCount: newMainScore.descendantCount
        };
        let oldScoreTreePartial = {
          descendantCount: scoreTree.descendantCount
        };
        scoreActions.push(new _Action.Action(newScoreTreePartial, oldScoreTreePartial, "modify_scoreTree", scoreTree.id));
      }
    }
  } //TODO: Review this decision: Feed the score actions back into the repository so this repository is up to date in case it is used 


  await repository.notify(scoreActions);
  return scoreActions;
} //Create Blank Missing Scores


async function createBlankMissingScores(repository, currentScoreId, currentClaimId, actions, scoreTreeId) {
  const edges = await repository.getClaimEdgesByParentId(currentClaimId);
  const scores = await repository.getChildrenByScoreId(currentScoreId);

  for (const edge of edges) {
    //see if there is a matching child score for the child edge
    let score = scores.find(({
      sourceClaimId
    }) => sourceClaimId === edge.childId);

    if (!score) {
      //Create a new Score and attach it to it's parent
      const u = undefined;
      score = new _Score.Score(edge.childId, scoreTreeId, currentScoreId, edge.id, undefined, edge.pro, edge.affects, u, u, u, edge.priority);
      actions.push(new _Action.Action(score, undefined, "add_score", score.id));
    } //Recurse and through children


    await createBlankMissingScores(repository, score.id, edge.childId, actions, scoreTreeId);
  }
} //This function assume that all scores already exist


async function calculateScoreDescendants(repository, currentScore, calculator = _calculateScore.calculateScore, actions) {
  const oldChildScores = await repository.getChildrenByScoreId(currentScore.id);
  const newChildScores = [];
  let newDescendantCount = 0;

  for (const oldChildScore of oldChildScores) {
    //Calculate Children
    //TODO: remove any scores to calculate based on formulas that exclude scores
    const newScore = await calculateScoreDescendants(repository, oldChildScore, calculator, actions);
    newChildScores.push(newScore);
    newDescendantCount += newScore.descendantCount + 1;
  }

  const newScoreFragment = calculator({
    childScores: newChildScores
  }); //update any newChildScores that changed

  for (const newChildScore of newChildScores) {
    // TODO: Is this slow accessing the data store again for this data or do we assume it is cached if it is in an external DB
    const oldChildScore = await repository.getScore(newChildScore.id);

    if (oldChildScore && (0, _hasItemChanged.hasItemChanged)(oldChildScore, newChildScore)) {
      actions.push(new _Action.Action(newChildScore, undefined, "modify_score"));
    }
  } //TODO: Modify the newScore based on any formulas


  const newScore = _objectSpread(_objectSpread(_objectSpread({}, currentScore), newScoreFragment), {}, {
    descendantCount: newDescendantCount
  });

  if ((0, _hasItemChanged.hasItemChanged)(currentScore, newScore)) {
    actions.push(new _Action.Action(newScore, undefined, "modify_score"));
  }

  return newScore;
}

async function calculateFractions(repository, parentScore, actions) {
  if (parentScore.id != undefined && parentScore.fraction != undefined && parentScore.fractionSimple != undefined) {
    const oldChildScores = await repository.getChildrenByScoreId(parentScore.id); //Count up total relevance

    let totalRelevance = 0;

    for (const oldScore of oldChildScores) {
      if (oldScore.affects === "confidence") {
        totalRelevance += oldScore.relevance;
      }
    }

    if (totalRelevance === 0) {
      totalRelevance = 1;
    }

    for (const oldChildScore of oldChildScores) {
      const newChildScore = _objectSpread(_objectSpread({}, oldChildScore), {}, {
        fractionSimple: oldChildScore.relevance / totalRelevance * parentScore.fractionSimple,
        fraction: parentScore.fraction * oldChildScore.percentOfWeight // parentFractionSimple: parentScore.fractionSimple,

      });

      if (newChildScore.fractionSimple != oldChildScore.fractionSimple || newChildScore.fraction != oldChildScore.fraction) {
        actions.push(new _Action.Action(newChildScore, undefined, "modify_score"));
      }

      await calculateFractions(repository, newChildScore, actions);
    }
  }
} // TODO: factor out duplicate code of these calculate functions. maybe make an array of items to process...


async function calculateGenerations(repository, parentScoreId, actions, generation) {
  const oldChildScores = await repository.getChildrenByScoreId(parentScoreId);
  generation++;

  for (const oldChildScore of oldChildScores) {
    if (oldChildScore.generation != generation) {
      const newChildScore = _objectSpread(_objectSpread({}, oldChildScore), {}, {
        generation: generation
      });

      actions.push(new _Action.Action(newChildScore, undefined, "modify_score"));
    }

    await calculateGenerations(repository, oldChildScore.id, actions, generation);
  }
} // TODO: factor out duplicate code of these calculate functions. maybe make an array of items to process...


async function calculateProMain(repository, parentScoreId, actions, proMain) {
  const oldChildScores = await repository.getChildrenByScoreId(parentScoreId);

  for (const oldChildScore of oldChildScores) {
    // const newChildScore = { ...oldChildScore, proMain: false }
    // actions.push(new Action(newChildScore, undefined, "modify_score"));
    // await calculateProMain(repository, oldChildScore.id, actions, proMain)
    if (oldChildScore.pro === true) {
      // && oldChildScore.proMain !== proMain) {
      const newChildScore = _objectSpread(_objectSpread({}, oldChildScore), {}, {
        proMain: proMain
      });

      actions.push(new _Action.Action(newChildScore, undefined, "modify_score"));
      await calculateProMain(repository, oldChildScore.id, actions, proMain);
    }

    if (oldChildScore.pro === false) {
      // && oldChildScore.proMain === proMain) {
      const newChildScore = _objectSpread(_objectSpread({}, oldChildScore), {}, {
        proMain: !proMain
      });

      actions.push(new _Action.Action(newChildScore, undefined, "modify_score"));
      await calculateProMain(repository, oldChildScore.id, actions, !proMain);
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWxjdWxhdGVTY29yZUFjdGlvbnMudHMiXSwibmFtZXMiOlsiY2FsY3VsYXRlU2NvcmVBY3Rpb25zIiwiYWN0aW9ucyIsInJlcG9zaXRvcnkiLCJSZXBvc2l0b3J5TG9jYWxQdXJlIiwiY2FsY3VsYXRvciIsImNhbGN1bGF0ZVNjb3JlIiwic2NvcmVBY3Rpb25zIiwiY2xhaW1JZHNUb1Njb3JlIiwiU2NvcmVUcmVlSWRzIiwibm90aWZ5IiwiYWN0aW9uIiwidHlwZSIsInB1c2giLCJkYXRhSWQiLCJzY29yZSIsIm5ld0RhdGEiLCJwYXJlbnRTY29yZUlkIiwic2NvcmVUZW1wIiwiZ2V0U2NvcmUiLCJzb3VyY2VDbGFpbUlkIiwiY2xhaW1FZGdlIiwicGFyZW50SWQiLCJjbGFpbUVkZ2VUZW1wIiwiZ2V0Q2xhaW1FZGdlIiwic2NvcmVzIiwiZ2V0U2NvcmVzQnlTb3VyY2VJZCIsImlkIiwicHJvIiwiYWZmZWN0cyIsInByaW9yaXR5IiwiQWN0aW9uIiwib2xkQ2xhaW1FZGdlIiwib2xkRGF0YSIsInNjb3JlVHJlZSIsImNsYWltSWQiLCJjbGFpbVNjb3JlIiwic2NvcmVUcmVlSWQiLCJnZXRTY29yZVRyZWUiLCJtaXNzaW5nU2NvcmVBY3Rpb25zIiwibWFpblNjb3JlIiwidG9wU2NvcmVJZCIsIlNjb3JlIiwidW5kZWZpbmVkIiwiY3JlYXRlQmxhbmtNaXNzaW5nU2NvcmVzIiwibGVuZ3RoIiwic2NvcmVUcmVlQWN0aW9ucyIsIm5ld01haW5TY29yZSIsImNhbGN1bGF0ZVNjb3JlRGVzY2VuZGFudHMiLCJmcmFjdGlvbkFjdGlvbnMiLCJjYWxjdWxhdGVGcmFjdGlvbnMiLCJnZW5lcmF0aW9uQWN0aW9ucyIsImNhbGN1bGF0ZUdlbmVyYXRpb25zIiwicHJvTWFpbkFjdGlvbnMiLCJuZXdDaGlsZFNjb3JlIiwicHJvTWFpbiIsImNhbGN1bGF0ZVByb01haW4iLCJkZXNjZW5kYW50Q291bnQiLCJuZXdTY29yZVRyZWVQYXJ0aWFsIiwib2xkU2NvcmVUcmVlUGFydGlhbCIsImN1cnJlbnRTY29yZUlkIiwiY3VycmVudENsYWltSWQiLCJlZGdlcyIsImdldENsYWltRWRnZXNCeVBhcmVudElkIiwiZ2V0Q2hpbGRyZW5CeVNjb3JlSWQiLCJlZGdlIiwiZmluZCIsImNoaWxkSWQiLCJ1IiwiY3VycmVudFNjb3JlIiwib2xkQ2hpbGRTY29yZXMiLCJuZXdDaGlsZFNjb3JlcyIsIm5ld0Rlc2NlbmRhbnRDb3VudCIsIm9sZENoaWxkU2NvcmUiLCJuZXdTY29yZSIsIm5ld1Njb3JlRnJhZ21lbnQiLCJjaGlsZFNjb3JlcyIsInBhcmVudFNjb3JlIiwiZnJhY3Rpb24iLCJmcmFjdGlvblNpbXBsZSIsInRvdGFsUmVsZXZhbmNlIiwib2xkU2NvcmUiLCJyZWxldmFuY2UiLCJwZXJjZW50T2ZXZWlnaHQiLCJnZW5lcmF0aW9uIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7Ozs7Ozs7O0FBR0E7QUFDQTtBQUNBO0FBQ08sZUFBZUEscUJBQWYsQ0FBcUM7QUFBRUMsRUFBQUEsT0FBTyxHQUFHLEVBQVo7QUFBZ0JDLEVBQUFBLFVBQVUsR0FBRyxJQUFJQyx3Q0FBSixFQUE3QjtBQUF3REMsRUFBQUEsVUFBVSxHQUFHQztBQUFyRSxJQU94QyxFQVBHLEVBUUw7QUFDRSxRQUFNQyxZQUFzQixHQUFHLEVBQS9CO0FBQ0EsUUFBTUMsZUFBeUIsR0FBRyxFQUFsQztBQUNBLFFBQU1DLFlBQXNCLEdBQUcsRUFBL0I7QUFFQSxRQUFNTixVQUFVLENBQUNPLE1BQVgsQ0FBa0JSLE9BQWxCLENBQU47O0FBQ0EsT0FBSyxNQUFNUyxNQUFYLElBQXFCVCxPQUFyQixFQUE4QjtBQUUxQjtBQUNBLFFBQUlTLE1BQU0sQ0FBQ0MsSUFBUCxJQUFlLFdBQWYsSUFBOEJELE1BQU0sQ0FBQ0MsSUFBUCxJQUFlLGNBQWpELEVBQWlFO0FBQzdESixNQUFBQSxlQUFlLENBQUNLLElBQWhCLENBQXFCRixNQUFNLENBQUNHLE1BQTVCO0FBQ0g7O0FB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QTdCOztBQUVBLE9BQUssTUFBTXdELGFBQVgsSUFBNEJILGNBQTVCLEVBQTRDO0FBQ3hDO0FBQ0E7QUFDQTtBQUNBLFFBQUlHLGFBQWEsQ0FBQzdDLEdBQWQsS0FBc0IsSUFBMUIsRUFBK0I7QUFBQztBQUM1QixZQUFNMEIsYUFBYSxtQ0FBUW1CLGFBQVI7QUFBdUJsQixRQUFBQSxPQUFPLEVBQUVBO0FBQWhDLFFBQW5COztBQUNBckQsTUFBQUEsT0FBTyxDQUFDVyxJQUFSLENBQWEsSUFBSWtCLGNBQUosQ0FBV3VCLGFBQVgsRUFBMEJYLFNBQTFCLEVBQXFDLGNBQXJDLENBQWI7QUFDQSxZQUFNYSxnQkFBZ0IsQ0FBQ3JELFVBQUQsRUFBYXNFLGFBQWEsQ0FBQzlDLEVBQTNCLEVBQStCekIsT0FBL0IsRUFBd0NxRCxPQUF4QyxDQUF0QjtBQUNIOztBQUVELFFBQUlrQixhQUFhLENBQUM3QyxHQUFkLEtBQXNCLEtBQTFCLEVBQWdDO0FBQUM7QUFDN0IsWUFBTTBCLGFBQWEsbUNBQVFtQixhQUFSO0FBQXVCbEIsUUFBQUEsT0FBTyxFQUFFLENBQUNBO0FBQWpDLFFBQW5COztBQUNBckQsTUFBQUEsT0FBTyxDQUFDVyxJQUFSLENBQWEsSUFBSWtCLGNBQUosQ0FBV3VCLGFBQVgsRUFBMEJYLFNBQTFCLEVBQXFDLGNBQXJDLENBQWI7QUFDQSxZQUFNYSxnQkFBZ0IsQ0FBQ3JELFVBQUQsRUFBYXNFLGFBQWEsQ0FBQzlDLEVBQTNCLEVBQStCekIsT0FBL0IsRUFBd0MsQ0FBQ3FELE9BQXpDLENBQXRCO0FBQ0g7QUFFSjtBQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2NvcmUgfSBmcm9tIFwiLi9kYXRhTW9kZWxzL1Njb3JlXCI7XHJcbmltcG9ydCB7IGhhc0l0ZW1DaGFuZ2VkIH0gZnJvbSBcIi4vdXRpbHMvaGFzSXRlbUNoYW5nZWRcIjtcclxuaW1wb3J0IHsgQWN0aW9uIH0gZnJvbSBcIi4vZGF0YU1vZGVscy9BY3Rpb25cIjtcclxuaW1wb3J0IHsgaUNhbGN1bGF0ZVNjb3JlLCBjYWxjdWxhdGVTY29yZSB9IGZyb20gXCIuL2NhbGN1bGF0ZVNjb3JlXCI7XHJcbmltcG9ydCB7IGlSZXBvc2l0b3J5IH0gZnJvbSBcIi4vZGF0YU1vZGVscy9pUmVwb3NpdG9yeVwiO1xyXG5pbXBvcnQgeyBDbGFpbUVkZ2UgfSBmcm9tIFwiLi9kYXRhTW9kZWxzL0NsYWltRWRnZVwiO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5TG9jYWxQdXJlIH0gZnJvbSBcIi4vcmVwb3NpdG9yaWVzL1JlcG9zaXRvcnlMb2NhbFB1cmVcIjtcclxuaW1wb3J0IHsgU2NvcmVUcmVlIH0gZnJvbSBcIi5cIjtcclxuXHJcbi8qKlxyXG4gKiBDYWxjdWxhdGVzIHRoZSBzY29yZSBhY3Rpb25zIGJhc2VkIG9uIGEgbGlzdCBvZiBhY3Rpb25zXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2FsY3VsYXRlU2NvcmVBY3Rpb25zKHsgYWN0aW9ucyA9IFtdLCByZXBvc2l0b3J5ID0gbmV3IFJlcG9zaXRvcnlMb2NhbFB1cmUoKSwgY2FsY3VsYXRvciA9IGNhbGN1bGF0ZVNjb3JlIH06IHtcclxuICAgIC8qKiBBbiBhcnJheSBvZiBhY3Rpb25zLCB1c3VhbGx5IG9uIGNsYWltcyBvciBlZGdlcyB0aGF0IGluY2x1c2Ugbm8gc2NvcmVzKi9cclxuICAgIGFjdGlvbnM/OiBBY3Rpb25bXTtcclxuICAgIC8qKiBUaGUgcmVwb3NpdG9yeSB1c2VkIHRvIGdldCBjb250ZXh0IGZvciB0aGUgYWN0aW9ucyAqL1xyXG4gICAgcmVwb3NpdG9yeT86IGlSZXBvc2l0b3J5O1xyXG4gICAgLyoqIFRoZSBmdW5jdGlvbiB1c2VkIHRvIGNhbGN1bGF0ZSB0aGUgc2NvcmVzICovXHJcbiAgICBjYWxjdWxhdG9yPzogaUNhbGN1bGF0ZVNjb3JlO1xyXG59ID0ge30sXHJcbikge1xyXG4gICAgY29uc3Qgc2NvcmVBY3Rpb25zOiBBY3Rpb25bXSA9IFtdO1xyXG4gICAgY29uc3QgY2xhaW1JZHNUb1Njb3JlOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgY29uc3QgU2NvcmVUcmVlSWRzOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAgIGF3YWl0IHJlcG9zaXRvcnkubm90aWZ5KGFjdGlvbnMpO1xyXG4gICAgZm9yIChjb25zdCBhY3Rpb24gb2YgYWN0aW9ucykge1xyXG5cclxuICAgICAgICAvLyBmaW5kIGNsYWltcyB0aGF0IG1heSBuZWVkIHNjb3JlcyBjaGFuZ2VkXHJcbiAgICAgICAgaWYgKGFjdGlvbi50eXBlID09ICdhZGRfY2xhaW0nIHx8IGFjdGlvbi50eXBlID09ICdtb2RpZnlfY2xhaW0nKSB7XHJcbiAgICAgICAgICAgIGNsYWltSWRzVG9TY29yZS5wdXNoKGFjdGlvbi5kYXRhSWQpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT0gXCJhZGRfc2NvcmVcIikge1xyXG4gICAgICAgICAgICBsZXQgc2NvcmUgPSBhY3Rpb24ubmV3RGF0YSBhcyBTY29yZTtcclxuICAgICAgICAgICAgaWYgKCFzY29yZS5wYXJlbnRTY29yZUlkKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzY29yZVRlbXAgPSBhd2FpdCByZXBvc2l0b3J5LmdldFNjb3JlKGFjdGlvbi5kYXRhSWQpXHJcbiAgICAgICAgICAgICAgICBpZiAoc2NvcmVUZW1wKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2NvcmUgPSBzY29yZVRlbXA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNsYWltSWRzVG9TY29yZS5wdXNoKHNjb3JlLnNvdXJjZUNsYWltSWQpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvL0FkZCBzY29yZXMgaWYgZWRnZXMgYWRkcyBuZXcgY2hpbGRyZW4gdG8gY2xhaW1zIGluIHNjb3JlIHRyZWVzXHJcbiAgICAgICAgaWYgKGFjdGlvbi50eXBlID09ICdhZGRfY2xhaW1FZGdlJyB8fCBhY3Rpb24udHlwZSA9PSAnbW9kaWZ5X2NsYWltRWRnZScpIHtcclxuICAgICAgICAgICAgbGV0IGNsYWltRWRnZSA9IGFjdGlvbi5uZXdEYXRhIGFzIENsYWltRWRnZTtcclxuICAgICAgICAgICAgaWYgKCFjbGFpbUVkZ2UucGFyZW50SWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNsYWltRWRnZVRlbXAgPSBhd2FpdCByZXBvc2l0b3J5LmdldENsYWltRWRnZShhY3Rpb24uZGF0YUlkKVxyXG4gICAgICAgICAgICAgICAgaWYgKGNsYWltRWRnZVRlbXApIHtcclxuICAgICAgICAgICAgICAgICAgICBjbGFpbUVkZ2UgPSBjbGFpbUVkZ2VUZW1wO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNsYWltSWRzVG9TY29yZS5wdXNoKGNsYWltRWRnZS5wYXJlbnRJZClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vVE9ETzogSWYgYW4gZWRnZSBjaGFuZ2VzIHRoZW4gbW9kaWZ5IHRoZSBleGlzdGluZyBzY29yZXMgdG8gbWF0Y2hcclxuICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT0gJ21vZGlmeV9jbGFpbUVkZ2UnKSB7XHJcbiAgICAgICAgICAgIGxldCBjbGFpbUVkZ2UgPSBhd2FpdCByZXBvc2l0b3J5LmdldENsYWltRWRnZShhY3Rpb24uZGF0YUlkKVxyXG4gICAgICAgICAgICBjbGFpbUVkZ2UgPSB7IC4uLmNsYWltRWRnZSwgLi4uYWN0aW9uLm5ld0RhdGEgfVxyXG4gICAgICAgICAgICBpZiAoY2xhaW1FZGdlKSB7XHJcbiAgICAgICAgICAgICAgICBhY3Rpb24ubmV3RGF0YSBhcyBDbGFpbUVkZ2U7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzY29yZXMgPSBhd2FpdCByZXBvc2l0b3J5LmdldFNjb3Jlc0J5U291cmNlSWQoY2xhaW1FZGdlLmlkKVxyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBzY29yZSBvZiBzY29yZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAvL1RPRE86IFdoZXJlIHNob3VsZCBJIHB1dCB0aGlzPyBJdCBpcyBtb2RpZnlpbmcgYW0gb2JqZWN0LiBJZiBpdCBpcyByZWFjdGl2ZSBpIHNob3VsZCBqdXN0IGNoYW5nZSB0aGUgZGF0YS4gSWYgcHVyZSBpdCBzaG91bGQgYmUgYSBuZXcgb2JqZWN0LlxyXG4gICAgICAgICAgICAgICAgICAgIC8vRm9yIG5vdyBJIHdpbGwgbW9kaWZ5IGl0IGJ1dCBpdCBtYXkgbm90IHRyaWdnZXIgdXBkYXRlcyBpbiBhIHB1cmUgbGlicmFyeSAoUmVhY3QpXHJcbiAgICAgICAgICAgICAgICAgICAgLy9UaGlzIGNoYW5nZSBzaG91bGQgYWxzbyBwcm9iYWJseSBiZSBjZW50cmFsaXplZCBzb21ld2hlcmUgdG8gcmVkdWNlIHRoZSBjaGFuY2Ugb2YgaW5jb25zaXN0ZW50IGJ1Z3MuIEkgdGhpbmsgaXQgd2lsbCBoYXBwZW4gaW4gbXVsdGlwbGUgcGFjZXNcclxuICAgICAgICAgICAgICAgICAgICAvL05vcGUsIGl0IGlzIGFuIGFjdGlvbiBzbyBpdCBzaG91bGQgYWx3YXlzIGJlIGEgbmV3IG9iamVjdC4gSWYgaXQgZ29lcyBpbnRvIGEgcmVhY3RpdmUgcmVzcG9pdG9yeSB0aGVuIGl0IHdpbGwgbW9kaWZ5IHRoZSBhY3R1YWwgb2JqZWN0XHJcbiAgICAgICAgICAgICAgICAgICAgLy9TaG91bGQgSSBncm91cCB0aGVzZSBhY3Rpb25zIG9yIGp1c3QgdGhyb3cgdGhlbSBpbiBvbmUgYXQgYSB0aW1lIGxpa2UgSSBhbSBkb2luZ1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzY29yZS5wcm8gIT0gY2xhaW1FZGdlLnByb1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCBzY29yZS5hZmZlY3RzICE9IGNsYWltRWRnZS5hZmZlY3RzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IHNjb3JlLnByaW9yaXR5ICE9IGNsYWltRWRnZS5wcmlvcml0eVxyXG4gICAgICAgICAgICAgICAgICAgICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhY3Rpb24gPSBuZXcgQWN0aW9uKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBybzogY2xhaW1FZGdlLnBybyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmZmVjdHM6IGNsYWltRWRnZS5hZmZlY3RzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpb3JpdHk6IGNsYWltRWRnZS5wcmlvcml0eSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSwgc2NvcmUsIFwibW9kaWZ5X3Njb3JlXCIsIHNjb3JlLmlkKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzY29yZUFjdGlvbnMucHVzaChhY3Rpb24pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCByZXBvc2l0b3J5Lm5vdGlmeShbYWN0aW9uXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT0gJ2RlbGV0ZV9jbGFpbUVkZ2UnKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG9sZENsYWltRWRnZSA9IGFjdGlvbi5vbGREYXRhIGFzIENsYWltRWRnZTtcclxuICAgICAgICAgICAgY2xhaW1JZHNUb1Njb3JlLnB1c2gob2xkQ2xhaW1FZGdlLnBhcmVudElkKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGFjdGlvbi50eXBlID09ICdhZGRfc2NvcmVUcmVlJykge1xyXG4gICAgICAgICAgICBjb25zdCBzY29yZVRyZWUgPSBhY3Rpb24ubmV3RGF0YSBhcyBTY29yZVRyZWU7XHJcbiAgICAgICAgICAgIFNjb3JlVHJlZUlkcy5wdXNoKHNjb3JlVHJlZS5pZClcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8vV2FsayB1cCB0aGUgc2NvcmVzIGZvciBlYWNoIGNsYWltIHRvIHRoZSB0b3BcclxuICAgIGZvciAoY29uc3QgY2xhaW1JZCBvZiBjbGFpbUlkc1RvU2NvcmUpIHtcclxuICAgICAgICBmb3IgKGNvbnN0IGNsYWltU2NvcmUgb2YgYXdhaXQgcmVwb3NpdG9yeS5nZXRTY29yZXNCeVNvdXJjZUlkKGNsYWltSWQpKSB7XHJcbiAgICAgICAgICAgIFNjb3JlVHJlZUlkcy5wdXNoKGNsYWltU2NvcmUuc2NvcmVUcmVlSWQpXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vUmUtY2FsYyBhbGwgU2NvcmUgVHJlZXMgd2l0aCBwb3NzaWJsZSBjaGFuZ2VkIGNsYWltc1xyXG5cclxuICAgIGZvciAoY29uc3Qgc2NvcmVUcmVlSWQgb2YgU2NvcmVUcmVlSWRzKSB7XHJcbiAgICAgICAgY29uc3Qgc2NvcmVUcmVlID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRTY29yZVRyZWUoc2NvcmVUcmVlSWQpXHJcbiAgICAgICAgaWYgKHNjb3JlVHJlZSkge1xyXG4gICAgICAgICAgICBjb25zdCBtaXNzaW5nU2NvcmVBY3Rpb25zOiBBY3Rpb25bXSA9IFtdO1xyXG5cclxuICAgICAgICAgICAgbGV0IG1haW5TY29yZSA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0U2NvcmUoc2NvcmVUcmVlLnRvcFNjb3JlSWQpO1xyXG4gICAgICAgICAgICBpZiAoIW1haW5TY29yZSkge1xyXG4gICAgICAgICAgICAgICAgbWFpblNjb3JlID0gbmV3IFNjb3JlKHNjb3JlVHJlZS5zb3VyY2VDbGFpbUlkLCBzY29yZVRyZWUuaWQpO1xyXG4gICAgICAgICAgICAgICAgbWFpblNjb3JlLmlkID0gc2NvcmVUcmVlLnRvcFNjb3JlSWQ7XHJcbiAgICAgICAgICAgICAgICBtaXNzaW5nU2NvcmVBY3Rpb25zLnB1c2gobmV3IEFjdGlvbihtYWluU2NvcmUsIHVuZGVmaW5lZCwgXCJhZGRfc2NvcmVcIikpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBhd2FpdCBjcmVhdGVCbGFua01pc3NpbmdTY29yZXMocmVwb3NpdG9yeSwgc2NvcmVUcmVlLnRvcFNjb3JlSWQsIHNjb3JlVHJlZS5zb3VyY2VDbGFpbUlkIHx8IFwiXCIsIG1pc3NpbmdTY29yZUFjdGlvbnMsIHNjb3JlVHJlZUlkKVxyXG4gICAgICAgICAgICBpZiAobWlzc2luZ1Njb3JlQWN0aW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCByZXBvc2l0b3J5Lm5vdGlmeShtaXNzaW5nU2NvcmVBY3Rpb25zKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBzY29yZVRyZWVBY3Rpb25zOiBBY3Rpb25bXSA9IFtdO1xyXG4gICAgICAgICAgICBjb25zdCBuZXdNYWluU2NvcmUgPSBhd2FpdCBjYWxjdWxhdGVTY29yZURlc2NlbmRhbnRzKHJlcG9zaXRvcnksIG1haW5TY29yZSwgY2FsY3VsYXRvciwgc2NvcmVUcmVlQWN0aW9ucyk7XHJcbiAgICAgICAgICAgIGlmIChtaXNzaW5nU2NvcmVBY3Rpb25zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHJlcG9zaXRvcnkubm90aWZ5KHNjb3JlVHJlZUFjdGlvbnMpXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGZyYWN0aW9uQWN0aW9uczogQWN0aW9uW10gPSBbXTtcclxuICAgICAgICAgICAgYXdhaXQgY2FsY3VsYXRlRnJhY3Rpb25zKHJlcG9zaXRvcnksIG1haW5TY29yZSwgZnJhY3Rpb25BY3Rpb25zKVxyXG4gICAgICAgICAgICBpZiAoZnJhY3Rpb25BY3Rpb25zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHJlcG9zaXRvcnkubm90aWZ5KGZyYWN0aW9uQWN0aW9ucylcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgZ2VuZXJhdGlvbkFjdGlvbnM6IEFjdGlvbltdID0gW107XHJcbiAgICAgICAgICAgIGF3YWl0IGNhbGN1bGF0ZUdlbmVyYXRpb25zKHJlcG9zaXRvcnksIG1haW5TY29yZS5pZCwgZ2VuZXJhdGlvbkFjdGlvbnMsIDApXHJcbiAgICAgICAgICAgIGlmIChnZW5lcmF0aW9uQWN0aW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCByZXBvc2l0b3J5Lm5vdGlmeShnZW5lcmF0aW9uQWN0aW9ucylcclxuICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHByb01haW5BY3Rpb25zOiBBY3Rpb25bXSA9IFtdOyBcclxuICAgICAgICAgICAgY29uc3QgbmV3Q2hpbGRTY29yZSA9IHsgLi4ubWFpblNjb3JlLCBwcm9NYWluOiB0cnVlIH1cclxuICAgICAgICAgICAgcHJvTWFpbkFjdGlvbnMucHVzaChuZXcgQWN0aW9uKG5ld0NoaWxkU2NvcmUsIHVuZGVmaW5lZCwgXCJtb2RpZnlfc2NvcmVcIikpO1xyXG4gICAgICAgICAgICBhd2FpdCBjYWxjdWxhdGVQcm9NYWluKHJlcG9zaXRvcnksIG1haW5TY29yZS5pZCwgcHJvTWFpbkFjdGlvbnMsIHRydWUpXHJcbiAgICAgICAgICAgIGlmIChwcm9NYWluQWN0aW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCByZXBvc2l0b3J5Lm5vdGlmeShwcm9NYWluQWN0aW9ucylcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgc2NvcmVBY3Rpb25zLnB1c2goXHJcbiAgICAgICAgICAgICAgICAuLi5taXNzaW5nU2NvcmVBY3Rpb25zLFxyXG4gICAgICAgICAgICAgICAgLi4uc2NvcmVUcmVlQWN0aW9ucyxcclxuICAgICAgICAgICAgICAgIC4uLmZyYWN0aW9uQWN0aW9ucyxcclxuICAgICAgICAgICAgICAgIC4uLmdlbmVyYXRpb25BY3Rpb25zLFxyXG4gICAgICAgICAgICAgICAgLi4ucHJvTWFpbkFjdGlvbnMsXHJcbiAgICAgICAgICAgIClcclxuXHJcbiAgICAgICAgICAgIGlmIChzY29yZVRyZWUuZGVzY2VuZGFudENvdW50ICE9IG5ld01haW5TY29yZS5kZXNjZW5kYW50Q291bnQpIHtcclxuICAgICAgICAgICAgICAgIGxldCBuZXdTY29yZVRyZWVQYXJ0aWFsOiBQYXJ0aWFsPFNjb3JlVHJlZT4gPSB7IGRlc2NlbmRhbnRDb3VudDogbmV3TWFpblNjb3JlLmRlc2NlbmRhbnRDb3VudCB9XHJcbiAgICAgICAgICAgICAgICBsZXQgb2xkU2NvcmVUcmVlUGFydGlhbDogUGFydGlhbDxTY29yZVRyZWU+ID0geyBkZXNjZW5kYW50Q291bnQ6IHNjb3JlVHJlZS5kZXNjZW5kYW50Q291bnQgfVxyXG4gICAgICAgICAgICAgICAgc2NvcmVBY3Rpb25zLnB1c2goXHJcbiAgICAgICAgICAgICAgICAgICAgbmV3IEFjdGlvbihuZXdTY29yZVRyZWVQYXJ0aWFsLCBvbGRTY29yZVRyZWVQYXJ0aWFsLCBcIm1vZGlmeV9zY29yZVRyZWVcIiwgc2NvcmVUcmVlLmlkKVxyXG4gICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vVE9ETzogUmV2aWV3IHRoaXMgZGVjaXNpb246IEZlZWQgdGhlIHNjb3JlIGFjdGlvbnMgYmFjayBpbnRvIHRoZSByZXBvc2l0b3J5IHNvIHRoaXMgcmVwb3NpdG9yeSBpcyB1cCB0byBkYXRlIGluIGNhc2UgaXQgaXMgdXNlZCBcclxuICAgIGF3YWl0IHJlcG9zaXRvcnkubm90aWZ5KHNjb3JlQWN0aW9ucyk7XHJcblxyXG4gICAgcmV0dXJuIHNjb3JlQWN0aW9ucztcclxufVxyXG5cclxuLy9DcmVhdGUgQmxhbmsgTWlzc2luZyBTY29yZXNcclxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlQmxhbmtNaXNzaW5nU2NvcmVzKHJlcG9zaXRvcnk6IGlSZXBvc2l0b3J5LCBjdXJyZW50U2NvcmVJZDogc3RyaW5nLCBjdXJyZW50Q2xhaW1JZDogc3RyaW5nLCBhY3Rpb25zOiBBY3Rpb25bXSwgc2NvcmVUcmVlSWQ6IHN0cmluZykge1xyXG4gICAgY29uc3QgZWRnZXMgPSBhd2FpdCByZXBvc2l0b3J5LmdldENsYWltRWRnZXNCeVBhcmVudElkKGN1cnJlbnRDbGFpbUlkKVxyXG4gICAgY29uc3Qgc2NvcmVzID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRDaGlsZHJlbkJ5U2NvcmVJZChjdXJyZW50U2NvcmVJZClcclxuICAgIGZvciAoY29uc3QgZWRnZSBvZiBlZGdlcykge1xyXG4gICAgICAgIC8vc2VlIGlmIHRoZXJlIGlzIGEgbWF0Y2hpbmcgY2hpbGQgc2NvcmUgZm9yIHRoZSBjaGlsZCBlZGdlXHJcbiAgICAgICAgbGV0IHNjb3JlID0gc2NvcmVzLmZpbmQoKHsgc291cmNlQ2xhaW1JZCB9KSA9PiBzb3VyY2VDbGFpbUlkID09PSBlZGdlLmNoaWxkSWQpO1xyXG4gICAgICAgIGlmICghc2NvcmUpIHtcclxuICAgICAgICAgICAgLy9DcmVhdGUgYSBuZXcgU2NvcmUgYW5kIGF0dGFjaCBpdCB0byBpdCdzIHBhcmVudFxyXG4gICAgICAgICAgICBjb25zdCB1ID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICBzY29yZSA9IG5ldyBTY29yZShlZGdlLmNoaWxkSWQsIHNjb3JlVHJlZUlkLCBjdXJyZW50U2NvcmVJZCwgZWRnZS5pZCwgdW5kZWZpbmVkLCBlZGdlLnBybywgZWRnZS5hZmZlY3RzLCB1LCB1LCB1LCBlZGdlLnByaW9yaXR5KTtcclxuICAgICAgICAgICAgYWN0aW9ucy5wdXNoKG5ldyBBY3Rpb24oc2NvcmUsIHVuZGVmaW5lZCwgXCJhZGRfc2NvcmVcIiwgc2NvcmUuaWQpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy9SZWN1cnNlIGFuZCB0aHJvdWdoIGNoaWxkcmVuXHJcbiAgICAgICAgYXdhaXQgY3JlYXRlQmxhbmtNaXNzaW5nU2NvcmVzKHJlcG9zaXRvcnksIHNjb3JlLmlkLCBlZGdlLmNoaWxkSWQsIGFjdGlvbnMsIHNjb3JlVHJlZUlkKTtcclxuICAgIH1cclxufVxyXG5cclxuLy9UaGlzIGZ1bmN0aW9uIGFzc3VtZSB0aGF0IGFsbCBzY29yZXMgYWxyZWFkeSBleGlzdFxyXG5hc3luYyBmdW5jdGlvbiBjYWxjdWxhdGVTY29yZURlc2NlbmRhbnRzKHJlcG9zaXRvcnk6IGlSZXBvc2l0b3J5LCBjdXJyZW50U2NvcmU6IFNjb3JlLCBjYWxjdWxhdG9yOiBpQ2FsY3VsYXRlU2NvcmUgPSBjYWxjdWxhdGVTY29yZSwgYWN0aW9uczogQWN0aW9uW10pIHtcclxuICAgIGNvbnN0IG9sZENoaWxkU2NvcmVzID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRDaGlsZHJlbkJ5U2NvcmVJZChjdXJyZW50U2NvcmUuaWQpXHJcbiAgICBjb25zdCBuZXdDaGlsZFNjb3JlczogU2NvcmVbXSA9IFtdO1xyXG4gICAgbGV0IG5ld0Rlc2NlbmRhbnRDb3VudCA9IDA7XHJcblxyXG4gICAgZm9yIChjb25zdCBvbGRDaGlsZFNjb3JlIG9mIG9sZENoaWxkU2NvcmVzKSB7IC8vQ2FsY3VsYXRlIENoaWxkcmVuXHJcbiAgICAgICAgLy9UT0RPOiByZW1vdmUgYW55IHNjb3JlcyB0byBjYWxjdWxhdGUgYmFzZWQgb24gZm9ybXVsYXMgdGhhdCBleGNsdWRlIHNjb3Jlc1xyXG4gICAgICAgIGNvbnN0IG5ld1Njb3JlID0gYXdhaXQgY2FsY3VsYXRlU2NvcmVEZXNjZW5kYW50cyhyZXBvc2l0b3J5LCBvbGRDaGlsZFNjb3JlLCBjYWxjdWxhdG9yLCBhY3Rpb25zKTtcclxuICAgICAgICBuZXdDaGlsZFNjb3Jlcy5wdXNoKG5ld1Njb3JlKTtcclxuICAgICAgICBuZXdEZXNjZW5kYW50Q291bnQgKz0gbmV3U2NvcmUuZGVzY2VuZGFudENvdW50ICsgMTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBuZXdTY29yZUZyYWdtZW50ID0gY2FsY3VsYXRvcih7XHJcbiAgICAgICAgY2hpbGRTY29yZXM6IG5ld0NoaWxkU2NvcmVzLFxyXG4gICAgfSlcclxuXHJcbiAgICAvL3VwZGF0ZSBhbnkgbmV3Q2hpbGRTY29yZXMgdGhhdCBjaGFuZ2VkXHJcbiAgICBmb3IgKGNvbnN0IG5ld0NoaWxkU2NvcmUgb2YgbmV3Q2hpbGRTY29yZXMpIHtcclxuICAgICAgICAvLyBUT0RPOiBJcyB0aGlzIHNsb3cgYWNjZXNzaW5nIHRoZSBkYXRhIHN0b3JlIGFnYWluIGZvciB0aGlzIGRhdGEgb3IgZG8gd2UgYXNzdW1lIGl0IGlzIGNhY2hlZCBpZiBpdCBpcyBpbiBhbiBleHRlcm5hbCBEQlxyXG4gICAgICAgIGNvbnN0IG9sZENoaWxkU2NvcmUgPSBhd2FpdCByZXBvc2l0b3J5LmdldFNjb3JlKG5ld0NoaWxkU2NvcmUuaWQpO1xyXG4gICAgICAgIGlmIChvbGRDaGlsZFNjb3JlICYmIGhhc0l0ZW1DaGFuZ2VkKG9sZENoaWxkU2NvcmUsIG5ld0NoaWxkU2NvcmUpKSB7XHJcbiAgICAgICAgICAgIGFjdGlvbnMucHVzaChuZXcgQWN0aW9uKG5ld0NoaWxkU2NvcmUsIHVuZGVmaW5lZCwgXCJtb2RpZnlfc2NvcmVcIikpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvL1RPRE86IE1vZGlmeSB0aGUgbmV3U2NvcmUgYmFzZWQgb24gYW55IGZvcm11bGFzXHJcbiAgICBjb25zdCBuZXdTY29yZSA9IHtcclxuICAgICAgICAuLi5jdXJyZW50U2NvcmUsXHJcbiAgICAgICAgLi4ubmV3U2NvcmVGcmFnbWVudCxcclxuICAgICAgICBkZXNjZW5kYW50Q291bnQ6IG5ld0Rlc2NlbmRhbnRDb3VudFxyXG4gICAgfVxyXG4gICAgaWYgKGhhc0l0ZW1DaGFuZ2VkKGN1cnJlbnRTY29yZSwgbmV3U2NvcmUpKSB7XHJcbiAgICAgICAgYWN0aW9ucy5wdXNoKG5ldyBBY3Rpb24obmV3U2NvcmUsIHVuZGVmaW5lZCwgXCJtb2RpZnlfc2NvcmVcIikpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBuZXdTY29yZTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gY2FsY3VsYXRlRnJhY3Rpb25zKHJlcG9zaXRvcnk6IGlSZXBvc2l0b3J5LCBwYXJlbnRTY29yZTogUGFydGlhbDxTY29yZT4sIGFjdGlvbnM6IEFjdGlvbltdKSB7XHJcbiAgICBpZiAocGFyZW50U2NvcmUuaWQgIT0gdW5kZWZpbmVkICYmXHJcbiAgICAgICAgcGFyZW50U2NvcmUuZnJhY3Rpb24gIT0gdW5kZWZpbmVkICYmXHJcbiAgICAgICAgcGFyZW50U2NvcmUuZnJhY3Rpb25TaW1wbGUgIT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgY29uc3Qgb2xkQ2hpbGRTY29yZXMgPSBhd2FpdCByZXBvc2l0b3J5LmdldENoaWxkcmVuQnlTY29yZUlkKHBhcmVudFNjb3JlLmlkKVxyXG5cclxuICAgICAgICAvL0NvdW50IHVwIHRvdGFsIHJlbGV2YW5jZVxyXG4gICAgICAgIGxldCB0b3RhbFJlbGV2YW5jZSA9IDBcclxuICAgICAgICBmb3IgKGNvbnN0IG9sZFNjb3JlIG9mIG9sZENoaWxkU2NvcmVzKSB7XHJcbiAgICAgICAgICAgIGlmIChvbGRTY29yZS5hZmZlY3RzID09PSBcImNvbmZpZGVuY2VcIikge1xyXG4gICAgICAgICAgICAgICAgdG90YWxSZWxldmFuY2UgKz0gb2xkU2NvcmUucmVsZXZhbmNlXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRvdGFsUmVsZXZhbmNlID09PSAwKSB7XHJcbiAgICAgICAgICAgIHRvdGFsUmVsZXZhbmNlID0gMTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAoY29uc3Qgb2xkQ2hpbGRTY29yZSBvZiBvbGRDaGlsZFNjb3Jlcykge1xyXG4gICAgICAgICAgICBjb25zdCBuZXdDaGlsZFNjb3JlOiBQYXJ0aWFsPFNjb3JlPiA9IHtcclxuICAgICAgICAgICAgICAgIC4uLm9sZENoaWxkU2NvcmUsXHJcbiAgICAgICAgICAgICAgICBmcmFjdGlvblNpbXBsZTogKG9sZENoaWxkU2NvcmUucmVsZXZhbmNlIC8gdG90YWxSZWxldmFuY2UpICogcGFyZW50U2NvcmUuZnJhY3Rpb25TaW1wbGUsXHJcbiAgICAgICAgICAgICAgICBmcmFjdGlvbjogcGFyZW50U2NvcmUuZnJhY3Rpb24gKiBvbGRDaGlsZFNjb3JlLnBlcmNlbnRPZldlaWdodCxcclxuICAgICAgICAgICAgICAgIC8vIHBhcmVudEZyYWN0aW9uU2ltcGxlOiBwYXJlbnRTY29yZS5mcmFjdGlvblNpbXBsZSxcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAobmV3Q2hpbGRTY29yZS5mcmFjdGlvblNpbXBsZSAhPSBvbGRDaGlsZFNjb3JlLmZyYWN0aW9uU2ltcGxlIHx8XHJcbiAgICAgICAgICAgICAgICBuZXdDaGlsZFNjb3JlLmZyYWN0aW9uICE9IG9sZENoaWxkU2NvcmUuZnJhY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgIGFjdGlvbnMucHVzaChuZXcgQWN0aW9uKG5ld0NoaWxkU2NvcmUsIHVuZGVmaW5lZCwgXCJtb2RpZnlfc2NvcmVcIikpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGF3YWl0IGNhbGN1bGF0ZUZyYWN0aW9ucyhyZXBvc2l0b3J5LCBuZXdDaGlsZFNjb3JlLCBhY3Rpb25zKTtcclxuXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxufVxyXG5cclxuLy8gVE9ETzogZmFjdG9yIG91dCBkdXBsaWNhdGUgY29kZSBvZiB0aGVzZSBjYWxjdWxhdGUgZnVuY3Rpb25zLiBtYXliZSBtYWtlIGFuIGFycmF5IG9mIGl0ZW1zIHRvIHByb2Nlc3MuLi5cclxuYXN5bmMgZnVuY3Rpb24gY2FsY3VsYXRlR2VuZXJhdGlvbnMocmVwb3NpdG9yeTogaVJlcG9zaXRvcnksIHBhcmVudFNjb3JlSWQ6IHN0cmluZywgYWN0aW9uczogQWN0aW9uW10sIGdlbmVyYXRpb246IG51bWJlcikge1xyXG4gICAgY29uc3Qgb2xkQ2hpbGRTY29yZXMgPSBhd2FpdCByZXBvc2l0b3J5LmdldENoaWxkcmVuQnlTY29yZUlkKHBhcmVudFNjb3JlSWQpXHJcbiAgICBnZW5lcmF0aW9uKys7XHJcblxyXG4gICAgZm9yIChjb25zdCBvbGRDaGlsZFNjb3JlIG9mIG9sZENoaWxkU2NvcmVzKSB7XHJcbiAgICAgICAgaWYgKG9sZENoaWxkU2NvcmUuZ2VuZXJhdGlvbiAhPSBnZW5lcmF0aW9uKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5ld0NoaWxkU2NvcmUgPSB7IC4uLm9sZENoaWxkU2NvcmUsIGdlbmVyYXRpb246IGdlbmVyYXRpb24gfVxyXG4gICAgICAgICAgICBhY3Rpb25zLnB1c2gobmV3IEFjdGlvbihuZXdDaGlsZFNjb3JlLCB1bmRlZmluZWQsIFwibW9kaWZ5X3Njb3JlXCIpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYXdhaXQgY2FsY3VsYXRlR2VuZXJhdGlvbnMocmVwb3NpdG9yeSwgb2xkQ2hpbGRTY29yZS5pZCwgYWN0aW9ucywgZ2VuZXJhdGlvbilcclxuICAgIH1cclxufVxyXG5cclxuLy8gVE9ETzogZmFjdG9yIG91dCBkdXBsaWNhdGUgY29kZSBvZiB0aGVzZSBjYWxjdWxhdGUgZnVuY3Rpb25zLiBtYXliZSBtYWtlIGFuIGFycmF5IG9mIGl0ZW1zIHRvIHByb2Nlc3MuLi5cclxuYXN5bmMgZnVuY3Rpb24gY2FsY3VsYXRlUHJvTWFpbihyZXBvc2l0b3J5OiBpUmVwb3NpdG9yeSwgcGFyZW50U2NvcmVJZDogc3RyaW5nLCBhY3Rpb25zOiBBY3Rpb25bXSwgcHJvTWFpbjogYm9vbGVhbikge1xyXG4gICAgY29uc3Qgb2xkQ2hpbGRTY29yZXMgPSBhd2FpdCByZXBvc2l0b3J5LmdldENoaWxkcmVuQnlTY29yZUlkKHBhcmVudFNjb3JlSWQpXHJcblxyXG4gICAgZm9yIChjb25zdCBvbGRDaGlsZFNjb3JlIG9mIG9sZENoaWxkU2NvcmVzKSB7XHJcbiAgICAgICAgLy8gY29uc3QgbmV3Q2hpbGRTY29yZSA9IHsgLi4ub2xkQ2hpbGRTY29yZSwgcHJvTWFpbjogZmFsc2UgfVxyXG4gICAgICAgIC8vIGFjdGlvbnMucHVzaChuZXcgQWN0aW9uKG5ld0NoaWxkU2NvcmUsIHVuZGVmaW5lZCwgXCJtb2RpZnlfc2NvcmVcIikpO1xyXG4gICAgICAgIC8vIGF3YWl0IGNhbGN1bGF0ZVByb01haW4ocmVwb3NpdG9yeSwgb2xkQ2hpbGRTY29yZS5pZCwgYWN0aW9ucywgcHJvTWFpbilcclxuICAgICAgICBpZiAob2xkQ2hpbGRTY29yZS5wcm8gPT09IHRydWUpey8vICYmIG9sZENoaWxkU2NvcmUucHJvTWFpbiAhPT0gcHJvTWFpbikge1xyXG4gICAgICAgICAgICBjb25zdCBuZXdDaGlsZFNjb3JlID0geyAuLi5vbGRDaGlsZFNjb3JlLCBwcm9NYWluOiBwcm9NYWluIH1cclxuICAgICAgICAgICAgYWN0aW9ucy5wdXNoKG5ldyBBY3Rpb24obmV3Q2hpbGRTY29yZSwgdW5kZWZpbmVkLCBcIm1vZGlmeV9zY29yZVwiKSk7XHJcbiAgICAgICAgICAgIGF3YWl0IGNhbGN1bGF0ZVByb01haW4ocmVwb3NpdG9yeSwgb2xkQ2hpbGRTY29yZS5pZCwgYWN0aW9ucywgcHJvTWFpbilcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChvbGRDaGlsZFNjb3JlLnBybyA9PT0gZmFsc2Upey8vICYmIG9sZENoaWxkU2NvcmUucHJvTWFpbiA9PT0gcHJvTWFpbikge1xyXG4gICAgICAgICAgICBjb25zdCBuZXdDaGlsZFNjb3JlID0geyAuLi5vbGRDaGlsZFNjb3JlLCBwcm9NYWluOiAhcHJvTWFpbiB9XHJcbiAgICAgICAgICAgIGFjdGlvbnMucHVzaChuZXcgQWN0aW9uKG5ld0NoaWxkU2NvcmUsIHVuZGVmaW5lZCwgXCJtb2RpZnlfc2NvcmVcIikpO1xyXG4gICAgICAgICAgICBhd2FpdCBjYWxjdWxhdGVQcm9NYWluKHJlcG9zaXRvcnksIG9sZENoaWxkU2NvcmUuaWQsIGFjdGlvbnMsICFwcm9NYWluKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcbn1cclxuIl19
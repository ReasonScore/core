"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.calculateScoreActions = calculateScoreActions;

var _Score = require("./dataModels/Score");

var _Action = require("./dataModels/Action");

var _calculateScore = require("./calculateScore");

var _RepositoryLocalPure = require("./repositories/RepositoryLocalPure");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Calculates the score actions based on a list of actions
 */
async function calculateScoreActions({
  actions = [],
  repository = new _RepositoryLocalPure.RepositoryLocalPure(),
  calculator = _calculateScore.calculateScore
} = {}) {
  const scoreActions = [];
  const claimIdsToScore = [];
  const ScoreTreeIds = [];
  await repository.notify(actions);

  for (const action of actions) {
    // find claims that may need scores changed
    if (action.type == 'add_claim' || action.type == 'modify_claim') {
      claimIdsToScore.push(action.dataId);
    }

    if (action.type == "add_score") {
      let score = action.newData;

      if (!score.parentScoreId) {
        const scoreTemp = await repository.getScore(action.dataId);

        if (scoreTemp) {
          score = scoreTemp;
        }
      }

      claimIdsToScore.push(score.sourceClaimId);
    } //Add scores if edges adds new children to claims in score trees


    if (action.type == 'add_claimEdge' || action.type == 'modify_claimEdge') {
      let claimEdge = action.newData;

      if (!claimEdge.parentId) {
        const claimEdgeTemp = await repository.getClaimEdge(action.dataId);

        if (claimEdgeTemp) {
          claimEdge = claimEdgeTemp;
        }
      }

      claimIdsToScore.push(claimEdge.parentId);
    } //TODO: If an edge changes then modify the existing scores to match


    if (action.type == 'modify_claimEdge') {
      let claimEdge = await repository.getClaimEdge(action.dataId);
      claimEdge = _objectSpread({}, claimEdge, {}, action.newData);

      if (claimEdge) {
        action.newData;
        const scores = await repository.getScoresBySourceId(claimEdge.id);

        for (const score of scores) {
          //TODO: Where should I put this? It is modifying am object. If it is reactive i should just change the data. If pure it should be a new object.
          //For now I will modify it but it may not trigger updates in a pure library (React)
          //This change should also probably be centralized somewhere to reduce the chance of inconsistent bugs. I think it will happen in multiple paces
          //Nope, it is an action so it should always be a new object. If it goes into a reactive respoitory then it will modify the actual object
          //Should I group these actions or just throw them in one at a time like I am doing
          if (score.pro != claimEdge.pro || score.affects != claimEdge.affects) {
            const action = new _Action.Action({
              pro: claimEdge.pro,
              affects: claimEdge.affects,
              priority: claimEdge.priority
            }, score, "modify_score", score.id);
            scoreActions.push(action);
            await repository.notify([action]);
          }
        }
      }
    }

    if (action.type == 'delete_claimEdge') {
      const oldClaimEdge = action.oldData;
      claimIdsToScore.push(oldClaimEdge.parentId);
    }

    if (action.type == 'add_scoreTree') {
      const scoreTree = action.newData;
      ScoreTreeIds.push(scoreTree.id);
    }
  } //Walk up the scores for each claim to the top


  for (const claimId of claimIdsToScore) {
    for (const claimScore of await repository.getScoresBySourceId(claimId)) {
      ScoreTreeIds.push(claimScore.scoreTreeId);
    }
  } //Re-calc all Score Trees with possible changed claims


  for (const scoreTreeId of ScoreTreeIds) {
    const scoreTree = await repository.getScoreTree(scoreTreeId);

    if (scoreTree) {
      const missingScoreActions = [];
      let topScore = await repository.getScore(scoreTree.topScoreId);

      if (!topScore) {
        topScore = new _Score.Score(scoreTree.sourceClaimId, scoreTree.id);
        topScore.id = scoreTree.topScoreId;
        missingScoreActions.push(new _Action.Action(topScore, undefined, "add_score"));
      }

      await createBlankMissingScores(repository, scoreTree.topScoreId, scoreTree.sourceClaimId || "", missingScoreActions, scoreTreeId);

      if (missingScoreActions.length > 0) {
        await repository.notify(missingScoreActions);
      }

      const scoreTreeActions = [];
      await calculateScoreTree(repository, topScore, calculator, scoreTreeActions);

      if (missingScoreActions.length > 0) {
        await repository.notify(scoreTreeActions);
      }

      const fractionActions = [];
      await calculateFractions(repository, topScore, fractionActions);

      if (fractionActions.length > 0) {
        await repository.notify(fractionActions);
      }

      debugger;
      scoreActions.push(...missingScoreActions, ...scoreTreeActions, ...fractionActions);
    }
  } //TODO: Review this decision: Feed the score actions back into the repository so this repository is up to date in case it is used 


  await repository.notify(scoreActions);
  return scoreActions;
} //Create Blank Missing Scores


async function createBlankMissingScores(repository, currentScoreId, currentClaimId, actions, scoreTreeId) {
  const edges = await repository.getClaimEdgesByParentId(currentClaimId);
  const scores = await repository.getChildrenByScoreId(currentScoreId);

  for (const edge of edges) {
    //see if there is a matching child score for the child edge
    let score = scores.find(({
      sourceClaimId
    }) => sourceClaimId === edge.childId);

    if (!score) {
      //Create a new Score and attach it to it's parent
      const u = undefined;
      score = new _Score.Score(edge.childId, scoreTreeId, currentScoreId, edge.id, undefined, edge.pro, edge.affects, u, u, u, edge.priority);
      actions.push(new _Action.Action(score, undefined, "add_score", score.id));
    } //Recurse and through children


    await createBlankMissingScores(repository, score.id, edge.childId, actions, scoreTreeId);
  }
} //This function assume that all scores already exist


async function calculateScoreTree(repository, currentScore, calculator = _calculateScore.calculateScore, actions) {
  const oldScores = await repository.getChildrenByScoreId(currentScore.id);
  const newScores = [];
  let newDescendantCount = 0;

  for (const oldScore of oldScores) {
    //Calculate Children
    //TODO: remove any scores to calculate based on formulas that exclude scores
    const newScore = await calculateScoreTree(repository, oldScore, calculator, actions);
    newScores.push(newScore);
    newDescendantCount += newScore.descendantCount + 1;
  }

  const newScoreFragment = calculator({
    childScores: newScores
  }); //TODO: Modify the newScore based on any formulas

  const newScore = _objectSpread({}, currentScore, {}, newScoreFragment, {
    descendantCount: newDescendantCount
  });

  if ((0, _Score.differentScores)(currentScore, newScore)) {
    actions.push(new _Action.Action(newScore, undefined, "modify_score", newScore.id));
  }

  return newScore;
}

async function calculateFractions(repository, parentScore, actions) {
  const oldChildScores = await repository.getChildrenByScoreId(parentScore.id);
  const newScores = []; //Count up total relevance

  let totalRelevance = 0;

  for (const oldScore of oldChildScores) {
    if (oldScore.affects = "confidence") {
      totalRelevance += oldScore.relevance;
    }
  }

  if (totalRelevance === 0) {
    totalRelevance = 1;
  }

  debugger;

  for (const oldChildScore of oldChildScores) {
    const newChildFraction = oldChildScore.relevance / totalRelevance * parentScore.fraction;

    const newChildScore = _objectSpread({}, oldChildScore, {
      fraction: newChildFraction
    });

    if (newChildFraction != oldChildScore.fraction) {
      actions.push(new _Action.Action(newChildScore, undefined, "modify_score"));
    }

    await calculateFractions(repository, newChildScore, actions);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWxjdWxhdGVTY29yZUFjdGlvbnMudHMiXSwibmFtZXMiOlsiY2FsY3VsYXRlU2NvcmVBY3Rpb25zIiwiYWN0aW9ucyIsInJlcG9zaXRvcnkiLCJSZXBvc2l0b3J5TG9jYWxQdXJlIiwiY2FsY3VsYXRvciIsImNhbGN1bGF0ZVNjb3JlIiwic2NvcmVBY3Rpb25zIiwiY2xhaW1JZHNUb1Njb3JlIiwiU2NvcmVUcmVlSWRzIiwibm90aWZ5IiwiYWN0aW9uIiwidHlwZSIsInB1c2giLCJkYXRhSWQiLCJzY29yZSIsIm5ld0RhdGEiLCJwYXJlbnRTY29yZUlkIiwic2NvcmVUZW1wIiwiZ2V0U2NvcmUiLCJzb3VyY2VDbGFpbUlkIiwiY2xhaW1FZGdlIiwicGFyZW50SWQiLCJjbGFpbUVkZ2VUZW1wIiwiZ2V0Q2xhaW1FZGdlIiwic2NvcmVzIiwiZ2V0U2NvcmVzQnlTb3VyY2VJZCIsImlkIiwicHJvIiwiYWZmZWN0cyIsIkFjdGlvbiIsInByaW9yaXR5Iiwib2xkQ2xhaW1FZGdlIiwib2xkRGF0YSIsInNjb3JlVHJlZSIsImNsYWltSWQiLCJjbGFpbVNjb3JlIiwic2NvcmVUcmVlSWQiLCJnZXRTY29yZVRyZWUiLCJtaXNzaW5nU2NvcmVBY3Rpb25zIiwidG9wU2NvcmUiLCJ0b3BTY29yZUlkIiwiU2NvcmUiLCJ1bmRlZmluZWQiLCJjcmVhdGVCbGFua01pc3NpbmdTY29yZXMiLCJsZW5ndGgiLCJzY29yZVRyZWVBY3Rpb25zIiwiY2FsY3VsYXRlU2NvcmVUcmVlIiwiZnJhY3Rpb25BY3Rpb25zIiwiY2FsY3VsYXRlRnJhY3Rpb25zIiwiY3VycmVudFNjb3JlSWQiLCJjdXJyZW50Q2xhaW1JZCIsImVkZ2VzIiwiZ2V0Q2xhaW1FZGdlc0J5UGFyZW50SWQiLCJnZXRDaGlsZHJlbkJ5U2NvcmVJZCIsImVkZ2UiLCJmaW5kIiwiY2hpbGRJZCIsInUiLCJjdXJyZW50U2NvcmUiLCJvbGRTY29yZXMiLCJuZXdTY29yZXMiLCJuZXdEZXNjZW5kYW50Q291bnQiLCJvbGRTY29yZSIsIm5ld1Njb3JlIiwiZGVzY2VuZGFudENvdW50IiwibmV3U2NvcmVGcmFnbWVudCIsImNoaWxkU2NvcmVzIiwicGFyZW50U2NvcmUiLCJvbGRDaGlsZFNjb3JlcyIsInRvdGFsUmVsZXZhbmNlIiwicmVsZXZhbmNlIiwib2xkQ2hpbGRTY29yZSIsIm5ld0NoaWxkRnJhY3Rpb24iLCJmcmFjdGlvbiIsIm5ld0NoaWxkU2NvcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFHQTs7Ozs7Ozs7QUFHQTs7O0FBR08sZUFBZUEscUJBQWYsQ0FBcUM7QUFBRUMsRUFBQUEsT0FBTyxHQUFHLEVBQVo7QUFBZ0JDLEVBQUFBLFVBQVUsR0FBRyxJQUFJQyx3Q0FBSixFQUE3QjtBQUF3REMsRUFBQUEsVUFBVSxHQUFHQztBQUFyRSxJQU94QyxFQVBHLEVBUUw7QUFDRSxRQUFNQyxZQUFzQixHQUFHLEVBQS9CO0FBQ0EsUUFBTUMsZUFBeUIsR0FBRyxFQUFsQztBQUNBLFFBQU1DLFlBQXNCLEdBQUcsRUFBL0I7QUFFQSxRQUFNTixVQUFVLENBQUNPLE1BQVgsQ0FBa0JSLE9BQWxCLENBQU47O0FBQ0EsT0FBSyxNQUFNUyxNQUFYLElBQXFCVCxPQUFyQixFQUE4QjtBQUUxQjtBQUNBLFFBQUlTLE1BQU0sQ0FBQ0MsSUFBUCxJQUFlLFdBQWYsSUFBOEJELE1BQU0sQ0FBQ0MsSUFBUCxJQUFlLGNBQWpELEVBQWlFO0FBQzdESixNQUFBQSxlQUFlLENBQUNLLElBQWhCLENBQXFCRixNQUFNLENBQUNHLE1BQTVCO0FBQ0g7O0FBRUQsUUFBSUgsTUFBTSxDQUFDQyxJQUFQLElBQWUsV0FBbkIsRUFBZ0M7QUFDNUIsVUFBSUcsS0FBSyxHQUFHSixNQUFNLENBQUNLLE9BQW5COztBQUNBLFVBQUksQ0FBQ0QsS0FBSyxDQUFDRSxhQUFYLEVBQTBCO0FBQ3RCLGNBQU1DLFNBQVMsR0FBRyxNQUFNZixVQUFVLENBQUNnQixRQUFYLENBQW9CUixNQUFNLENBQUNHLE1BQTNCLENB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Z0JBQWdCLEdBQUlELGFBQWEsQ0FBQ0QsU0FBZCxHQUEwQkQsY0FBM0IsR0FBNkNGLFdBQVcsQ0FBQ00sUUFBbEY7O0FBQ0EsVUFBTUMsYUFBYSxxQkFBUUgsYUFBUjtBQUF1QkUsTUFBQUEsUUFBUSxFQUFFRDtBQUFqQyxNQUFuQjs7QUFDQSxRQUFJQSxnQkFBZ0IsSUFBSUQsYUFBYSxDQUFDRSxRQUF0QyxFQUFnRDtBQUM1Q3hFLE1BQUFBLE9BQU8sQ0FBQ1csSUFBUixDQUFhLElBQUlpQixjQUFKLENBQVc2QyxhQUFYLEVBQTBCaEMsU0FBMUIsRUFBcUMsY0FBckMsQ0FBYjtBQUNIOztBQUNELFVBQU1NLGtCQUFrQixDQUFDOUMsVUFBRCxFQUFhd0UsYUFBYixFQUE0QnpFLE9BQTVCLENBQXhCO0FBRUg7QUFDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNjb3JlLCBkaWZmZXJlbnRTY29yZXMsIGlTY29yZSB9IGZyb20gXCIuL2RhdGFNb2RlbHMvU2NvcmVcIjtcclxuaW1wb3J0IHsgQWN0aW9uIH0gZnJvbSBcIi4vZGF0YU1vZGVscy9BY3Rpb25cIjtcclxuaW1wb3J0IHsgaUNhbGN1bGF0ZVNjb3JlLCBjYWxjdWxhdGVTY29yZSB9IGZyb20gXCIuL2NhbGN1bGF0ZVNjb3JlXCI7XHJcbmltcG9ydCB7IGlSZXBvc2l0b3J5IH0gZnJvbSBcIi4vZGF0YU1vZGVscy9pUmVwb3NpdG9yeVwiO1xyXG5pbXBvcnQgeyBDbGFpbUVkZ2UsIGlDbGFpbUVkZ2UgfSBmcm9tIFwiLi9kYXRhTW9kZWxzL0NsYWltRWRnZVwiO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5TG9jYWxQdXJlIH0gZnJvbSBcIi4vcmVwb3NpdG9yaWVzL1JlcG9zaXRvcnlMb2NhbFB1cmVcIjtcclxuaW1wb3J0IHsgU2NvcmVUcmVlIH0gZnJvbSBcIi5cIjtcclxuXHJcbi8qKlxyXG4gKiBDYWxjdWxhdGVzIHRoZSBzY29yZSBhY3Rpb25zIGJhc2VkIG9uIGEgbGlzdCBvZiBhY3Rpb25zXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2FsY3VsYXRlU2NvcmVBY3Rpb25zKHsgYWN0aW9ucyA9IFtdLCByZXBvc2l0b3J5ID0gbmV3IFJlcG9zaXRvcnlMb2NhbFB1cmUoKSwgY2FsY3VsYXRvciA9IGNhbGN1bGF0ZVNjb3JlIH06IHtcclxuICAgIC8qKiBBbiBhcnJheSBvZiBhY3Rpb25zLCB1c3VhbGx5IG9uIGNsYWltcyBvciBlZGdlcyB0aGF0IGluY2x1c2Ugbm8gc2NvcmVzKi9cclxuICAgIGFjdGlvbnM/OiBBY3Rpb25bXTtcclxuICAgIC8qKiBUaGUgcmVwb3NpdG9yeSB1c2VkIHRvIGdldCBjb250ZXh0IGZvciB0aGUgYWN0aW9ucyAqL1xyXG4gICAgcmVwb3NpdG9yeT86IGlSZXBvc2l0b3J5O1xyXG4gICAgLyoqIFRoZSBmdW5jdGlvbiB1c2VkIHRvIGNhbGN1bGF0ZSB0aGUgc2NvcmVzICovXHJcbiAgICBjYWxjdWxhdG9yPzogaUNhbGN1bGF0ZVNjb3JlO1xyXG59ID0ge30sXHJcbikge1xyXG4gICAgY29uc3Qgc2NvcmVBY3Rpb25zOiBBY3Rpb25bXSA9IFtdO1xyXG4gICAgY29uc3QgY2xhaW1JZHNUb1Njb3JlOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgY29uc3QgU2NvcmVUcmVlSWRzOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAgIGF3YWl0IHJlcG9zaXRvcnkubm90aWZ5KGFjdGlvbnMpO1xyXG4gICAgZm9yIChjb25zdCBhY3Rpb24gb2YgYWN0aW9ucykge1xyXG5cclxuICAgICAgICAvLyBmaW5kIGNsYWltcyB0aGF0IG1heSBuZWVkIHNjb3JlcyBjaGFuZ2VkXHJcbiAgICAgICAgaWYgKGFjdGlvbi50eXBlID09ICdhZGRfY2xhaW0nIHx8IGFjdGlvbi50eXBlID09ICdtb2RpZnlfY2xhaW0nKSB7XHJcbiAgICAgICAgICAgIGNsYWltSWRzVG9TY29yZS5wdXNoKGFjdGlvbi5kYXRhSWQpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT0gXCJhZGRfc2NvcmVcIikge1xyXG4gICAgICAgICAgICBsZXQgc2NvcmUgPSBhY3Rpb24ubmV3RGF0YSBhcyBpU2NvcmU7XHJcbiAgICAgICAgICAgIGlmICghc2NvcmUucGFyZW50U2NvcmVJZCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2NvcmVUZW1wID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRTY29yZShhY3Rpb24uZGF0YUlkKVxyXG4gICAgICAgICAgICAgICAgaWYgKHNjb3JlVGVtcCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNjb3JlID0gc2NvcmVUZW1wO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjbGFpbUlkc1RvU2NvcmUucHVzaChzY29yZS5zb3VyY2VDbGFpbUlkKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy9BZGQgc2NvcmVzIGlmIGVkZ2VzIGFkZHMgbmV3IGNoaWxkcmVuIHRvIGNsYWltcyBpbiBzY29yZSB0cmVlc1xyXG4gICAgICAgIGlmIChhY3Rpb24udHlwZSA9PSAnYWRkX2NsYWltRWRnZScgfHwgYWN0aW9uLnR5cGUgPT0gJ21vZGlmeV9jbGFpbUVkZ2UnKSB7XHJcbiAgICAgICAgICAgIGxldCBjbGFpbUVkZ2UgPSBhY3Rpb24ubmV3RGF0YSBhcyBpQ2xhaW1FZGdlO1xyXG4gICAgICAgICAgICBpZiAoIWNsYWltRWRnZS5wYXJlbnRJZCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY2xhaW1FZGdlVGVtcCA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0Q2xhaW1FZGdlKGFjdGlvbi5kYXRhSWQpXHJcbiAgICAgICAgICAgICAgICBpZiAoY2xhaW1FZGdlVGVtcCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNsYWltRWRnZSA9IGNsYWltRWRnZVRlbXA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2xhaW1JZHNUb1Njb3JlLnB1c2goY2xhaW1FZGdlLnBhcmVudElkKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy9UT0RPOiBJZiBhbiBlZGdlIGNoYW5nZXMgdGhlbiBtb2RpZnkgdGhlIGV4aXN0aW5nIHNjb3JlcyB0byBtYXRjaFxyXG4gICAgICAgIGlmIChhY3Rpb24udHlwZSA9PSAnbW9kaWZ5X2NsYWltRWRnZScpIHtcclxuICAgICAgICAgICAgbGV0IGNsYWltRWRnZSA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0Q2xhaW1FZGdlKGFjdGlvbi5kYXRhSWQpXHJcbiAgICAgICAgICAgIGNsYWltRWRnZSA9IHsgLi4uY2xhaW1FZGdlLCAuLi5hY3Rpb24ubmV3RGF0YSB9XHJcbiAgICAgICAgICAgIGlmIChjbGFpbUVkZ2UpIHtcclxuICAgICAgICAgICAgICAgIGFjdGlvbi5uZXdEYXRhIGFzIENsYWltRWRnZTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNjb3JlcyA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0U2NvcmVzQnlTb3VyY2VJZChjbGFpbUVkZ2UuaWQpXHJcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHNjb3JlIG9mIHNjb3Jlcykge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vVE9ETzogV2hlcmUgc2hvdWxkIEkgcHV0IHRoaXM/IEl0IGlzIG1vZGlmeWluZyBhbSBvYmplY3QuIElmIGl0IGlzIHJlYWN0aXZlIGkgc2hvdWxkIGp1c3QgY2hhbmdlIHRoZSBkYXRhLiBJZiBwdXJlIGl0IHNob3VsZCBiZSBhIG5ldyBvYmplY3QuXHJcbiAgICAgICAgICAgICAgICAgICAgLy9Gb3Igbm93IEkgd2lsbCBtb2RpZnkgaXQgYnV0IGl0IG1heSBub3QgdHJpZ2dlciB1cGRhdGVzIGluIGEgcHVyZSBsaWJyYXJ5IChSZWFjdClcclxuICAgICAgICAgICAgICAgICAgICAvL1RoaXMgY2hhbmdlIHNob3VsZCBhbHNvIHByb2JhYmx5IGJlIGNlbnRyYWxpemVkIHNvbWV3aGVyZSB0byByZWR1Y2UgdGhlIGNoYW5jZSBvZiBpbmNvbnNpc3RlbnQgYnVncy4gSSB0aGluayBpdCB3aWxsIGhhcHBlbiBpbiBtdWx0aXBsZSBwYWNlc1xyXG4gICAgICAgICAgICAgICAgICAgIC8vTm9wZSwgaXQgaXMgYW4gYWN0aW9uIHNvIGl0IHNob3VsZCBhbHdheXMgYmUgYSBuZXcgb2JqZWN0LiBJZiBpdCBnb2VzIGludG8gYSByZWFjdGl2ZSByZXNwb2l0b3J5IHRoZW4gaXQgd2lsbCBtb2RpZnkgdGhlIGFjdHVhbCBvYmplY3RcclxuICAgICAgICAgICAgICAgICAgICAvL1Nob3VsZCBJIGdyb3VwIHRoZXNlIGFjdGlvbnMgb3IganVzdCB0aHJvdyB0aGVtIGluIG9uZSBhdCBhIHRpbWUgbGlrZSBJIGFtIGRvaW5nXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNjb3JlLnBybyAhPSBjbGFpbUVkZ2UucHJvIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3JlLmFmZmVjdHMgIT0gY2xhaW1FZGdlLmFmZmVjdHMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0aW9uID0gbmV3IEFjdGlvbih7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm86IGNsYWltRWRnZS5wcm8sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZmZlY3RzOiBjbGFpbUVkZ2UuYWZmZWN0cyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW9yaXR5OiBjbGFpbUVkZ2UucHJpb3JpdHksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIHNjb3JlLCBcIm1vZGlmeV9zY29yZVwiLCBzY29yZS5pZClcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2NvcmVBY3Rpb25zLnB1c2goYWN0aW9uKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgcmVwb3NpdG9yeS5ub3RpZnkoW2FjdGlvbl0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGFjdGlvbi50eXBlID09ICdkZWxldGVfY2xhaW1FZGdlJykge1xyXG4gICAgICAgICAgICBjb25zdCBvbGRDbGFpbUVkZ2UgPSBhY3Rpb24ub2xkRGF0YSBhcyBDbGFpbUVkZ2U7XHJcbiAgICAgICAgICAgIGNsYWltSWRzVG9TY29yZS5wdXNoKG9sZENsYWltRWRnZS5wYXJlbnRJZClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChhY3Rpb24udHlwZSA9PSAnYWRkX3Njb3JlVHJlZScpIHtcclxuICAgICAgICAgICAgY29uc3Qgc2NvcmVUcmVlID0gYWN0aW9uLm5ld0RhdGEgYXMgU2NvcmVUcmVlO1xyXG4gICAgICAgICAgICBTY29yZVRyZWVJZHMucHVzaChzY29yZVRyZWUuaWQpXHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICAvL1dhbGsgdXAgdGhlIHNjb3JlcyBmb3IgZWFjaCBjbGFpbSB0byB0aGUgdG9wXHJcbiAgICBmb3IgKGNvbnN0IGNsYWltSWQgb2YgY2xhaW1JZHNUb1Njb3JlKSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBjbGFpbVNjb3JlIG9mIGF3YWl0IHJlcG9zaXRvcnkuZ2V0U2NvcmVzQnlTb3VyY2VJZChjbGFpbUlkKSkge1xyXG4gICAgICAgICAgICBTY29yZVRyZWVJZHMucHVzaChjbGFpbVNjb3JlLnNjb3JlVHJlZUlkKVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvL1JlLWNhbGMgYWxsIFNjb3JlIFRyZWVzIHdpdGggcG9zc2libGUgY2hhbmdlZCBjbGFpbXNcclxuXHJcbiAgICBmb3IgKGNvbnN0IHNjb3JlVHJlZUlkIG9mIFNjb3JlVHJlZUlkcykge1xyXG4gICAgICAgIGNvbnN0IHNjb3JlVHJlZSA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0U2NvcmVUcmVlKHNjb3JlVHJlZUlkKVxyXG4gICAgICAgIGlmIChzY29yZVRyZWUpIHtcclxuICAgICAgICAgICAgY29uc3QgbWlzc2luZ1Njb3JlQWN0aW9uczogQWN0aW9uW10gPSBbXTtcclxuXHJcbiAgICAgICAgICAgIGxldCB0b3BTY29yZSA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0U2NvcmUoc2NvcmVUcmVlLnRvcFNjb3JlSWQpO1xyXG4gICAgICAgICAgICBpZiAoIXRvcFNjb3JlKSB7XHJcbiAgICAgICAgICAgICAgICB0b3BTY29yZSA9IG5ldyBTY29yZShzY29yZVRyZWUuc291cmNlQ2xhaW1JZCwgc2NvcmVUcmVlLmlkKTtcclxuICAgICAgICAgICAgICAgIHRvcFNjb3JlLmlkID0gc2NvcmVUcmVlLnRvcFNjb3JlSWQ7XHJcbiAgICAgICAgICAgICAgICBtaXNzaW5nU2NvcmVBY3Rpb25zLnB1c2gobmV3IEFjdGlvbih0b3BTY29yZSwgdW5kZWZpbmVkLCBcImFkZF9zY29yZVwiKSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGF3YWl0IGNyZWF0ZUJsYW5rTWlzc2luZ1Njb3JlcyhyZXBvc2l0b3J5LCBzY29yZVRyZWUudG9wU2NvcmVJZCwgc2NvcmVUcmVlLnNvdXJjZUNsYWltSWQgfHwgXCJcIiwgbWlzc2luZ1Njb3JlQWN0aW9ucywgc2NvcmVUcmVlSWQpXHJcbiAgICAgICAgICAgIGlmIChtaXNzaW5nU2NvcmVBY3Rpb25zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHJlcG9zaXRvcnkubm90aWZ5KG1pc3NpbmdTY29yZUFjdGlvbnMpXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHNjb3JlVHJlZUFjdGlvbnM6IEFjdGlvbltdID0gW107XHJcbiAgICAgICAgICAgIGF3YWl0IGNhbGN1bGF0ZVNjb3JlVHJlZShyZXBvc2l0b3J5LCB0b3BTY29yZSwgY2FsY3VsYXRvciwgc2NvcmVUcmVlQWN0aW9ucyk7XHJcbiAgICAgICAgICAgIGlmIChtaXNzaW5nU2NvcmVBY3Rpb25zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHJlcG9zaXRvcnkubm90aWZ5KHNjb3JlVHJlZUFjdGlvbnMpXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGZyYWN0aW9uQWN0aW9uczogQWN0aW9uW10gPSBbXTtcclxuICAgICAgICAgICAgYXdhaXQgY2FsY3VsYXRlRnJhY3Rpb25zKHJlcG9zaXRvcnksIHRvcFNjb3JlLCBmcmFjdGlvbkFjdGlvbnMpXHJcbiAgICAgICAgICAgIGlmIChmcmFjdGlvbkFjdGlvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgcmVwb3NpdG9yeS5ub3RpZnkoZnJhY3Rpb25BY3Rpb25zKVxyXG4gICAgICAgICAgICB9XHJcbmRlYnVnZ2VyXHJcbiAgICAgICAgICAgIHNjb3JlQWN0aW9ucy5wdXNoKFxyXG4gICAgICAgICAgICAgICAgLi4ubWlzc2luZ1Njb3JlQWN0aW9ucyxcclxuICAgICAgICAgICAgICAgIC4uLnNjb3JlVHJlZUFjdGlvbnMsXHJcbiAgICAgICAgICAgICAgICAuLi5mcmFjdGlvbkFjdGlvbnMpXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vVE9ETzogUmV2aWV3IHRoaXMgZGVjaXNpb246IEZlZWQgdGhlIHNjb3JlIGFjdGlvbnMgYmFjayBpbnRvIHRoZSByZXBvc2l0b3J5IHNvIHRoaXMgcmVwb3NpdG9yeSBpcyB1cCB0byBkYXRlIGluIGNhc2UgaXQgaXMgdXNlZCBcclxuICAgIGF3YWl0IHJlcG9zaXRvcnkubm90aWZ5KHNjb3JlQWN0aW9ucyk7XHJcblxyXG4gICAgcmV0dXJuIHNjb3JlQWN0aW9ucztcclxufVxyXG5cclxuLy9DcmVhdGUgQmxhbmsgTWlzc2luZyBTY29yZXNcclxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlQmxhbmtNaXNzaW5nU2NvcmVzKHJlcG9zaXRvcnk6IGlSZXBvc2l0b3J5LCBjdXJyZW50U2NvcmVJZDogc3RyaW5nLCBjdXJyZW50Q2xhaW1JZDogc3RyaW5nLCBhY3Rpb25zOiBBY3Rpb25bXSwgc2NvcmVUcmVlSWQ6IHN0cmluZykge1xyXG4gICAgY29uc3QgZWRnZXMgPSBhd2FpdCByZXBvc2l0b3J5LmdldENsYWltRWRnZXNCeVBhcmVudElkKGN1cnJlbnRDbGFpbUlkKVxyXG4gICAgY29uc3Qgc2NvcmVzID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRDaGlsZHJlbkJ5U2NvcmVJZChjdXJyZW50U2NvcmVJZClcclxuICAgIGZvciAoY29uc3QgZWRnZSBvZiBlZGdlcykge1xyXG4gICAgICAgIC8vc2VlIGlmIHRoZXJlIGlzIGEgbWF0Y2hpbmcgY2hpbGQgc2NvcmUgZm9yIHRoZSBjaGlsZCBlZGdlXHJcbiAgICAgICAgbGV0IHNjb3JlID0gc2NvcmVzLmZpbmQoKHsgc291cmNlQ2xhaW1JZCB9KSA9PiBzb3VyY2VDbGFpbUlkID09PSBlZGdlLmNoaWxkSWQpO1xyXG4gICAgICAgIGlmICghc2NvcmUpIHtcclxuICAgICAgICAgICAgLy9DcmVhdGUgYSBuZXcgU2NvcmUgYW5kIGF0dGFjaCBpdCB0byBpdCdzIHBhcmVudFxyXG4gICAgICAgICAgICBjb25zdCB1ID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICBzY29yZSA9IG5ldyBTY29yZShlZGdlLmNoaWxkSWQsIHNjb3JlVHJlZUlkLCBjdXJyZW50U2NvcmVJZCwgZWRnZS5pZCwgdW5kZWZpbmVkLCBlZGdlLnBybywgZWRnZS5hZmZlY3RzLCB1LCB1LCB1LCBlZGdlLnByaW9yaXR5KTtcclxuICAgICAgICAgICAgYWN0aW9ucy5wdXNoKG5ldyBBY3Rpb24oc2NvcmUsIHVuZGVmaW5lZCwgXCJhZGRfc2NvcmVcIiwgc2NvcmUuaWQpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy9SZWN1cnNlIGFuZCB0aHJvdWdoIGNoaWxkcmVuXHJcbiAgICAgICAgYXdhaXQgY3JlYXRlQmxhbmtNaXNzaW5nU2NvcmVzKHJlcG9zaXRvcnksIHNjb3JlLmlkLCBlZGdlLmNoaWxkSWQsIGFjdGlvbnMsIHNjb3JlVHJlZUlkKTtcclxuICAgIH1cclxufVxyXG5cclxuLy9UaGlzIGZ1bmN0aW9uIGFzc3VtZSB0aGF0IGFsbCBzY29yZXMgYWxyZWFkeSBleGlzdFxyXG5hc3luYyBmdW5jdGlvbiBjYWxjdWxhdGVTY29yZVRyZWUocmVwb3NpdG9yeTogaVJlcG9zaXRvcnksIGN1cnJlbnRTY29yZTogaVNjb3JlLCBjYWxjdWxhdG9yOiBpQ2FsY3VsYXRlU2NvcmUgPSBjYWxjdWxhdGVTY29yZSwgYWN0aW9uczogQWN0aW9uW10pIHtcclxuICAgIGNvbnN0IG9sZFNjb3JlcyA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0Q2hpbGRyZW5CeVNjb3JlSWQoY3VycmVudFNjb3JlLmlkKVxyXG4gICAgY29uc3QgbmV3U2NvcmVzOiBpU2NvcmVbXSA9IFtdO1xyXG4gICAgbGV0IG5ld0Rlc2NlbmRhbnRDb3VudCA9IDA7XHJcblxyXG5cclxuXHJcbiAgICBmb3IgKGNvbnN0IG9sZFNjb3JlIG9mIG9sZFNjb3JlcykgeyAvL0NhbGN1bGF0ZSBDaGlsZHJlblxyXG4gICAgICAgIC8vVE9ETzogcmVtb3ZlIGFueSBzY29yZXMgdG8gY2FsY3VsYXRlIGJhc2VkIG9uIGZvcm11bGFzIHRoYXQgZXhjbHVkZSBzY29yZXNcclxuICAgICAgICBjb25zdCBuZXdTY29yZSA9IGF3YWl0IGNhbGN1bGF0ZVNjb3JlVHJlZShyZXBvc2l0b3J5LCBvbGRTY29yZSwgY2FsY3VsYXRvciwgYWN0aW9ucyk7XHJcbiAgICAgICAgbmV3U2NvcmVzLnB1c2gobmV3U2NvcmUpO1xyXG4gICAgICAgIG5ld0Rlc2NlbmRhbnRDb3VudCArPSBuZXdTY29yZS5kZXNjZW5kYW50Q291bnQgKyAxO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG5ld1Njb3JlRnJhZ21lbnQgPSBjYWxjdWxhdG9yKHtcclxuICAgICAgICBjaGlsZFNjb3JlczogbmV3U2NvcmVzLFxyXG4gICAgfSlcclxuXHJcbiAgICAvL1RPRE86IE1vZGlmeSB0aGUgbmV3U2NvcmUgYmFzZWQgb24gYW55IGZvcm11bGFzXHJcbiAgICBjb25zdCBuZXdTY29yZSA9IHtcclxuICAgICAgICAuLi5jdXJyZW50U2NvcmUsXHJcbiAgICAgICAgLi4ubmV3U2NvcmVGcmFnbWVudCxcclxuICAgICAgICBkZXNjZW5kYW50Q291bnQ6IG5ld0Rlc2NlbmRhbnRDb3VudFxyXG4gICAgfVxyXG4gICAgaWYgKGRpZmZlcmVudFNjb3JlcyhjdXJyZW50U2NvcmUsIG5ld1Njb3JlKSkge1xyXG4gICAgICAgIGFjdGlvbnMucHVzaChuZXcgQWN0aW9uKG5ld1Njb3JlLCB1bmRlZmluZWQsIFwibW9kaWZ5X3Njb3JlXCIsIG5ld1Njb3JlLmlkKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5ld1Njb3JlO1xyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBjYWxjdWxhdGVGcmFjdGlvbnMocmVwb3NpdG9yeTogaVJlcG9zaXRvcnksIHBhcmVudFNjb3JlOiBpU2NvcmUsIGFjdGlvbnM6IEFjdGlvbltdKSB7XHJcbiAgICBjb25zdCBvbGRDaGlsZFNjb3JlcyA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0Q2hpbGRyZW5CeVNjb3JlSWQocGFyZW50U2NvcmUuaWQpXHJcbiAgICBjb25zdCBuZXdTY29yZXM6IGlTY29yZVtdID0gW107XHJcblxyXG4gICAgLy9Db3VudCB1cCB0b3RhbCByZWxldmFuY2VcclxuICAgIGxldCB0b3RhbFJlbGV2YW5jZSA9IDBcclxuICAgIGZvciAoY29uc3Qgb2xkU2NvcmUgb2Ygb2xkQ2hpbGRTY29yZXMpIHtcclxuICAgICAgICBpZiAob2xkU2NvcmUuYWZmZWN0cyA9IFwiY29uZmlkZW5jZVwiKSB7XHJcbiAgICAgICAgICAgIHRvdGFsUmVsZXZhbmNlICs9IG9sZFNjb3JlLnJlbGV2YW5jZVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGlmICh0b3RhbFJlbGV2YW5jZSA9PT0gMCkge1xyXG4gICAgICAgIHRvdGFsUmVsZXZhbmNlID0gMTtcclxuICAgIH1cclxuXHJcbiAgICBkZWJ1Z2dlclxyXG4gICAgZm9yIChjb25zdCBvbGRDaGlsZFNjb3JlIG9mIG9sZENoaWxkU2NvcmVzKSB7XHJcbiAgICAgICAgY29uc3QgbmV3Q2hpbGRGcmFjdGlvbiA9IChvbGRDaGlsZFNjb3JlLnJlbGV2YW5jZSAvIHRvdGFsUmVsZXZhbmNlKSAqIHBhcmVudFNjb3JlLmZyYWN0aW9uXHJcbiAgICAgICAgY29uc3QgbmV3Q2hpbGRTY29yZSA9IHsgLi4ub2xkQ2hpbGRTY29yZSwgZnJhY3Rpb246IG5ld0NoaWxkRnJhY3Rpb24gfVxyXG4gICAgICAgIGlmIChuZXdDaGlsZEZyYWN0aW9uICE9IG9sZENoaWxkU2NvcmUuZnJhY3Rpb24pIHtcclxuICAgICAgICAgICAgYWN0aW9ucy5wdXNoKG5ldyBBY3Rpb24obmV3Q2hpbGRTY29yZSwgdW5kZWZpbmVkLCBcIm1vZGlmeV9zY29yZVwiKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGF3YWl0IGNhbGN1bGF0ZUZyYWN0aW9ucyhyZXBvc2l0b3J5LCBuZXdDaGlsZFNjb3JlLCBhY3Rpb25zKVxyXG5cclxuICAgIH1cclxufVxyXG4iXX0=
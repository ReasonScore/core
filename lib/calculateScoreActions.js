"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.calculateScoreActions = calculateScoreActions;

var _Score = require("./dataModels/Score");

var _Action = require("./dataModels/Action");

var _calculateScore = require("./calculateScore");

var _ = require(".");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Calculates the score actions based on a list of actions
 */
async function calculateScoreActions({
  actions = [],
  repository = new _.RepositoryLocalPure(),
  calculator = _calculateScore.calculateScore
} = {}) {
  const scoreActions = [];
  const claimIdsToScore = [];
  const topScoreIds = [];
  await repository.notify(actions);

  for (const action of actions) {
    // find claims that may need scores changed
    if (action.type == 'add_claim' || action.type == 'modify_claim') {
      claimIdsToScore.push(action.dataId);
    }

    if (action.type == "add_score") {
      let score = action.newData;

      if (!score.parentId) {
        const scoreTemp = await repository.getScore(action.dataId);

        if (scoreTemp) {
          score = scoreTemp;
        }
      }

      claimIdsToScore.push(score.sourceClaimId);
    } //Add scores if edges adds new children to claims in score trees


    if (action.type == 'add_claimEdge' || action.type == 'modify_claimEdge') {
      let claimEdge = action.newData;

      if (!claimEdge.parentId) {
        const claimEdgeTemp = await repository.getClaimEdge(action.dataId);

        if (claimEdgeTemp) {
          claimEdge = claimEdgeTemp;
        }
      }

      claimIdsToScore.push(claimEdge.parentId);
    } //TODO: If an edge changes then modify the existing scores to match


    if (action.type == 'modify_claimEdge') {
      let claimEdge = await repository.getClaimEdge(action.dataId);
      claimEdge = _objectSpread({}, claimEdge, {}, action.newData);

      if (claimEdge) {
        action.newData;
        const scores = await repository.getScoresBySourceId(claimEdge.id);

        for (const score of scores) {
          //TODO: Where should I put this? It is modifying am object. If it is reactive i should just change the data. If pure it should be a new object.
          //For now I will modify it but it may not trigger updates in a pure library (React)
          //This change should also probably be centralized somewhere to reduce the chance of inconsistent bugs. I think it will happen in multiple paces
          //Nope, it is an action so it should always be a new object. If it goes into a reactive respoitory then it will modify the actual object
          //Should I group these actions or just throw them in one at a time like I am doing
          if (score.pro != claimEdge.pro || score.affects != claimEdge.affects) {
            const action = new _Action.Action({
              pro: claimEdge.pro,
              affects: claimEdge.affects,
              priority: claimEdge.priority
            }, score, "modify_score", score.id);
            scoreActions.push(action);
            await repository.notify([action]);
          }
        }
      }
    }
  } //Walk up the scores for each claim to the top


  for (const claimId of claimIdsToScore) {
    const scoresForTheClaim = await repository.getScoresBySourceId(claimId);

    for (const claimScore of scoresForTheClaim) {
      // for each score, walk up the tree looking for the top (the first score to not have a parentId)
      let currentScore = claimScore;
      let topScoreId = claimScore.id;

      do {
        var _currentScore;

        if (currentScore.parentScoreId) {
          currentScore = await repository.getScore(currentScore.parentScoreId);
        }

        if (currentScore) {
          topScoreId = currentScore.id;
        }
      } while ((_currentScore = currentScore) === null || _currentScore === void 0 ? void 0 : _currentScore.parentScoreId);

      if (topScoreId && topScoreIds.indexOf(topScoreId) == -1) {
        topScoreIds.push(topScoreId);
      }
    }
  } //Re-calc all top scores with possible changed claims


  for (const topScoreId of topScoreIds) {
    const topScore = await repository.getScore(topScoreId);

    if (topScore) {
      const tempMissingScoreActions = [];
      await createBlankMissingScores(repository, topScoreId, topScore.sourceClaimId || "", tempMissingScoreActions, topScoreId);

      if (tempMissingScoreActions.length > 0) {
        await repository.notify(tempMissingScoreActions);
      }

      const tempcalculateScoreTreeActions = [];
      await calculateScoreTree(repository, topScore, calculator, tempMissingScoreActions);
      scoreActions.push(...tempMissingScoreActions, ...tempcalculateScoreTreeActions);
    }
  } //TODO: Review this decision: Feed the score actions back into the repository so this repository is up to date in case it is used 


  await repository.notify(scoreActions);
  return scoreActions;
} //Create Blank Missing Scores


async function createBlankMissingScores(repository, currentScoreId, currentClaimId, actions, topScoreId) {
  const edges = await repository.getClaimEdgesByParentId(currentClaimId);
  const scores = await repository.getChildrenByScoreId(currentScoreId);

  for (const edge of edges) {
    //see if there is a matching child score for the child edge
    let score = scores.find(({
      sourceClaimId
    }) => sourceClaimId === edge.childId);

    if (!score) {
      //Create a new Score and attach it to it's parent
      const u = undefined;
      score = new _Score.Score(edge.childId, topScoreId, currentScoreId, edge.id, undefined, edge.pro, edge.affects, u, u, u, edge.priority);
      actions.push(new _Action.Action(score, undefined, "add_score", score.id));
    } //Recurse and through children


    await createBlankMissingScores(repository, score.id, edge.childId, actions, topScoreId);
  }
} //This function assume that all scores already exist


async function calculateScoreTree(repository, currentScore, calculator = _calculateScore.calculateScore, actions) {
  const oldScores = await repository.getChildrenByScoreId(currentScore.id);
  const newScores = [];

  for (const oldScore of oldScores) {
    //Calculate Children
    //TODO: remove any scores to calculate based on formulas that exclude scores
    newScores.push((await calculateScoreTree(repository, oldScore, calculator, actions)));
  }

  const newScoreFragment = calculator({
    childScores: newScores,
    reversible: currentScore.reversible
  }); //TODO: Modify the newScore based on any formulas

  const newScore = _objectSpread({}, currentScore, {}, newScoreFragment);

  if ((0, _Score.differentScores)(currentScore, newScore)) {
    actions.push(new _Action.Action(newScore, undefined, "modify_score", newScore.id));
  }

  return newScore;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWxjdWxhdGVTY29yZUFjdGlvbnMudHMiXSwibmFtZXMiOlsiY2FsY3VsYXRlU2NvcmVBY3Rpb25zIiwiYWN0aW9ucyIsInJlcG9zaXRvcnkiLCJSZXBvc2l0b3J5TG9jYWxQdXJlIiwiY2FsY3VsYXRvciIsImNhbGN1bGF0ZVNjb3JlIiwic2NvcmVBY3Rpb25zIiwiY2xhaW1JZHNUb1Njb3JlIiwidG9wU2NvcmVJZHMiLCJub3RpZnkiLCJhY3Rpb24iLCJ0eXBlIiwicHVzaCIsImRhdGFJZCIsInNjb3JlIiwibmV3RGF0YSIsInBhcmVudElkIiwic2NvcmVUZW1wIiwiZ2V0U2NvcmUiLCJzb3VyY2VDbGFpbUlkIiwiY2xhaW1FZGdlIiwiY2xhaW1FZGdlVGVtcCIsImdldENsYWltRWRnZSIsInNjb3JlcyIsImdldFNjb3Jlc0J5U291cmNlSWQiLCJpZCIsInBybyIsImFmZmVjdHMiLCJBY3Rpb24iLCJwcmlvcml0eSIsImNsYWltSWQiLCJzY29yZXNGb3JUaGVDbGFpbSIsImNsYWltU2NvcmUiLCJjdXJyZW50U2NvcmUiLCJ0b3BTY29yZUlkIiwicGFyZW50U2NvcmVJZCIsImluZGV4T2YiLCJ0b3BTY29yZSIsInRlbXBNaXNzaW5nU2NvcmVBY3Rpb25zIiwiY3JlYXRlQmxhbmtNaXNzaW5nU2NvcmVzIiwibGVuZ3RoIiwidGVtcGNhbGN1bGF0ZVNjb3JlVHJlZUFjdGlvbnMiLCJjYWxjdWxhdGVTY29yZVRyZWUiLCJjdXJyZW50U2NvcmVJZCIsImN1cnJlbnRDbGFpbUlkIiwiZWRnZXMiLCJnZXRDbGFpbUVkZ2VzQnlQYXJlbnRJZCIsImdldENoaWxkcmVuQnlTY29yZUlkIiwiZWRnZSIsImZpbmQiLCJjaGlsZElkIiwidSIsInVuZGVmaW5lZCIsIlNjb3JlIiwib2xkU2NvcmVzIiwibmV3U2NvcmVzIiwib2xkU2NvcmUiLCJuZXdTY29yZUZyYWdtZW50IiwiY2hpbGRTY29yZXMiLCJyZXZlcnNpYmxlIiwibmV3U2NvcmUiXSwibWFwcGlu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Q0FDLElBQUFBLFNBQVMsQ0FBQzNDLElBQVYsRUFBZSxNQUFNOEIsa0JBQWtCLENBQUN4QyxVQUFELEVBQWFzRCxRQUFiLEVBQXVCcEQsVUFBdkIsRUFBbUNILE9BQW5DLENBQXZDO0FBQ0g7O0FBRUQsUUFBTXdELGdCQUFnQixHQUFHckQsVUFBVSxDQUFDO0FBQ2hDc0QsSUFBQUEsV0FBVyxFQUFFSCxTQURtQjtBQUVoQ0ksSUFBQUEsVUFBVSxFQUFFMUIsWUFBWSxDQUFDMEI7QUFGTyxHQUFELENBQW5DLENBVDhJLENBYzlJOztBQUNBLFFBQU1DLFFBQVEscUJBQVEzQixZQUFSLE1BQXlCd0IsZ0JBQXpCLENBQWQ7O0FBQ0EsTUFBSSw0QkFBZ0J4QixZQUFoQixFQUE4QjJCLFFBQTlCLENBQUosRUFBNkM7QUFDekMzRCxJQUFBQSxPQUFPLENBQUNXLElBQVIsQ0FBYSxJQUFJZ0IsY0FBSixDQUFXZ0MsUUFBWCxFQUFxQlIsU0FBckIsRUFBZ0MsY0FBaEMsRUFBZ0RRLFFBQVEsQ0FBQ25DLEVBQXpELENBQWI7QUFDSDs7QUFDRCxTQUFPbUMsUUFBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2NvcmUsIGRpZmZlcmVudFNjb3JlcywgaVNjb3JlIH0gZnJvbSBcIi4vZGF0YU1vZGVscy9TY29yZVwiO1xyXG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tIFwiLi9kYXRhTW9kZWxzL0FjdGlvblwiO1xyXG5pbXBvcnQgeyBpQ2FsY3VsYXRlU2NvcmUsIGNhbGN1bGF0ZVNjb3JlIH0gZnJvbSBcIi4vY2FsY3VsYXRlU2NvcmVcIjtcclxuaW1wb3J0IHsgaVJlcG9zaXRvcnkgfSBmcm9tIFwiLi9kYXRhTW9kZWxzL2lSZXBvc2l0b3J5XCI7XHJcbmltcG9ydCB7IENsYWltRWRnZSwgaUNsYWltRWRnZSB9IGZyb20gXCIuL2RhdGFNb2RlbHMvQ2xhaW1FZGdlXCI7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnlMb2NhbFB1cmUgfSBmcm9tIFwiLlwiO1xyXG5cclxuLyoqXHJcbiAqIENhbGN1bGF0ZXMgdGhlIHNjb3JlIGFjdGlvbnMgYmFzZWQgb24gYSBsaXN0IG9mIGFjdGlvbnNcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjYWxjdWxhdGVTY29yZUFjdGlvbnMoeyBhY3Rpb25zID0gW10sIHJlcG9zaXRvcnkgPSBuZXcgUmVwb3NpdG9yeUxvY2FsUHVyZSgpLCBjYWxjdWxhdG9yID0gY2FsY3VsYXRlU2NvcmUgfToge1xyXG4gICAgLyoqIEFuIGFycmF5IG9mIGFjdGlvbnMsIHVzdWFsbHkgb24gY2xhaW1zIG9yIGVkZ2VzIHRoYXQgaW5jbHVzZSBubyBzY29yZXMqL1xyXG4gICAgYWN0aW9ucz86IEFjdGlvbltdO1xyXG4gICAgLyoqIFRoZSByZXBvc2l0b3J5IHVzZWQgdG8gZ2V0IGNvbnRleHQgZm9yIHRoZSBhY3Rpb25zICovXHJcbiAgICByZXBvc2l0b3J5PzogaVJlcG9zaXRvcnk7XHJcbiAgICAvKiogVGhlIGZ1bmN0aW9uIHVzZWQgdG8gY2FsY3VsYXRlIHRoZSBzY29yZXMgKi9cclxuICAgIGNhbGN1bGF0b3I/OiBpQ2FsY3VsYXRlU2NvcmU7XHJcbn0gPSB7fSxcclxuKSB7XHJcbiAgICBjb25zdCBzY29yZUFjdGlvbnM6IEFjdGlvbltdID0gW107XHJcbiAgICBjb25zdCBjbGFpbUlkc1RvU2NvcmU6IHN0cmluZ1tdID0gW107XHJcbiAgICBjb25zdCB0b3BTY29yZUlkczogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICBhd2FpdCByZXBvc2l0b3J5Lm5vdGlmeShhY3Rpb25zKTtcclxuICAgIGZvciAoY29uc3QgYWN0aW9uIG9mIGFjdGlvbnMpIHtcclxuXHJcbiAgICAgICAgLy8gZmluZCBjbGFpbXMgdGhhdCBtYXkgbmVlZCBzY29yZXMgY2hhbmdlZFxyXG4gICAgICAgIGlmIChhY3Rpb24udHlwZSA9PSAnYWRkX2NsYWltJyB8fCBhY3Rpb24udHlwZSA9PSAnbW9kaWZ5X2NsYWltJykge1xyXG4gICAgICAgICAgICBjbGFpbUlkc1RvU2NvcmUucHVzaChhY3Rpb24uZGF0YUlkKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGFjdGlvbi50eXBlID09IFwiYWRkX3Njb3JlXCIpIHtcclxuICAgICAgICAgICAgbGV0IHNjb3JlID0gYWN0aW9uLm5ld0RhdGEgYXMgaVNjb3JlO1xyXG4gICAgICAgICAgICBpZiAoIXNjb3JlLnBhcmVudElkKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzY29yZVRlbXAgPSBhd2FpdCByZXBvc2l0b3J5LmdldFNjb3JlKGFjdGlvbi5kYXRhSWQpXHJcbiAgICAgICAgICAgICAgICBpZiAoc2NvcmVUZW1wKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2NvcmUgPSBzY29yZVRlbXA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNsYWltSWRzVG9TY29yZS5wdXNoKHNjb3JlLnNvdXJjZUNsYWltSWQpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvL0FkZCBzY29yZXMgaWYgZWRnZXMgYWRkcyBuZXcgY2hpbGRyZW4gdG8gY2xhaW1zIGluIHNjb3JlIHRyZWVzXHJcbiAgICAgICAgaWYgKGFjdGlvbi50eXBlID09ICdhZGRfY2xhaW1FZGdlJyB8fCBhY3Rpb24udHlwZSA9PSAnbW9kaWZ5X2NsYWltRWRnZScpIHtcclxuICAgICAgICAgICAgbGV0IGNsYWltRWRnZSA9IGFjdGlvbi5uZXdEYXRhIGFzIGlDbGFpbUVkZ2U7XHJcbiAgICAgICAgICAgIGlmICghY2xhaW1FZGdlLnBhcmVudElkKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjbGFpbUVkZ2VUZW1wID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRDbGFpbUVkZ2UoYWN0aW9uLmRhdGFJZClcclxuICAgICAgICAgICAgICAgIGlmIChjbGFpbUVkZ2VUZW1wKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2xhaW1FZGdlID0gY2xhaW1FZGdlVGVtcDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjbGFpbUlkc1RvU2NvcmUucHVzaChjbGFpbUVkZ2UucGFyZW50SWQpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvL1RPRE86IElmIGFuIGVkZ2UgY2hhbmdlcyB0aGVuIG1vZGlmeSB0aGUgZXhpc3Rpbmcgc2NvcmVzIHRvIG1hdGNoXHJcbiAgICAgICAgaWYgKGFjdGlvbi50eXBlID09ICdtb2RpZnlfY2xhaW1FZGdlJykge1xyXG4gICAgICAgICAgICBsZXQgY2xhaW1FZGdlID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRDbGFpbUVkZ2UoYWN0aW9uLmRhdGFJZClcclxuICAgICAgICAgICAgY2xhaW1FZGdlID0geyAuLi5jbGFpbUVkZ2UsIC4uLmFjdGlvbi5uZXdEYXRhIH1cclxuICAgICAgICAgICAgaWYgKGNsYWltRWRnZSkge1xyXG4gICAgICAgICAgICAgICAgYWN0aW9uLm5ld0RhdGEgYXMgQ2xhaW1FZGdlO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2NvcmVzID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRTY29yZXNCeVNvdXJjZUlkKGNsYWltRWRnZS5pZClcclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgc2NvcmUgb2Ygc2NvcmVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9UT0RPOiBXaGVyZSBzaG91bGQgSSBwdXQgdGhpcz8gSXQgaXMgbW9kaWZ5aW5nIGFtIG9iamVjdC4gSWYgaXQgaXMgcmVhY3RpdmUgaSBzaG91bGQganVzdCBjaGFuZ2UgdGhlIGRhdGEuIElmIHB1cmUgaXQgc2hvdWxkIGJlIGEgbmV3IG9iamVjdC5cclxuICAgICAgICAgICAgICAgICAgICAvL0ZvciBub3cgSSB3aWxsIG1vZGlmeSBpdCBidXQgaXQgbWF5IG5vdCB0cmlnZ2VyIHVwZGF0ZXMgaW4gYSBwdXJlIGxpYnJhcnkgKFJlYWN0KVxyXG4gICAgICAgICAgICAgICAgICAgIC8vVGhpcyBjaGFuZ2Ugc2hvdWxkIGFsc28gcHJvYmFibHkgYmUgY2VudHJhbGl6ZWQgc29tZXdoZXJlIHRvIHJlZHVjZSB0aGUgY2hhbmNlIG9mIGluY29uc2lzdGVudCBidWdzLiBJIHRoaW5rIGl0IHdpbGwgaGFwcGVuIGluIG11bHRpcGxlIHBhY2VzXHJcbiAgICAgICAgICAgICAgICAgICAgLy9Ob3BlLCBpdCBpcyBhbiBhY3Rpb24gc28gaXQgc2hvdWxkIGFsd2F5cyBiZSBhIG5ldyBvYmplY3QuIElmIGl0IGdvZXMgaW50byBhIHJlYWN0aXZlIHJlc3BvaXRvcnkgdGhlbiBpdCB3aWxsIG1vZGlmeSB0aGUgYWN0dWFsIG9iamVjdFxyXG4gICAgICAgICAgICAgICAgICAgIC8vU2hvdWxkIEkgZ3JvdXAgdGhlc2UgYWN0aW9ucyBvciBqdXN0IHRocm93IHRoZW0gaW4gb25lIGF0IGEgdGltZSBsaWtlIEkgYW0gZG9pbmdcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc2NvcmUucHJvICE9IGNsYWltRWRnZS5wcm8gfHxcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2NvcmUuYWZmZWN0cyAhPSBjbGFpbUVkZ2UuYWZmZWN0cykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhY3Rpb24gPSBuZXcgQWN0aW9uKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBybzogY2xhaW1FZGdlLnBybyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmZmVjdHM6IGNsYWltRWRnZS5hZmZlY3RzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpb3JpdHk6IGNsYWltRWRnZS5wcmlvcml0eSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSwgc2NvcmUsIFwibW9kaWZ5X3Njb3JlXCIsIHNjb3JlLmlkKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzY29yZUFjdGlvbnMucHVzaChhY3Rpb24pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCByZXBvc2l0b3J5Lm5vdGlmeShbYWN0aW9uXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vV2FsayB1cCB0aGUgc2NvcmVzIGZvciBlYWNoIGNsYWltIHRvIHRoZSB0b3BcclxuICAgIGZvciAoY29uc3QgY2xhaW1JZCBvZiBjbGFpbUlkc1RvU2NvcmUpIHtcclxuICAgICAgICBjb25zdCBzY29yZXNGb3JUaGVDbGFpbSA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0U2NvcmVzQnlTb3VyY2VJZChjbGFpbUlkKVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGNsYWltU2NvcmUgb2Ygc2NvcmVzRm9yVGhlQ2xhaW0pIHtcclxuICAgICAgICAgICAgLy8gZm9yIGVhY2ggc2NvcmUsIHdhbGsgdXAgdGhlIHRyZWUgbG9va2luZyBmb3IgdGhlIHRvcCAodGhlIGZpcnN0IHNjb3JlIHRvIG5vdCBoYXZlIGEgcGFyZW50SWQpXHJcbiAgICAgICAgICAgIGxldCBjdXJyZW50U2NvcmU6IGlTY29yZSB8IHVuZGVmaW5lZCA9IGNsYWltU2NvcmU7XHJcbiAgICAgICAgICAgIGxldCB0b3BTY29yZUlkID0gY2xhaW1TY29yZS5pZDtcclxuICAgICAgICAgICAgZG8ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRTY29yZS5wYXJlbnRTY29yZUlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudFNjb3JlID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRTY29yZShjdXJyZW50U2NvcmUucGFyZW50U2NvcmVJZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFNjb3JlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdG9wU2NvcmVJZCA9IGN1cnJlbnRTY29yZS5pZDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSB3aGlsZSAoY3VycmVudFNjb3JlPy5wYXJlbnRTY29yZUlkKVxyXG5cclxuICAgICAgICAgICAgaWYgKHRvcFNjb3JlSWQgJiYgdG9wU2NvcmVJZHMuaW5kZXhPZih0b3BTY29yZUlkKSA9PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgdG9wU2NvcmVJZHMucHVzaCh0b3BTY29yZUlkKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vUmUtY2FsYyBhbGwgdG9wIHNjb3JlcyB3aXRoIHBvc3NpYmxlIGNoYW5nZWQgY2xhaW1zXHJcbiAgICBmb3IgKGNvbnN0IHRvcFNjb3JlSWQgb2YgdG9wU2NvcmVJZHMpIHtcclxuICAgICAgICBjb25zdCB0b3BTY29yZSA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0U2NvcmUodG9wU2NvcmVJZClcclxuICAgICAgICBpZiAodG9wU2NvcmUpIHtcclxuICAgICAgICAgICAgY29uc3QgdGVtcE1pc3NpbmdTY29yZUFjdGlvbnM6IEFjdGlvbltdID0gW107XHJcbiAgICAgICAgICAgIGF3YWl0IGNyZWF0ZUJsYW5rTWlzc2luZ1Njb3JlcyhyZXBvc2l0b3J5LCB0b3BTY29yZUlkLCB0b3BTY29yZS5zb3VyY2VDbGFpbUlkIHx8IFwiXCIsIHRlbXBNaXNzaW5nU2NvcmVBY3Rpb25zLCB0b3BTY29yZUlkKVxyXG4gICAgICAgICAgICBpZiAodGVtcE1pc3NpbmdTY29yZUFjdGlvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgcmVwb3NpdG9yeS5ub3RpZnkodGVtcE1pc3NpbmdTY29yZUFjdGlvbnMpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgdGVtcGNhbGN1bGF0ZVNjb3JlVHJlZUFjdGlvbnM6IEFjdGlvbltdID0gW107XHJcbiAgICAgICAgICAgIGF3YWl0IGNhbGN1bGF0ZVNjb3JlVHJlZShyZXBvc2l0b3J5LCB0b3BTY29yZSwgY2FsY3VsYXRvciwgdGVtcE1pc3NpbmdTY29yZUFjdGlvbnMpO1xyXG4gICAgICAgICAgICBzY29yZUFjdGlvbnMucHVzaCguLi50ZW1wTWlzc2luZ1Njb3JlQWN0aW9ucywgLi4udGVtcGNhbGN1bGF0ZVNjb3JlVHJlZUFjdGlvbnMpXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vVE9ETzogUmV2aWV3IHRoaXMgZGVjaXNpb246IEZlZWQgdGhlIHNjb3JlIGFjdGlvbnMgYmFjayBpbnRvIHRoZSByZXBvc2l0b3J5IHNvIHRoaXMgcmVwb3NpdG9yeSBpcyB1cCB0byBkYXRlIGluIGNhc2UgaXQgaXMgdXNlZCBcclxuICAgIGF3YWl0IHJlcG9zaXRvcnkubm90aWZ5KHNjb3JlQWN0aW9ucyk7XHJcblxyXG4gICAgcmV0dXJuIHNjb3JlQWN0aW9ucztcclxufVxyXG5cclxuLy9DcmVhdGUgQmxhbmsgTWlzc2luZyBTY29yZXNcclxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlQmxhbmtNaXNzaW5nU2NvcmVzKHJlcG9zaXRvcnk6IGlSZXBvc2l0b3J5LCBjdXJyZW50U2NvcmVJZDogc3RyaW5nLCBjdXJyZW50Q2xhaW1JZDogc3RyaW5nLCBhY3Rpb25zOiBBY3Rpb25bXSwgdG9wU2NvcmVJZDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBlZGdlcyA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0Q2xhaW1FZGdlc0J5UGFyZW50SWQoY3VycmVudENsYWltSWQpXHJcbiAgICBjb25zdCBzY29yZXMgPSBhd2FpdCByZXBvc2l0b3J5LmdldENoaWxkcmVuQnlTY29yZUlkKGN1cnJlbnRTY29yZUlkKVxyXG4gICAgZm9yIChjb25zdCBlZGdlIG9mIGVkZ2VzKSB7XHJcbiAgICAgICAgLy9zZWUgaWYgdGhlcmUgaXMgYSBtYXRjaGluZyBjaGlsZCBzY29yZSBmb3IgdGhlIGNoaWxkIGVkZ2VcclxuICAgICAgICBsZXQgc2NvcmUgPSBzY29yZXMuZmluZCgoeyBzb3VyY2VDbGFpbUlkIH0pID0+IHNvdXJjZUNsYWltSWQgPT09IGVkZ2UuY2hpbGRJZCk7XHJcbiAgICAgICAgaWYgKCFzY29yZSkge1xyXG4gICAgICAgICAgICAvL0NyZWF0ZSBhIG5ldyBTY29yZSBhbmQgYXR0YWNoIGl0IHRvIGl0J3MgcGFyZW50XHJcbiAgICAgICAgICAgIGNvbnN0IHUgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIHNjb3JlID0gbmV3IFNjb3JlKGVkZ2UuY2hpbGRJZCwgdG9wU2NvcmVJZCwgY3VycmVudFNjb3JlSWQsIGVkZ2UuaWQsIHVuZGVmaW5lZCwgZWRnZS5wcm8sIGVkZ2UuYWZmZWN0cyx1LHUsdSxlZGdlLnByaW9yaXR5KTtcclxuICAgICAgICAgICAgYWN0aW9ucy5wdXNoKG5ldyBBY3Rpb24oc2NvcmUsIHVuZGVmaW5lZCwgXCJhZGRfc2NvcmVcIiwgc2NvcmUuaWQpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy9SZWN1cnNlIGFuZCB0aHJvdWdoIGNoaWxkcmVuXHJcbiAgICAgICAgYXdhaXQgY3JlYXRlQmxhbmtNaXNzaW5nU2NvcmVzKHJlcG9zaXRvcnksIHNjb3JlLmlkLCBlZGdlLmNoaWxkSWQsIGFjdGlvbnMsIHRvcFNjb3JlSWQpO1xyXG4gICAgfVxyXG59XHJcblxyXG4vL1RoaXMgZnVuY3Rpb24gYXNzdW1lIHRoYXQgYWxsIHNjb3JlcyBhbHJlYWR5IGV4aXN0XHJcbmFzeW5jIGZ1bmN0aW9uIGNhbGN1bGF0ZVNjb3JlVHJlZShyZXBvc2l0b3J5OiBpUmVwb3NpdG9yeSwgY3VycmVudFNjb3JlOiBpU2NvcmUsIGNhbGN1bGF0b3I6IGlDYWxjdWxhdGVTY29yZSA9IGNhbGN1bGF0ZVNjb3JlLCBhY3Rpb25zOiBBY3Rpb25bXSkge1xyXG4gICAgY29uc3Qgb2xkU2NvcmVzID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRDaGlsZHJlbkJ5U2NvcmVJZChjdXJyZW50U2NvcmUuaWQpXHJcbiAgICBjb25zdCBuZXdTY29yZXM6IGlTY29yZVtdID0gW107XHJcblxyXG4gICAgZm9yIChjb25zdCBvbGRTY29yZSBvZiBvbGRTY29yZXMpIHsgLy9DYWxjdWxhdGUgQ2hpbGRyZW5cclxuICAgICAgICAvL1RPRE86IHJlbW92ZSBhbnkgc2NvcmVzIHRvIGNhbGN1bGF0ZSBiYXNlZCBvbiBmb3JtdWxhcyB0aGF0IGV4Y2x1ZGUgc2NvcmVzXHJcbiAgICAgICAgbmV3U2NvcmVzLnB1c2goYXdhaXQgY2FsY3VsYXRlU2NvcmVUcmVlKHJlcG9zaXRvcnksIG9sZFNjb3JlLCBjYWxjdWxhdG9yLCBhY3Rpb25zKSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbmV3U2NvcmVGcmFnbWVudCA9IGNhbGN1bGF0b3Ioe1xyXG4gICAgICAgIGNoaWxkU2NvcmVzOiBuZXdTY29yZXMsXHJcbiAgICAgICAgcmV2ZXJzaWJsZTogY3VycmVudFNjb3JlLnJldmVyc2libGUsXHJcbiAgICB9KVxyXG5cclxuICAgIC8vVE9ETzogTW9kaWZ5IHRoZSBuZXdTY29yZSBiYXNlZCBvbiBhbnkgZm9ybXVsYXNcclxuICAgIGNvbnN0IG5ld1Njb3JlID0geyAuLi5jdXJyZW50U2NvcmUsIC4uLm5ld1Njb3JlRnJhZ21lbnQgfVxyXG4gICAgaWYgKGRpZmZlcmVudFNjb3JlcyhjdXJyZW50U2NvcmUsIG5ld1Njb3JlKSkge1xyXG4gICAgICAgIGFjdGlvbnMucHVzaChuZXcgQWN0aW9uKG5ld1Njb3JlLCB1bmRlZmluZWQsIFwibW9kaWZ5X3Njb3JlXCIsIG5ld1Njb3JlLmlkKSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbmV3U2NvcmU7XHJcbn1cclxuIl19
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.calculateScoreActions = calculateScoreActions;

var _Score = require("./dataModels/Score");

var _Action = require("./dataModels/Action");

var _calculateScore = require("./calculateScore");

var _RepositoryLocalReactive = require("./repositories/RepositoryLocalReactive");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Calculates the score actions based on a list of actions
 */
async function calculateScoreActions({
  actions = [],
  repository = new _RepositoryLocalReactive.RepositoryLocalReactive(),
  calculator = _calculateScore.calculateScore
} = {}) {
  debugger;
  const scoreActions = [];
  const claimIdsToScore = [];
  const topScoreIds = [];
  await repository.notify(actions);

  for (const action of actions) {
    // find claims that may need scores changed
    if (action.type == 'add_claim' || action.type == 'modify_claim') {
      claimIdsToScore.push(action.dataId);
    }

    if (action.type == "add_score") {
      const score = action.newData;
      claimIdsToScore.push(score.sourceClaimId);
    } //Add scores if edges adds new children to claims in score trees


    if (action.type == 'add_claimEdge' || action.type == 'modify_claimEdge') {
      const claimEdge = action.newData;
      claimIdsToScore.push(claimEdge.parentId);
    } //TODO: If an edge changes then modify the existing scores to match


    if (action.type == 'modify_claimEdge') {
      const claimEdge = action.newData;
      const scores = await repository.getScoresBySourceId(claimEdge.id);

      for (const score of scores) {
        //TODO: Where should I put this? It is modifying am object. If it is reactive i should just change the data. If pure it should be a new object.
        //For now I will modify it but it may not trigger updates in a pure library (React)
        //This change should also probably be centralized somewhere to reduce the chance of inconsistent bugs. I think it will happen in multiple paces
        //Nope, it is an action so it should always be a new object. If it goes into a reactive respoitory then it will modify the actual object
        //Should I group these actions or just throw them in one at a time like I am doing
        await repository.notify([new _Action.Action({
          pro: claimEdge.pro,
          affects: claimEdge.affects
        }, score, "modify_score", score.id)]);
      }
    }
  } //Walk up the scores for each claim to the top


  for (const claimId of claimIdsToScore) {
    const scoresForTheClaim = await repository.getScoresBySourceId(claimId);

    for (const claimScore of scoresForTheClaim) {
      // for each score, walk up the tree looking for the top (the first score to not have a parentId)
      let currentScore = claimScore;
      let topScoreId = claimScore.id;

      do {
        var _currentScore;

        if (currentScore.parentScoreId) {
          currentScore = await repository.getScore(currentScore.parentScoreId);
        }

        if (currentScore) {
          topScoreId = currentScore.id;
        }
      } while ((_currentScore = currentScore) === null || _currentScore === void 0 ? void 0 : _currentScore.parentScoreId);

      if (topScoreId && topScoreIds.indexOf(topScoreId) == -1) {
        topScoreIds.push(topScoreId);
      }
    }
  } //Re-calc all top scores with possible changed claims


  for (const topScoreId of topScoreIds) {
    const topScore = await repository.getScore(topScoreId);

    if (topScore) {
      const tempMissingScoreActions = [];
      await createBlankMissingScores(repository, topScoreId, topScore.sourceClaimId || "", tempMissingScoreActions, topScoreId);

      if (tempMissingScoreActions.length > 0) {
        await repository.notify(tempMissingScoreActions);
      }

      const tempcalculateScoreTreeActions = [];
      await calculateScoreTree(repository, topScore, calculator, tempMissingScoreActions);
      debugger;
      scoreActions.push(...tempMissingScoreActions, ...tempcalculateScoreTreeActions);
    }
  }

  return scoreActions;
} //Create Blank Missing Scores


async function createBlankMissingScores(repository, currentScoreId, currentClaimId, actions, topScoreId) {
  const edges = await repository.getClaimEdgesByParentId(currentClaimId);
  const scores = await repository.getChildrenByScoreId(currentScoreId);

  for (const edge of edges) {
    //see if there is a matching child score for the child edge
    let score = scores.find(({
      sourceClaimId
    }) => sourceClaimId === edge.childId);

    if (!score) {
      //Create a new Score and attach it to it's parent
      score = new _Score.Score(edge.childId, topScoreId, currentScoreId, edge.id, undefined, edge.pro, edge.affects);
      actions.push(new _Action.Action(score, undefined, "add_score", score.id));
    } //Recurse and through children


    await createBlankMissingScores(repository, score.id, edge.childId, actions, topScoreId);
  }
} //This function assume that all scores already exist


async function calculateScoreTree(repository, currentScore, calculator = _calculateScore.calculateScore, actions) {
  const oldScores = await repository.getChildrenByScoreId(currentScore.id);
  const newScores = [];

  for (const oldScore of oldScores) {
    //Calculate Children
    //TODO: remove any scores to calculate based on formulas that exclude scores
    newScores.push((await calculateScoreTree(repository, oldScore, calculator, actions)));
  }

  const newScoreFragment = calculator({
    childScores: newScores,
    reversible: currentScore.reversible
  }); //TODO: Modify the newScore based on any formulas

  const newScore = _objectSpread({}, currentScore, {}, newScoreFragment);

  if ((0, _Score.differentScores)(currentScore, newScore)) {
    actions.push(new _Action.Action(newScore, undefined, "modify_score", newScore.id));
  }

  return newScore;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWxjdWxhdGVTY29yZUFjdGlvbnMudHMiXSwibmFtZXMiOlsiY2FsY3VsYXRlU2NvcmVBY3Rpb25zIiwiYWN0aW9ucyIsInJlcG9zaXRvcnkiLCJSZXBvc2l0b3J5TG9jYWxSZWFjdGl2ZSIsImNhbGN1bGF0b3IiLCJjYWxjdWxhdGVTY29yZSIsInNjb3JlQWN0aW9ucyIsImNsYWltSWRzVG9TY29yZSIsInRvcFNjb3JlSWRzIiwibm90aWZ5IiwiYWN0aW9uIiwidHlwZSIsInB1c2giLCJkYXRhSWQiLCJzY29yZSIsIm5ld0RhdGEiLCJzb3VyY2VDbGFpbUlkIiwiY2xhaW1FZGdlIiwicGFyZW50SWQiLCJzY29yZXMiLCJnZXRTY29yZXNCeVNvdXJjZUlkIiwiaWQiLCJBY3Rpb24iLCJwcm8iLCJhZmZlY3RzIiwiY2xhaW1JZCIsInNjb3Jlc0ZvclRoZUNsYWltIiwiY2xhaW1TY29yZSIsImN1cnJlbnRTY29yZSIsInRvcFNjb3JlSWQiLCJwYXJlbnRTY29yZUlkIiwiZ2V0U2NvcmUiLCJpbmRleE9mIiwidG9wU2NvcmUiLCJ0ZW1wTWlzc2luZ1Njb3JlQWN0aW9ucyIsImNyZWF0ZUJsYW5rTWlzc2luZ1Njb3JlcyIsImxlbmd0aCIsInRlbXBjYWxjdWxhdGVTY29yZVRyZWVBY3Rpb25zIiwiY2FsY3VsYXRlU2NvcmVUcmVlIiwiY3VycmVudFNjb3JlSWQiLCJjdXJyZW50Q2xhaW1JZCIsImVkZ2VzIiwiZ2V0Q2xhaW1FZGdlc0J5UGFyZW50SWQiLCJnZXRDaGlsZHJlbkJ5U2NvcmVJZCIsImVkZ2UiLCJmaW5kIiwiY2hpbGRJZCIsIlNjb3JlIiwidW5kZWZpbmVkIiwib2xkU2NvcmVzIiwibmV3U2NvcmVzIiwib2xkU2NvcmUiLCJuZXdTY29yZUZyYWdtZW50IiwiY2hpbGRTY29yZXMiLCJyZXZlcnNpYmxlIiwibmV3U2NvcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFLQTs7Ozs7Ozs7QUFFQTs7O0FBR08s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QyxJQUFWLEVBQWUsTUFBTTBCLGtCQUFrQixDQUFDcEMsVUFBRCxFQUFhaUQsUUFBYixFQUF1Qi9DLFVBQXZCLEVBQW1DSCxPQUFuQyxDQUF2QztBQUNIOztBQUVELFFBQU1tRCxnQkFBZ0IsR0FBR2hELFVBQVUsQ0FBQztBQUNoQ2lELElBQUFBLFdBQVcsRUFBRUgsU0FEbUI7QUFFaENJLElBQUFBLFVBQVUsRUFBRTFCLFlBQVksQ0FBQzBCO0FBRk8sR0FBRCxDQUFuQyxDQVQ4SSxDQWM5STs7QUFDQSxRQUFNQyxRQUFRLHFCQUFRM0IsWUFBUixNQUF5QndCLGdCQUF6QixDQUFkOztBQUNBLE1BQUksNEJBQWdCeEIsWUFBaEIsRUFBOEIyQixRQUE5QixDQUFKLEVBQTZDO0FBQ3pDdEQsSUFBQUEsT0FBTyxDQUFDVyxJQUFSLENBQWEsSUFBSVUsY0FBSixDQUFXaUMsUUFBWCxFQUFxQlAsU0FBckIsRUFBZ0MsY0FBaEMsRUFBZ0RPLFFBQVEsQ0FBQ2xDLEVBQXpELENBQWI7QUFDSDs7QUFDRCxTQUFPa0MsUUFBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2NvcmUsIGRpZmZlcmVudFNjb3JlcywgaVNjb3JlIH0gZnJvbSBcIi4vZGF0YU1vZGVscy9TY29yZVwiO1xyXG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tIFwiLi9kYXRhTW9kZWxzL0FjdGlvblwiO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5TG9jYWxQdXJlIH0gZnJvbSBcIi4vcmVwb3NpdG9yaWVzL1JlcG9zaXRvcnlMb2NhbFB1cmVcIjtcclxuaW1wb3J0IHsgaUNhbGN1bGF0ZVNjb3JlLCBjYWxjdWxhdGVTY29yZSB9IGZyb20gXCIuL2NhbGN1bGF0ZVNjb3JlXCI7XHJcbmltcG9ydCB7IENsYWltIH0gZnJvbSBcIi4vZGF0YU1vZGVscy9DbGFpbVwiO1xyXG5pbXBvcnQgeyBpUmVwb3NpdG9yeSB9IGZyb20gXCIuL2RhdGFNb2RlbHMvaVJlcG9zaXRvcnlcIjtcclxuaW1wb3J0IHsgQ2xhaW1FZGdlIH0gZnJvbSBcIi4vZGF0YU1vZGVscy9DbGFpbUVkZ2VcIjtcclxuaW1wb3J0IHsgbmV3SWQgfSBmcm9tIFwiLi9uZXdJZFwiO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5TG9jYWxSZWFjdGl2ZSB9IGZyb20gXCIuL3JlcG9zaXRvcmllcy9SZXBvc2l0b3J5TG9jYWxSZWFjdGl2ZVwiO1xyXG5cclxuLyoqXHJcbiAqIENhbGN1bGF0ZXMgdGhlIHNjb3JlIGFjdGlvbnMgYmFzZWQgb24gYSBsaXN0IG9mIGFjdGlvbnNcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjYWxjdWxhdGVTY29yZUFjdGlvbnMoeyBhY3Rpb25zID0gW10sIHJlcG9zaXRvcnkgPSBuZXcgUmVwb3NpdG9yeUxvY2FsUmVhY3RpdmUoKSwgY2FsY3VsYXRvciA9IGNhbGN1bGF0ZVNjb3JlIH06IHtcclxuICAgIC8qKiBBbiBhcnJheSBvZiBhY3Rpb25zLCB1c3VhbGx5IG9uIGNsYWltcyBvciBlZGdlcyB0aGF0IGluY2x1c2Ugbm8gc2NvcmVzKi9cclxuICAgIGFjdGlvbnM/OiBBY3Rpb25bXTtcclxuICAgIC8qKiBUaGUgcmVwb3NpdG9yeSB1c2VkIHRvIGdldCBjb250ZXh0IGZvciB0aGUgYWN0aW9ucyAqL1xyXG4gICAgcmVwb3NpdG9yeT86IGlSZXBvc2l0b3J5O1xyXG4gICAgLyoqIFRoZSBmdW5jdGlvbiB1c2VkIHRvIGNhbGN1bGF0ZSB0aGUgc2NvcmVzICovXHJcbiAgICBjYWxjdWxhdG9yPzogaUNhbGN1bGF0ZVNjb3JlO1xyXG59ID0ge30sXHJcbikge1xyXG4gICAgZGVidWdnZXJcclxuICAgIGNvbnN0IHNjb3JlQWN0aW9uczogQWN0aW9uW10gPSBbXTtcclxuICAgIGNvbnN0IGNsYWltSWRzVG9TY29yZTogc3RyaW5nW10gPSBbXTtcclxuICAgIGNvbnN0IHRvcFNjb3JlSWRzOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAgIGF3YWl0IHJlcG9zaXRvcnkubm90aWZ5KGFjdGlvbnMpO1xyXG4gICAgZm9yIChjb25zdCBhY3Rpb24gb2YgYWN0aW9ucykge1xyXG5cclxuICAgICAgICAvLyBmaW5kIGNsYWltcyB0aGF0IG1heSBuZWVkIHNjb3JlcyBjaGFuZ2VkXHJcbiAgICAgICAgaWYgKGFjdGlvbi50eXBlID09ICdhZGRfY2xhaW0nIHx8IGFjdGlvbi50eXBlID09ICdtb2RpZnlfY2xhaW0nKSB7XHJcbiAgICAgICAgICAgIGNsYWltSWRzVG9TY29yZS5wdXNoKGFjdGlvbi5kYXRhSWQpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT0gXCJhZGRfc2NvcmVcIikge1xyXG4gICAgICAgICAgICBjb25zdCBzY29yZSA9IGFjdGlvbi5uZXdEYXRhIGFzIFNjb3JlO1xyXG4gICAgICAgICAgICBjbGFpbUlkc1RvU2NvcmUucHVzaChzY29yZS5zb3VyY2VDbGFpbUlkKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy9BZGQgc2NvcmVzIGlmIGVkZ2VzIGFkZHMgbmV3IGNoaWxkcmVuIHRvIGNsYWltcyBpbiBzY29yZSB0cmVlc1xyXG4gICAgICAgIGlmIChhY3Rpb24udHlwZSA9PSAnYWRkX2NsYWltRWRnZScgfHwgYWN0aW9uLnR5cGUgPT0gJ21vZGlmeV9jbGFpbUVkZ2UnKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNsYWltRWRnZSA9IGFjdGlvbi5uZXdEYXRhIGFzIENsYWltRWRnZTtcclxuICAgICAgICAgICAgY2xhaW1JZHNUb1Njb3JlLnB1c2goY2xhaW1FZGdlLnBhcmVudElkKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy9UT0RPOiBJZiBhbiBlZGdlIGNoYW5nZXMgdGhlbiBtb2RpZnkgdGhlIGV4aXN0aW5nIHNjb3JlcyB0byBtYXRjaFxyXG4gICAgICAgIGlmIChhY3Rpb24udHlwZSA9PSAnbW9kaWZ5X2NsYWltRWRnZScpIHtcclxuICAgICAgICAgICAgY29uc3QgY2xhaW1FZGdlID0gYWN0aW9uLm5ld0RhdGEgYXMgQ2xhaW1FZGdlO1xyXG4gICAgICAgICAgICBjb25zdCBzY29yZXMgPSBhd2FpdCByZXBvc2l0b3J5LmdldFNjb3Jlc0J5U291cmNlSWQoY2xhaW1FZGdlLmlkKVxyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHNjb3JlIG9mIHNjb3Jlcykge1xyXG4gICAgICAgICAgICAgICAgLy9UT0RPOiBXaGVyZSBzaG91bGQgSSBwdXQgdGhpcz8gSXQgaXMgbW9kaWZ5aW5nIGFtIG9iamVjdC4gSWYgaXQgaXMgcmVhY3RpdmUgaSBzaG91bGQganVzdCBjaGFuZ2UgdGhlIGRhdGEuIElmIHB1cmUgaXQgc2hvdWxkIGJlIGEgbmV3IG9iamVjdC5cclxuICAgICAgICAgICAgICAgIC8vRm9yIG5vdyBJIHdpbGwgbW9kaWZ5IGl0IGJ1dCBpdCBtYXkgbm90IHRyaWdnZXIgdXBkYXRlcyBpbiBhIHB1cmUgbGlicmFyeSAoUmVhY3QpXHJcbiAgICAgICAgICAgICAgICAvL1RoaXMgY2hhbmdlIHNob3VsZCBhbHNvIHByb2JhYmx5IGJlIGNlbnRyYWxpemVkIHNvbWV3aGVyZSB0byByZWR1Y2UgdGhlIGNoYW5jZSBvZiBpbmNvbnNpc3RlbnQgYnVncy4gSSB0aGluayBpdCB3aWxsIGhhcHBlbiBpbiBtdWx0aXBsZSBwYWNlc1xyXG4gICAgICAgICAgICAgICAgLy9Ob3BlLCBpdCBpcyBhbiBhY3Rpb24gc28gaXQgc2hvdWxkIGFsd2F5cyBiZSBhIG5ldyBvYmplY3QuIElmIGl0IGdvZXMgaW50byBhIHJlYWN0aXZlIHJlc3BvaXRvcnkgdGhlbiBpdCB3aWxsIG1vZGlmeSB0aGUgYWN0dWFsIG9iamVjdFxyXG4gICAgICAgICAgICAgICAgLy9TaG91bGQgSSBncm91cCB0aGVzZSBhY3Rpb25zIG9yIGp1c3QgdGhyb3cgdGhlbSBpbiBvbmUgYXQgYSB0aW1lIGxpa2UgSSBhbSBkb2luZ1xyXG5cclxuICAgICAgICAgICAgICAgIGF3YWl0IHJlcG9zaXRvcnkubm90aWZ5KFtuZXcgQWN0aW9uKHtcclxuICAgICAgICAgICAgICAgICAgICBwcm86IGNsYWltRWRnZS5wcm8sXHJcbiAgICAgICAgICAgICAgICAgICAgYWZmZWN0czogY2xhaW1FZGdlLmFmZmVjdHMsXHJcbiAgICAgICAgICAgICAgICB9LCBzY29yZSwgXCJtb2RpZnlfc2NvcmVcIiwgc2NvcmUuaWQpXSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvL1dhbGsgdXAgdGhlIHNjb3JlcyBmb3IgZWFjaCBjbGFpbSB0byB0aGUgdG9wXHJcbiAgICBmb3IgKGNvbnN0IGNsYWltSWQgb2YgY2xhaW1JZHNUb1Njb3JlKSB7XHJcbiAgICAgICAgY29uc3Qgc2NvcmVzRm9yVGhlQ2xhaW0gPSBhd2FpdCByZXBvc2l0b3J5LmdldFNjb3Jlc0J5U291cmNlSWQoY2xhaW1JZClcclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBjbGFpbVNjb3JlIG9mIHNjb3Jlc0ZvclRoZUNsYWltKSB7XHJcbiAgICAgICAgICAgIC8vIGZvciBlYWNoIHNjb3JlLCB3YWxrIHVwIHRoZSB0cmVlIGxvb2tpbmcgZm9yIHRoZSB0b3AgKHRoZSBmaXJzdCBzY29yZSB0byBub3QgaGF2ZSBhIHBhcmVudElkKVxyXG4gICAgICAgICAgICBsZXQgY3VycmVudFNjb3JlOiBpU2NvcmUgfCB1bmRlZmluZWQgPSBjbGFpbVNjb3JlO1xyXG4gICAgICAgICAgICBsZXQgdG9wU2NvcmVJZCA9IGNsYWltU2NvcmUuaWQ7XHJcbiAgICAgICAgICAgIGRvIHtcclxuICAgICAgICAgICAgICAgIGlmIChjdXJyZW50U2NvcmUucGFyZW50U2NvcmVJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTY29yZSA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0U2NvcmUoY3VycmVudFNjb3JlLnBhcmVudFNjb3JlSWQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRTY29yZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRvcFNjb3JlSWQgPSBjdXJyZW50U2NvcmUuaWQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gd2hpbGUgKGN1cnJlbnRTY29yZT8ucGFyZW50U2NvcmVJZClcclxuXHJcbiAgICAgICAgICAgIGlmICh0b3BTY29yZUlkICYmIHRvcFNjb3JlSWRzLmluZGV4T2YodG9wU2NvcmVJZCkgPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIHRvcFNjb3JlSWRzLnB1c2godG9wU2NvcmVJZClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvL1JlLWNhbGMgYWxsIHRvcCBzY29yZXMgd2l0aCBwb3NzaWJsZSBjaGFuZ2VkIGNsYWltc1xyXG4gICAgZm9yIChjb25zdCB0b3BTY29yZUlkIG9mIHRvcFNjb3JlSWRzKSB7XHJcbiAgICAgICAgY29uc3QgdG9wU2NvcmUgPSBhd2FpdCByZXBvc2l0b3J5LmdldFNjb3JlKHRvcFNjb3JlSWQpXHJcbiAgICAgICAgaWYgKHRvcFNjb3JlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRlbXBNaXNzaW5nU2NvcmVBY3Rpb25zOiBBY3Rpb25bXSA9IFtdO1xyXG4gICAgICAgICAgICBhd2FpdCBjcmVhdGVCbGFua01pc3NpbmdTY29yZXMocmVwb3NpdG9yeSwgdG9wU2NvcmVJZCwgdG9wU2NvcmUuc291cmNlQ2xhaW1JZCB8fCBcIlwiLCB0ZW1wTWlzc2luZ1Njb3JlQWN0aW9ucywgdG9wU2NvcmVJZClcclxuICAgICAgICAgICAgaWYgKHRlbXBNaXNzaW5nU2NvcmVBY3Rpb25zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHJlcG9zaXRvcnkubm90aWZ5KHRlbXBNaXNzaW5nU2NvcmVBY3Rpb25zKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHRlbXBjYWxjdWxhdGVTY29yZVRyZWVBY3Rpb25zOiBBY3Rpb25bXSA9IFtdO1xyXG4gICAgICAgICAgICBhd2FpdCBjYWxjdWxhdGVTY29yZVRyZWUocmVwb3NpdG9yeSwgdG9wU2NvcmUsIGNhbGN1bGF0b3IsIHRlbXBNaXNzaW5nU2NvcmVBY3Rpb25zKTtcclxuICAgICAgICAgICAgZGVidWdnZXJcclxuICAgICAgICAgICAgc2NvcmVBY3Rpb25zLnB1c2goLi4udGVtcE1pc3NpbmdTY29yZUFjdGlvbnMsIC4uLnRlbXBjYWxjdWxhdGVTY29yZVRyZWVBY3Rpb25zKVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gc2NvcmVBY3Rpb25zO1xyXG59XHJcblxyXG4vL0NyZWF0ZSBCbGFuayBNaXNzaW5nIFNjb3Jlc1xyXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVCbGFua01pc3NpbmdTY29yZXMocmVwb3NpdG9yeTogaVJlcG9zaXRvcnksIGN1cnJlbnRTY29yZUlkOiBzdHJpbmcsIGN1cnJlbnRDbGFpbUlkOiBzdHJpbmcsIGFjdGlvbnM6IEFjdGlvbltdLCB0b3BTY29yZUlkOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGVkZ2VzID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRDbGFpbUVkZ2VzQnlQYXJlbnRJZChjdXJyZW50Q2xhaW1JZClcclxuICAgIGNvbnN0IHNjb3JlcyA9IGF3YWl0IHJlcG9zaXRvcnkuZ2V0Q2hpbGRyZW5CeVNjb3JlSWQoY3VycmVudFNjb3JlSWQpXHJcbiAgICBmb3IgKGNvbnN0IGVkZ2Ugb2YgZWRnZXMpIHtcclxuICAgICAgICAvL3NlZSBpZiB0aGVyZSBpcyBhIG1hdGNoaW5nIGNoaWxkIHNjb3JlIGZvciB0aGUgY2hpbGQgZWRnZVxyXG4gICAgICAgIGxldCBzY29yZSA9IHNjb3Jlcy5maW5kKCh7IHNvdXJjZUNsYWltSWQgfSkgPT4gc291cmNlQ2xhaW1JZCA9PT0gZWRnZS5jaGlsZElkKTtcclxuICAgICAgICBpZiAoIXNjb3JlKSB7XHJcbiAgICAgICAgICAgIC8vQ3JlYXRlIGEgbmV3IFNjb3JlIGFuZCBhdHRhY2ggaXQgdG8gaXQncyBwYXJlbnRcclxuICAgICAgICAgICAgc2NvcmUgPSBuZXcgU2NvcmUoZWRnZS5jaGlsZElkLCB0b3BTY29yZUlkLCBjdXJyZW50U2NvcmVJZCwgZWRnZS5pZCwgdW5kZWZpbmVkLCBlZGdlLnBybywgZWRnZS5hZmZlY3RzKTtcclxuICAgICAgICAgICAgYWN0aW9ucy5wdXNoKG5ldyBBY3Rpb24oc2NvcmUsIHVuZGVmaW5lZCwgXCJhZGRfc2NvcmVcIiwgc2NvcmUuaWQpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy9SZWN1cnNlIGFuZCB0aHJvdWdoIGNoaWxkcmVuXHJcbiAgICAgICAgYXdhaXQgY3JlYXRlQmxhbmtNaXNzaW5nU2NvcmVzKHJlcG9zaXRvcnksIHNjb3JlLmlkLCBlZGdlLmNoaWxkSWQsIGFjdGlvbnMsIHRvcFNjb3JlSWQpO1xyXG4gICAgfVxyXG59XHJcblxyXG4vL1RoaXMgZnVuY3Rpb24gYXNzdW1lIHRoYXQgYWxsIHNjb3JlcyBhbHJlYWR5IGV4aXN0XHJcbmFzeW5jIGZ1bmN0aW9uIGNhbGN1bGF0ZVNjb3JlVHJlZShyZXBvc2l0b3J5OiBpUmVwb3NpdG9yeSwgY3VycmVudFNjb3JlOiBpU2NvcmUsIGNhbGN1bGF0b3I6IGlDYWxjdWxhdGVTY29yZSA9IGNhbGN1bGF0ZVNjb3JlLCBhY3Rpb25zOiBBY3Rpb25bXSkge1xyXG4gICAgY29uc3Qgb2xkU2NvcmVzID0gYXdhaXQgcmVwb3NpdG9yeS5nZXRDaGlsZHJlbkJ5U2NvcmVJZChjdXJyZW50U2NvcmUuaWQpXHJcbiAgICBjb25zdCBuZXdTY29yZXM6IGlTY29yZVtdID0gW107XHJcblxyXG4gICAgZm9yIChjb25zdCBvbGRTY29yZSBvZiBvbGRTY29yZXMpIHsgLy9DYWxjdWxhdGUgQ2hpbGRyZW5cclxuICAgICAgICAvL1RPRE86IHJlbW92ZSBhbnkgc2NvcmVzIHRvIGNhbGN1bGF0ZSBiYXNlZCBvbiBmb3JtdWxhcyB0aGF0IGV4Y2x1ZGUgc2NvcmVzXHJcbiAgICAgICAgbmV3U2NvcmVzLnB1c2goYXdhaXQgY2FsY3VsYXRlU2NvcmVUcmVlKHJlcG9zaXRvcnksIG9sZFNjb3JlLCBjYWxjdWxhdG9yLCBhY3Rpb25zKSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbmV3U2NvcmVGcmFnbWVudCA9IGNhbGN1bGF0b3Ioe1xyXG4gICAgICAgIGNoaWxkU2NvcmVzOiBuZXdTY29yZXMsXHJcbiAgICAgICAgcmV2ZXJzaWJsZTogY3VycmVudFNjb3JlLnJldmVyc2libGUsXHJcbiAgICB9KVxyXG5cclxuICAgIC8vVE9ETzogTW9kaWZ5IHRoZSBuZXdTY29yZSBiYXNlZCBvbiBhbnkgZm9ybXVsYXNcclxuICAgIGNvbnN0IG5ld1Njb3JlID0geyAuLi5jdXJyZW50U2NvcmUsIC4uLm5ld1Njb3JlRnJhZ21lbnQgfVxyXG4gICAgaWYgKGRpZmZlcmVudFNjb3JlcyhjdXJyZW50U2NvcmUsIG5ld1Njb3JlKSkge1xyXG4gICAgICAgIGFjdGlvbnMucHVzaChuZXcgQWN0aW9uKG5ld1Njb3JlLCB1bmRlZmluZWQsIFwibW9kaWZ5X3Njb3JlXCIsIG5ld1Njb3JlLmlkKSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbmV3U2NvcmU7XHJcbn1cclxuIl19
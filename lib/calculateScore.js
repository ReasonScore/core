"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.calculateScore = calculateScore;

/**
 * Calculates a new score based on the child scores passed in.
 */
function calculateScore({
  childScores = [],
  reversible = true
} = {}) {
  // TODO: Simplify all this math and maybe break it up between base functionality and additional scoring (like the points)
  const newScore = {};
  newScore.confidence = 0;
  newScore.relevance = 1;
  newScore.childrenAveragingWeight = 0;
  newScore.childrenConfidenceWeight = 0;
  newScore.childrenRelevanceWeight = 0;
  newScore.childrenWeight = 0; // newScore.childrenProWeight = 0;
  // newScore.childrenConWeight = 0;

  let maxChildWeight = 0;

  if (childScores.filter(s => s.affects === 'confidence').length < 1) {
    // Defaults if there are no children
    newScore.confidence = 1; // assume 100% confident

    newScore.relevance = 1; // assume 100% relevant

    newScore.childrenAveragingWeight = 1;
    newScore.childrenConfidenceWeight = 1;
    newScore.childrenRelevanceWeight = 1;
    newScore.childrenWeight = 1;
    newScore.weight = 1;
  } //Gather children Weights totals for processing further down


  for (const childScore of childScores) {
    // //Ensure calculations for non-reversible scores don't allow the confidence to be below 0
    // //TODO: Is this needed in the totals seciton?
    // let confidence = childScore.confidence
    // if (!childScore.reversible && childScore.confidence < 0) {
    //     confidence = 0
    // }
    childScore.weight = calcWeight(childScore); //TODO: Just in case a child score comes in uncalculated - maybe should be removed

    newScore.childrenAveragingWeight += 1;
    newScore.childrenConfidenceWeight += Math.abs(childScore.confidence);
    newScore.childrenRelevanceWeight += childScore.relevance;
    newScore.childrenWeight += childScore.weight;

    if (childScore.weight > maxChildWeight) {
      maxChildWeight = childScore.weight;
    } // //TODO: Experimantal
    // if (confidence > 0) {
    //     if (childScore.pro) {
    //         newScore.childrenProWeight += confidence
    //     }
    //     if (!childScore.pro) {
    //         newScore.childrenConWeight += confidence
    //     }
    // } else if (confidence < 0) {
    //     if (childScore.pro) {
    //         newScore.childrenConWeight += confidence
    //     }
    //     if (!childScore.pro) {
    //         newScore.childrenProWeight += confidence
    //     }
    // }

  } // Loop through to calculate the final scores


  for (const childScore of childScores) {
    const polarity = childScore.pro ? 1 : -1;

    if (childScore.affects === "confidence") {
      if (newScore.childrenWeight === 0) {
        childScore.percentOfWeight = 0;
        newScore.confidence = 0;
      } else {
        childScore.percentOfWeight = childScore.weight / newScore.childrenWeight;
        newScore.confidence += childScore.percentOfWeight * childScore.confidence * polarity;
      }
    }

    if (childScore.affects === "relevance") {
      // Process Relevance child claims
      let confidence = childScore.confidence;

      if (!childScore.reversible && childScore.confidence < 0) {
        confidence = 0;
      }

      if (newScore.relevance == undefined) {
        newScore.relevance = 1;
      }

      if (childScore.pro) {
        newScore.relevance += confidence;
      } else {
        newScore.relevance -= confidence / 2;
      }
    } // if (childScore.pro) {
    //     childScore.percentAgreeWeight = confidence / newScore.childrenProWeight
    // } else {
    //     childScore.percentAgreeWeight = confidence / newScore.childrenConWeight
    // }


    childScore.scaledWeight = childScore.weight / maxChildWeight;
  }

  if (Object.is(newScore.confidence, -0)) {
    // Protect against negative zero 
    newScore.confidence = 0;
  }

  let confidence = Math.abs(newScore.confidence);

  if (!newScore.reversible && newScore.confidence < 0) {
    confidence = 0;
  }

  newScore.weight = calcWeight(newScore);
  newScore.scaledWeight = newScore.weight;
  return newScore;
}

function calcWeight(score) {
  if (score.confidence !== undefined && score.relevance !== undefined) {
    let confidence = Math.abs(score.confidence);

    if (!score.reversible && score.confidence < 0) {
      confidence = 0;
    }

    return confidence * score.relevance;
  } else {
    return 1;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWxjdWxhdGVTY29yZS50cyJdLCJuYW1lcyI6WyJjYWxjdWxhdGVTY29yZSIsImNoaWxkU2NvcmVzIiwicmV2ZXJzaWJsZSIsIm5ld1Njb3JlIiwiY29uZmlkZW5jZSIsInJlbGV2YW5jZSIsImNoaWxkcmVuQXZlcmFnaW5nV2VpZ2h0IiwiY2hpbGRyZW5Db25maWRlbmNlV2VpZ2h0IiwiY2hpbGRyZW5SZWxldmFuY2VXZWlnaHQiLCJjaGlsZHJlbldlaWdodCIsIm1heENoaWxkV2VpZ2h0IiwiZmlsdGVyIiwicyIsImFmZmVjdHMiLCJsZW5ndGgiLCJ3ZWlnaHQiLCJjaGlsZFNjb3JlIiwiY2FsY1dlaWdodCIsIk1hdGgiLCJhYnMiLCJwb2xhcml0eSIsInBybyIsInBlcmNlbnRPZldlaWdodCIsInVuZGVmaW5lZCIsInNjYWxlZFdlaWdodCIsIk9iamVjdCIsImlzIiwic2NvcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFTQTtBQUNBO0FBQ0E7QUFDTyxTQUFTQSxjQUFULENBQXdCO0FBQUVDLEVBQUFBLFdBQVcsR0FBRyxFQUFoQjtBQUFvQkMsRUFBQUEsVUFBVSxHQUFHO0FBQWpDLElBSzNCLEVBTEcsRUFNVztBQUNkO0FBQ0EsUUFBTUMsUUFBd0IsR0FBRyxFQUFqQztBQUNBQSxFQUFBQSxRQUFRLENBQUNDLFVBQVQsR0FBc0IsQ0FBdEI7QUFDQUQsRUFBQUEsUUFBUSxDQUFDRSxTQUFULEdBQXFCLENBQXJCO0FBQ0FGLEVBQUFBLFFBQVEsQ0FBQ0csdUJBQVQsR0FBbUMsQ0FBbkM7QUFDQUgsRUFBQUEsUUFBUSxDQUFDSSx3QkFBVCxHQUFvQyxDQUFwQztBQUNBSixFQUFBQSxRQUFRLENBQUNLLHVCQUFULEdBQW1DLENBQW5DO0FBQ0FMLEVBQUFBLFFBQVEsQ0FBQ00sY0FBVCxHQUEwQixDQUExQixDQVJjLENBU2Q7QUFDQTs7QUFFQSxNQUFJQyxjQUFjLEdBQUcsQ0FBckI7O0FBR0EsTUFBSVQsV0FBVyxDQUFDVSxNQUFaLENBQW1C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K0M7QUFDM0NBLE1BQUFBLFVBQVUsR0FBRyxDQUFiO0FBQ0g7O0FBQ0QsV0FBT0EsVUFBVSxHQUFHdUIsS0FBSyxDQUFDdEIsU0FBMUI7QUFDSCxHQU5ELE1BTU87QUFDSCxXQUFPLENBQVA7QUFDSDtBQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2NvcmUgfSBmcm9tIFwiLi9kYXRhTW9kZWxzL1Njb3JlXCI7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIGlDYWxjdWxhdGVTY29yZSB7XHJcbiAgICAoeyBjaGlsZFNjb3JlcyB9OiB7XHJcbiAgICAgICAgLyoqIEFuIGFycmF5IG9mIGdyb3VwZWQgZWRnZXMgYW5kIGNsYWltcyovXHJcbiAgICAgICAgY2hpbGRTY29yZXM/OiBTY29yZVtdO1xyXG4gICAgfSk6IFBhcnRpYWw8U2NvcmU+XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDYWxjdWxhdGVzIGEgbmV3IHNjb3JlIGJhc2VkIG9uIHRoZSBjaGlsZCBzY29yZXMgcGFzc2VkIGluLlxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZVNjb3JlKHsgY2hpbGRTY29yZXMgPSBbXSwgcmV2ZXJzaWJsZSA9IHRydWUgfToge1xyXG4gICAgLyoqIEFuIGFycmF5IG9mIGdyb3VwZWQgZWRnZXMgYW5kIGNsYWltcyovXHJcbiAgICBjaGlsZFNjb3Jlcz86IFNjb3JlW107XHJcbiAgICAvKiogQ2FuIHRoaXMgc2NvcmUgZmFsbCBiZWxvdyBhIDAgY29uZmlkZW5jZSAoaGF2ZSBhIG5lZ2F0aXZlIGNvbmZpZGVuY2UpICovXHJcbiAgICByZXZlcnNpYmxlPzogYm9vbGVhblxyXG59ID0ge30sXHJcbik6IFBhcnRpYWw8U2NvcmU+IHtcclxuICAgIC8vIFRPRE86IFNpbXBsaWZ5IGFsbCB0aGlzIG1hdGggYW5kIG1heWJlIGJyZWFrIGl0IHVwIGJldHdlZW4gYmFzZSBmdW5jdGlvbmFsaXR5IGFuZCBhZGRpdGlvbmFsIHNjb3JpbmcgKGxpa2UgdGhlIHBvaW50cylcclxuICAgIGNvbnN0IG5ld1Njb3JlOiBQYXJ0aWFsPFNjb3JlPiA9IHt9O1xyXG4gICAgbmV3U2NvcmUuY29uZmlkZW5jZSA9IDA7XHJcbiAgICBuZXdTY29yZS5yZWxldmFuY2UgPSAxO1xyXG4gICAgbmV3U2NvcmUuY2hpbGRyZW5BdmVyYWdpbmdXZWlnaHQgPSAwO1xyXG4gICAgbmV3U2NvcmUuY2hpbGRyZW5Db25maWRlbmNlV2VpZ2h0ID0gMDtcclxuICAgIG5ld1Njb3JlLmNoaWxkcmVuUmVsZXZhbmNlV2VpZ2h0ID0gMDtcclxuICAgIG5ld1Njb3JlLmNoaWxkcmVuV2VpZ2h0ID0gMDtcclxuICAgIC8vIG5ld1Njb3JlLmNoaWxkcmVuUHJvV2VpZ2h0ID0gMDtcclxuICAgIC8vIG5ld1Njb3JlLmNoaWxkcmVuQ29uV2VpZ2h0ID0gMDtcclxuXHJcbiAgICBsZXQgbWF4Q2hpbGRXZWlnaHQgPSAwXHJcblxyXG5cclxuICAgIGlmIChjaGlsZFNjb3Jlcy5maWx0ZXIocyA9PiBzLmFmZmVjdHMgPT09ICdjb25maWRlbmNlJykubGVuZ3RoIDwgMSkge1xyXG4gICAgICAgIC8vIERlZmF1bHRzIGlmIHRoZXJlIGFyZSBubyBjaGlsZHJlblxyXG4gICAgICAgIG5ld1Njb3JlLmNvbmZpZGVuY2UgPSAxOyAvLyBhc3N1bWUgMTAwJSBjb25maWRlbnRcclxuICAgICAgICBuZXdTY29yZS5yZWxldmFuY2UgPSAxOyAvLyBhc3N1bWUgMTAwJSByZWxldmFudFxyXG4gICAgICAgIG5ld1Njb3JlLmNoaWxkcmVuQXZlcmFnaW5nV2VpZ2h0ID0gMTtcclxuICAgICAgICBuZXdTY29yZS5jaGlsZHJlbkNvbmZpZGVuY2VXZWlnaHQgPSAxO1xyXG4gICAgICAgIG5ld1Njb3JlLmNoaWxkcmVuUmVsZXZhbmNlV2VpZ2h0ID0gMTtcclxuICAgICAgICBuZXdTY29yZS5jaGlsZHJlbldlaWdodCA9IDE7XHJcbiAgICAgICAgbmV3U2NvcmUud2VpZ2h0ID0gMTtcclxuICAgIH1cclxuXHJcbiAgICAvL0dhdGhlciBjaGlsZHJlbiBXZWlnaHRzIHRvdGFscyBmb3IgcHJvY2Vzc2luZyBmdXJ0aGVyIGRvd25cclxuICAgIGZvciAoY29uc3QgY2hpbGRTY29yZSBvZiBjaGlsZFNjb3Jlcykge1xyXG4gICAgICAgIC8vIC8vRW5zdXJlIGNhbGN1bGF0aW9ucyBmb3Igbm9uLXJldmVyc2libGUgc2NvcmVzIGRvbid0IGFsbG93IHRoZSBjb25maWRlbmNlIHRvIGJlIGJlbG93IDBcclxuICAgICAgICAvLyAvL1RPRE86IElzIHRoaXMgbmVlZGVkIGluIHRoZSB0b3RhbHMgc2VjaXRvbj9cclxuICAgICAgICAvLyBsZXQgY29uZmlkZW5jZSA9IGNoaWxkU2NvcmUuY29uZmlkZW5jZVxyXG4gICAgICAgIC8vIGlmICghY2hpbGRTY29yZS5yZXZlcnNpYmxlICYmIGNoaWxkU2NvcmUuY29uZmlkZW5jZSA8IDApIHtcclxuICAgICAgICAvLyAgICAgY29uZmlkZW5jZSA9IDBcclxuICAgICAgICAvLyB9XHJcblxyXG4gICAgICAgIGNoaWxkU2NvcmUud2VpZ2h0ID0gY2FsY1dlaWdodChjaGlsZFNjb3JlKTsgLy9UT0RPOiBKdXN0IGluIGNhc2UgYSBjaGlsZCBzY29yZSBjb21lcyBpbiB1bmNhbGN1bGF0ZWQgLSBtYXliZSBzaG91bGQgYmUgcmVtb3ZlZFxyXG4gICAgICAgIG5ld1Njb3JlLmNoaWxkcmVuQXZlcmFnaW5nV2VpZ2h0ICs9IDE7XHJcbiAgICAgICAgbmV3U2NvcmUuY2hpbGRyZW5Db25maWRlbmNlV2VpZ2h0ICs9IE1hdGguYWJzKGNoaWxkU2NvcmUuY29uZmlkZW5jZSk7XHJcbiAgICAgICAgbmV3U2NvcmUuY2hpbGRyZW5SZWxldmFuY2VXZWlnaHQgKz0gY2hpbGRTY29yZS5yZWxldmFuY2U7XHJcbiAgICAgICAgbmV3U2NvcmUuY2hpbGRyZW5XZWlnaHQgKz0gY2hpbGRTY29yZS53ZWlnaHQ7XHJcbiAgICAgICAgaWYgKGNoaWxkU2NvcmUud2VpZ2h0ID4gbWF4Q2hpbGRXZWlnaHQpe1xyXG4gICAgICAgICAgICBtYXhDaGlsZFdlaWdodCA9IGNoaWxkU2NvcmUud2VpZ2h0O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gLy9UT0RPOiBFeHBlcmltYW50YWxcclxuICAgICAgICAvLyBpZiAoY29uZmlkZW5jZSA+IDApIHtcclxuICAgICAgICAvLyAgICAgaWYgKGNoaWxkU2NvcmUucHJvKSB7XHJcbiAgICAgICAgLy8gICAgICAgICBuZXdTY29yZS5jaGlsZHJlblByb1dlaWdodCArPSBjb25maWRlbmNlXHJcbiAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAvLyAgICAgaWYgKCFjaGlsZFNjb3JlLnBybykge1xyXG4gICAgICAgIC8vICAgICAgICAgbmV3U2NvcmUuY2hpbGRyZW5Db25XZWlnaHQgKz0gY29uZmlkZW5jZVxyXG4gICAgICAgIC8vICAgICB9XHJcbiAgICAgICAgLy8gfSBlbHNlIGlmIChjb25maWRlbmNlIDwgMCkge1xyXG4gICAgICAgIC8vICAgICBpZiAoY2hpbGRTY29yZS5wcm8pIHtcclxuICAgICAgICAvLyAgICAgICAgIG5ld1Njb3JlLmNoaWxkcmVuQ29uV2VpZ2h0ICs9IGNvbmZpZGVuY2VcclxuICAgICAgICAvLyAgICAgfVxyXG4gICAgICAgIC8vICAgICBpZiAoIWNoaWxkU2NvcmUucHJvKSB7XHJcbiAgICAgICAgLy8gICAgICAgICBuZXdTY29yZS5jaGlsZHJlblByb1dlaWdodCArPSBjb25maWRlbmNlXHJcbiAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAvLyB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gTG9vcCB0aHJvdWdoIHRvIGNhbGN1bGF0ZSB0aGUgZmluYWwgc2NvcmVzXHJcbiAgICBmb3IgKGNvbnN0IGNoaWxkU2NvcmUgb2YgY2hpbGRTY29yZXMpIHtcclxuICAgICAgICBjb25zdCBwb2xhcml0eSA9IGNoaWxkU2NvcmUucHJvID8gMSA6IC0xXHJcblxyXG4gICAgICAgIGlmIChjaGlsZFNjb3JlLmFmZmVjdHMgPT09IFwiY29uZmlkZW5jZVwiKSB7XHJcbiAgICAgICAgICAgIGlmIChuZXdTY29yZS5jaGlsZHJlbldlaWdodCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgY2hpbGRTY29yZS5wZXJjZW50T2ZXZWlnaHQgPSAwO1xyXG4gICAgICAgICAgICAgICAgbmV3U2NvcmUuY29uZmlkZW5jZSA9IDA7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAgICAgICAgICAgY2hpbGRTY29yZS5wZXJjZW50T2ZXZWlnaHQgPVxyXG4gICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcmUud2VpZ2h0IC9cclxuICAgICAgICAgICAgICAgICAgICBuZXdTY29yZS5jaGlsZHJlbldlaWdodDtcclxuXHJcbiAgICAgICAgICAgICAgICBuZXdTY29yZS5jb25maWRlbmNlICs9XHJcbiAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29yZS5wZXJjZW50T2ZXZWlnaHQgKlxyXG4gICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcmUuY29uZmlkZW5jZSAqIHBvbGFyaXR5O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoY2hpbGRTY29yZS5hZmZlY3RzID09PSBcInJlbGV2YW5jZVwiKSB7XHJcbiAgICAgICAgICAgIC8vIFByb2Nlc3MgUmVsZXZhbmNlIGNoaWxkIGNsYWltc1xyXG5cclxuICAgICAgICAgICAgbGV0IGNvbmZpZGVuY2UgPSBjaGlsZFNjb3JlLmNvbmZpZGVuY2VcclxuICAgICAgICAgICAgaWYgKCFjaGlsZFNjb3JlLnJldmVyc2libGUgJiYgY2hpbGRTY29yZS5jb25maWRlbmNlIDwgMCkge1xyXG4gICAgICAgICAgICAgICAgY29uZmlkZW5jZSA9IDBcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKG5ld1Njb3JlLnJlbGV2YW5jZSA9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIG5ld1Njb3JlLnJlbGV2YW5jZSA9IDE7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChjaGlsZFNjb3JlLnBybykge1xyXG4gICAgICAgICAgICAgICAgbmV3U2NvcmUucmVsZXZhbmNlICs9IGNvbmZpZGVuY2U7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBuZXdTY29yZS5yZWxldmFuY2UgLT0gY29uZmlkZW5jZSAvIDI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGlmIChjaGlsZFNjb3JlLnBybykge1xyXG4gICAgICAgIC8vICAgICBjaGlsZFNjb3JlLnBlcmNlbnRBZ3JlZVdlaWdodCA9IGNvbmZpZGVuY2UgLyBuZXdTY29yZS5jaGlsZHJlblByb1dlaWdodFxyXG4gICAgICAgIC8vIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gICAgIGNoaWxkU2NvcmUucGVyY2VudEFncmVlV2VpZ2h0ID0gY29uZmlkZW5jZSAvIG5ld1Njb3JlLmNoaWxkcmVuQ29uV2VpZ2h0XHJcbiAgICAgICAgLy8gfVxyXG5cclxuICAgICAgICBjaGlsZFNjb3JlLnNjYWxlZFdlaWdodCA9IChjaGlsZFNjb3JlLndlaWdodC9tYXhDaGlsZFdlaWdodClcclxuXHJcbiAgICB9XHJcblxyXG5cclxuICAgIGlmIChPYmplY3QuaXMobmV3U2NvcmUuY29uZmlkZW5jZSwgLTApKSB7XHJcbiAgICAgICAgLy8gUHJvdGVjdCBhZ2FpbnN0IG5lZ2F0aXZlIHplcm8gXHJcbiAgICAgICAgbmV3U2NvcmUuY29uZmlkZW5jZSA9IDA7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGNvbmZpZGVuY2UgPSBNYXRoLmFicyhuZXdTY29yZS5jb25maWRlbmNlKVxyXG4gICAgaWYgKCFuZXdTY29yZS5yZXZlcnNpYmxlICYmIG5ld1Njb3JlLmNvbmZpZGVuY2UgPCAwKSB7XHJcbiAgICAgICAgY29uZmlkZW5jZSA9IDBcclxuICAgIH1cclxuXHJcbiAgICBuZXdTY29yZS53ZWlnaHQgPSBjYWxjV2VpZ2h0KG5ld1Njb3JlKTtcclxuICAgIG5ld1Njb3JlLnNjYWxlZFdlaWdodCA9IG5ld1Njb3JlLndlaWdodDtcclxuXHJcbiAgICByZXR1cm4gbmV3U2NvcmU7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNhbGNXZWlnaHQoc2NvcmU6IFBhcnRpYWw8U2NvcmU+KSB7XHJcbiAgICBpZiAoc2NvcmUuY29uZmlkZW5jZSAhPT0gdW5kZWZpbmVkICYmIHNjb3JlLnJlbGV2YW5jZSAhPT0gdW5kZWZpbmVkKXtcclxuICAgICAgICBsZXQgY29uZmlkZW5jZSA9IE1hdGguYWJzKHNjb3JlLmNvbmZpZGVuY2UpXHJcbiAgICAgICAgaWYgKCFzY29yZS5yZXZlcnNpYmxlICYmIHNjb3JlLmNvbmZpZGVuY2UgPCAwKSB7XHJcbiAgICAgICAgICAgIGNvbmZpZGVuY2UgPSAwXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBjb25maWRlbmNlICogc2NvcmUucmVsZXZhbmNlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gMTtcclxuICAgIH1cclxufVxyXG4iXX0=
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.calculateScore = calculateScore;

var _Affects = require("./dataModels/Affects");

var _Score = require("./dataModels/Score");

var _Id = require("./dataModels/Id");

/**
 * Calculates a new score based on the child scores and how thay wre linked (by edged) the claim this score is for.
 */
function calculateScore() {
  var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},
      _ref$scoreAndClaimEdg = _ref.scoreAndClaimEdges,
      scoreAndClaimEdges = _ref$scoreAndClaimEdg === void 0 ? [] : _ref$scoreAndClaimEdg,
      _ref$reversable = _ref.reversable,
      reversable = _ref$reversable === void 0 ? true : _ref$reversable,
      _ref$sourceClaimId = _ref.sourceClaimId,
      sourceClaimId = _ref$sourceClaimId === void 0 ? (0, _Id.ID)("") : _ref$sourceClaimId;

  var newScore = new _Score.Score();
  var childrenConfidence = 0;
  var childrenRelevance = 0;

  if (scoreAndClaimEdges.filter(function (c) {
    return c.claimEdge.affects === _Affects.Affects.Confidence;
  }).length < 1) {
    // If there are no children that affect the confidence of the claim
    // then assume the claim is 100% confident and start strength and relevance at 1
    childrenConfidence = 1;
    childrenRelevance = 1;
  }

  scoreAndClaimEdges.forEach(function (_ref2) {
    var score = _ref2.score,
        claimEdge = _ref2.claimEdge;

    // Loop through the child scores and determine the score of the parent.
    if (claimEdge.affects === _Affects.Affects.Confidence) {
      // Process edges that affect confidence
      if (claimEdge.pro) {
        childrenConfidence += score.confidence * score.relevance; // Add up all the strength of the children

        childrenRelevance += score.relevance; //Add up the relevance separately so we can do a weighted agerage later
      } else {
        childrenConfidence -= score.confidence * score.relevance;
        childrenRelevance += score.relevance;
      }
    }

    if (claimEdge.affects === 'relevance') {
      // Process Relevance child claims
      if (claimEdge.pro) {
        newScore.relevance += score.confidence; // Add up all the strength of the children
      } else {
        newScore.relevance -= score.confidence;
      }
    }
  });

  if (childrenRelevance === 0) {
    // Protect against division by zero
    newScore.confidence = 0;
  } else {
    //Calculate the score
    newScore.confidence = childrenConfidence / childrenRelevance;
  }

  if (!reversable && newScore.confidence < 0) {
    // If it is not reversable then do not let it go negative
    newScore.confidence = 0;
  }

  if (Object.is(newScore.confidence, -0)) {
    // Protect against negative zero 
    newScore.confidence = 0;
  }

  if (sourceClaimId !== undefined) {
    newScore.sourceClaimId = sourceClaimId;
  }

  return newScore;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWxjdWxhdGVTY29yZS50cyJdLCJuYW1lcyI6WyJjYWxjdWxhdGVTY29yZSIsInNjb3JlQW5kQ2xhaW1FZGdlcyIsInJldmVyc2FibGUiLCJzb3VyY2VDbGFpbUlkIiwibmV3U2NvcmUiLCJTY29yZSIsImNoaWxkcmVuQ29uZmlkZW5jZSIsImNoaWxkcmVuUmVsZXZhbmNlIiwiZmlsdGVyIiwiYyIsImNsYWltRWRnZSIsImFmZmVjdHMiLCJBZmZlY3RzIiwiQ29uZmlkZW5jZSIsImxlbmd0aCIsImZvckVhY2giLCJzY29yZSIsInBybyIsImNvbmZpZGVuY2UiLCJyZWxldmFuY2UiLCJPYmplY3QiLCJpcyIsInVuZGVmaW5lZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUdBOzs7QUFHTyxTQUFTQSxjQUFULEdBUUw7QUFBQSxpRkFERSxFQUNGO0FBQUEsbUNBUitCQyxrQkFRL0I7QUFBQSxNQVIrQkEsa0JBUS9CLHNDQVJvRCxFQVFwRDtBQUFBLDZCQVJ3REMsVUFReEQ7QUFBQSxNQVJ3REEsVUFReEQsZ0NBUnFFLElBUXJFO0FBQUEsZ0NBUjJFQyxhQVEzRTtBQUFBLE1BUjJFQSxhQVEzRSxtQ0FSMkYsWUFBRyxFQUFILENBUTNGOztBQUNFLE1BQU1DLFFBQWUsR0FBRyxJQUFJQyxZQUFKLEVBQXhCO0FBQ0EsTUFBSUMsa0JBQWtCLEdBQUcsQ0FBekI7QUFDQSxNQUFJQyxpQkFBaUIsR0FBRyxDQUF4Qjs7QUFFQSxNQUFJTixrQkFBa0IsQ0FBQ08sTUFBbkIsQ0FBMEIsVUFBQUMsQ0FBQztBQUFBLFdBQUlBLENBQUMsQ0FBQ0MsU0FBRixDQUFZQyxPQUFaLEtBQXdCQyxpQkFBUUMsVUFBcEM7QUFBQSxHQUEzQixFQUEyRUMsTUFBM0UsR0FBb0YsQ0FBeEYsRUFBMkY7QUFDdkY7QUFDQTtBQUNBUixJQUFBQSxrQkFBa0IsR0FBRyxDQUFyQjtBQUNBQyxJQUFBQSxpQkFBaUIsR0FBRyxDQUFwQjtBQUNIOztBQUVETixFQUFBQSxrQkFBa0IsQ0FBQ2MsT0FBbkIsQ0FBMkIsaUJBQXdCO0FBQUEsUUFBdEJDLEtBQXNCLFNBQXRCQSxLQUFzQjtBQUFBLFFBQWZOLFNBQWUsU0FBZkEsU0FBZTs7QUFDL0M7QUFDQSxRQUFJQSxTQUFTLENBQUNDLE9BQVYsS0FBc0JDLGlCQUFRQyxVQUFsQyxFQUE4QztBQUMxQztBQUNBLFVBQUlILFNBQVMsQ0FBQ08sR0FBZCxFQUFtQjtBQUNmWCxRQUFBQSxrQkFBa0IsSUFBSVUsS0FBSyxDQUFDRSxVQUFOLEdBQW1CRixLQUFLLENBQUNHLFNBQS9DLENBRGUsQ0FDMkM7O0FBQzFEWixRQUFBQSxpQkFBaUIsSUFBSVMsS0FBSyxDQUFDRyxTQUEzQixDQUZlLENBRXVCO0FBQ3pDLE9BSEQsTUFHTztBQUNIYixRQUFBQSxrQkFBa0IsSUFBSVUsS0FBSyxDQUFDRSxVQUFOLEdBQW1CRixLQUFLLENBQUNHLFNBQS9DO0FBQ0FaLFFBQUFBLGlCQUFpQixJQUFJUyxLQUFLLENBQUNHLFNBQTNCO0FBQ0g7QUFDSjs7QUFFRCxRQUFJVCxTQUFTLENBQUNDLE9BQVYsS0FBc0IsV0FBMUIsRUFBdUM7QUFDbkM7QUFDQSxVQUFJRCxTQUFTLENBQUNPLEdBQWQsRUFBbUI7QUFDZmIsUUFBQUEsUUFBUSxDQUFDZSxTQUFULElBQXNCSCxLQUFLLENBQUNFLFVBQTVCLENBRGUsQ0FDeUI7QUFDM0MsT0FGRCxNQUVPO0FBQ0hkLFFBQUFBLFFBQVEsQ0FBQ2UsU0FBVCxJQUFzQkgsS0FBSyxDQUFDRSxVQUE1QjtBQUNIO0FBQ0o7QUFDSixHQXJCRDs7QUF1QkEsTUFBSVgsaUJBQWlCLEtBQUssQ0FBMUIsRUFBNkI7QUFDekI7QUFDQUgsSUFBQUEsUUFBUSxDQUFDYyxVQUFULEdBQXNCLENBQXRCO0FBQ0gsR0FIRCxNQUdPO0FBQ0g7QUFDQWQsSUFBQUEsUUFBUSxDQUFDYyxVQUFULEdBQXNCWixrQkFBa0IsR0FBR0MsaUJBQTNDO0FBQ0g7O0FBRUQsTUFBSSxDQUFDTCxVQUFELElBQWVFLFFBQVEsQ0FBQ2MsVUFBVCxHQUFzQixDQUF6QyxFQUE0QztBQUN4QztBQUNBZCxJQUFBQSxRQUFRLENBQUNjLFVBQVQsR0FBc0IsQ0FBdEI7QUFDSDs7QUFFRCxNQUFJRSxNQUFNLENBQUNDLEVBQVAsQ0FBVWpCLFFBQVEsQ0FBQ2MsVUFBbkIsRUFBK0IsQ0FBQyxDQUFoQyxDQUFKLEVBQXdDO0FBQ3BDO0FBQ0FkLElBQUFBLFFBQVEsQ0FBQ2MsVUFBVCxHQUFzQixDQUF0QjtBQUNIOztBQUVELE1BQUlmLGFBQWEsS0FBS21CLFNBQXRCLEVBQWlDO0FBQzdCbEIsSUFBQUEsUUFBUSxDQUFDRCxhQUFULEdBQXlCQSxhQUF6QjtBQUNIOztBQUdELFNBQU9DLFFBQVA7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFmZmVjdHMgfSBmcm9tIFwiLi9kYXRhTW9kZWxzL0FmZmVjdHNcIlxyXG5pbXBvcnQgeyBTY29yZSB9IGZyb20gXCIuL2RhdGFNb2RlbHMvU2NvcmVcIjtcclxuaW1wb3J0IHsgSWQsIElEIH0gZnJvbSBcIi4vZGF0YU1vZGVscy9JZFwiO1xyXG5pbXBvcnQgeyBTY29yZUFuZENsYWltRWRnZSB9IGZyb20gXCIuL2RhdGFNb2RlbHMvU2NvcmVBbmRDbGFpbUVkZ2VcIjtcclxuXHJcbi8qKlxyXG4gKiBDYWxjdWxhdGVzIGEgbmV3IHNjb3JlIGJhc2VkIG9uIHRoZSBjaGlsZCBzY29yZXMgYW5kIGhvdyB0aGF5IHdyZSBsaW5rZWQgKGJ5IGVkZ2VkKSB0aGUgY2xhaW0gdGhpcyBzY29yZSBpcyBmb3IuXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlU2NvcmUoeyBzY29yZUFuZENsYWltRWRnZXMgPSBbXSwgcmV2ZXJzYWJsZSA9IHRydWUsIHNvdXJjZUNsYWltSWQgPSBJRChcIlwiKSB9OiB7XHJcbiAgICAvKiogQW4gYXJyYXkgb2YgZ3JvdXBlZCBlZGdlcyBhbmQgY2xhaW1zKi9cclxuICAgIHNjb3JlQW5kQ2xhaW1FZGdlcz86IFNjb3JlQW5kQ2xhaW1FZGdlW107XHJcbiAgICAvKiogQ2FuIHRoaXMgc2NvcmUgZmFsbCBiZWxvdyBhIDAgY29uZmlkZW5jZSAoaGF2ZSBhIG5lZ2F0aXZlIGNvbmZpZGVuY2UpICovXHJcbiAgICByZXZlcnNhYmxlPzogYm9vbGVhbjtcclxuICAgIC8qKiBUaGUgSUQgb2YgdGhlIGNsYWltIHdlIGFyZSBjcmVhdGluZyBhIHNjb3JlIGZvciAqL1xyXG4gICAgc291cmNlQ2xhaW1JZD86IElkO1xyXG59ID0ge30sXHJcbikge1xyXG4gICAgY29uc3QgbmV3U2NvcmU6IFNjb3JlID0gbmV3IFNjb3JlKCk7XHJcbiAgICBsZXQgY2hpbGRyZW5Db25maWRlbmNlID0gMFxyXG4gICAgbGV0IGNoaWxkcmVuUmVsZXZhbmNlID0gMFxyXG5cclxuICAgIGlmIChzY29yZUFuZENsYWltRWRnZXMuZmlsdGVyKGMgPT4gYy5jbGFpbUVkZ2UuYWZmZWN0cyA9PT0gQWZmZWN0cy5Db25maWRlbmNlKS5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgLy8gSWYgdGhlcmUgYXJlIG5vIGNoaWxkcmVuIHRoYXQgYWZmZWN0IHRoZSBjb25maWRlbmNlIG9mIHRoZSBjbGFpbVxyXG4gICAgICAgIC8vIHRoZW4gYXNzdW1lIHRoZSBjbGFpbSBpcyAxMDAlIGNvbmZpZGVudCBhbmQgc3RhcnQgc3RyZW5ndGggYW5kIHJlbGV2YW5jZSBhdCAxXHJcbiAgICAgICAgY2hpbGRyZW5Db25maWRlbmNlID0gMTtcclxuICAgICAgICBjaGlsZHJlblJlbGV2YW5jZSA9IDE7XHJcbiAgICB9XHJcblxyXG4gICAgc2NvcmVBbmRDbGFpbUVkZ2VzLmZvckVhY2goKHtzY29yZSwgY2xhaW1FZGdlfSkgPT4ge1xyXG4gICAgICAgIC8vIExvb3AgdGhyb3VnaCB0aGUgY2hpbGQgc2NvcmVzIGFuZCBkZXRlcm1pbmUgdGhlIHNjb3JlIG9mIHRoZSBwYXJlbnQuXHJcbiAgICAgICAgaWYgKGNsYWltRWRnZS5hZmZlY3RzID09PSBBZmZlY3RzLkNvbmZpZGVuY2UpIHtcclxuICAgICAgICAgICAgLy8gUHJvY2VzcyBlZGdlcyB0aGF0IGFmZmVjdCBjb25maWRlbmNlXHJcbiAgICAgICAgICAgIGlmIChjbGFpbUVkZ2UucHJvKSB7XHJcbiAgICAgICAgICAgICAgICBjaGlsZHJlbkNvbmZpZGVuY2UgKz0gc2NvcmUuY29uZmlkZW5jZSAqIHNjb3JlLnJlbGV2YW5jZTsgLy8gQWRkIHVwIGFsbCB0aGUgc3RyZW5ndGggb2YgdGhlIGNoaWxkcmVuXHJcbiAgICAgICAgICAgICAgICBjaGlsZHJlblJlbGV2YW5jZSArPSBzY29yZS5yZWxldmFuY2U7IC8vQWRkIHVwIHRoZSByZWxldmFuY2Ugc2VwYXJhdGVseSBzbyB3ZSBjYW4gZG8gYSB3ZWlnaHRlZCBhZ2VyYWdlIGxhdGVyXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjaGlsZHJlbkNvbmZpZGVuY2UgLT0gc2NvcmUuY29uZmlkZW5jZSAqIHNjb3JlLnJlbGV2YW5jZTtcclxuICAgICAgICAgICAgICAgIGNoaWxkcmVuUmVsZXZhbmNlICs9IHNjb3JlLnJlbGV2YW5jZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGNsYWltRWRnZS5hZmZlY3RzID09PSAncmVsZXZhbmNlJykge1xyXG4gICAgICAgICAgICAvLyBQcm9jZXNzIFJlbGV2YW5jZSBjaGlsZCBjbGFpbXNcclxuICAgICAgICAgICAgaWYgKGNsYWltRWRnZS5wcm8pIHtcclxuICAgICAgICAgICAgICAgIG5ld1Njb3JlLnJlbGV2YW5jZSArPSBzY29yZS5jb25maWRlbmNlOyAvLyBBZGQgdXAgYWxsIHRoZSBzdHJlbmd0aCBvZiB0aGUgY2hpbGRyZW5cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG5ld1Njb3JlLnJlbGV2YW5jZSAtPSBzY29yZS5jb25maWRlbmNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKGNoaWxkcmVuUmVsZXZhbmNlID09PSAwKSB7XHJcbiAgICAgICAgLy8gUHJvdGVjdCBhZ2FpbnN0IGRpdmlzaW9uIGJ5IHplcm9cclxuICAgICAgICBuZXdTY29yZS5jb25maWRlbmNlID0gMDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy9DYWxjdWxhdGUgdGhlIHNjb3JlXHJcbiAgICAgICAgbmV3U2NvcmUuY29uZmlkZW5jZSA9IGNoaWxkcmVuQ29uZmlkZW5jZSAvIGNoaWxkcmVuUmVsZXZhbmNlO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghcmV2ZXJzYWJsZSAmJiBuZXdTY29yZS5jb25maWRlbmNlIDwgMCkge1xyXG4gICAgICAgIC8vIElmIGl0IGlzIG5vdCByZXZlcnNhYmxlIHRoZW4gZG8gbm90IGxldCBpdCBnbyBuZWdhdGl2ZVxyXG4gICAgICAgIG5ld1Njb3JlLmNvbmZpZGVuY2UgPSAwXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKE9iamVjdC5pcyhuZXdTY29yZS5jb25maWRlbmNlLCAtMCkpIHtcclxuICAgICAgICAvLyBQcm90ZWN0IGFnYWluc3QgbmVnYXRpdmUgemVybyBcclxuICAgICAgICBuZXdTY29yZS5jb25maWRlbmNlID0gMDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoc291cmNlQ2xhaW1JZCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgbmV3U2NvcmUuc291cmNlQ2xhaW1JZCA9IHNvdXJjZUNsYWltSWRcclxuICAgIH1cclxuXHJcblxyXG4gICAgcmV0dXJuIG5ld1Njb3JlO1xyXG59XHJcblxyXG4iXX0=

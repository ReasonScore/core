"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.calculateScore = calculateScore;

/**
 * Calculates a new score based on the child scores passed in.
 */
function calculateScore({
  childScores = [],
  reversible = true
} = {}) {
  // TODO: Simplify all this math and maybe break it up between base functionality and additional scoring (like the points)
  const newScore = {};
  newScore.confidence = 0;
  newScore.relevance = 1;
  newScore.childrenAveragingWeight = 0;
  newScore.childrenConfidenceWeight = 0;
  newScore.childrenRelevanceWeight = 0;
  newScore.childrenWeight = 0; // newScore.childrenProWeight = 0;
  // newScore.childrenConWeight = 0;

  let maxChildWeight = 0;

  if (childScores.filter(s => s.affects === 'confidence').length < 1) {
    // Defaults if there are no children
    newScore.confidence = 1; // assume 100% confident

    newScore.relevance = 1; // assume 100% relevant

    newScore.childrenAveragingWeight = 1;
    newScore.childrenConfidenceWeight = 1;
    newScore.childrenRelevanceWeight = 1;
    newScore.childrenWeight = 1;
    newScore.weight = 1;
  } //Gather children Weights totals for processing further down


  for (const childScore of childScores) {
    // //Ensure calculations for non-reversible scores don't allow the confidence to be below 0
    // //TODO: Is this needed in the totals seciton?
    // let confidence = childScore.confidence
    // if (!childScore.reversible && childScore.confidence < 0) {
    //     confidence = 0
    // }
    childScore.weight = calcWeight(childScore); //TODO: Just in case a child score comes in uncalculated - maybe should be removed

    newScore.childrenAveragingWeight += 1; // if (childScore.affects = "confidence") {

    newScore.childrenConfidenceWeight += Math.abs(childScore.confidence); // } else {

    newScore.childrenRelevanceWeight += childScore.relevance; // }

    if (childScore.affects === "confidence") {
      newScore.childrenWeight += childScore.weight;

      if (childScore.weight > maxChildWeight) {
        maxChildWeight = childScore.weight;
      }
    } // //TODO: Experimantal
    // if (confidence > 0) {
    //     if (childScore.pro) {
    //         newScore.childrenProWeight += confidence
    //     }
    //     if (!childScore.pro) {
    //         newScore.childrenConWeight += confidence
    //     }
    // } else if (confidence < 0) {
    //     if (childScore.pro) {
    //         newScore.childrenConWeight += confidence
    //     }
    //     if (!childScore.pro) {
    //         newScore.childrenProWeight += confidence
    //     }
    // }

  } // Loop through to calculate the final confidence


  for (const childScore of childScores) {
    const polarity = childScore.pro ? 1 : -1;

    if (childScore.affects === "confidence") {
      if (newScore.childrenWeight === 0) {
        childScore.percentOfWeight = 0;
        newScore.confidence = 0;
      } else {
        childScore.percentOfWeight = childScore.weight / newScore.childrenWeight;
        newScore.confidence += childScore.percentOfWeight * childScore.confidence * polarity;
      }
    } // if (childScore.pro) {
    //     childScore.percentAgreeWeight = confidence / newScore.childrenProWeight
    // } else {
    //     childScore.percentAgreeWeight = confidence / newScore.childrenConWeight
    // }


    childScore.scaledWeight = childScore.weight / maxChildWeight;
  } // Loop through to calculate the final relevance


  for (const childScore of childScores) {
    if (childScore.affects === "relevance") {
      // Process Relevance child claims
      let confidence = childScore.confidence;

      if (!childScore.reversible && childScore.confidence < 0) {
        confidence = 0;
      }

      if (newScore.relevance == undefined) {
        newScore.relevance = 1;
      }

      if (childScore.pro) {
        // newScore.relevance = newScore.relevance * 2;
        newScore.relevance += confidence;
      } else {
        // newScore.relevance = newScore.relevance / 2;
        newScore.relevance -= confidence / 2;
      }
    }
  } // Protect against negative zero 


  if (Object.is(newScore.confidence, -0)) {
    newScore.confidence = 0;
  }

  let confidence = Math.abs(newScore.confidence);

  if (!newScore.reversible && newScore.confidence < 0) {
    confidence = 0;
  }

  newScore.weight = calcWeight(newScore);
  newScore.scaledWeight = newScore.weight;
  return newScore;
}

function calcWeight(score) {
  if (score.confidence !== undefined && score.relevance !== undefined) {
    let confidence = Math.abs(score.confidence);

    if (!score.reversible && score.confidence < 0) {
      confidence = 0;
    }

    return confidence * score.relevance;
  } else {
    return 1;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWxjdWxhdGVTY29yZS50cyJdLCJuYW1lcyI6WyJjYWxjdWxhdGVTY29yZSIsImNoaWxkU2NvcmVzIiwicmV2ZXJzaWJsZSIsIm5ld1Njb3JlIiwiY29uZmlkZW5jZSIsInJlbGV2YW5jZSIsImNoaWxkcmVuQXZlcmFnaW5nV2VpZ2h0IiwiY2hpbGRyZW5Db25maWRlbmNlV2VpZ2h0IiwiY2hpbGRyZW5SZWxldmFuY2VXZWlnaHQiLCJjaGlsZHJlbldlaWdodCIsIm1heENoaWxkV2VpZ2h0IiwiZmlsdGVyIiwicyIsImFmZmVjdHMiLCJsZW5ndGgiLCJ3ZWlnaHQiLCJjaGlsZFNjb3JlIiwiY2FsY1dlaWdodCIsIk1hdGgiLCJhYnMiLCJwb2xhcml0eSIsInBybyIsInBlcmNlbnRPZldlaWdodCIsInNjYWxlZFdlaWdodCIsInVuZGVmaW5lZCIsIk9iamVjdCIsImlzIiwic2NvcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFTQTtBQUNBO0FBQ0E7QUFDTyxTQUFTQSxjQUFULENBQXdCO0FBQUVDLEVBQUFBLFdBQVcsR0FBRyxFQUFoQjtBQUFvQkMsRUFBQUEsVUFBVSxHQUFHO0FBQWpDLElBSzNCLEVBTEcsRUFNVztBQUNkO0FBQ0EsUUFBTUMsUUFBd0IsR0FBRyxFQUFqQztBQUNBQSxFQUFBQSxRQUFRLENBQUNDLFVBQVQsR0FBc0IsQ0FBdEI7QUFDQUQsRUFBQUEsUUFBUSxDQUFDRSxTQUFULEdBQXFCLENBQXJCO0FBQ0FGLEVBQUFBLFFBQVEsQ0FBQ0csdUJBQVQsR0FBbUMsQ0FBbkM7QUFDQUgsRUFBQUEsUUFBUSxDQUFDSSx3QkFBVCxHQUFvQyxDQUFwQztBQUNBSixFQUFBQSxRQUFRLENBQUNLLHVCQUFULEdBQW1DLENBQW5DO0FBQ0FMLEVBQUFBLFFBQVEsQ0FBQ00sY0FBVCxHQUEwQixDQUExQixDQVJjLENBU2Q7QUFDQTs7QUFFQSxNQUFJQyxjQUFjLEdBQUcsQ0FBckI7O0FBR0EsTUFBSVQsV0FBVyxDQUFDVSxNQUFaLENBQW1C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U0FBTixLQUFvQm1CLFNBQTFELEVBQXFFO0FBQ2pFLFFBQUlwQixVQUFVLEdBQUdjLElBQUksQ0FBQ0MsR0FBTCxDQUFTUSxLQUFLLENBQUN2QixVQUFmLENBQWpCOztBQUNBLFFBQUksQ0FBQ3VCLEtBQUssQ0FBQ3pCLFVBQVAsSUFBcUJ5QixLQUFLLENBQUN2QixVQUFOLEdBQW1CLENBQTVDLEVBQStDO0FBQzNDQSxNQUFBQSxVQUFVLEdBQUcsQ0FBYjtBQUNIOztBQUNELFdBQU9BLFVBQVUsR0FBR3VCLEtBQUssQ0FBQ3RCLFNBQTFCO0FBQ0gsR0FORCxNQU1PO0FBQ0gsV0FBTyxDQUFQO0FBQ0g7QUFDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNjb3JlIH0gZnJvbSBcIi4vZGF0YU1vZGVscy9TY29yZVwiO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBpQ2FsY3VsYXRlU2NvcmUge1xyXG4gICAgKHsgY2hpbGRTY29yZXMgfToge1xyXG4gICAgICAgIC8qKiBBbiBhcnJheSBvZiBncm91cGVkIGVkZ2VzIGFuZCBjbGFpbXMqL1xyXG4gICAgICAgIGNoaWxkU2NvcmVzPzogU2NvcmVbXTtcclxuICAgIH0pOiBQYXJ0aWFsPFNjb3JlPlxyXG59XHJcblxyXG4vKipcclxuICogQ2FsY3VsYXRlcyBhIG5ldyBzY29yZSBiYXNlZCBvbiB0aGUgY2hpbGQgc2NvcmVzIHBhc3NlZCBpbi5cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVTY29yZSh7IGNoaWxkU2NvcmVzID0gW10sIHJldmVyc2libGUgPSB0cnVlIH06IHtcclxuICAgIC8qKiBBbiBhcnJheSBvZiBncm91cGVkIGVkZ2VzIGFuZCBjbGFpbXMqL1xyXG4gICAgY2hpbGRTY29yZXM/OiBTY29yZVtdO1xyXG4gICAgLyoqIENhbiB0aGlzIHNjb3JlIGZhbGwgYmVsb3cgYSAwIGNvbmZpZGVuY2UgKGhhdmUgYSBuZWdhdGl2ZSBjb25maWRlbmNlKSAqL1xyXG4gICAgcmV2ZXJzaWJsZT86IGJvb2xlYW5cclxufSA9IHt9LFxyXG4pOiBQYXJ0aWFsPFNjb3JlPiB7XHJcbiAgICAvLyBUT0RPOiBTaW1wbGlmeSBhbGwgdGhpcyBtYXRoIGFuZCBtYXliZSBicmVhayBpdCB1cCBiZXR3ZWVuIGJhc2UgZnVuY3Rpb25hbGl0eSBhbmQgYWRkaXRpb25hbCBzY29yaW5nIChsaWtlIHRoZSBwb2ludHMpXHJcbiAgICBjb25zdCBuZXdTY29yZTogUGFydGlhbDxTY29yZT4gPSB7fTtcclxuICAgIG5ld1Njb3JlLmNvbmZpZGVuY2UgPSAwO1xyXG4gICAgbmV3U2NvcmUucmVsZXZhbmNlID0gMTtcclxuICAgIG5ld1Njb3JlLmNoaWxkcmVuQXZlcmFnaW5nV2VpZ2h0ID0gMDtcclxuICAgIG5ld1Njb3JlLmNoaWxkcmVuQ29uZmlkZW5jZVdlaWdodCA9IDA7XHJcbiAgICBuZXdTY29yZS5jaGlsZHJlblJlbGV2YW5jZVdlaWdodCA9IDA7XHJcbiAgICBuZXdTY29yZS5jaGlsZHJlbldlaWdodCA9IDA7XHJcbiAgICAvLyBuZXdTY29yZS5jaGlsZHJlblByb1dlaWdodCA9IDA7XHJcbiAgICAvLyBuZXdTY29yZS5jaGlsZHJlbkNvbldlaWdodCA9IDA7XHJcblxyXG4gICAgbGV0IG1heENoaWxkV2VpZ2h0ID0gMFxyXG5cclxuXHJcbiAgICBpZiAoY2hpbGRTY29yZXMuZmlsdGVyKHMgPT4gcy5hZmZlY3RzID09PSAnY29uZmlkZW5jZScpLmxlbmd0aCA8IDEpIHtcclxuICAgICAgICAvLyBEZWZhdWx0cyBpZiB0aGVyZSBhcmUgbm8gY2hpbGRyZW5cclxuICAgICAgICBuZXdTY29yZS5jb25maWRlbmNlID0gMTsgLy8gYXNzdW1lIDEwMCUgY29uZmlkZW50XHJcbiAgICAgICAgbmV3U2NvcmUucmVsZXZhbmNlID0gMTsgLy8gYXNzdW1lIDEwMCUgcmVsZXZhbnRcclxuICAgICAgICBuZXdTY29yZS5jaGlsZHJlbkF2ZXJhZ2luZ1dlaWdodCA9IDE7XHJcbiAgICAgICAgbmV3U2NvcmUuY2hpbGRyZW5Db25maWRlbmNlV2VpZ2h0ID0gMTtcclxuICAgICAgICBuZXdTY29yZS5jaGlsZHJlblJlbGV2YW5jZVdlaWdodCA9IDE7XHJcbiAgICAgICAgbmV3U2NvcmUuY2hpbGRyZW5XZWlnaHQgPSAxO1xyXG4gICAgICAgIG5ld1Njb3JlLndlaWdodCA9IDE7XHJcbiAgICB9XHJcblxyXG4gICAgLy9HYXRoZXIgY2hpbGRyZW4gV2VpZ2h0cyB0b3RhbHMgZm9yIHByb2Nlc3NpbmcgZnVydGhlciBkb3duXHJcbiAgICBmb3IgKGNvbnN0IGNoaWxkU2NvcmUgb2YgY2hpbGRTY29yZXMpIHtcclxuICAgICAgICAvLyAvL0Vuc3VyZSBjYWxjdWxhdGlvbnMgZm9yIG5vbi1yZXZlcnNpYmxlIHNjb3JlcyBkb24ndCBhbGxvdyB0aGUgY29uZmlkZW5jZSB0byBiZSBiZWxvdyAwXHJcbiAgICAgICAgLy8gLy9UT0RPOiBJcyB0aGlzIG5lZWRlZCBpbiB0aGUgdG90YWxzIHNlY2l0b24/XHJcbiAgICAgICAgLy8gbGV0IGNvbmZpZGVuY2UgPSBjaGlsZFNjb3JlLmNvbmZpZGVuY2VcclxuICAgICAgICAvLyBpZiAoIWNoaWxkU2NvcmUucmV2ZXJzaWJsZSAmJiBjaGlsZFNjb3JlLmNvbmZpZGVuY2UgPCAwKSB7XHJcbiAgICAgICAgLy8gICAgIGNvbmZpZGVuY2UgPSAwXHJcbiAgICAgICAgLy8gfVxyXG5cclxuICAgICAgICBjaGlsZFNjb3JlLndlaWdodCA9IGNhbGNXZWlnaHQoY2hpbGRTY29yZSk7IC8vVE9ETzogSnVzdCBpbiBjYXNlIGEgY2hpbGQgc2NvcmUgY29tZXMgaW4gdW5jYWxjdWxhdGVkIC0gbWF5YmUgc2hvdWxkIGJlIHJlbW92ZWRcclxuICAgICAgICBuZXdTY29yZS5jaGlsZHJlbkF2ZXJhZ2luZ1dlaWdodCArPSAxO1xyXG4gICAgICAgIC8vIGlmIChjaGlsZFNjb3JlLmFmZmVjdHMgPSBcImNvbmZpZGVuY2VcIikge1xyXG4gICAgICAgIG5ld1Njb3JlLmNoaWxkcmVuQ29uZmlkZW5jZVdlaWdodCArPSBNYXRoLmFicyhjaGlsZFNjb3JlLmNvbmZpZGVuY2UpO1xyXG4gICAgICAgIC8vIH0gZWxzZSB7XHJcbiAgICAgICAgbmV3U2NvcmUuY2hpbGRyZW5SZWxldmFuY2VXZWlnaHQgKz0gY2hpbGRTY29yZS5yZWxldmFuY2U7XHJcbiAgICAgICAgLy8gfVxyXG4gICAgICAgIGlmIChjaGlsZFNjb3JlLmFmZmVjdHMgPT09IFwiY29uZmlkZW5jZVwiKSB7XHJcbiAgICAgICAgICAgIG5ld1Njb3JlLmNoaWxkcmVuV2VpZ2h0ICs9IGNoaWxkU2NvcmUud2VpZ2h0O1xyXG4gICAgICAgICAgICBpZiAoY2hpbGRTY29yZS53ZWlnaHQgPiBtYXhDaGlsZFdlaWdodCkge1xyXG4gICAgICAgICAgICAgICAgbWF4Q2hpbGRXZWlnaHQgPSBjaGlsZFNjb3JlLndlaWdodDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gLy9UT0RPOiBFeHBlcmltYW50YWxcclxuICAgICAgICAvLyBpZiAoY29uZmlkZW5jZSA+IDApIHtcclxuICAgICAgICAvLyAgICAgaWYgKGNoaWxkU2NvcmUucHJvKSB7XHJcbiAgICAgICAgLy8gICAgICAgICBuZXdTY29yZS5jaGlsZHJlblByb1dlaWdodCArPSBjb25maWRlbmNlXHJcbiAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAvLyAgICAgaWYgKCFjaGlsZFNjb3JlLnBybykge1xyXG4gICAgICAgIC8vICAgICAgICAgbmV3U2NvcmUuY2hpbGRyZW5Db25XZWlnaHQgKz0gY29uZmlkZW5jZVxyXG4gICAgICAgIC8vICAgICB9XHJcbiAgICAgICAgLy8gfSBlbHNlIGlmIChjb25maWRlbmNlIDwgMCkge1xyXG4gICAgICAgIC8vICAgICBpZiAoY2hpbGRTY29yZS5wcm8pIHtcclxuICAgICAgICAvLyAgICAgICAgIG5ld1Njb3JlLmNoaWxkcmVuQ29uV2VpZ2h0ICs9IGNvbmZpZGVuY2VcclxuICAgICAgICAvLyAgICAgfVxyXG4gICAgICAgIC8vICAgICBpZiAoIWNoaWxkU2NvcmUucHJvKSB7XHJcbiAgICAgICAgLy8gICAgICAgICBuZXdTY29yZS5jaGlsZHJlblByb1dlaWdodCArPSBjb25maWRlbmNlXHJcbiAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAvLyB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gTG9vcCB0aHJvdWdoIHRvIGNhbGN1bGF0ZSB0aGUgZmluYWwgY29uZmlkZW5jZVxyXG4gICAgZm9yIChjb25zdCBjaGlsZFNjb3JlIG9mIGNoaWxkU2NvcmVzKSB7XHJcbiAgICAgICAgY29uc3QgcG9sYXJpdHkgPSBjaGlsZFNjb3JlLnBybyA/IDEgOiAtMVxyXG5cclxuICAgICAgICBpZiAoY2hpbGRTY29yZS5hZmZlY3RzID09PSBcImNvbmZpZGVuY2VcIikge1xyXG4gICAgICAgICAgICBpZiAobmV3U2NvcmUuY2hpbGRyZW5XZWlnaHQgPT09IDApIHtcclxuICAgICAgICAgICAgICAgIGNoaWxkU2NvcmUucGVyY2VudE9mV2VpZ2h0ID0gMDtcclxuICAgICAgICAgICAgICAgIG5ld1Njb3JlLmNvbmZpZGVuY2UgPSAwO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG5cclxuICAgICAgICAgICAgICAgIGNoaWxkU2NvcmUucGVyY2VudE9mV2VpZ2h0ID1cclxuICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3JlLndlaWdodCAvXHJcbiAgICAgICAgICAgICAgICAgICAgbmV3U2NvcmUuY2hpbGRyZW5XZWlnaHQ7XHJcblxyXG4gICAgICAgICAgICAgICAgbmV3U2NvcmUuY29uZmlkZW5jZSArPVxyXG4gICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcmUucGVyY2VudE9mV2VpZ2h0ICpcclxuICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3JlLmNvbmZpZGVuY2UgKiBwb2xhcml0eTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gaWYgKGNoaWxkU2NvcmUucHJvKSB7XHJcbiAgICAgICAgLy8gICAgIGNoaWxkU2NvcmUucGVyY2VudEFncmVlV2VpZ2h0ID0gY29uZmlkZW5jZSAvIG5ld1Njb3JlLmNoaWxkcmVuUHJvV2VpZ2h0XHJcbiAgICAgICAgLy8gfSBlbHNlIHtcclxuICAgICAgICAvLyAgICAgY2hpbGRTY29yZS5wZXJjZW50QWdyZWVXZWlnaHQgPSBjb25maWRlbmNlIC8gbmV3U2NvcmUuY2hpbGRyZW5Db25XZWlnaHRcclxuICAgICAgICAvLyB9XHJcblxyXG4gICAgICAgIGNoaWxkU2NvcmUuc2NhbGVkV2VpZ2h0ID0gKGNoaWxkU2NvcmUud2VpZ2h0IC8gbWF4Q2hpbGRXZWlnaHQpXHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8vIExvb3AgdGhyb3VnaCB0byBjYWxjdWxhdGUgdGhlIGZpbmFsIHJlbGV2YW5jZVxyXG4gICAgZm9yIChjb25zdCBjaGlsZFNjb3JlIG9mIGNoaWxkU2NvcmVzKSB7XHJcbiAgICAgICAgaWYgKGNoaWxkU2NvcmUuYWZmZWN0cyA9PT0gXCJyZWxldmFuY2VcIikge1xyXG4gICAgICAgICAgICAvLyBQcm9jZXNzIFJlbGV2YW5jZSBjaGlsZCBjbGFpbXNcclxuXHJcbiAgICAgICAgICAgIGxldCBjb25maWRlbmNlID0gY2hpbGRTY29yZS5jb25maWRlbmNlXHJcbiAgICAgICAgICAgIGlmICghY2hpbGRTY29yZS5yZXZlcnNpYmxlICYmIGNoaWxkU2NvcmUuY29uZmlkZW5jZSA8IDApIHtcclxuICAgICAgICAgICAgICAgIGNvbmZpZGVuY2UgPSAwXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChuZXdTY29yZS5yZWxldmFuY2UgPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBuZXdTY29yZS5yZWxldmFuY2UgPSAxO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoY2hpbGRTY29yZS5wcm8pIHtcclxuICAgICAgICAgICAgICAgIC8vIG5ld1Njb3JlLnJlbGV2YW5jZSA9IG5ld1Njb3JlLnJlbGV2YW5jZSAqIDI7XHJcbiAgICAgICAgICAgICAgICBuZXdTY29yZS5yZWxldmFuY2UgKz0gY29uZmlkZW5jZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIG5ld1Njb3JlLnJlbGV2YW5jZSA9IG5ld1Njb3JlLnJlbGV2YW5jZSAvIDI7XHJcbiAgICAgICAgICAgICAgICBuZXdTY29yZS5yZWxldmFuY2UgLT0gY29uZmlkZW5jZSAvIDJcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgLy8gUHJvdGVjdCBhZ2FpbnN0IG5lZ2F0aXZlIHplcm8gXHJcbiAgICBpZiAoT2JqZWN0LmlzKG5ld1Njb3JlLmNvbmZpZGVuY2UsIC0wKSkge1xyXG4gICAgICAgIG5ld1Njb3JlLmNvbmZpZGVuY2UgPSAwO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBjb25maWRlbmNlID0gTWF0aC5hYnMobmV3U2NvcmUuY29uZmlkZW5jZSlcclxuICAgIGlmICghbmV3U2NvcmUucmV2ZXJzaWJsZSAmJiBuZXdTY29yZS5jb25maWRlbmNlIDwgMCkge1xyXG4gICAgICAgIGNvbmZpZGVuY2UgPSAwXHJcbiAgICB9XHJcblxyXG4gICAgbmV3U2NvcmUud2VpZ2h0ID0gY2FsY1dlaWdodChuZXdTY29yZSk7XHJcbiAgICBuZXdTY29yZS5zY2FsZWRXZWlnaHQgPSBuZXdTY29yZS53ZWlnaHQ7XHJcblxyXG4gICAgcmV0dXJuIG5ld1Njb3JlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjYWxjV2VpZ2h0KHNjb3JlOiBQYXJ0aWFsPFNjb3JlPikge1xyXG4gICAgaWYgKHNjb3JlLmNvbmZpZGVuY2UgIT09IHVuZGVmaW5lZCAmJiBzY29yZS5yZWxldmFuY2UgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIGxldCBjb25maWRlbmNlID0gTWF0aC5hYnMoc2NvcmUuY29uZmlkZW5jZSlcclxuICAgICAgICBpZiAoIXNjb3JlLnJldmVyc2libGUgJiYgc2NvcmUuY29uZmlkZW5jZSA8IDApIHtcclxuICAgICAgICAgICAgY29uZmlkZW5jZSA9IDBcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGNvbmZpZGVuY2UgKiBzY29yZS5yZWxldmFuY2U7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiAxO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==
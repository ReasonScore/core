"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.calculateScore = calculateScore;

var _Affects = require("./dataModels/Affects");

var _Score = require("./dataModels/Score");

var _Id = require("./dataModels/Id");

/**
 * Calculates a new score based on the child scores and how thay wre linked (by edged) the claim this score is for.
 */
function calculateScore() {
  var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},
      _ref$scoreAndClaimEdg = _ref.scoreAndClaimEdges,
      scoreAndClaimEdges = _ref$scoreAndClaimEdg === void 0 ? [] : _ref$scoreAndClaimEdg,
      _ref$reversible = _ref.reversible,
      reversible = _ref$reversible === void 0 ? true : _ref$reversible,
      _ref$sourceClaimId = _ref.sourceClaimId,
      sourceClaimId = _ref$sourceClaimId === void 0 ? (0, _Id.ID)("") : _ref$sourceClaimId;

  var newScore = new _Score.Score();
  var childrenConfidence = 0;
  var childrenRelevance = 0;

  if (scoreAndClaimEdges.filter(function (c) {
    return c.claimEdge.affects === _Affects.Affects.Confidence;
  }).length < 1) {
    // If there are no children that affect the confidence of the claim
    // then assume the claim is 100% confident and start strength and relevance at 1
    childrenConfidence = 1;
    childrenRelevance = 1;
  }

  scoreAndClaimEdges.forEach(function (_ref2) {
    var score = _ref2.score,
        claimEdge = _ref2.claimEdge;

    // Loop through the child scores and determine the score of the parent.
    if (claimEdge.affects === _Affects.Affects.Confidence) {
      //calculate the reduction of the relevance bease on the distance of the confidence from zero
      //TODO: maybe add a flag on the claimEdge to be able to turn this off in the case of a claim that should draw the parent towards zero
      //Like "This claim should require supporting evidence"
      var confidenceRelevanceAdjustment = 1;
      confidenceRelevanceAdjustment = Math.abs(score.confidence); // Process edges that affect confidence

      if (claimEdge.pro) {
        childrenConfidence += score.confidence * score.relevance * confidenceRelevanceAdjustment; // Add up all the strength of the children

        childrenRelevance += score.relevance * confidenceRelevanceAdjustment; //Add up the relevance separately so we can do a weighted agerage later
      } else {
        childrenConfidence -= score.confidence * score.relevance * confidenceRelevanceAdjustment;
        childrenRelevance += score.relevance * confidenceRelevanceAdjustment;
      }
    }

    if (claimEdge.affects === 'relevance') {
      // Process Relevance child claims
      if (claimEdge.pro) {
        newScore.relevance += score.confidence; // Add up all the strength of the children
      } else {
        newScore.relevance -= score.confidence;
      }
    }
  });

  if (childrenRelevance === 0) {
    // Protect against division by zero
    newScore.confidence = 0;
  } else {
    //Calculate the score
    newScore.confidence = childrenConfidence / childrenRelevance;
  }

  if (!reversible && newScore.confidence < 0) {
    // If it is not reversible then do not let it go negative
    newScore.confidence = 0;
  }

  if (Object.is(newScore.confidence, -0)) {
    // Protect against negative zero 
    newScore.confidence = 0;
  }

  if (sourceClaimId !== undefined) {
    newScore.sourceClaimId = sourceClaimId;
  }

  return newScore;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWxjdWxhdGVTY29yZS50cyJdLCJuYW1lcyI6WyJjYWxjdWxhdGVTY29yZSIsInNjb3JlQW5kQ2xhaW1FZGdlcyIsInJldmVyc2libGUiLCJzb3VyY2VDbGFpbUlkIiwibmV3U2NvcmUiLCJTY29yZSIsImNoaWxkcmVuQ29uZmlkZW5jZSIsImNoaWxkcmVuUmVsZXZhbmNlIiwiZmlsdGVyIiwiYyIsImNsYWltRWRnZSIsImFmZmVjdHMiLCJBZmZlY3RzIiwiQ29uZmlkZW5jZSIsImxlbmd0aCIsImZvckVhY2giLCJzY29yZSIsImNvbmZpZGVuY2VSZWxldmFuY2VBZGp1c3RtZW50IiwiTWF0aCIsImFicyIsImNvbmZpZGVuY2UiLCJwcm8iLCJyZWxldmFuY2UiLCJPYmplY3QiLCJpcyIsInVuZGVmaW5lZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUdBOzs7QUFHTyxTQUFTQSxjQUFULEdBUUw7QUFBQSxpRkFERSxFQUNGO0FBQUEsbUNBUitCQyxrQkFRL0I7QUFBQSxNQVIrQkEsa0JBUS9CLHNDQVJvRCxFQVFwRDtBQUFBLDZCQVJ3REMsVUFReEQ7QUFBQSxNQVJ3REEsVUFReEQsZ0NBUnFFLElBUXJFO0FBQUEsZ0NBUjJFQyxhQVEzRTtBQUFBLE1BUjJFQSxhQVEzRSxtQ0FSMkYsWUFBRyxFQUFILENBUTNGOztBQUNFLE1BQU1DLFFBQWUsR0FBRyxJQUFJQyxZQUFKLEVBQXhCO0FBQ0EsTUFBSUMsa0JBQWtCLEdBQUcsQ0FBekI7QUFDQSxNQUFJQyxpQkFBaUIsR0FBRyxDQUF4Qjs7QUFFQSxNQUFJTixrQkFBa0IsQ0FBQ08sTUFBbkIsQ0FBMEIsVUFBQUMsQ0FBQztBQUFBLFdBQUlBLENBQUMsQ0FBQ0MsU0FBRixDQUFZQyxPQUFaLEtBQXdCQyxpQkFBUUMsVUFBcEM7QUFBQSxHQUEzQixFQUEyRUMsTUFBM0UsR0FBb0YsQ0FBeEYsRUFBMkY7QUFDdkY7QUFDQTtBQUNBUixJQUFBQSxrQkFBa0IsR0FBRyxDQUFyQjtBQUNBQyxJQUFBQSxpQkFBaUIsR0FBRyxDQUFwQjtBQUNIOztBQUVETixFQUFBQSxrQkFBa0IsQ0FBQ2MsT0FBbkIsQ0FBMkIsaUJBQXdCO0FBQUEsUUFBdEJDLEtBQXNCLFNBQXRCQSxLQUFzQjtBQUFBLFFBQWZOLFNBQWUsU0FBZkEsU0FBZTs7QUFDL0M7QUFDQSxRQUFJQSxTQUFTLENBQUNDLE9BQVYsS0FBc0JDLGlCQUFRQyxVQUFsQyxFQUE4QztBQUUxQztBQUNBO0FBQ0E7QUFDQSxVQUFJSSw2QkFBNkIsR0FBRyxDQUFwQztBQUNBQSxNQUFBQSw2QkFBNkIsR0FBR0MsSUFBSSxDQUFDQyxHQUFMLENBQVNILEtBQUssQ0FBQ0ksVUFBZixDQUFoQyxDQU4wQyxDQVExQzs7QUFDQSxVQUFJVixTQUFTLENBQUNXLEdBQWQsRUFBbUI7QUFDZmYsUUFBQUEsa0JBQWtCLElBQUlVLEtBQUssQ0FBQ0ksVUFBTixHQUFtQkosS0FBSyxDQUFDTSxTQUF6QixHQUFxQ0wsNkJBQTNELENBRGUsQ0FDMkU7O0FBQzFGVixRQUFBQSxpQkFBaUIsSUFBSVMsS0FBSyxDQUFDTSxTQUFOLEdBQWtCTCw2QkFBdkMsQ0FGZSxDQUV1RDtBQUN6RSxPQUhELE1BR087QUFDSFgsUUFBQUEsa0JBQWtCLElBQUlVLEtBQUssQ0FBQ0ksVUFBTixHQUFtQkosS0FBSyxDQUFDTSxTQUF6QixHQUFxQ0wsNkJBQTNEO0FBQ0FWLFFBQUFBLGlCQUFpQixJQUFJUyxLQUFLLENBQUNNLFNBQU4sR0FBa0JMLDZCQUF2QztBQUNIO0FBQ0o7O0FBRUQsUUFBSVAsU0FBUyxDQUFDQyxPQUFWLEtBQXNCLFdBQTFCLEVBQXVDO0FBQ25DO0FBQ0EsVUFBSUQsU0FBUyxDQUFDVyxHQUFkLEVBQW1CO0FBQ2ZqQixRQUFBQSxRQUFRLENBQUNrQixTQUFULElBQXNCTixLQUFLLENBQUNJLFVBQTVCLENBRGUsQ0FDeUI7QUFDM0MsT0FGRCxNQUVPO0FBQ0hoQixRQUFBQSxRQUFRLENBQUNrQixTQUFULElBQXNCTixLQUFLLENBQUNJLFVBQTVCO0FBQ0g7QUFDSjtBQUNKLEdBNUJEOztBQThCQSxNQUFJYixpQkFBaUIsS0FBSyxDQUExQixFQUE2QjtBQUN6QjtBQUNBSCxJQUFBQSxRQUFRLENBQUNnQixVQUFULEdBQXNCLENBQXRCO0FBQ0gsR0FIRCxNQUdPO0FBQ0g7QUFDQWhCLElBQUFBLFFBQVEsQ0FBQ2dCLFVBQVQsR0FBc0JkLGtCQUFrQixHQUFHQyxpQkFBM0M7QUFDSDs7QUFFRCxNQUFJLENBQUNMLFVBQUQsSUFBZUUsUUFBUSxDQUFDZ0IsVUFBVCxHQUFzQixDQUF6QyxFQUE0QztBQUN4QztBQUNBaEIsSUFBQUEsUUFBUSxDQUFDZ0IsVUFBVCxHQUFzQixDQUF0QjtBQUNIOztBQUVELE1BQUlHLE1BQU0sQ0FBQ0MsRUFBUCxDQUFVcEIsUUFBUSxDQUFDZ0IsVUFBbkIsRUFBK0IsQ0FBQyxDQUFoQyxDQUFKLEVBQXdDO0FBQ3BDO0FBQ0FoQixJQUFBQSxRQUFRLENBQUNnQixVQUFULEdBQXNCLENBQXRCO0FBQ0g7O0FBRUQsTUFBSWpCLGFBQWEsS0FBS3NCLFNBQXRCLEVBQWlDO0FBQzdCckIsSUFBQUEsUUFBUSxDQUFDRCxhQUFULEdBQXlCQSxhQUF6QjtBQUNIOztBQUdELFNBQU9DLFFBQVA7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFmZmVjdHMgfSBmcm9tIFwiLi9kYXRhTW9kZWxzL0FmZmVjdHNcIlxyXG5pbXBvcnQgeyBTY29yZSB9IGZyb20gXCIuL2RhdGFNb2RlbHMvU2NvcmVcIjtcclxuaW1wb3J0IHsgSWQsIElEIH0gZnJvbSBcIi4vZGF0YU1vZGVscy9JZFwiO1xyXG5pbXBvcnQgeyBTY29yZUFuZENsYWltRWRnZSB9IGZyb20gXCIuL2RhdGFNb2RlbHMvU2NvcmVBbmRDbGFpbUVkZ2VcIjtcclxuXHJcbi8qKlxyXG4gKiBDYWxjdWxhdGVzIGEgbmV3IHNjb3JlIGJhc2VkIG9uIHRoZSBjaGlsZCBzY29yZXMgYW5kIGhvdyB0aGF5IHdyZSBsaW5rZWQgKGJ5IGVkZ2VkKSB0aGUgY2xhaW0gdGhpcyBzY29yZSBpcyBmb3IuXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlU2NvcmUoeyBzY29yZUFuZENsYWltRWRnZXMgPSBbXSwgcmV2ZXJzaWJsZSA9IHRydWUsIHNvdXJjZUNsYWltSWQgPSBJRChcIlwiKSB9OiB7XHJcbiAgICAvKiogQW4gYXJyYXkgb2YgZ3JvdXBlZCBlZGdlcyBhbmQgY2xhaW1zKi9cclxuICAgIHNjb3JlQW5kQ2xhaW1FZGdlcz86IFNjb3JlQW5kQ2xhaW1FZGdlW107XHJcbiAgICAvKiogQ2FuIHRoaXMgc2NvcmUgZmFsbCBiZWxvdyBhIDAgY29uZmlkZW5jZSAoaGF2ZSBhIG5lZ2F0aXZlIGNvbmZpZGVuY2UpICovXHJcbiAgICByZXZlcnNpYmxlPzogYm9vbGVhbjtcclxuICAgIC8qKiBUaGUgSUQgb2YgdGhlIGNsYWltIHdlIGFyZSBjcmVhdGluZyBhIHNjb3JlIGZvciAqL1xyXG4gICAgc291cmNlQ2xhaW1JZD86IElkO1xyXG59ID0ge30sXHJcbikge1xyXG4gICAgY29uc3QgbmV3U2NvcmU6IFNjb3JlID0gbmV3IFNjb3JlKCk7XHJcbiAgICBsZXQgY2hpbGRyZW5Db25maWRlbmNlID0gMFxyXG4gICAgbGV0IGNoaWxkcmVuUmVsZXZhbmNlID0gMFxyXG5cclxuICAgIGlmIChzY29yZUFuZENsYWltRWRnZXMuZmlsdGVyKGMgPT4gYy5jbGFpbUVkZ2UuYWZmZWN0cyA9PT0gQWZmZWN0cy5Db25maWRlbmNlKS5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgLy8gSWYgdGhlcmUgYXJlIG5vIGNoaWxkcmVuIHRoYXQgYWZmZWN0IHRoZSBjb25maWRlbmNlIG9mIHRoZSBjbGFpbVxyXG4gICAgICAgIC8vIHRoZW4gYXNzdW1lIHRoZSBjbGFpbSBpcyAxMDAlIGNvbmZpZGVudCBhbmQgc3RhcnQgc3RyZW5ndGggYW5kIHJlbGV2YW5jZSBhdCAxXHJcbiAgICAgICAgY2hpbGRyZW5Db25maWRlbmNlID0gMTtcclxuICAgICAgICBjaGlsZHJlblJlbGV2YW5jZSA9IDE7XHJcbiAgICB9XHJcblxyXG4gICAgc2NvcmVBbmRDbGFpbUVkZ2VzLmZvckVhY2goKHtzY29yZSwgY2xhaW1FZGdlfSkgPT4ge1xyXG4gICAgICAgIC8vIExvb3AgdGhyb3VnaCB0aGUgY2hpbGQgc2NvcmVzIGFuZCBkZXRlcm1pbmUgdGhlIHNjb3JlIG9mIHRoZSBwYXJlbnQuXHJcbiAgICAgICAgaWYgKGNsYWltRWRnZS5hZmZlY3RzID09PSBBZmZlY3RzLkNvbmZpZGVuY2UpIHtcclxuXHJcbiAgICAgICAgICAgIC8vY2FsY3VsYXRlIHRoZSByZWR1Y3Rpb24gb2YgdGhlIHJlbGV2YW5jZSBiZWFzZSBvbiB0aGUgZGlzdGFuY2Ugb2YgdGhlIGNvbmZpZGVuY2UgZnJvbSB6ZXJvXHJcbiAgICAgICAgICAgIC8vVG9ETzogbWF5YmUgYWRkIGEgZmxhZyBvbiB0aGUgY2xhaW1FZGdlIHRvIGJlIGFibGUgdG8gdHVybiB0aGlzIG9mZiBpbiB0aGUgY2FzZSBvZiBhIGNsYWltIHRoYXQgc2hvdWxkIGRyYXcgdGhlIHBhcmVudCB0b3dhcmRzIHplcm9cclxuICAgICAgICAgICAgLy9MaWtlIFwiVGhpcyBjbGFpbSBzaG91bGQgcmVxdWlyZSBzdXBwb3J0aW5nIGV2aWRlbmNlXCJcclxuICAgICAgICAgICAgbGV0IGNvbmZpZGVuY2VSZWxldmFuY2VBZGp1c3RtZW50ID0gMVxyXG4gICAgICAgICAgICBjb25maWRlbmNlUmVsZXZhbmNlQWRqdXN0bWVudCA9IE1hdGguYWJzKHNjb3JlLmNvbmZpZGVuY2UpXHJcblxyXG4gICAgICAgICAgICAvLyBQcm9jZXNzIGVkZ2VzIHRoYXQgYWZmZWN0IGNvbmZpZGVuY2VcclxuICAgICAgICAgICAgaWYgKGNsYWltRWRnZS5wcm8pIHtcclxuICAgICAgICAgICAgICAgIGNoaWxkcmVuQ29uZmlkZW5jZSArPSBzY29yZS5jb25maWRlbmNlICogc2NvcmUucmVsZXZhbmNlICogY29uZmlkZW5jZVJlbGV2YW5jZUFkanVzdG1lbnQ7IC8vIEFkZCB1cCBhbGwgdGhlIHN0cmVuZ3RoIG9mIHRoZSBjaGlsZHJlblxyXG4gICAgICAgICAgICAgICAgY2hpbGRyZW5SZWxldmFuY2UgKz0gc2NvcmUucmVsZXZhbmNlICogY29uZmlkZW5jZVJlbGV2YW5jZUFkanVzdG1lbnQ7IC8vQWRkIHVwIHRoZSByZWxldmFuY2Ugc2VwYXJhdGVseSBzbyB3ZSBjYW4gZG8gYSB3ZWlnaHRlZCBhZ2VyYWdlIGxhdGVyXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjaGlsZHJlbkNvbmZpZGVuY2UgLT0gc2NvcmUuY29uZmlkZW5jZSAqIHNjb3JlLnJlbGV2YW5jZSAqIGNvbmZpZGVuY2VSZWxldmFuY2VBZGp1c3RtZW50O1xyXG4gICAgICAgICAgICAgICAgY2hpbGRyZW5SZWxldmFuY2UgKz0gc2NvcmUucmVsZXZhbmNlICogY29uZmlkZW5jZVJlbGV2YW5jZUFkanVzdG1lbnQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChjbGFpbUVkZ2UuYWZmZWN0cyA9PT0gJ3JlbGV2YW5jZScpIHtcclxuICAgICAgICAgICAgLy8gUHJvY2VzcyBSZWxldmFuY2UgY2hpbGQgY2xhaW1zXHJcbiAgICAgICAgICAgIGlmIChjbGFpbUVkZ2UucHJvKSB7XHJcbiAgICAgICAgICAgICAgICBuZXdTY29yZS5yZWxldmFuY2UgKz0gc2NvcmUuY29uZmlkZW5jZTsgLy8gQWRkIHVwIGFsbCB0aGUgc3RyZW5ndGggb2YgdGhlIGNoaWxkcmVuXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBuZXdTY29yZS5yZWxldmFuY2UgLT0gc2NvcmUuY29uZmlkZW5jZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIGlmIChjaGlsZHJlblJlbGV2YW5jZSA9PT0gMCkge1xyXG4gICAgICAgIC8vIFByb3RlY3QgYWdhaW5zdCBkaXZpc2lvbiBieSB6ZXJvXHJcbiAgICAgICAgbmV3U2NvcmUuY29uZmlkZW5jZSA9IDA7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vQ2FsY3VsYXRlIHRoZSBzY29yZVxyXG4gICAgICAgIG5ld1Njb3JlLmNvbmZpZGVuY2UgPSBjaGlsZHJlbkNvbmZpZGVuY2UgLyBjaGlsZHJlblJlbGV2YW5jZTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXJldmVyc2libGUgJiYgbmV3U2NvcmUuY29uZmlkZW5jZSA8IDApIHtcclxuICAgICAgICAvLyBJZiBpdCBpcyBub3QgcmV2ZXJzaWJsZSB0aGVuIGRvIG5vdCBsZXQgaXQgZ28gbmVnYXRpdmVcclxuICAgICAgICBuZXdTY29yZS5jb25maWRlbmNlID0gMFxyXG4gICAgfVxyXG5cclxuICAgIGlmIChPYmplY3QuaXMobmV3U2NvcmUuY29uZmlkZW5jZSwgLTApKSB7XHJcbiAgICAgICAgLy8gUHJvdGVjdCBhZ2FpbnN0IG5lZ2F0aXZlIHplcm8gXHJcbiAgICAgICAgbmV3U2NvcmUuY29uZmlkZW5jZSA9IDA7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHNvdXJjZUNsYWltSWQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIG5ld1Njb3JlLnNvdXJjZUNsYWltSWQgPSBzb3VyY2VDbGFpbUlkXHJcbiAgICB9XHJcblxyXG5cclxuICAgIHJldHVybiBuZXdTY29yZTtcclxufVxyXG5cclxuIl19
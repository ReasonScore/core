"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.calculateScore = calculateScore;

var _Score = require("./Score");

var _Edge = require("./Edge");

/**
 * Calculates a new score based on the child scores and how thay wre linked (by edged) the claim this score is for. This function does not take into account scopes. The caller of this fuction should only put the children and scores into this array that are within scope.
 * @param childEdges - an array of edges (aka arguments) that link an individual child to the claim this score is for. 
 * @param childScores - an array of scores for child claims linked to the claim this score is for. This function does not take into account scopes. The caller of this fuction should only put the scores into this array that are within scope.
 * @param previousScore - The previous score for this claim which may be replaced by this new score (if there are different)
 */
function calculateScore(claimId) {
  var childEdges = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var childScores = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];
  var newScore = new _Score.Score(claimId); // ToDO: Removed the previous score. Comparisons and duplication of the previous score should be done in other places. This is so that the calcuations are as simple as possible. 
  //If there are no children that affect the truth of the claim then assume the claim is 100% true and start strength at 1

  if (childEdges === undefined || childEdges.length < 1 || childEdges.filter(function (e) {
    return e.affects === _Edge.Affects.Confidence;
  }).length < 1) {
    newScore.childrenStrength = 1;
    newScore.childrenWeight = 1;
  } // Loop through the child edges and determine the score of the parent. Many of the child properties are also filled out during this calcuation
  // If there are no children that affect the confidence of the claim then assume the claim is 100% confident and start strength at 1. No code necessary as this is the default of the object


  childEdges.forEach(function (childEdge) {
    var childScore = childScores.filter(function (s) {
      return s.claimId === childEdge.childId;
    })[0]; // Process edges that affect confidence

    if (childEdge.affects === _Edge.Affects.Confidence) {
      if (childEdge.reversable) {
        childScore.weight = childScore.score * childScore.relevance;
      } else {
        childScore.weight = Math.max(0, childScore.score) * childScore.relevance; // If the claim is not reversable and weight is below 0 then assume it is 0
      }

      newScore.childrenWeight += childScore.weight; // Add up all the weights of the children

      if (childEdge.pro) {
        childScore.strength = childScore.weight * childScore.score;
      } else {
        childScore.strength = childScore.weight * -childScore.score;
      }

      newScore.childrenStrength += childScore.strength; // Add up all the strength of the children

      childScore.displayText = "".concat(Math.round(childScore.weight * 100), "%"); // * (edge.pro ? 1 : -1)}%`;
    } // Process Relevance child claims


    if (childEdge.affects === 'relevance') {
      if (childEdge.pro) {
        childScore.relevance = 1 + childScore.score;
      } else {
        childScore.relevance = 1 - childScore.score / 2;
      }

      newScore.relevance *= childScore.relevance;
      childScore.displayText = "X".concat(childScore.relevance);
    }
  });

  if (newScore.childrenWeight === 0) {
    // Protect against division by zero
    newScore.score = 0;
  } else {
    newScore.score = newScore.childrenStrength / newScore.childrenWeight;
  }

  newScore.displayText = "".concat(Math.round(newScore.score * 100), "%");
  return newScore;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWxjdWxhdGVTY29yZS50cyJdLCJuYW1lcyI6WyJjYWxjdWxhdGVTY29yZSIsImNsYWltSWQiLCJjaGlsZEVkZ2VzIiwiY2hpbGRTY29yZXMiLCJuZXdTY29yZSIsIlNjb3JlIiwidW5kZWZpbmVkIiwibGVuZ3RoIiwiZmlsdGVyIiwiZSIsImFmZmVjdHMiLCJBZmZlY3RzIiwiQ29uZmlkZW5jZSIsImNoaWxkcmVuU3RyZW5ndGgiLCJjaGlsZHJlbldlaWdodCIsImZvckVhY2giLCJjaGlsZEVkZ2UiLCJjaGlsZFNjb3JlIiwicyIsImNoaWxkSWQiLCJyZXZlcnNhYmxlIiwid2VpZ2h0Iiwic2NvcmUiLCJyZWxldmFuY2UiLCJNYXRoIiwibWF4IiwicHJvIiwic3RyZW5ndGgiLCJkaXNwbGF5VGV4dCIsInJvdW5kIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7OztBQU1PLFNBQVNBLGNBQVQsQ0FBd0JDLE9BQXhCLEVBQTZGO0FBQUEsTUFBcERDLFVBQW9ELHVFQUEvQixFQUErQjtBQUFBLE1BQTNCQyxXQUEyQix1RUFBSixFQUFJO0FBQ2hHLE1BQU1DLFFBQWUsR0FBRyxJQUFJQyxZQUFKLENBQVVKLE9BQVYsQ0FBeEIsQ0FEZ0csQ0FFaEc7QUFFQTs7QUFDQSxNQUFJQyxVQUFVLEtBQUtJLFNBQWYsSUFDR0osVUFBVSxDQUFDSyxNQUFYLEdBQW9CLENBRHZCLElBRUdMLFVBQVUsQ0FBQ00sTUFBWCxDQUFrQixVQUFBQyxDQUFDO0FBQUEsV0FBSUEsQ0FBQyxDQUFDQyxPQUFGLEtBQWNDLGNBQVFDLFVBQTFCO0FBQUEsR0FBbkIsRUFBeURMLE1BQXpELEdBQWtFLENBRnpFLEVBRTRFO0FBQ3hFSCxJQUFBQSxRQUFRLENBQUNTLGdCQUFULEdBQTRCLENBQTVCO0FBQ0FULElBQUFBLFFBQVEsQ0FBQ1UsY0FBVCxHQUEwQixDQUExQjtBQUNILEdBVitGLENBWWhHO0FBQ0E7OztBQUNBWixFQUFBQSxVQUFVLENBQUNhLE9BQVgsQ0FBbUIsVUFBQ0MsU0FBRCxFQUFlO0FBQzlCLFFBQU1DLFVBQVUsR0FBR2QsV0FBVyxDQUFDSyxNQUFaLENBQW1CLFVBQUFVLENBQUM7QUFBQSxhQUFJQSxDQUFDLENBQUNqQixPQUFGLEtBQWNlLFNBQVMsQ0FBQ0csT0FBNUI7QUFBQSxLQUFwQixFQUF5RCxDQUF6RCxDQUFuQixDQUQ4QixDQUc5Qjs7QUFDQSxRQUFJSCxTQUFTLENBQUNOLE9BQVYsS0FBc0JDLGNBQVFDLFVBQWxDLEVBQThDO0FBQzFDLFVBQUlJLFNBQVMsQ0FBQ0ksVUFBZCxFQUEwQjtBQUN0QkgsUUFBQUEsVUFBVSxDQUFDSSxNQUFYLEdBQW9CSixVQUFVLENBQUNLLEtBQVgsR0FBbUJMLFVBQVUsQ0FBQ00sU0FBbEQ7QUFDSCxPQUZELE1BRU87QUFDSE4sUUFBQUEsVUFBVSxDQUFDSSxNQUFYLEdBQW9CRyxJQUFJLENBQUNDLEdBQUwsQ0FBUyxDQUFULEVBQVlSLFVBQVUsQ0FBQ0ssS0FBdkIsSUFBZ0NMLFVBQVUsQ0FBQ00sU0FBL0QsQ0FERyxDQUN1RTtBQUM3RTs7QUFDRG5CLE1BQUFBLFFBQVEsQ0FBQ1UsY0FBVCxJQUEyQkcsVUFBVSxDQUFDSSxNQUF0QyxDQU4wQyxDQU1JOztBQUM5QyxVQUFJTCxTQUFTLENBQUNVLEdBQWQsRUFBbUI7QUFDZlQsUUFBQUEsVUFBVSxDQUFDVSxRQUFYLEdBQXNCVixVQUFVLENBQUNJLE1BQVgsR0FBb0JKLFVBQVUsQ0FBQ0ssS0FBckQ7QUFDSCxPQUZELE1BRU87QUFDSEwsUUFBQUEsVUFBVSxDQUFDVSxRQUFYLEdBQXNCVixVQUFVLENBQUNJLE1BQVgsR0FBb0IsQ0FBQ0osVUFBVSxDQUFDSyxLQUF0RDtBQUNIOztBQUNEbEIsTUFBQUEsUUFBUSxDQUFDUyxnQkFBVCxJQUE2QkksVUFBVSxDQUFDVSxRQUF4QyxDQVowQyxDQVlROztBQUNsRFYsTUFBQUEsVUFBVSxDQUFDVyxXQUFYLGFBQTRCSixJQUFJLENBQUNLLEtBQUwsQ0FBV1osVUFBVSxDQUFDSSxNQUFYLEdBQW9CLEdBQS9CLENBQTVCLE9BYjBDLENBYXlCO0FBQ3RFLEtBbEI2QixDQW9COUI7OztBQUNBLFFBQUlMLFNBQVMsQ0FBQ04sT0FBVixLQUFzQixXQUExQixFQUF1QztBQUNuQyxVQUFJTSxTQUFTLENBQUNVLEdBQWQsRUFBbUI7QUFDZlQsUUFBQUEsVUFBVSxDQUFDTSxTQUFYLEdBQXVCLElBQUlOLFVBQVUsQ0FBQ0ssS0FBdEM7QUFDSCxPQUZELE1BRU87QUFDSEwsUUFBQUEsVUFBVSxDQUFDTSxTQUFYLEdBQXVCLElBQUtOLFVBQVUsQ0FBQ0ssS0FBWCxHQUFtQixDQUEvQztBQUNIOztBQUNEbEIsTUFBQUEsUUFBUSxDQUFDbUIsU0FBVCxJQUFzQk4sVUFBVSxDQUFDTSxTQUFqQztBQUNBTixNQUFBQSxVQUFVLENBQUNXLFdBQVgsY0FBNkJYLFVBQVUsQ0FBQ00sU0FBeEM7QUFDSDtBQUNKLEdBOUJEOztBQWdDQSxNQUFJbkIsUUFBUSxDQUFDVSxjQUFULEtBQTRCLENBQWhDLEVBQW1DO0FBQy9CO0FBQ0FWLElBQUFBLFFBQVEsQ0FBQ2tCLEtBQVQsR0FBaUIsQ0FBakI7QUFDSCxHQUhELE1BR087QUFDSGxCLElBQUFBLFFBQVEsQ0FBQ2tCLEtBQVQsR0FBaUJsQixRQUFRLENBQUNTLGdCQUFULEdBQTRCVCxRQUFRLENBQUNVLGNBQXREO0FBQ0g7O0FBRURWLEVBQUFBLFFBQVEsQ0FBQ3dCLFdBQVQsYUFBMEJKLElBQUksQ0FBQ0ssS0FBTCxDQUFXekIsUUFBUSxDQUFDa0IsS0FBVCxHQUFpQixHQUE1QixDQUExQjtBQUVBLFNBQU9sQixRQUFQO0FBRUgiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTY29yZSB9IGZyb20gXCIuL1Njb3JlXCJcclxuaW1wb3J0IHsgRWRnZSwgQWZmZWN0cyB9IGZyb20gXCIuL0VkZ2VcIlxyXG4vKipcclxuICogQ2FsY3VsYXRlcyBhIG5ldyBzY29yZSBiYXNlZCBvbiB0aGUgY2hpbGQgc2NvcmVzIGFuZCBob3cgdGhheSB3cmUgbGlua2VkIChieSBlZGdlZCkgdGhlIGNsYWltIHRoaXMgc2NvcmUgaXMgZm9yLiBUaGlzIGZ1bmN0aW9uIGRvZXMgbm90IHRha2UgaW50byBhY2NvdW50IHNjb3Blcy4gVGhlIGNhbGxlciBvZiB0aGlzIGZ1Y3Rpb24gc2hvdWxkIG9ubHkgcHV0IHRoZSBjaGlsZHJlbiBhbmQgc2NvcmVzIGludG8gdGhpcyBhcnJheSB0aGF0IGFyZSB3aXRoaW4gc2NvcGUuXHJcbiAqIEBwYXJhbSBjaGlsZEVkZ2VzIC0gYW4gYXJyYXkgb2YgZWRnZXMgKGFrYSBhcmd1bWVudHMpIHRoYXQgbGluayBhbiBpbmRpdmlkdWFsIGNoaWxkIHRvIHRoZSBjbGFpbSB0aGlzIHNjb3JlIGlzIGZvci4gXHJcbiAqIEBwYXJhbSBjaGlsZFNjb3JlcyAtIGFuIGFycmF5IG9mIHNjb3JlcyBmb3IgY2hpbGQgY2xhaW1zIGxpbmtlZCB0byB0aGUgY2xhaW0gdGhpcyBzY29yZSBpcyBmb3IuIFRoaXMgZnVuY3Rpb24gZG9lcyBub3QgdGFrZSBpbnRvIGFjY291bnQgc2NvcGVzLiBUaGUgY2FsbGVyIG9mIHRoaXMgZnVjdGlvbiBzaG91bGQgb25seSBwdXQgdGhlIHNjb3JlcyBpbnRvIHRoaXMgYXJyYXkgdGhhdCBhcmUgd2l0aGluIHNjb3BlLlxyXG4gKiBAcGFyYW0gcHJldmlvdXNTY29yZSAtIFRoZSBwcmV2aW91cyBzY29yZSBmb3IgdGhpcyBjbGFpbSB3aGljaCBtYXkgYmUgcmVwbGFjZWQgYnkgdGhpcyBuZXcgc2NvcmUgKGlmIHRoZXJlIGFyZSBkaWZmZXJlbnQpXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlU2NvcmUoY2xhaW1JZDogc3RyaW5nLCBjaGlsZEVkZ2VzOiBFZGdlW10gPSBbXSwgY2hpbGRTY29yZXM6IFNjb3JlW10gPSBbXSkge1xyXG4gICAgY29uc3QgbmV3U2NvcmU6IFNjb3JlID0gbmV3IFNjb3JlKGNsYWltSWQpO1xyXG4gICAgLy8gVG9ETzogUmVtb3ZlZCB0aGUgcHJldmlvdXMgc2NvcmUuIENvbXBhcmlzb25zIGFuZCBkdXBsaWNhdGlvbiBvZiB0aGUgcHJldmlvdXMgc2NvcmUgc2hvdWxkIGJlIGRvbmUgaW4gb3RoZXIgcGxhY2VzLiBUaGlzIGlzIHNvIHRoYXQgdGhlIGNhbGN1YXRpb25zIGFyZSBhcyBzaW1wbGUgYXMgcG9zc2libGUuIFxyXG5cclxuICAgIC8vSWYgdGhlcmUgYXJlIG5vIGNoaWxkcmVuIHRoYXQgYWZmZWN0IHRoZSB0cnV0aCBvZiB0aGUgY2xhaW0gdGhlbiBhc3N1bWUgdGhlIGNsYWltIGlzIDEwMCUgdHJ1ZSBhbmQgc3RhcnQgc3RyZW5ndGggYXQgMVxyXG4gICAgaWYgKGNoaWxkRWRnZXMgPT09IHVuZGVmaW5lZFxyXG4gICAgICAgIHx8IGNoaWxkRWRnZXMubGVuZ3RoIDwgMVxyXG4gICAgICAgIHx8IGNoaWxkRWRnZXMuZmlsdGVyKGUgPT4gZS5hZmZlY3RzID09PSBBZmZlY3RzLkNvbmZpZGVuY2UpLmxlbmd0aCA8IDEpIHtcclxuICAgICAgICBuZXdTY29yZS5jaGlsZHJlblN0cmVuZ3RoID0gMTtcclxuICAgICAgICBuZXdTY29yZS5jaGlsZHJlbldlaWdodCA9IDE7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gTG9vcCB0aHJvdWdoIHRoZSBjaGlsZCBlZGdlcyBhbmQgZGV0ZXJtaW5lIHRoZSBzY29yZSBvZiB0aGUgcGFyZW50LiBNYW55IG9mIHRoZSBjaGlsZCBwcm9wZXJ0aWVzIGFyZSBhbHNvIGZpbGxlZCBvdXQgZHVyaW5nIHRoaXMgY2FsY3VhdGlvblxyXG4gICAgLy8gSWYgdGhlcmUgYXJlIG5vIGNoaWxkcmVuIHRoYXQgYWZmZWN0IHRoZSBjb25maWRlbmNlIG9mIHRoZSBjbGFpbSB0aGVuIGFzc3VtZSB0aGUgY2xhaW0gaXMgMTAwJSBjb25maWRlbnQgYW5kIHN0YXJ0IHN0cmVuZ3RoIGF0IDEuIE5vIGNvZGUgbmVjZXNzYXJ5IGFzIHRoaXMgaXMgdGhlIGRlZmF1bHQgb2YgdGhlIG9iamVjdFxyXG4gICAgY2hpbGRFZGdlcy5mb3JFYWNoKChjaGlsZEVkZ2UpID0+IHtcclxuICAgICAgICBjb25zdCBjaGlsZFNjb3JlID0gY2hpbGRTY29yZXMuZmlsdGVyKHMgPT4gcy5jbGFpbUlkID09PSBjaGlsZEVkZ2UuY2hpbGRJZClbMF07XHJcblxyXG4gICAgICAgIC8vIFByb2Nlc3MgZWRnZXMgdGhhdCBhZmZlY3QgY29uZmlkZW5jZVxyXG4gICAgICAgIGlmIChjaGlsZEVkZ2UuYWZmZWN0cyA9PT0gQWZmZWN0cy5Db25maWRlbmNlKSB7XHJcbiAgICAgICAgICAgIGlmIChjaGlsZEVkZ2UucmV2ZXJzYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgY2hpbGRTY29yZS53ZWlnaHQgPSBjaGlsZFNjb3JlLnNjb3JlICogY2hpbGRTY29yZS5yZWxldmFuY2U7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjaGlsZFNjb3JlLndlaWdodCA9IE1hdGgubWF4KDAsIGNoaWxkU2NvcmUuc2NvcmUpICogY2hpbGRTY29yZS5yZWxldmFuY2U7IC8vIElmIHRoZSBjbGFpbSBpcyBub3QgcmV2ZXJzYWJsZSBhbmQgd2VpZ2h0IGlzIGJlbG93IDAgdGhlbiBhc3N1bWUgaXQgaXMgMFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG5ld1Njb3JlLmNoaWxkcmVuV2VpZ2h0ICs9IGNoaWxkU2NvcmUud2VpZ2h0OyAvLyBBZGQgdXAgYWxsIHRoZSB3ZWlnaHRzIG9mIHRoZSBjaGlsZHJlblxyXG4gICAgICAgICAgICBpZiAoY2hpbGRFZGdlLnBybykge1xyXG4gICAgICAgICAgICAgICAgY2hpbGRTY29yZS5zdHJlbmd0aCA9IGNoaWxkU2NvcmUud2VpZ2h0ICogY2hpbGRTY29yZS5zY29yZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNoaWxkU2NvcmUuc3RyZW5ndGggPSBjaGlsZFNjb3JlLndlaWdodCAqIC1jaGlsZFNjb3JlLnNjb3JlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG5ld1Njb3JlLmNoaWxkcmVuU3RyZW5ndGggKz0gY2hpbGRTY29yZS5zdHJlbmd0aDsgLy8gQWRkIHVwIGFsbCB0aGUgc3RyZW5ndGggb2YgdGhlIGNoaWxkcmVuXHJcbiAgICAgICAgICAgIGNoaWxkU2NvcmUuZGlzcGxheVRleHQgPSBgJHtNYXRoLnJvdW5kKGNoaWxkU2NvcmUud2VpZ2h0ICogMTAwKX0lYDsvLyAqIChlZGdlLnBybyA/IDEgOiAtMSl9JWA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBQcm9jZXNzIFJlbGV2YW5jZSBjaGlsZCBjbGFpbXNcclxuICAgICAgICBpZiAoY2hpbGRFZGdlLmFmZmVjdHMgPT09ICdyZWxldmFuY2UnKSB7XHJcbiAgICAgICAgICAgIGlmIChjaGlsZEVkZ2UucHJvKSB7XHJcbiAgICAgICAgICAgICAgICBjaGlsZFNjb3JlLnJlbGV2YW5jZSA9IDEgKyBjaGlsZFNjb3JlLnNjb3JlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY2hpbGRTY29yZS5yZWxldmFuY2UgPSAxIC0gKGNoaWxkU2NvcmUuc2NvcmUgLyAyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBuZXdTY29yZS5yZWxldmFuY2UgKj0gY2hpbGRTY29yZS5yZWxldmFuY2U7XHJcbiAgICAgICAgICAgIGNoaWxkU2NvcmUuZGlzcGxheVRleHQgPSBgWCR7Y2hpbGRTY29yZS5yZWxldmFuY2V9YDtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAobmV3U2NvcmUuY2hpbGRyZW5XZWlnaHQgPT09IDApIHtcclxuICAgICAgICAvLyBQcm90ZWN0IGFnYWluc3QgZGl2aXNpb24gYnkgemVyb1xyXG4gICAgICAgIG5ld1Njb3JlLnNjb3JlID0gMDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbmV3U2NvcmUuc2NvcmUgPSBuZXdTY29yZS5jaGlsZHJlblN0cmVuZ3RoIC8gbmV3U2NvcmUuY2hpbGRyZW5XZWlnaHQ7XHJcbiAgICB9XHJcblxyXG4gICAgbmV3U2NvcmUuZGlzcGxheVRleHQgPSBgJHtNYXRoLnJvdW5kKG5ld1Njb3JlLnNjb3JlICogMTAwKX0lYDtcclxuXHJcbiAgICByZXR1cm4gbmV3U2NvcmU7XHJcblxyXG59XHJcblxyXG4iXX0=
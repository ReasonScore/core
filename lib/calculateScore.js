"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.calculateScore = calculateScore;

/**
 * Calculates a new score based on the child scores passed in.
 */
function calculateScore({
  childScores = [],
  reversible = true
} = {}) {
  // TODO: Simplify all this math and maybe break it up between base functionality and additional scoring (like the points)
  const newScore = {
    confidence: 0,
    relevance: 1,
    childrenAveragingWeight: 0,
    childrenConfidenceWeight: 0,
    childrenRelevanceWeight: 0,
    childrenWeight: 0
  };

  if (childScores.filter(s => s.affects === 'confidence').length < 1) {
    // Defaults if there are no children
    newScore.confidence = 1; // assume 100% confident

    newScore.relevance = 1; // assume 100% relevant

    newScore.childrenAveragingWeight = 1;
    newScore.childrenConfidenceWeight = 1;
    newScore.childrenRelevanceWeight = 1;
    newScore.childrenWeight = 1;
  } //Gather children Weights totals for processing further down


  for (const childScore of childScores) {
    //Ensure calculations for non-reversible scores don't allow the confidence to be below 0
    //TODO: Is this needed in the totals seciton?
    let confidence = childScore.confidence;

    if (!childScore.reversible && childScore.confidence < 0) {
      confidence = 0;
    }

    childScore.weight = Math.abs(confidence) * childScore.relevance; // confidenceWeight * RelevanceWeight
    // @ts-ignore

    newScore.childrenAveragingWeight += 1; // @ts-ignore

    newScore.childrenConfidenceWeight += Math.abs(confidence); // @ts-ignore

    newScore.childrenRelevanceWeight += childScore.relevance; // @ts-ignore

    newScore.childrenWeight += childScore.weight;
  } // Loop through to calculate the final scores


  for (const childScore of childScores) {
    const polarity = childScore.pro ? 1 : -1;

    if (childScore.affects === "confidence") {
      if (newScore.childrenWeight === 0) {
        childScore.percentOfWeight = 0;
        newScore.confidence = 0;
      } else {
        // @ts-ignore
        childScore.percentOfWeight = childScore.weight / // @ts-ignore
        newScore.childrenWeight; // @ts-ignore

        newScore.confidence += childScore.percentOfWeight * childScore.confidence * polarity;
      }
    }

    if (childScore.affects === "relevance") {
      // Process Relevance child claims
      let confidence = childScore.confidence;

      if (!childScore.reversible && childScore.confidence < 0) {
        confidence = 0;
      }

      if (newScore.relevance == undefined) {
        newScore.relevance = 1;
      }

      if (childScore.pro) {
        newScore.relevance += confidence;
      } else {
        newScore.relevance -= confidence / 2;
      }
    }
  }

  if (Object.is(newScore.confidence, -0)) {
    // Protect against negative zero 
    newScore.confidence = 0;
  }

  return newScore;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWxjdWxhdGVTY29yZS50cyJdLCJuYW1lcyI6WyJjYWxjdWxhdGVTY29yZSIsImNoaWxkU2NvcmVzIiwicmV2ZXJzaWJsZSIsIm5ld1Njb3JlIiwiY29uZmlkZW5jZSIsInJlbGV2YW5jZSIsImNoaWxkcmVuQXZlcmFnaW5nV2VpZ2h0IiwiY2hpbGRyZW5Db25maWRlbmNlV2VpZ2h0IiwiY2hpbGRyZW5SZWxldmFuY2VXZWlnaHQiLCJjaGlsZHJlbldlaWdodCIsImZpbHRlciIsInMiLCJhZmZlY3RzIiwibGVuZ3RoIiwiY2hpbGRTY29yZSIsIndlaWdodCIsIk1hdGgiLCJhYnMiLCJwb2xhcml0eSIsInBybyIsInBlcmNlbnRPZldlaWdodCIsInVuZGVmaW5lZCIsIk9iamVjdCIsImlzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBU0E7OztBQUdPLFNBQVNBLGNBQVQsQ0FBd0I7QUFBRUMsRUFBQUEsV0FBVyxHQUFHLEVBQWhCO0FBQW9CQyxFQUFBQSxVQUFVLEdBQUc7QUFBakMsSUFLM0IsRUFMRyxFQU1XO0FBQ2Q7QUFDQSxRQUFNQyxRQUF3QixHQUFHO0FBQzdCQyxJQUFBQSxVQUFVLEVBQUUsQ0FEaUI7QUFFN0JDLElBQUFBLFNBQVMsRUFBRSxDQUZrQjtBQUc3QkMsSUFBQUEsdUJBQXVCLEVBQUUsQ0FISTtBQUk3QkMsSUFBQUEsd0JBQXdCLEVBQUUsQ0FKRztBQUs3QkMsSUFBQUEsdUJBQXVCLEVBQUUsQ0FMSTtBQU03QkMsSUFBQUEsY0FBYyxFQUFFO0FBTmEsR0FBakM7O0FBU0EsTUFBSVIsV0FBVyxDQUFDUyxNQUFaLENBQW1CQyxDQUFDLElBQUlBLENBQUMsQ0FBQ0MsT0FBRixLQUFjLFlBQXRDLEVBQW9EQyxNQUFwRCxHQUE2RCxDQUFqRSxFQUFvRTtBQUNoRTtBQUNBVixJQUFBQSxRQUFRLENBQUNDLFVBQVQsR0FBc0IsQ0FBdEIsQ0FGZ0UsQ0FFdkM7O0FBQ3pCRCxJQUFBQSxRQUFRLENBQUNFLFNBQVQsR0FBcUIsQ0FBckIs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QUQsSUFBQUEsUUFBUSxDQUFDQyxVQUFULEdBQXNCLENBQXRCO0FBQ0g7O0FBRUQsU0FBT0QsUUFBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2NvcmV9IGZyb20gXCIuL2RhdGFNb2RlbHMvU2NvcmVcIjtcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgaUNhbGN1bGF0ZVNjb3JlIHtcclxuICAgICh7IGNoaWxkU2NvcmVzIH06IHtcclxuICAgICAgICAvKiogQW4gYXJyYXkgb2YgZ3JvdXBlZCBlZGdlcyBhbmQgY2xhaW1zKi9cclxuICAgICAgICBjaGlsZFNjb3Jlcz86IFNjb3JlW107XHJcbiAgICB9KTogUGFydGlhbDxTY29yZT5cclxufVxyXG5cclxuLyoqXHJcbiAqIENhbGN1bGF0ZXMgYSBuZXcgc2NvcmUgYmFzZWQgb24gdGhlIGNoaWxkIHNjb3JlcyBwYXNzZWQgaW4uXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlU2NvcmUoeyBjaGlsZFNjb3JlcyA9IFtdLCByZXZlcnNpYmxlID0gdHJ1ZSB9OiB7XHJcbiAgICAvKiogQW4gYXJyYXkgb2YgZ3JvdXBlZCBlZGdlcyBhbmQgY2xhaW1zKi9cclxuICAgIGNoaWxkU2NvcmVzPzogU2NvcmVbXTtcclxuICAgIC8qKiBDYW4gdGhpcyBzY29yZSBmYWxsIGJlbG93IGEgMCBjb25maWRlbmNlIChoYXZlIGEgbmVnYXRpdmUgY29uZmlkZW5jZSkgKi9cclxuICAgIHJldmVyc2libGU/OiBib29sZWFuXHJcbn0gPSB7fSxcclxuKTogUGFydGlhbDxTY29yZT4ge1xyXG4gICAgLy8gVE9ETzogU2ltcGxpZnkgYWxsIHRoaXMgbWF0aCBhbmQgbWF5YmUgYnJlYWsgaXQgdXAgYmV0d2VlbiBiYXNlIGZ1bmN0aW9uYWxpdHkgYW5kIGFkZGl0aW9uYWwgc2NvcmluZyAobGlrZSB0aGUgcG9pbnRzKVxyXG4gICAgY29uc3QgbmV3U2NvcmU6IFBhcnRpYWw8U2NvcmU+ID0ge1xyXG4gICAgICAgIGNvbmZpZGVuY2U6IDAsXHJcbiAgICAgICAgcmVsZXZhbmNlOiAxLFxyXG4gICAgICAgIGNoaWxkcmVuQXZlcmFnaW5nV2VpZ2h0OiAwLFxyXG4gICAgICAgIGNoaWxkcmVuQ29uZmlkZW5jZVdlaWdodDogMCxcclxuICAgICAgICBjaGlsZHJlblJlbGV2YW5jZVdlaWdodDogMCxcclxuICAgICAgICBjaGlsZHJlbldlaWdodDogMCxcclxuICAgIH07XHJcblxyXG4gICAgaWYgKGNoaWxkU2NvcmVzLmZpbHRlcihzID0+IHMuYWZmZWN0cyA9PT0gJ2NvbmZpZGVuY2UnKS5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgLy8gRGVmYXVsdHMgaWYgdGhlcmUgYXJlIG5vIGNoaWxkcmVuXHJcbiAgICAgICAgbmV3U2NvcmUuY29uZmlkZW5jZSA9IDE7IC8vIGFzc3VtZSAxMDAlIGNvbmZpZGVudFxyXG4gICAgICAgIG5ld1Njb3JlLnJlbGV2YW5jZSA9IDE7IC8vIGFzc3VtZSAxMDAlIHJlbGV2YW50XHJcbiAgICAgICAgbmV3U2NvcmUuY2hpbGRyZW5BdmVyYWdpbmdXZWlnaHQgPSAxO1xyXG4gICAgICAgIG5ld1Njb3JlLmNoaWxkcmVuQ29uZmlkZW5jZVdlaWdodCA9IDE7XHJcbiAgICAgICAgbmV3U2NvcmUuY2hpbGRyZW5SZWxldmFuY2VXZWlnaHQgPSAxO1xyXG4gICAgICAgIG5ld1Njb3JlLmNoaWxkcmVuV2VpZ2h0ID0gMTtcclxuICAgIH1cclxuXHJcbiAgICAvL0dhdGhlciBjaGlsZHJlbiBXZWlnaHRzIHRvdGFscyBmb3IgcHJvY2Vzc2luZyBmdXJ0aGVyIGRvd25cclxuICAgIGZvciAoY29uc3QgY2hpbGRTY29yZSBvZiBjaGlsZFNjb3Jlcykge1xyXG4gICAgICAgIC8vRW5zdXJlIGNhbGN1bGF0aW9ucyBmb3Igbm9uLXJldmVyc2libGUgc2NvcmVzIGRvbid0IGFsbG93IHRoZSBjb25maWRlbmNlIHRvIGJlIGJlbG93IDBcclxuICAgICAgICAvL1RPRE86IElzIHRoaXMgbmVlZGVkIGluIHRoZSB0b3RhbHMgc2VjaXRvbj9cclxuICAgICAgICBsZXQgY29uZmlkZW5jZSA9IGNoaWxkU2NvcmUuY29uZmlkZW5jZVxyXG4gICAgICAgIGlmICghY2hpbGRTY29yZS5yZXZlcnNpYmxlICYmIGNoaWxkU2NvcmUuY29uZmlkZW5jZSA8IDApIHtcclxuICAgICAgICAgICAgY29uZmlkZW5jZSA9IDBcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNoaWxkU2NvcmUud2VpZ2h0ID0gTWF0aC5hYnMoY29uZmlkZW5jZSkgKiBjaGlsZFNjb3JlLnJlbGV2YW5jZTsgLy8gY29uZmlkZW5jZVdlaWdodCAqIFJlbGV2YW5jZVdlaWdodFxyXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICBuZXdTY29yZS5jaGlsZHJlbkF2ZXJhZ2luZ1dlaWdodCArPSAxO1xyXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICBuZXdTY29yZS5jaGlsZHJlbkNvbmZpZGVuY2VXZWlnaHQgKz1cclxuICAgICAgICAgICAgTWF0aC5hYnMoY29uZmlkZW5jZSk7XHJcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgIG5ld1Njb3JlLmNoaWxkcmVuUmVsZXZhbmNlV2VpZ2h0ICs9XHJcbiAgICAgICAgICAgIGNoaWxkU2NvcmUucmVsZXZhbmNlO1xyXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICBuZXdTY29yZS5jaGlsZHJlbldlaWdodCArPVxyXG4gICAgICAgICAgICBjaGlsZFNjb3JlLndlaWdodDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBMb29wIHRocm91Z2ggdG8gY2FsY3VsYXRlIHRoZSBmaW5hbCBzY29yZXNcclxuICAgIGZvciAoY29uc3QgY2hpbGRTY29yZSBvZiBjaGlsZFNjb3Jlcykge1xyXG4gICAgICAgIGNvbnN0IHBvbGFyaXR5ID0gY2hpbGRTY29yZS5wcm8gPyAxIDogLTFcclxuXHJcbiAgICAgICAgaWYgKGNoaWxkU2NvcmUuYWZmZWN0cyA9PT0gXCJjb25maWRlbmNlXCIpIHtcclxuICAgICAgICAgICAgaWYgKG5ld1Njb3JlLmNoaWxkcmVuV2VpZ2h0ID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBjaGlsZFNjb3JlLnBlcmNlbnRPZldlaWdodCA9IDA7XHJcbiAgICAgICAgICAgICAgICBuZXdTY29yZS5jb25maWRlbmNlID0gMDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICBjaGlsZFNjb3JlLnBlcmNlbnRPZldlaWdodCA9XHJcbiAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29yZS53ZWlnaHQgL1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICAgICAgICAgICAgICBuZXdTY29yZS5jaGlsZHJlbldlaWdodDtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICBuZXdTY29yZS5jb25maWRlbmNlICs9XHJcbiAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29yZS5wZXJjZW50T2ZXZWlnaHQgKlxyXG4gICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcmUuY29uZmlkZW5jZSAqIHBvbGFyaXR5O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoY2hpbGRTY29yZS5hZmZlY3RzID09PSBcInJlbGV2YW5jZVwiKSB7XHJcbiAgICAgICAgICAgIC8vIFByb2Nlc3MgUmVsZXZhbmNlIGNoaWxkIGNsYWltc1xyXG5cclxuICAgICAgICAgICAgbGV0IGNvbmZpZGVuY2UgPSBjaGlsZFNjb3JlLmNvbmZpZGVuY2VcclxuICAgICAgICAgICAgaWYgKCFjaGlsZFNjb3JlLnJldmVyc2libGUgJiYgY2hpbGRTY29yZS5jb25maWRlbmNlIDwgMCkge1xyXG4gICAgICAgICAgICAgICAgY29uZmlkZW5jZSA9IDBcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKG5ld1Njb3JlLnJlbGV2YW5jZSA9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIG5ld1Njb3JlLnJlbGV2YW5jZSA9IDE7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChjaGlsZFNjb3JlLnBybykge1xyXG4gICAgICAgICAgICAgICAgbmV3U2NvcmUucmVsZXZhbmNlICs9IGNvbmZpZGVuY2U7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBuZXdTY29yZS5yZWxldmFuY2UgLT0gY29uZmlkZW5jZSAvIDI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGlmIChPYmplY3QuaXMobmV3U2NvcmUuY29uZmlkZW5jZSwgLTApKSB7XHJcbiAgICAgICAgLy8gUHJvdGVjdCBhZ2FpbnN0IG5lZ2F0aXZlIHplcm8gXHJcbiAgICAgICAgbmV3U2NvcmUuY29uZmlkZW5jZSA9IDA7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5ld1Njb3JlO1xyXG59XHJcblxyXG4iXX0=